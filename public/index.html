<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>TradeSim</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0B0E11;
      --panel: #1E2329;
      --panel-light: #2A2F36;
      --muted: #848E9C;
      --accent-green: #0ECB81;
      --accent-green-transparent: rgba(14, 203, 129, 0.15);
      --accent-red: #F6465D;
      --accent-red-transparent: rgba(246, 70, 93, 0.15);
      --white: #EAECEF;
      --border: rgba(255, 255, 255, 0.08);
      --gold: #F0B90B;
      --gold-gradient: linear-gradient(135deg, #F0B90B 0%, #B88A00 100%);
      --accent-blue: #1E90FF;
      --accent-purple: #A855F7;
      --accent-orange: #F7931A;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--white); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; position: relative; }

    .view-section {
      flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease;
      position: absolute; width: 100%; top: 0; left: 0; background: var(--bg);
    }
    .view-section.hidden { display: none; opacity: 0; pointer-events: none; z-index: -1; }
    .view-section.active { display: flex; opacity: 1; z-index: 10; }

    .header {
      flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; background: var(--panel); border-bottom: 1px solid var(--border); height: 60px; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo-img { height: 28px; width: auto; display: block; }

    .pair-dropdown { position: relative; font-family: 'Roboto Mono', monospace; }
    .pair-trigger {
      display: flex; align-items: center; gap: 8px; background: transparent; padding: 6px 12px;
      border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 15px; color: var(--white);
      transition: background 0.2s; user-select: none;
    }
    .pair-trigger:hover { background: rgba(255,255,255,0.05); }
    .pair-trigger .arrow { font-size: 10px; color: var(--muted); transition: transform 0.2s; }
    .pair-dropdown.open .pair-trigger .arrow { transform: rotate(180deg); }
    .pair-menu {
      position: absolute; top: 100%; left: 0; margin-top: 8px;
      background: rgba(30, 35, 41, 0.95); backdrop-filter: blur(10px);
      border: 1px solid var(--border); border-radius: 8px; width: 160px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; pointer-events: none;
      transform: translateY(-10px); transition: all 0.2s ease; z-index: 200;
      display: flex; flex-direction: column; padding: 4px;
    }
    .pair-dropdown.open .pair-menu { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .pair-item {
      padding: 10px 12px; font-size: 14px; font-weight: 500; color: var(--muted);
      cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
    }
    .pair-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
    .pair-item.active { background: rgba(255,255,255,0.08); color: var(--white); font-weight: 700; }
    .pair-item.active::after { content: '✓'; color: var(--accent-green); font-size: 12px; }

    .user-area { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 8px; border-radius: 8px; transition: background 0.2s; }
    .user-area:active { background: rgba(255,255,255,0.05); }
    .balance-group { text-align: right; line-height: 1.2; }
    .balance-label { font-size: 10px; color: var(--muted); display: block; }
    .balance-val { font-size: 13px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono', monospace; }
    .avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; border: 1px solid var(--border); }
    .avatar-sm img { width: 100%; height: 100%; object-fit: cover; }

    .container {
      flex: 1; display: flex; flex-direction: column;
      overflow-y: auto; overflow-x: hidden; padding: 12px; gap: 12px;
    }
    @media (min-width: 900px) {
      .container { display: grid; grid-template-columns: 1fr 340px; height: calc(100vh - 60px); overflow: hidden; }
      .left-col { overflow-y: auto; padding-right: 4px; }
      .right-col { overflow: hidden; height: 100%; }
      .ob-container, .pos-list { max-height: 400px; overflow-y: auto; }
    }

    .left-col { display: flex; flex-direction: column; gap: 12px; }
    .right-col { display: flex; flex-direction: column; gap: 12px; }
    .card { background: var(--panel); border-radius: 12px; padding: 12px; border: 1px solid var(--border); }

    .market-header {
      display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
      gap: 12px; min-width: 0; position: relative;
    }

    .price-block {
      display: flex; flex-direction: column; min-width: 0; flex-shrink: 0;
    }

    .price-label {
      color: var(--muted); font-size: 11px; margin-bottom: 4px;
    }

    .price-display { font-family: 'Roboto Mono', monospace; font-size: 32px; font-weight: 700; line-height: 1; letter-spacing: -1px; white-space: nowrap; }

    .chart-wrapper { position: relative; display: flex; flex-direction: column; gap: 0; }

    .chart-container {
      height: 280px; width: 100%; border-radius: 8px; overflow: hidden;
      position: relative; background: #111;
    }
    .chart-container.has-volume { border-radius: 8px 8px 0 0; }
    @media (min-width: 900px) { .chart-container { height: 40vh; } }

    .volume-container {
      height: 60px; width: 100%; background: #111;
      border-radius: 0 0 8px 8px; overflow: hidden; position: relative;
      border-top: 1px solid rgba(255,255,255,0.12);
      display: none;
    }
    .volume-container.visible { display: block; }

    .chart-loading-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(11, 14, 17, 0.7); display: flex; align-items: center; justify-content: center;
      z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
    }
    .chart-loading-overlay.active { opacity: 1; pointer-events: auto; }
    .chart-loading-spinner {
      width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-green); border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .ohlc-tooltip {
      position: absolute; top: 8px; left: 46px; z-index: 30;
      display: flex; align-items: center; gap: 8px;
      font-family: 'Roboto Mono', monospace; font-size: 10px; color: var(--muted);
      background: rgba(11, 14, 17, 0.85); padding: 4px 8px; border-radius: 4px;
      pointer-events: none; opacity: 0; transition: opacity 0.15s ease;
      max-width: calc(100% - 54px);
    }
    .ohlc-tooltip.visible { opacity: 1; }
    .ohlc-tooltip.ohlc-wrapped { flex-wrap: wrap; }
    .ohlc-tooltip .ohlc-item { display: flex; gap: 2px; white-space: nowrap; }
    .ohlc-tooltip .ohlc-label { color: var(--muted); }
    .ohlc-tooltip .ohlc-value { color: var(--white); font-weight: 500; }
    .ohlc-tooltip .ohlc-value.up { color: var(--accent-green); }
    .ohlc-tooltip .ohlc-value.down { color: var(--accent-red); }

    .drawing-tools-menu {
      position: absolute; top: 8px; left: 8px; z-index: 40;
      display: flex; flex-direction: column; gap: 2px;
    }
    .drawing-tools-toggle {
      width: 28px; height: 28px; background: rgba(30, 35, 41, 0.9);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--muted); font-size: 14px;
    }
    .drawing-tools-toggle:hover { background: var(--panel-light); color: var(--white); }
    .drawing-tools-toggle.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); }
    .drawing-tools-panel {
      display: flex; flex-direction: column; gap: 2px;
      opacity: 0; pointer-events: none; transform: translateY(-4px); transition: all 0.2s ease;
    }
    .drawing-tools-menu.open .drawing-tools-panel { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .drawing-tool-btn {
      width: 28px; height: 28px; background: rgba(30, 35, 41, 0.9);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--muted); font-size: 12px;
    }
    .drawing-tool-btn:hover { background: var(--panel-light); color: var(--white); }
    .drawing-tool-btn.active { background: rgba(30, 144, 255, 0.2); color: var(--accent-blue); border-color: var(--accent-blue); }
    .drawing-tool-btn svg { width: 14px; height: 14px; }

    .indicators-panel {
      display: flex; align-items: center; gap: 6px; padding: 8px 0; flex-wrap: wrap;
    }
    .indicator-chip {
      display: flex; align-items: center; gap: 4px; padding: 4px 10px;
      font-size: 11px; font-weight: 600; color: var(--muted);
      background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
      border-radius: 4px; cursor: pointer; transition: all 0.2s; user-select: none;
    }
    .indicator-chip:hover { background: rgba(255, 255, 255, 0.06); color: var(--white); }
    .indicator-chip.active.ema { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(30, 144, 255, 0.15); }
    .indicator-chip.active.sma { border-color: var(--accent-purple); color: var(--accent-purple); background: rgba(168, 85, 247, 0.15); }
    .indicator-chip.active.vwap { border-color: var(--accent-orange); color: var(--accent-orange); background: rgba(247, 147, 26, 0.15); }
    .indicator-chip.active.volume { border-color: var(--accent-green); color: var(--accent-green); background: var(--accent-green-transparent); }
    .indicator-dot {
      width: 6px; height: 6px; border-radius: 50%; background: currentColor;
      opacity: 0; transition: opacity 0.2s;
    }
    .indicator-chip.active .indicator-dot { opacity: 1; }

    .controls-area { display: flex; flex-direction: column; gap: 16px; margin-top: 12px; }
    .input-group { position: relative; }
    .input-label { position: absolute; top: 8px; left: 12px; font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .main-input {
      width: 100%; background: #111; border: 1px solid var(--border); color: var(--white);
      padding: 24px 12px 8px 12px; border-radius: 8px; font-size: 16px;
      font-family: 'Roboto Mono', monospace; outline: none; transition: border 0.2s;
    }
    .main-input:focus { border-color: var(--accent-green); }

    .slider-wrap { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
    .slider-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .slider-val { color: var(--accent-green); font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

    .range-slider {
      -webkit-appearance: none; width: 100%; height: 4px;
      background: linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) 0%, #2A2F36 0%, #2A2F36 100%);
      border-radius: 2px; outline: none; margin: 10px 0;
    }
    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid var(--accent-green); transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .range-slider::-webkit-slider-thumb:hover { transform: scale(1.1); box-shadow: 0 2px 12px rgba(14, 203, 129, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); }
    .range-slider::-webkit-slider-thumb:active { transform: scale(0.95); }
    .range-slider::-moz-range-thumb {
      width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid var(--accent-green);
    }

    .chips-row { display: flex; justify-content: space-between; gap: 4px; margin-top: 8px; }
    .chip { flex: 1; text-align: center; padding: 6px 0; font-size: 11px; background: #15181b; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); color: var(--muted); transition: 0.2s; }
    .chip.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); font-weight: 700; }

    .margin-slider-wrap { position: relative; padding: 0 10px; }
    .margin-slider-wrap .range-slider { width: 100%; }
    .margin-marks { display: flex; justify-content: space-between; margin-top: 4px; position: relative; }
    .margin-mark {
      font-size: 10px; color: var(--muted); cursor: pointer; padding: 2px 0; border-radius: 3px;
      transition: 0.2s; user-select: none; text-align: center; min-width: 28px;
    }
    .margin-mark:first-child { text-align: left; }
    .margin-mark:last-child { text-align: right; }
    .margin-mark:hover { color: var(--accent-green); }
    .margin-mark.active { color: var(--accent-green); font-weight: 600; }

    .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .btn-trade {
      padding: 14px; border-radius: 8px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; color: #fff;
      display: flex; flex-direction: column; align-items: center; line-height: 1.2; transition: filter 0.2s;
    }
    .btn-trade:active { filter: brightness(0.9); transform: scale(0.98); }
    .btn-trade span { font-size: 10px; font-weight: 400; opacity: 0.8; margin-top: 2px; }
    .btn-long { background: var(--accent-green); color: #052e1f; }
    .btn-short { background: var(--accent-red); color: #2d0a0f; }

    .ob-header { display: grid; grid-template-columns: 1fr 1fr; font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; padding: 0 6px; }
    .ob-container { font-size: 12px; font-family: 'Roboto Mono', monospace; display: flex; flex-direction: column; gap: 1px; overflow: hidden; }
    .ob-row { position: relative; display: grid; grid-template-columns: 1fr 1fr; align-items: center; height: 20px; padding: 0 6px; line-height: 1; white-space: nowrap; overflow: hidden; }
    .trade-time { text-align: right; opacity: 0.7; }
    .ob-bg { position: absolute; top: 0; bottom: 0; z-index: 0; opacity: 0.18; transition: width 0.2s ease; }
    .bg-red { left: 0; background: linear-gradient(to right, var(--accent-red), transparent); }
    .bg-green { right: 0; background: linear-gradient(to left, var(--accent-green), transparent); }
    .ob-row span { position: relative; z-index: 1; }
    .ob-row span:last-child { text-align: right; }
    .text-green { color: var(--accent-green); }
    .text-red { color: var(--accent-red); }

    /* ==================== POSITION ITEM STYLES ==================== */
    .pos-list { display: flex; flex-direction: column; gap: 8px; }
    .pos-item { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; position: relative; overflow: hidden; }
    .pos-item.long { border-left: 4px solid var(--accent-green); }
    .pos-item.short { border-left: 4px solid var(--accent-red); }
    .pos-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; font-weight: 700; align-items: center; }
    .pos-pair { font-size: 15px; letter-spacing: 0.5px; }
    .pos-type-badge { font-size: 14px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

    .pos-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 8px 0; padding: 8px 0; border-top: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .stat-col { display: flex; flex-direction: column; gap: 4px; }
    .stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stat-val { font-size: 13px; font-weight: 700; font-family: 'Roboto Mono'; }

    .risk-wrap { margin-top: 4px; width: 100%; }
    .risk-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .risk-fill { height: 100%; width: 0%; background: var(--accent-green); transition: width 0.3s, background 0.3s; }

    .pos-details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
    .pd-col { display: flex; flex-direction: column; gap: 2px; }
    .pd-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .pd-val { font-size: 12px; color: var(--white); font-family: 'Roboto Mono'; font-weight: 700; }

    /* ==================== TP/SL BUTTONS ==================== */
    .pos-tpsl-actions {
      display: flex; gap: 8px; margin-top: 12px; padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .btn-tpsl {
      flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 10px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    .btn-tpsl:hover { background: rgba(255,255,255,0.06); }
    .btn-tpsl:active { transform: scale(0.98); }
    .btn-tpsl.tp { color: var(--accent-green); }
    .btn-tpsl.tp:hover { border-color: var(--accent-green); background: var(--accent-green-transparent); }
    .btn-tpsl.sl { color: var(--accent-red); }
    .btn-tpsl.sl:hover { border-color: var(--accent-red); background: var(--accent-red-transparent); }
    .btn-tpsl-icon { font-size: 14px; }

    /* ==================== TP/SL ORDERS LIST ==================== */
    .pos-tpsl-orders {
      margin-top: 12px; padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .tpsl-orders-title {
      font-size: 11px; color: var(--muted); text-transform: uppercase;
      font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
    }
    .tpsl-orders-count {
      background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 10px;
      font-size: 10px; color: var(--white);
    }
    .tpsl-orders-list { display: flex; flex-direction: column; gap: 6px; }
    .tpsl-order-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; border-radius: 8px; font-size: 12px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
    }
    .tpsl-order-item.tp { border-left: 3px solid var(--accent-green); }
    .tpsl-order-item.sl { border-left: 3px solid var(--accent-red); }
    .tpsl-order-info { display: flex; flex-direction: column; gap: 2px; }
    .tpsl-order-type {
      font-weight: 700; font-size: 11px; text-transform: uppercase;
    }
    .tpsl-order-type.tp { color: var(--accent-green); }
    .tpsl-order-type.sl { color: var(--accent-red); }
    .tpsl-order-details {
      display: flex; gap: 12px; font-size: 11px; color: var(--muted);
      font-family: 'Roboto Mono', monospace;
    }
    .tpsl-order-details span { display: flex; align-items: center; gap: 4px; }
    .tpsl-order-pnl { font-size: 12px; font-weight: 600; font-family: 'Roboto Mono', monospace; }
    .tpsl-order-pnl.positive { color: var(--accent-green); }
    .tpsl-order-pnl.negative { color: var(--accent-red); }
    .tpsl-order-actions { display: flex; align-items: center; gap: 8px; }
    .btn-delete-tpsl {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      background: rgba(246, 70, 93, 0.1); border: 1px solid transparent;
      border-radius: 6px; color: var(--accent-red); cursor: pointer;
      transition: all 0.2s; font-size: 14px;
    }
    .btn-delete-tpsl:hover { background: var(--accent-red-transparent); border-color: var(--accent-red); }
    .btn-delete-tpsl:active { transform: scale(0.9); }

    .close-btn {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--accent-red);
      padding: 8px 12px; border-radius: 8px; font-size: 12px; margin-top: 12px; width: 100%; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .close-btn:active { background: var(--accent-red); color: #fff; }

    /* ==================== TP/SL MODAL STYLES ==================== */
    .tpsl-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .tpsl-modal-overlay.active { opacity: 1; pointer-events: auto; }

    .tpsl-modal {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      max-height: 90vh; overflow-y: auto; z-index: 1001;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    .tpsl-modal-overlay.active .tpsl-modal { transform: translateY(0); }

    .tpsl-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--panel); z-index: 10;
    }
    .tpsl-modal-title { font-size: 16px; font-weight: 700; color: var(--white); }
    .tpsl-modal-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .tpsl-modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 50%; cursor: pointer;
      color: var(--muted); font-size: 18px; transition: all 0.2s; border: none;
    }
    .tpsl-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }

    .tpsl-modal-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }

    /* Position Info in Modal */
    .tpsl-position-info {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; background: rgba(255,255,255,0.03);
      border: 1px solid var(--border); border-radius: 10px;
    }
    .tpsl-position-left { display: flex; align-items: center; gap: 10px; }
    .tpsl-position-type {
      padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700;
    }
    .tpsl-position-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
    .tpsl-position-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
    .tpsl-position-pair { font-size: 14px; font-weight: 600; color: var(--white); }
    .tpsl-position-leverage { font-size: 12px; color: var(--muted); margin-left: 4px; }
    .tpsl-position-right { text-align: right; }
    .tpsl-position-entry { font-size: 11px; color: var(--muted); }
    .tpsl-position-entry-val { font-size: 14px; font-weight: 600; font-family: 'Roboto Mono', monospace; color: var(--white); }

    /* Tabs */
    .tpsl-tabs {
      display: flex; gap: 4px; background: rgba(255,255,255,0.03);
      padding: 4px; border-radius: 10px; border: 1px solid var(--border);
    }
    .tpsl-tab {
      flex: 1; padding: 10px 16px; font-size: 13px; font-weight: 600;
      color: var(--muted); background: transparent; border: none;
      border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .tpsl-tab:hover { color: var(--white); }
    .tpsl-tab.active { background: var(--panel-light); color: var(--white); }

    /* Tab Content */
    .tpsl-tab-content { display: none; flex-direction: column; gap: 16px; }
    .tpsl-tab-content.active { display: flex; }

    /* Input Group */
    .tpsl-input-group { display: flex; flex-direction: column; gap: 8px; }
    .tpsl-input-label {
      font-size: 12px; font-weight: 600; color: var(--muted);
      display: flex; align-items: center; justify-content: space-between;
    }
    .tpsl-input-hint { font-size: 11px; font-weight: 400; }
    .tpsl-input-wrapper { position: relative; }
    .tpsl-input {
      width: 100%; background: #111; border: 1px solid var(--border);
      color: var(--white); padding: 14px 16px; border-radius: 10px;
      font-size: 16px; font-family: 'Roboto Mono', monospace;
      outline: none; transition: border 0.2s;
    }
    .tpsl-input:focus { border-color: var(--accent-green); }
    .tpsl-input.error { border-color: var(--accent-red); }
    .tpsl-input-suffix {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
      font-size: 12px; color: var(--muted); font-weight: 600;
    }
    .tpsl-input-error {
      font-size: 11px; color: var(--accent-red); margin-top: 4px;
      display: none;
    }
    .tpsl-input-error.visible { display: block; }

    /* Size Slider */
    .tpsl-size-section { display: flex; flex-direction: column; gap: 12px; }
    .tpsl-size-header {
      display: flex; justify-content: space-between; align-items: center;
    }
    .tpsl-size-label { font-size: 12px; font-weight: 600; color: var(--muted); }
    .tpsl-size-value {
      font-size: 14px; font-weight: 700; color: var(--accent-green);
      font-family: 'Roboto Mono', monospace;
    }
    .tpsl-size-slider-wrap { padding: 0 4px; }
    .tpsl-size-slider {
      -webkit-appearance: none; width: 100%; height: 6px;
      background: linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) 100%, #2A2F36 100%, #2A2F36 100%);
      border-radius: 3px; outline: none;
    }
    .tpsl-size-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%);
      border: 2px solid var(--accent-green); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .tpsl-size-marks {
      display: flex; justify-content: space-between; margin-top: 6px;
    }
    .tpsl-size-mark {
      font-size: 10px; color: var(--muted); cursor: pointer;
      padding: 4px 8px; border-radius: 4px; transition: 0.2s;
    }
    .tpsl-size-mark:hover { color: var(--accent-green); background: rgba(255,255,255,0.05); }
    .tpsl-size-mark.active { color: var(--accent-green); font-weight: 600; }
    .tpsl-available-info {
      display: flex; justify-content: space-between; font-size: 11px;
      color: var(--muted); padding: 8px 12px; background: rgba(255,255,255,0.02);
      border-radius: 6px; border: 1px solid var(--border);
    }
    .tpsl-available-info span:last-child { color: var(--white); font-family: 'Roboto Mono', monospace; }

    /* PnL Preview */
    .tpsl-pnl-preview {
      display: flex; flex-direction: column; gap: 8px; padding: 16px;
      background: rgba(255,255,255,0.02); border: 1px solid var(--border);
      border-radius: 10px;
    }
    .tpsl-pnl-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 13px;
    }
    .tpsl-pnl-label { color: var(--muted); }
    .tpsl-pnl-value { font-weight: 600; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .tpsl-pnl-value.positive { color: var(--accent-green); }
    .tpsl-pnl-value.negative { color: var(--accent-red); }
    .tpsl-pnl-divider { height: 1px; background: var(--border); margin: 4px 0; }

    /* Submit Button */
    .tpsl-submit-btn {
      width: 100%; padding: 16px; border-radius: 10px; border: none;
      font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .tpsl-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .tpsl-submit-btn:not(:disabled):active { transform: scale(0.98); }
    .tpsl-submit-btn.tp { background: var(--accent-green); color: #052e1f; }
    .tpsl-submit-btn.sl { background: var(--accent-red); color: #fff; }

    /* Existing Orders Warning */
    .tpsl-existing-orders {
      padding: 12px 16px; background: rgba(240, 185, 11, 0.1);
      border: 1px solid rgba(240, 185, 11, 0.3); border-radius: 10px;
    }
    .tpsl-existing-title {
      font-size: 12px; font-weight: 600; color: var(--gold);
      display: flex; align-items: center; gap: 6px; margin-bottom: 8px;
    }
    .tpsl-existing-list { display: flex; flex-direction: column; gap: 6px; }
    .tpsl-existing-item {
      display: flex; justify-content: space-between; font-size: 12px;
      padding: 8px 10px; background: rgba(0,0,0,0.2); border-radius: 6px;
    }
    .tpsl-existing-item-type { font-weight: 600; }
    .tpsl-existing-item-type.tp { color: var(--accent-green); }
    .tpsl-existing-item-type.sl { color: var(--accent-red); }
    .tpsl-existing-item-info { color: var(--muted); font-family: 'Roboto Mono', monospace; }

    /* ==================== PROFILE STYLES ==================== */
    .profile-container { flex: 1; display: flex; flex-direction: column; padding: 16px; overflow-y: auto; gap: 20px; background: var(--bg); }
    .pro-header, .asset-card, .analysis-block, .rewards-banner, .hist-header-row { flex-shrink: 0; }
    .pro-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .pro-user { display: flex; align-items: center; gap: 12px; }
    .pro-avatar { width: 44px; height: 44px; border-radius: 50%; background: #333; overflow: hidden; border: 2px solid var(--panel); }
    .pro-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .pro-name { font-size: 16px; font-weight: 700; color: var(--white); line-height: 1.2; }
    .pro-id { font-size: 11px; color: var(--muted); font-family: monospace; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }

    .asset-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; position: relative; overflow: hidden; }
    .asset-label { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
    .eye-btn { width: 20px; height: 20px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; margin-left: 6px; display: block; }
    .eye-btn:active { opacity: 1; transform: scale(0.9); }
    .asset-val { font-size: 26px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono'; margin: 8px 0; }
    .asset-approx { font-size: 13px; color: var(--muted); }
    .asset-pnl { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); display: inline-flex; align-items: center; gap: 4px; margin-left: 8px; }
    .asset-rate { font-size: 11px; color: var(--muted); margin-top: 8px; display: block; }
    .pro-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .pro-btn { background: var(--panel-light); border: none; color: var(--white); padding: 10px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .pro-btn.primary { background: var(--gold); color: #000; }

    .analysis-block { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .an-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 110px; }
    .an-card.clickable { cursor: pointer; transition: all 0.2s; }
    .an-card.clickable:hover { border-color: rgba(255,255,255,0.15); background: rgba(30, 35, 41, 0.8); }
    .an-card.clickable:active { transform: scale(0.98); }
    .an-title { font-size: 11px; color: var(--muted); margin-bottom: 0; text-transform: uppercase; width: 100%; text-align: left; }
    .an-content-center { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }

    .donut-chart { width: 70px; height: 70px; border-radius: 50%; background: conic-gradient(var(--accent-green) 0% 0%, var(--panel-light) 0% 100%); position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; }
    .donut-chart::after { content: ''; position: absolute; width: 56px; height: 56px; background: var(--panel); border-radius: 50%; }
    .donut-val { position: absolute; z-index: 2; font-size: 12px; font-weight: 700; color: var(--white); }
    .an-text { font-size: 12px; color: var(--white); font-weight: 600; margin-top: 4px; }

    .pnl-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .pnl-modal-overlay.active { opacity: 1; pointer-events: auto; }
    .pnl-modal {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      max-height: 85vh; overflow-y: auto; z-index: 1001;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    .pnl-modal-overlay.active .pnl-modal { transform: translateY(0); }
    .pnl-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--panel); z-index: 10;
    }
    .pnl-modal-title { font-size: 16px; font-weight: 700; color: var(--white); }
    .pnl-modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 50%; cursor: pointer;
      color: var(--muted); font-size: 18px; transition: all 0.2s; border: none;
    }
    .pnl-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .pnl-modal-content { padding: 20px; display: flex; flex-direction: column; gap: 24px; }

    .stats-metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stats-metric-card {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 4px;
    }
    .stats-metric-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stats-metric-value { font-size: 18px; font-weight: 700; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .stats-metric-value.positive { color: var(--accent-green); }
    .stats-metric-value.negative { color: var(--accent-red); }

    .period-selector {
      display: flex; gap: 4px; background: rgba(255,255,255,0.03);
      padding: 3px; border-radius: 8px; border: 1px solid var(--border);
    }
    .period-btn {
      padding: 6px 12px; font-size: 11px; font-weight: 600; color: var(--muted);
      background: transparent; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;
    }
    .period-btn:hover { color: var(--white); }
    .period-btn.active { background: var(--panel-light); color: var(--white); }

    .chart-section { display: flex; flex-direction: column; gap: 12px; }
    .chart-section-header { display: flex; justify-content: space-between; align-items: center; }
    .chart-section-title { font-size: 13px; font-weight: 600; color: var(--white); }
    .equity-chart-container {
      height: 160px; background: rgba(0,0,0,0.2); border-radius: 8px;
      overflow: hidden; position: relative;
    }

    .calendar-pnl-container { display: flex; flex-direction: column; gap: 8px; }
    .calendar-month-nav {
      display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 8px;
    }
    .calendar-nav-btn {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border: none; border-radius: 6px;
      color: var(--muted); cursor: pointer; transition: all 0.2s; font-size: 16px;
    }
    .calendar-nav-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .calendar-month-label { font-size: 14px; font-weight: 600; color: var(--white); min-width: 120px; text-align: center; }
    .calendar-header { display: flex; justify-content: space-between; padding: 0 2px; }
    .calendar-day-label { font-size: 9px; color: var(--muted); width: 36px; text-align: center; font-weight: 600; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-cell {
      aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 600; font-family: 'Roboto Mono', monospace;
      cursor: default; transition: transform 0.15s; position: relative;
      background: rgba(255,255,255,0.03); color: var(--muted);
    }
    .calendar-cell:hover { transform: scale(1.1); z-index: 2; }
    .calendar-cell.empty { background: transparent; }
    .calendar-cell.profit { background: var(--accent-green-transparent); color: var(--accent-green); }
    .calendar-cell.loss { background: var(--accent-red-transparent); color: var(--accent-red); }
    .calendar-cell.profit.high { background: rgba(14, 203, 129, 0.3); }
    .calendar-cell.loss.high { background: rgba(246, 70, 93, 0.3); }
    .calendar-cell.today { border: 1px solid var(--gold); }
    .calendar-legend {
      display: flex; justify-content: center; gap: 16px; margin-top: 8px;
      padding-top: 8px; border-top: 1px solid var(--border);
    }
    .calendar-legend-item { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--muted); }
    .calendar-legend-dot { width: 10px; height: 10px; border-radius: 3px; }
    .calendar-legend-dot.profit { background: var(--accent-green-transparent); }
    .calendar-legend-dot.loss { background: var(--accent-red-transparent); }
    .calendar-legend-dot.no-trade { background: rgba(255,255,255,0.03); }

    .ref-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .ref-top { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .ref-title { font-weight: 800; font-size: 14px; }
    .ref-badge { font-size: 11px; color: var(--muted); background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); }
    .ref-row { display: flex; gap: 8px; align-items: center; }
    .ref-input { flex: 1; background: #111; border: 1px solid var(--border); color: var(--white); padding: 12px; border-radius: 10px; font-family: 'Roboto Mono', monospace; font-size: 12px; outline: none; width: 100%; }
    .ref-btn { background: var(--panel-light); border: 1px solid var(--border); color: var(--white); padding: 12px 12px; border-radius: 10px; font-weight: 700; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .ref-btn.primary { background: var(--gold); color: #000; border-color: rgba(240,185,11,0.4); }
    .ref-help { font-size: 11px; color: var(--muted); line-height: 1.35; }
    .ref-list { display: flex; flex-direction: column; gap: 8px; max-height: 180px; overflow-y: auto; padding-right: 2px; }
    .ref-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 10px; }
    .ref-item-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .ref-avatar { width: 28px; height: 28px; border-radius: 50%; background: #333; overflow: hidden; border: 1px solid var(--border); flex-shrink: 0; }
    .ref-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .ref-name { font-size: 12px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
    .ref-date { font-size: 10px; color: var(--muted); font-family: monospace; flex-shrink: 0; }
    .ref-status { font-size: 10px; color: var(--muted); }

    .rewards-banner {
      background: linear-gradient(90deg, #1E2329 0%, #252a33 100%); border: 1px solid rgba(240, 185, 11, 0.3);
      border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; position: relative; overflow: hidden;
    }
    .rewards-banner::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gold); }
    .rb-content h3 { margin: 0; font-size: 15px; color: var(--white); }
    .rb-content p { margin: 4px 0 0; font-size: 11px; color: var(--muted); }
    .rb-icon { display: flex; align-items: center; }

    .hist-header-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; }
    .hist-title { margin: 0; font-size: 15px; font-weight: 700; }
    .hist-filters { display: flex; background: var(--panel); border-radius: 8px; padding: 2px; border: 1px solid var(--border); }
    .h-filter { padding: 4px 10px; font-size: 11px; color: var(--muted); border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: 500; }
    .h-filter.active { background: var(--panel-light); color: var(--white); font-weight: 700; }

    .history-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 60px; }
    .history-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 8px; }
    .hc-header { display: flex; justify-content: space-between; align-items: center; }
    .hc-pair { font-weight: 700; font-size: 14px; }
    .hc-type { font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
    .hc-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
    .hc-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
    .hc-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); }
    .hc-val { color: var(--white); font-family: 'Roboto Mono'; }
    .hc-pnl { font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

    .rewards-container { padding: 20px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; padding-bottom: 100px; }
    .rewards-header { text-align: center; padding: 20px 0; }
    .rh-title { font-size: 22px; font-weight: 700; color: var(--white); margin-bottom: 8px; }
    .rh-sub { font-size: 13px; color: var(--muted); }
    .stats-row { display: flex; justify-content: center; gap: 32px; margin-top: 16px; }
    .stat-item { text-align: center; }
    .stat-item .stat-number { font-size: 24px; font-weight: 700; color: var(--gold); font-family: 'Roboto Mono'; }
    .stat-item .stat-desc { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .progress-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
    .prog-info { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; color: var(--white); font-weight: 600; }
    .prog-track { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative; }
    .prog-fill { height: 100%; background: var(--gold-gradient); width: 0%; transition: width 0.5s ease; border-radius: 4px; }
    .milestones { display: flex; justify-content: space-between; margin-top: 12px; }
    .ms-item { text-align: center; width: 30px; position: relative; }
    .ms-dot { width: 10px; height: 10px; background: #333; border: 2px solid var(--muted); border-radius: 50%; margin: 0 auto 4px; z-index: 2; position: relative; }
    .ms-item.active .ms-dot { background: var(--gold); border-color: var(--gold); box-shadow: 0 0 10px rgba(240, 185, 11, 0.4); }
    .ms-val { font-size: 10px; color: var(--muted); }

    .task-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .task-item { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
    .task-left h4 { margin: 0 0 4px; font-size: 14px; }
    .task-left p { margin: 0; font-size: 11px; color: var(--muted); }
    .task-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .daily-counter { font-size: 11px; color: var(--muted); font-family: 'Roboto Mono'; }
    .daily-counter.limit-reached { color: var(--accent-red); }
    .btn-claim { background: var(--gold); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .btn-claim:hover { filter: brightness(1.1); }
    .btn-claim:active { transform: scale(0.96); }
    .btn-claim:disabled { background: var(--panel-light); color: var(--muted); cursor: not-allowed; }
    .btn-claim.loading { opacity: 0.7; pointer-events: none; }

    .btn-back-float {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--panel-light); border: 1px solid var(--border); color: var(--white);
      padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 900; cursor: pointer;
    }

    #app-loader {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s;
    }
    #app-loader.hidden { opacity: 0; pointer-events: none; }
    .loader-logo { width: 80px; height: auto; margin-bottom: 20px; animation: pulse 2s infinite ease-in-out; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    .loader-bar-bg { width: 140px; height: 2px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .loader-bar-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.2s; }

    .tf-selector {
      display: flex; gap: 2px; background: rgba(255,255,255,0.03);
      padding: 2px; border-radius: 6px; height: fit-content;
      flex-shrink: 0; align-self: flex-start;
    }
    .tf-selector.tf-wrapped {
      display: grid; grid-template-columns: repeat(3, auto);
      grid-template-rows: auto auto; gap: 2px; width: auto; justify-content: end;
    }
    .tf-opt {
      padding: 4px 8px; font-size: 10px; color: var(--muted);
      border-radius: 4px; cursor: pointer; font-weight: 600;
      transition: 0.2s; user-select: none; white-space: nowrap; text-align: center;
    }
    .tf-opt:hover { color: var(--white); background: rgba(255,255,255,0.05); }
    .tf-opt.active { background: var(--panel-light); color: var(--gold); }
  </style>
</head>
<body>

<div id="app-loader">
  <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="TradeSim" class="loader-logo">
  <div class="loader-bar-bg"><div class="loader-bar-fill" id="loaderBar"></div></div>
  <div style="margin-top: 12px; font-size: 10px; color: var(--muted); font-family: monospace; letter-spacing: 1px;" id="loaderText">CONNECTING</div>
</div>

<div class="app">

  <div id="view-trade" class="view-section active">
    <header class="header">
      <div class="header-left">
        <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="Logo" class="logo-img">
        <div class="pair-dropdown" id="pairDropdown">
          <div class="pair-trigger" id="pairTrigger">
            <span id="triggerText">BTC/USD</span>
            <span class="arrow">▼</span>
          </div>
          <div class="pair-menu">
            <div class="pair-item active" data-pair="BTC-USD">BTC/USD</div>
            <div class="pair-item" data-pair="ETH-USD">ETH/USD</div>
          </div>
        </div>
      </div>
      <div class="user-area" id="btnProfile">
        <div class="balance-group">
          <span class="balance-label">Total Assets</span>
          <span class="balance-val" id="headerBalance">0.00 VP</span>
        </div>
        <div class="avatar-sm"><img id="avatarImg" src="" style="display:none"></div>
      </div>
    </header>

    <main class="container">
      <div class="left-col">
        <div class="card">
          <div class="market-header" id="marketHeader">
            <div class="price-block" id="priceBlock">
              <div class="price-label">Market Price</div>
              <div class="price-display text-green" id="priceDisplay">--.--</div>
            </div>
            <div class="tf-selector" id="timeframeSelector">
              <div class="tf-opt active" data-tf="60">1m</div>
              <div class="tf-opt" data-tf="300">5m</div>
              <div class="tf-opt" data-tf="900">15m</div>
              <div class="tf-opt" data-tf="3600">1h</div>
              <div class="tf-opt" data-tf="21600">6h</div>
              <div class="tf-opt" data-tf="86400">1d</div>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-container" id="chartCard">
              <div id="chart" style="width: 100%; height: 100%;"></div>
              <div class="chart-loading-overlay" id="chartLoadingOverlay">
                <div class="chart-loading-spinner"></div>
              </div>

              <div class="ohlc-tooltip" id="ohlcTooltip">
                <div class="ohlc-item"><span class="ohlc-label">O:</span><span class="ohlc-value" id="ohlcOpen">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">H:</span><span class="ohlc-value" id="ohlcHigh">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">L:</span><span class="ohlc-value" id="ohlcLow">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">C:</span><span class="ohlc-value" id="ohlcClose">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">V:</span><span class="ohlc-value" id="ohlcVol">-</span></div>
              </div>

              <div class="drawing-tools-menu" id="drawingToolsMenu">
                <div class="drawing-tools-toggle" id="drawingToolsToggle" title="Drawing Tools">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                  </svg>
                </div>
                <div class="drawing-tools-panel" id="drawingToolsPanel">
                  <div class="drawing-tool-btn" id="toolCursor" data-tool="cursor" title="Cursor">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>
                  </div>
                  <div class="drawing-tool-btn" id="toolTrendLine" data-tool="trendline" title="Trend Line">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="20" x2="20" y2="4"/></svg>
                  </div>
                  <div class="drawing-tool-btn" id="toolHorizLine" data-tool="horizline" title="Horizontal Line">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="12" x2="22" y2="12"/></svg>
                  </div>
                  <div class="drawing-tool-btn" id="toolClearAll" data-tool="clear" title="Clear All">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                  </div>
                </div>
              </div>
            </div>

            <div class="volume-container" id="volumeContainer">
              <div id="volumeChart" style="width: 100%; height: 100%;"></div>
            </div>

            <div class="indicators-panel" id="indicatorsPanel">
              <div class="indicator-chip ema" id="chipEMA" data-indicator="ema">
                <span class="indicator-dot"></span>
                <span>EMA 20</span>
              </div>
              <div class="indicator-chip sma" id="chipSMA" data-indicator="sma">
                <span class="indicator-dot"></span>
                <span>SMA 50</span>
              </div>
              <div class="indicator-chip vwap" id="chipVWAP" data-indicator="vwap">
                <span class="indicator-dot"></span>
                <span>VWAP</span>
              </div>
              <div class="indicator-chip volume" id="chipVolume" data-indicator="volume">
                <span class="indicator-dot"></span>
                <span>Volume</span>
              </div>
            </div>
          </div>

          <div class="controls-area">
            <div class="input-group">
              <span class="input-label">Margin (VP)</span>
              <input type="number" id="sizeInput" class="main-input" value="100" placeholder="10-10000" />
            </div>
            <div class="slider-wrap">
              <div class="slider-header"><span>Margin %</span><span class="slider-val" id="marginPercentText">0%</span></div>
              <div class="margin-slider-wrap">
                <input type="range" class="range-slider" id="marginSlider" min="0" max="100" step="1" value="0">
                <div class="margin-marks">
                  <span class="margin-mark" data-pct="0">0%</span>
                  <span class="margin-mark" data-pct="25">25%</span>
                  <span class="margin-mark" data-pct="50">50%</span>
                  <span class="margin-mark" data-pct="75">75%</span>
                  <span class="margin-mark" data-pct="100">100%</span>
                </div>
              </div>
            </div>
            <div class="slider-wrap">
              <div class="slider-header"><span>Leverage</span><span class="slider-val" id="leverageValText">10x</span></div>
              <input type="range" class="range-slider" id="leverageSlider" min="1" max="50" step="1" value="10">
              <div class="chips-row" id="leverageChips">
                <div class="chip" data-v="1">1x</div>
                <div class="chip" data-v="5">5x</div>
                <div class="chip active" data-v="10">10x</div>
                <div class="chip" data-v="20">20x</div>
                <div class="chip" data-v="50">50x</div>
              </div>
            </div>
            <div class="action-btns">
              <button id="openLong" class="btn-trade btn-long">Buy / Long <span>Up</span></button>
              <button id="openShort" class="btn-trade btn-short">Sell / Short <span>Down</span></button>
            </div>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px; padding-left: 4px;">Open Positions</div>
          <div id="positionsList" class="pos-list"><div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div></div>
        </div>
      </div>

      <div class="right-col">
        <div class="card" style="display:flex; flex-direction:column; min-height: 300px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between; align-items:center;">
            <span>Order Book</span>
            <div style="display:flex; gap:8px; align-items:center;">
              <span id="bookPairLabel" style="color:var(--muted); font-size:11px;">BTC-USD</span>
              <span id="bookUpdated" style="color:var(--muted); font-size:11px;">—</span>
            </div>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Amount</span></div>
          <div class="ob-container" id="orderBook" style="flex:1;"></div>
        </div>

        <div class="card" style="display:flex; flex-direction:column; min-height: 250px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between;">
            <span>Last Trades</span>
            <span style="color:var(--muted); font-size:11px;">Real-time</span>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Time</span></div>
          <div class="ob-container" id="tradeHistory" style="flex:1;"></div>
        </div>
      </div>
    </main>
  </div>

  <div id="view-profile" class="view-section hidden">
    <div class="profile-container">
      <div class="pro-header">
        <div class="pro-user">
          <div class="pro-avatar"><img id="profileAvatarBig" src=""></div>
          <div>
            <div class="pro-name" id="profileName">Trader</div>
            <div class="pro-id" id="profileId">ID: --</div>
          </div>
        </div>
        <div class="btn-close" id="btnCloseProfile" style="color:var(--muted); padding:8px; cursor:pointer;">✕</div>
      </div>

      <div class="asset-card">
        <div class="asset-label">
          Total Assets (VP)
          <img id="btnToggleBalance" class="eye-btn" src="https://img.icons8.com/ios-glyphs/60/ffffff/visible.png" alt="Show/Hide">
        </div>
        <div class="asset-val" id="profileBalance">0.00</div>
        <div style="display:flex; align-items:center;">
          <span class="asset-approx" id="profileBalanceApprox">≈ $0.00</span>
          <div class="asset-pnl text-green" id="profilePnlPill">+0.00%</div>
        </div>
        <span class="asset-rate">1 VP = $0.005</span>
        <div class="pro-actions">
          <button class="pro-btn primary">Deposit</button>
          <button class="pro-btn">Withdraw</button>
        </div>
      </div>

      <div class="analysis-block">
        <div class="an-card">
          <div class="an-title">Win Rate</div>
          <div class="an-content-center">
            <div class="donut-chart" id="winRateChart">
              <span class="donut-val" id="winRateVal">0%</span>
            </div>
            <div class="an-text" id="totalTradesVal" style="margin-top: 6px;">0 Trades</div>
          </div>
        </div>
        <div class="an-card clickable" id="netPnlCard">
          <div class="an-title">Net PnL</div>
          <div class="an-content-center">
            <div style="font-size:20px; font-weight:700; font-family:'Roboto Mono';" id="statPnL">0.00</div>
          </div>
          <div style="font-size:10px; color:var(--muted); width:100%; text-align:center;">Tap for details →</div>
        </div>
      </div>

      <div class="ref-card" id="refCard">
        <div class="ref-top">
          <div class="ref-title">Referrals</div>
          <div class="ref-badge" id="refCountBadge">Invited: 0</div>
        </div>
        <div class="ref-row">
          <input class="ref-input" id="refLinkInput" readonly value="Loading...">
          <button class="ref-btn primary" id="btnCopyRefLink">Copy</button>
        </div>
        <div class="ref-help" id="refHelpText">Share the link with friends. When they open the bot using your link, they will be automatically assigned as your referral.</div>
        <div class="ref-list" id="refList">
          <div class="ref-status" id="refStatus">Loading referrals...</div>
        </div>
      </div>

      <div class="rewards-banner" id="btnGoRewards">
        <div class="rb-content">
          <h3>Rewards Center</h3>
          <p>Complete tasks to unlock features</p>
        </div>
        <div class="rb-icon">
          <img src="https://i.postimg.cc/pdkwtBbQ/gift-thunder.png" style="width: 40px; height: auto;">
        </div>
      </div>

      <div>
        <div class="hist-header-row">
          <div class="hist-title">History</div>
          <div class="hist-filters">
            <div class="h-filter active" data-filter="all">All</div>
            <div class="h-filter" data-filter="day">24h</div>
            <div class="h-filter" data-filter="week">7d</div>
          </div>
        </div>
        <div class="history-list" id="historyList">
          <div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history</div>
        </div>
      </div>
    </div>
  </div>

  <div id="view-rewards" class="view-section hidden">
    <div class="rewards-container">
      <div class="rewards-header">
        <div class="rh-title">Achievement Progress</div>
        <div class="rh-sub">Watch ads & earn rewards</div>
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-number" id="totalAdsWatched">0</div>
            <div class="stat-desc">Ads Watched</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalEarnedFromAds">0</div>
            <div class="stat-desc">VP Earned</div>
          </div>
        </div>
      </div>

      <div class="progress-card">
        <div class="prog-info">
          <span id="currentLevelText">Level 1</span>
          <span id="adsProgressText">0 / 10 Ads</span>
        </div>
        <div class="prog-track">
          <div class="prog-fill" id="adsProgressBar" style="width: 0%;"></div>
        </div>
        <div class="milestones">
          <div class="ms-item active" id="ms-start"><div class="ms-dot"></div><span class="ms-val">Start</span></div>
          <div class="ms-item" id="ms-5"><div class="ms-dot"></div><span class="ms-val">5 Ads</span></div>
          <div class="ms-item" id="ms-10"><div class="ms-dot"></div><span class="ms-val">10 Ads</span></div>
        </div>
      </div>

      <div class="task-list">
        <div class="task-item">
          <div class="task-left">
            <h4>Watch Ad</h4>
            <p>Earn +1 VP per view</p>
          </div>
          <div class="task-right">
            <span class="daily-counter" id="dailyAdCounter">0/5 today</span>
            <button class="btn-claim" id="btnWatchAd">WATCH</button>
          </div>
        </div>
      </div>

      <button class="btn-back-float" id="btnBackFromRewards">Back to Profile</button>
    </div>
  </div>

</div>

<!-- PnL Statistics Modal -->
<div class="pnl-modal-overlay" id="pnlModalOverlay">
  <div class="pnl-modal" id="pnlModal">
    <div class="pnl-modal-header">
      <div class="pnl-modal-title">Trading Statistics</div>
      <button class="pnl-modal-close" id="pnlModalClose">×</button>
    </div>
    <div class="pnl-modal-content">
      <div class="stats-metrics-grid">
        <div class="stats-metric-card">
          <div class="stats-metric-label">Avg Risk:Reward</div>
          <div class="stats-metric-value" id="modalAvgRR">--</div>
        </div>
        <div class="stats-metric-card">
          <div class="stats-metric-label">Max Drawdown</div>
          <div class="stats-metric-value negative" id="modalMaxDD">--</div>
        </div>
        <div class="stats-metric-card">
          <div class="stats-metric-label">Profit Factor</div>
          <div class="stats-metric-value" id="modalProfitFactor">--</div>
        </div>
        <div class="stats-metric-card">
          <div class="stats-metric-label">Avg Trade</div>
          <div class="stats-metric-value" id="modalAvgTrade">--</div>
        </div>
      </div>

      <div class="chart-section">
        <div class="chart-section-header">
          <div class="chart-section-title">Equity Curve</div>
          <div class="period-selector" id="equityPeriodSelector">
            <button class="period-btn active" data-period="7d">7D</button>
            <button class="period-btn" data-period="30d">30D</button>
            <button class="period-btn" data-period="90d">90D</button>
            <button class="period-btn" data-period="all">All</button>
          </div>
        </div>
        <div class="equity-chart-container" id="equityChartContainer"></div>
      </div>

      <div class="chart-section">
        <div class="chart-section-title" style="margin-bottom: 12px;">Calendar PnL</div>
        <div class="calendar-pnl-container" id="calendarPnlContainer">
          <div class="calendar-month-nav">
            <button class="calendar-nav-btn" id="calendarPrev">‹</button>
            <span class="calendar-month-label" id="calendarMonthLabel">January 2025</span>
            <button class="calendar-nav-btn" id="calendarNext">›</button>
          </div>
          <div class="calendar-header">
            <span class="calendar-day-label">Mon</span>
            <span class="calendar-day-label">Tue</span>
            <span class="calendar-day-label">Wed</span>
            <span class="calendar-day-label">Thu</span>
            <span class="calendar-day-label">Fri</span>
            <span class="calendar-day-label">Sat</span>
            <span class="calendar-day-label">Sun</span>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
          <div class="calendar-legend">
            <div class="calendar-legend-item"><span class="calendar-legend-dot profit"></span><span>Profit</span></div>
            <div class="calendar-legend-item"><span class="calendar-legend-dot loss"></span><span>Loss</span></div>
            <div class="calendar-legend-item"><span class="calendar-legend-dot no-trade"></span><span>No Trade</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TP/SL Modal -->
<div class="tpsl-modal-overlay" id="tpslModalOverlay">
  <div class="tpsl-modal" id="tpslModal">
    <div class="tpsl-modal-header">
      <div>
        <div class="tpsl-modal-title" id="tpslModalTitle">Set Take Profit</div>
        <div class="tpsl-modal-subtitle" id="tpslModalSubtitle">Configure your exit strategy</div>
      </div>
      <button class="tpsl-modal-close" id="tpslModalClose">×</button>
    </div>
    <div class="tpsl-modal-content">
      <!-- Position Info -->
      <div class="tpsl-position-info">
        <div class="tpsl-position-left">
          <div class="tpsl-position-type long" id="tpslPositionType">LONG</div>
          <div>
            <span class="tpsl-position-pair" id="tpslPositionPair">BTC-USD</span>
            <span class="tpsl-position-leverage" id="tpslPositionLeverage">x10</span>
          </div>
        </div>
        <div class="tpsl-position-right">
          <div class="tpsl-position-entry">Entry Price</div>
          <div class="tpsl-position-entry-val" id="tpslEntryPrice">0.00</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tpsl-tabs">
        <button class="tpsl-tab active" data-tab="full">Position TP/SL</button>
        <button class="tpsl-tab" data-tab="partial">Partial TP/SL</button>
      </div>

      <!-- Full Position Tab -->
      <div class="tpsl-tab-content active" id="tabFull">
        <div class="tpsl-input-group">
          <div class="tpsl-input-label">
            <span>Trigger Price</span>
            <span class="tpsl-input-hint" id="tpslPriceHint">Must be above entry for TP</span>
          </div>
          <div class="tpsl-input-wrapper">
            <input type="number" class="tpsl-input" id="tpslTriggerPrice" placeholder="0.00" step="0.01">
            <span class="tpsl-input-suffix">USD</span>
          </div>
          <div class="tpsl-input-error" id="tpslPriceError">Invalid trigger price</div>
        </div>

        <div class="tpsl-pnl-preview">
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Expected PnL</span>
            <span class="tpsl-pnl-value" id="tpslExpectedPnl">-- VP</span>
          </div>
          <div class="tpsl-pnl-divider"></div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">ROE</span>
            <span class="tpsl-pnl-value" id="tpslExpectedRoe">--%</span>
          </div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Close Size</span>
            <span class="tpsl-pnl-value" id="tpslCloseSize">100%</span>
          </div>
        </div>

        <!-- Existing Orders -->
        <div class="tpsl-existing-orders" id="tpslExistingOrders" style="display: none;">
          <div class="tpsl-existing-title">
            <span>⚠️</span>
            <span>Existing Orders</span>
          </div>
          <div class="tpsl-existing-list" id="tpslExistingList"></div>
        </div>

        <button class="tpsl-submit-btn tp" id="tpslSubmitFull">
          <span>Confirm</span>
        </button>
      </div>

      <!-- Partial Position Tab -->
      <div class="tpsl-tab-content" id="tabPartial">
        <div class="tpsl-input-group">
          <div class="tpsl-input-label">
            <span>Trigger Price</span>
            <span class="tpsl-input-hint" id="tpslPriceHintPartial">Must be above entry for TP</span>
          </div>
          <div class="tpsl-input-wrapper">
            <input type="number" class="tpsl-input" id="tpslTriggerPricePartial" placeholder="0.00" step="0.01">
            <span class="tpsl-input-suffix">USD</span>
          </div>
          <div class="tpsl-input-error" id="tpslPriceErrorPartial">Invalid trigger price</div>
        </div>

        <div class="tpsl-size-section">
          <div class="tpsl-size-header">
            <span class="tpsl-size-label">Close Size</span>
            <span class="tpsl-size-value" id="tpslSizeValue">50%</span>
          </div>
          <div class="tpsl-size-slider-wrap">
            <input type="range" class="tpsl-size-slider" id="tpslSizeSlider" min="10" max="100" step="5" value="50">
          </div>
          <div class="tpsl-size-marks">
            <span class="tpsl-size-mark" data-size="25">25%</span>
            <span class="tpsl-size-mark active" data-size="50">50%</span>
            <span class="tpsl-size-mark" data-size="75">75%</span>
            <span class="tpsl-size-mark" data-size="100">100%</span>
          </div>
          <div class="tpsl-available-info">
            <span>Available to close</span>
            <span id="tpslAvailableSize">100%</span>
          </div>
        </div>

        <div class="tpsl-pnl-preview">
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Expected PnL</span>
            <span class="tpsl-pnl-value" id="tpslExpectedPnlPartial">-- VP</span>
          </div>
          <div class="tpsl-pnl-divider"></div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">ROE</span>
            <span class="tpsl-pnl-value" id="tpslExpectedRoePartial">--%</span>
          </div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Close Amount</span>
            <span class="tpsl-pnl-value" id="tpslCloseSizePartial">-- VP</span>
          </div>
        </div>

        <!-- Existing Orders Partial -->
        <div class="tpsl-existing-orders" id="tpslExistingOrdersPartial" style="display: none;">
          <div class="tpsl-existing-title">
            <span>⚠️</span>
            <span>Existing Orders (<span id="tpslUsedPercent">0</span>% used)</span>
          </div>
          <div class="tpsl-existing-list" id="tpslExistingListPartial"></div>
        </div>

        <button class="tpsl-submit-btn tp" id="tpslSubmitPartial">
          <span>Confirm</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// =====================================================================
// GLOBAL STATE
// =====================================================================
let tgUser = null;
let balance = 10000;
let positions = [];
let tradeHistory = [];
let currentPair = 'BTC-USD';
let currentPrice = 0;
let leverage = 10;
let historyFilter = 'all';

let chart = null;
let candleSeries = null;
let volumeChart = null;
let volumeSeries = null;
let emaSeries = null;
let smaSeries = null;
let vwapSeries = null;

let currentTimeframe = 60;
let candleData = [];
let wsPrice = null;

let activeIndicators = { ema: false, sma: false, vwap: false, volume: false };

let currentDrawingTool = null;
let drawingState = { isDrawing: false, startPoint: null, lines: [], tempLine: null };

let adsWatched = 0;
let dailyAdsToday = 0;
let dailyAdsDate = '';
const DAILY_AD_LIMIT = 5;
let AdController = null;

let balanceHidden = false;
let referrals = [];

let equityChart = null;
let equityLineSeries = null;
let calendarMonth = new Date();

// =====================================================================
// TP/SL MANAGER
// =====================================================================
const TPSLManager = {
  orders: [], // { id, positionId, type: 'tp'|'sl', triggerPrice, closePercent, createdAt }
  
  generateId() {
    return 'tpsl_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  },
  
  getOrdersForPosition(positionId) {
    return this.orders.filter(o => o.positionId === positionId);
  },
  
  getTotalUsedPercent(positionId) {
    const orders = this.getOrdersForPosition(positionId);
    return orders.reduce((sum, o) => sum + o.closePercent, 0);
  },
  
  getAvailablePercent(positionId) {
    return Math.max(0, 100 - this.getTotalUsedPercent(positionId));
  },
  
  createOrder(positionId, type, triggerPrice, closePercent) {
    const position = positions.find(p => p.id === positionId);
    if (!position) return { success: false, error: 'Position not found' };
    
    const available = this.getAvailablePercent(positionId);
    if (closePercent > available) {
      return { success: false, error: `Only ${available}% available` };
    }
    
    // Validate trigger price
    const isLong = position.type === 'long';
    if (type === 'tp') {
      if (isLong && triggerPrice <= position.entry) {
        return { success: false, error: 'TP must be above entry for long' };
      }
      if (!isLong && triggerPrice >= position.entry) {
        return { success: false, error: 'TP must be below entry for short' };
      }
    } else {
      if (isLong && triggerPrice >= position.entry) {
        return { success: false, error: 'SL must be below entry for long' };
      }
      if (!isLong && triggerPrice <= position.entry) {
        return { success: false, error: 'SL must be above entry for short' };
      }
    }
    
    const order = {
      id: this.generateId(),
      positionId,
      type,
      triggerPrice,
      closePercent,
      createdAt: Date.now()
    };
    
    this.orders.push(order);
    this.saveToStorage();
    return { success: true, order };
  },
  
  deleteOrder(orderId) {
    const index = this.orders.findIndex(o => o.id === orderId);
    if (index !== -1) {
      this.orders.splice(index, 1);
      this.saveToStorage();
      return true;
    }
    return false;
  },
  
  deleteOrdersForPosition(positionId) {
    this.orders = this.orders.filter(o => o.positionId !== positionId);
    this.saveToStorage();
  },
  
  checkAndExecute(currentPrice) {
    const toExecute = [];
    
    for (const order of this.orders) {
      const position = positions.find(p => p.id === order.positionId);
      if (!position) continue;
      
      const isLong = position.type === 'long';
      let triggered = false;
      
      if (order.type === 'tp') {
        if (isLong && currentPrice >= order.triggerPrice) triggered = true;
        if (!isLong && currentPrice <= order.triggerPrice) triggered = true;
      } else {
        if (isLong && currentPrice <= order.triggerPrice) triggered = true;
        if (!isLong && currentPrice >= order.triggerPrice) triggered = true;
      }
      
      if (triggered) {
        toExecute.push(order);
      }
    }
    
    for (const order of toExecute) {
      this.executeOrder(order, currentPrice);
    }
  },
  
  executeOrder(order, price) {
    const position = positions.find(p => p.id === order.positionId);
    if (!position) {
      this.deleteOrder(order.id);
      return;
    }
    
    const closeAmount = position.size * (order.closePercent / 100);
    const isLong = position.type === 'long';
    const priceDiff = isLong ? (price - position.entry) : (position.entry - price);
    const pnl = (priceDiff / position.entry) * closeAmount * position.leverage;
    
    balance += closeAmount + pnl;
    
    const historyEntry = {
      pair: position.pair,
      type: position.type,
      entry: position.entry,
      exit: price,
      size: closeAmount,
      leverage: position.leverage,
      pnl: pnl,
      closedAt: Date.now(),
      closeReason: order.type.toUpperCase()
    };
    tradeHistory.unshift(historyEntry);
    
    // Show notification
    const typeLabel = order.type === 'tp' ? 'Take Profit' : 'Stop Loss';
    const pnlSign = pnl >= 0 ? '+' : '';
    showToast(`${typeLabel} triggered! ${pnlSign}${pnl.toFixed(2)} VP`, pnl >= 0 ? 'success' : 'error');
    
    // Update position
    if (order.closePercent >= 100 || position.size - closeAmount < 0.01) {
      // Close entire position
      const idx = positions.findIndex(p => p.id === position.id);
      if (idx !== -1) positions.splice(idx, 1);
      this.deleteOrdersForPosition(position.id);
    } else {
      // Partial close - reduce position size
      position.size -= closeAmount;
      // Recalculate remaining orders percentages
      this.recalculateOrdersAfterPartialClose(position.id, order.closePercent);
      this.deleteOrder(order.id);
    }
    
    updateUI();
    saveData();
  },
  
  recalculateOrdersAfterPartialClose(positionId, closedPercent) {
    // When position is partially closed, remaining orders need adjustment
    const remainingOrders = this.getOrdersForPosition(positionId);
    const scaleFactor = 100 / (100 - closedPercent);
    
    for (const order of remainingOrders) {
      order.closePercent = Math.min(100, order.closePercent * scaleFactor);
    }
    this.saveToStorage();
  },
  
  calculateExpectedPnl(position, triggerPrice, closePercent) {
    const closeAmount = position.size * (closePercent / 100);
    const isLong = position.type === 'long';
    const priceDiff = isLong ? (triggerPrice - position.entry) : (position.entry - triggerPrice);
    const pnl = (priceDiff / position.entry) * closeAmount * position.leverage;
    const roe = (pnl / closeAmount) * 100;
    return { pnl, roe, closeAmount };
  },
  
  saveToStorage() {
    try {
      localStorage.setItem('tpsl_orders', JSON.stringify(this.orders));
    } catch (e) {}
  },
  
  loadFromStorage() {
    try {
      const data = localStorage.getItem('tpsl_orders');
      if (data) {
        this.orders = JSON.parse(data);
        // Clean up orders for non-existent positions
        this.orders = this.orders.filter(o => positions.some(p => p.id === o.positionId));
      }
    } catch (e) {
      this.orders = [];
    }
  }
};

// =====================================================================
// TP/SL MODAL
// =====================================================================
const TPSLModal = {
  overlay: null,
  modal: null,
  currentPositionId: null,
  currentType: null, // 'tp' or 'sl'
  currentTab: 'full',
  
  init() {
    this.overlay = document.getElementById('tpslModalOverlay');
    this.modal = document.getElementById('tpslModal');
    
    // Close handlers
    document.getElementById('tpslModalClose').addEventListener('click', () => this.close());
    this.overlay.addEventListener('click', (e) => {
      if (e.target === this.overlay) this.close();
    });
    
    // Tab switching
    document.querySelectorAll('.tpsl-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        this.switchTab(tabId);
      });
    });
    
    // Price input handlers
    document.getElementById('tpslTriggerPrice').addEventListener('input', () => this.updatePreview('full'));
    document.getElementById('tpslTriggerPricePartial').addEventListener('input', () => this.updatePreview('partial'));
    
    // Size slider
    const sizeSlider = document.getElementById('tpslSizeSlider');
    sizeSlider.addEventListener('input', () => {
      const val = sizeSlider.value;
      document.getElementById('tpslSizeValue').textContent = val + '%';
      this.updateSizeMarks(val);
      this.updateSliderGradient(sizeSlider, val);
      this.updatePreview('partial');
    });
    
    // Size marks
    document.querySelectorAll('.tpsl-size-mark').forEach(mark => {
      mark.addEventListener('click', () => {
        const size = parseInt(mark.dataset.size);
        sizeSlider.value = size;
        document.getElementById('tpslSizeValue').textContent = size + '%';
        this.updateSizeMarks(size);
        this.updateSliderGradient(sizeSlider, size);
        this.updatePreview('partial');
      });
    });
    
    // Submit buttons
    document.getElementById('tpslSubmitFull').addEventListener('click', () => this.submit('full'));
    document.getElementById('tpslSubmitPartial').addEventListener('click', () => this.submit('partial'));
  },
  
  open(positionId, type) {
    const position = positions.find(p => p.id === positionId);
    if (!position) return;
    
    this.currentPositionId = positionId;
    this.currentType = type;
    
    // Update modal title
    const title = type === 'tp' ? 'Set Take Profit' : 'Set Stop Loss';
    document.getElementById('tpslModalTitle').textContent = title;
    document.getElementById('tpslModalSubtitle').textContent = type === 'tp' 
      ? 'Lock in profits at target price' 
      : 'Limit losses at trigger price';
    
    // Update position info
    const typeEl = document.getElementById('tpslPositionType');
    typeEl.textContent = position.type.toUpperCase();
    typeEl.className = 'tpsl-position-type ' + position.type;
    
    document.getElementById('tpslPositionPair').textContent = position.pair;
    document.getElementById('tpslPositionLeverage').textContent = 'x' + position.leverage;
    document.getElementById('tpslEntryPrice').textContent = formatPrice(position.entry, position.pair);
    
    // Update hints
    const isLong = position.type === 'long';
    const tpHint = isLong ? 'Must be above entry for long' : 'Must be below entry for short';
    const slHint = isLong ? 'Must be below entry for long' : 'Must be above entry for short';
    const hint = type === 'tp' ? tpHint : slHint;
    document.getElementById('tpslPriceHint').textContent = hint;
    document.getElementById('tpslPriceHintPartial').textContent = hint;
    
    // Update submit button style
    const btnClass = type === 'tp' ? 'tp' : 'sl';
    document.getElementById('tpslSubmitFull').className = 'tpsl-submit-btn ' + btnClass;
    document.getElementById('tpslSubmitPartial').className = 'tpsl-submit-btn ' + btnClass;
    
    // Reset inputs
    document.getElementById('tpslTriggerPrice').value = '';
    document.getElementById('tpslTriggerPricePartial').value = '';
    document.getElementById('tpslSizeSlider').value = 50;
    document.getElementById('tpslSizeValue').textContent = '50%';
    this.updateSizeMarks(50);
    
    // Update available size
    const available = TPSLManager.getAvailablePercent(positionId);
    document.getElementById('tpslAvailableSize').textContent = available + '%';
    document.getElementById('tpslSizeSlider').max = available;
    if (available < 50) {
      document.getElementById('tpslSizeSlider').value = available;
      document.getElementById('tpslSizeValue').textContent = available + '%';
    }
    
    // Show existing orders
    this.showExistingOrders(positionId);
    
    // Reset preview
    this.resetPreview();
    
    // Switch to full tab
    this.switchTab('full');
    
    // Show modal
    this.overlay.classList.add('active');
  },
  
  close() {
    this.overlay.classList.remove('active');
    this.currentPositionId = null;
    this.currentType = null;
  },
  
  switchTab(tabId) {
    this.currentTab = tabId;
    document.querySelectorAll('.tpsl-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tpsl-tab[data-tab="${tabId}"]`).classList.add('active');
    
    document.querySelectorAll('.tpsl-tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabId === 'full' ? 'tabFull' : 'tabPartial').classList.add('active');
  },
  
  updateSizeMarks(value) {
    document.querySelectorAll('.tpsl-size-mark').forEach(mark => {
      const size = parseInt(mark.dataset.size);
      mark.classList.toggle('active', size === parseInt(value));
    });
  },
  
  updateSliderGradient(slider, value) {
    const pct = ((value - slider.min) / (slider.max - slider.min)) * 100;
    slider.style.background = `linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) ${pct}%, #2A2F36 ${pct}%, #2A2F36 100%)`;
  },
  
  updatePreview(tab) {
    const position = positions.find(p => p.id === this.currentPositionId);
    if (!position) return;
    
    const priceInput = tab === 'full' 
      ? document.getElementById('tpslTriggerPrice')
      : document.getElementById('tpslTriggerPricePartial');
    
    const triggerPrice = parseFloat(priceInput.value);
    
    if (!triggerPrice || isNaN(triggerPrice)) {
      if (tab === 'full') {
        document.getElementById('tpslExpectedPnl').textContent = '-- VP';
        document.getElementById('tpslExpectedPnl').className = 'tpsl-pnl-value';
        document.getElementById('tpslExpectedRoe').textContent = '--%';
        document.getElementById('tpslExpectedRoe').className = 'tpsl-pnl-value';
      } else {
        document.getElementById('tpslExpectedPnlPartial').textContent = '-- VP';
        document.getElementById('tpslExpectedPnlPartial').className = 'tpsl-pnl-value';
        document.getElementById('tpslExpectedRoePartial').textContent = '--%';
        document.getElementById('tpslExpectedRoePartial').className = 'tpsl-pnl-value';
        document.getElementById('tpslCloseSizePartial').textContent = '-- VP';
      }
      return;
    }
    
    const closePercent = tab === 'full' ? 100 : parseInt(document.getElementById('tpslSizeSlider').value);
    const { pnl, roe, closeAmount } = TPSLManager.calculateExpectedPnl(position, triggerPrice, closePercent);
    
    const pnlClass = pnl >= 0 ? 'positive' : 'negative';
    const pnlSign = pnl >= 0 ? '+' : '';
    const roeSign = roe >= 0 ? '+' : '';
    
    if (tab === 'full') {
      document.getElementById('tpslExpectedPnl').textContent = pnlSign + pnl.toFixed(2) + ' VP';
      document.getElementById('tpslExpectedPnl').className = 'tpsl-pnl-value ' + pnlClass;
      document.getElementById('tpslExpectedRoe').textContent = roeSign + roe.toFixed(2) + '%';
      document.getElementById('tpslExpectedRoe').className = 'tpsl-pnl-value ' + pnlClass;
      document.getElementById('tpslCloseSize').textContent = '100%';
    } else {
      document.getElementById('tpslExpectedPnlPartial').textContent = pnlSign + pnl.toFixed(2) + ' VP';
      document.getElementById('tpslExpectedPnlPartial').className = 'tpsl-pnl-value ' + pnlClass;
      document.getElementById('tpslExpectedRoePartial').textContent = roeSign + roe.toFixed(2) + '%';
      document.getElementById('tpslExpectedRoePartial').className = 'tpsl-pnl-value ' + pnlClass;
      document.getElementById('tpslCloseSizePartial').textContent = closeAmount.toFixed(2) + ' VP';
    }
  },
  
  resetPreview() {
    document.getElementById('tpslExpectedPnl').textContent = '-- VP';
    document.getElementById('tpslExpectedPnl').className = 'tpsl-pnl-value';
    document.getElementById('tpslExpectedRoe').textContent = '--%';
    document.getElementById('tpslExpectedRoe').className = 'tpsl-pnl-value';
    document.getElementById('tpslCloseSize').textContent = '100%';
    
    document.getElementById('tpslExpectedPnlPartial').textContent = '-- VP';
    document.getElementById('tpslExpectedPnlPartial').className = 'tpsl-pnl-value';
    document.getElementById('tpslExpectedRoePartial').textContent = '--%';
    document.getElementById('tpslExpectedRoePartial').className = 'tpsl-pnl-value';
    document.getElementById('tpslCloseSizePartial').textContent = '-- VP';
  },
  
  showExistingOrders(positionId) {
    const orders = TPSLManager.getOrdersForPosition(positionId);
    const position = positions.find(p => p.id === positionId);
    
    // Full tab existing orders
    const existingFull = document.getElementById('tpslExistingOrders');
    const listFull = document.getElementById('tpslExistingList');
    
    // Partial tab existing orders
    const existingPartial = document.getElementById('tpslExistingOrdersPartial');
    const listPartial = document.getElementById('tpslExistingListPartial');
    
    if (orders.length === 0) {
      existingFull.style.display = 'none';
      existingPartial.style.display = 'none';
      return;
    }
    
    const usedPercent = TPSLManager.getTotalUsedPercent(positionId);
    document.getElementById('tpslUsedPercent').textContent = usedPercent;
    
    const html = orders.map(o => {
      const { pnl } = TPSLManager.calculateExpectedPnl(position, o.triggerPrice, o.closePercent);
      const pnlClass = pnl >= 0 ? 'tp' : 'sl';
      const pnlSign = pnl >= 0 ? '+' : '';
      return `
        <div class="tpsl-existing-item">
          <span class="tpsl-existing-item-type ${o.type}">${o.type.toUpperCase()}</span>
          <span class="tpsl-existing-item-info">@ ${formatPrice(o.triggerPrice, position.pair)} (${o.closePercent}%) → ${pnlSign}${pnl.toFixed(2)} VP</span>
        </div>
      `;
    }).join('');
    
    listFull.innerHTML = html;
    listPartial.innerHTML = html;
    
    existingFull.style.display = 'block';
    existingPartial.style.display = 'block';
  },
  
  submit(tab) {
    const position = positions.find(p => p.id === this.currentPositionId);
    if (!position) return;
    
    const priceInput = tab === 'full'
      ? document.getElementById('tpslTriggerPrice')
      : document.getElementById('tpslTriggerPricePartial');
    
    const triggerPrice = parseFloat(priceInput.value);
    
    if (!triggerPrice || isNaN(triggerPrice)) {
      priceInput.classList.add('error');
      setTimeout(() => priceInput.classList.remove('error'), 2000);
      return;
    }
    
    const closePercent = tab === 'full' ? 100 : parseInt(document.getElementById('tpslSizeSlider').value);
    
    const result = TPSLManager.createOrder(
      this.currentPositionId,
      this.currentType,
      triggerPrice,
      closePercent
    );
    
    if (result.success) {
      const typeLabel = this.currentType === 'tp' ? 'Take Profit' : 'Stop Loss';
      showToast(`${typeLabel} order created!`, 'success');
      this.close();
      renderPositions();
    } else {
      showToast(result.error, 'error');
      priceInput.classList.add('error');
      const errorEl = tab === 'full' 
        ? document.getElementById('tpslPriceError')
        : document.getElementById('tpslPriceErrorPartial');
      errorEl.textContent = result.error;
      errorEl.classList.add('visible');
      setTimeout(() => {
        priceInput.classList.remove('error');
        errorEl.classList.remove('visible');
      }, 3000);
    }
  }
};

// =====================================================================
// TOAST NOTIFICATION
// =====================================================================
function showToast(message, type = 'info') {
  const existing = document.querySelector('.toast-notification');
  if (existing) existing.remove();
  
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.style.cssText = `
    position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
    padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600;
    z-index: 9999; animation: toastIn 0.3s ease;
    background: ${type === 'success' ? 'var(--accent-green)' : type === 'error' ? 'var(--accent-red)' : 'var(--panel-light)'};
    color: ${type === 'success' ? '#052e1f' : type === 'error' ? '#fff' : 'var(--white)'};
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'toastOut 0.3s ease forwards';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Add toast animations
const toastStyle = document.createElement('style');
toastStyle.textContent = `
  @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
  @keyframes toastOut { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }
`;
document.head.appendChild(toastStyle);

// =====================================================================
// HELPERS
// =====================================================================
function formatPrice(price, pair) {
  if (!price) return '--';
  const decimals = pair === 'ETH-USD' ? 2 : 2;
  return price.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function formatCompactPrice(price) {
  if (price >= 1000) return (price / 1000).toFixed(1) + 'k';
  return price.toFixed(2);
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  return Math.floor(hrs / 24) + 'd ago';
}

// =====================================================================
// DATA PERSISTENCE
// =====================================================================
function saveData() {
  try {
    const data = { balance, positions, tradeHistory, adsWatched, dailyAdsToday, dailyAdsDate, referrals };
    localStorage.setItem('tradeSim_data', JSON.stringify(data));
  } catch (e) {}
}

function loadData() {
  try {
    const raw = localStorage.getItem('tradeSim_data');
    if (raw) {
      const data = JSON.parse(raw);
      balance = data.balance ?? 10000;
      positions = data.positions ?? [];
      tradeHistory = data.tradeHistory ?? [];
      adsWatched = data.adsWatched ?? 0;
      dailyAdsToday = data.dailyAdsToday ?? 0;
      dailyAdsDate = data.dailyAdsDate ?? '';
      referrals = data.referrals ?? [];
      
      // Ensure positions have IDs
      positions.forEach(p => {
        if (!p.id) p.id = 'pos_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      });
    }
  } catch (e) {
    balance = 10000;
    positions = [];
    tradeHistory = [];
  }
  
  // Load TP/SL orders
  TPSLManager.loadFromStorage();
}

// =====================================================================
// UI UPDATE
// =====================================================================
function updateUI() {
  const displayBalance = balanceHidden ? '••••••' : balance.toFixed(2) + ' VP';
  document.getElementById('headerBalance').textContent = displayBalance;
  document.getElementById('profileBalance').textContent = balanceHidden ? '••••••' : balance.toFixed(2);
  document.getElementById('profileBalanceApprox').textContent = balanceHidden ? '≈ $••••' : '≈ $' + (balance * 0.005).toFixed(2);
  
  // Update price display
  if (currentPrice) {
    const priceEl = document.getElementById('priceDisplay');
    priceEl.textContent = formatPrice(currentPrice, currentPair);
  }
  
  renderPositions();
  updateProfileStats();
  saveData();
}

// =====================================================================
// POSITIONS RENDERING WITH TP/SL
// =====================================================================
function renderPositions() {
  const container = document.getElementById('positionsList');
  if (positions.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>';
    return;
  }
  
  container.innerHTML = positions.map(pos => {
    const isLong = pos.type === 'long';
    const priceDiff = isLong ? (currentPrice - pos.entry) : (pos.entry - currentPrice);
    const pnl = (priceDiff / pos.entry) * pos.size * pos.leverage;
    const roe = (pnl / pos.size) * 100;
    const pnlClass = pnl >= 0 ? 'text-green' : 'text-red';
    const pnlSign = pnl >= 0 ? '+' : '';
    
    const liqDistance = isLong 
      ? ((currentPrice - pos.liqPrice) / currentPrice * 100)
      : ((pos.liqPrice - currentPrice) / currentPrice * 100);
    const riskPct = Math.max(0, Math.min(100, 100 - liqDistance * 2));
    const riskColor = riskPct < 30 ? 'var(--accent-green)' : riskPct < 70 ? 'var(--gold)' : 'var(--accent-red)';
    
    // Get TP/SL orders for this position
    const tpslOrders = TPSLManager.getOrdersForPosition(pos.id);
    const tpOrders = tpslOrders.filter(o => o.type === 'tp');
    const slOrders = tpslOrders.filter(o => o.type === 'sl');
    
    // Render TP/SL orders list
    let ordersHtml = '';
    if (tpslOrders.length > 0) {
      ordersHtml = `
        <div class="pos-tpsl-orders">
          <div class="tpsl-orders-title">
            Active Orders
            <span class="tpsl-orders-count">${tpslOrders.length}</span>
          </div>
          <div class="tpsl-orders-list">
            ${tpslOrders.map(order => {
              const { pnl: orderPnl } = TPSLManager.calculateExpectedPnl(pos, order.triggerPrice, order.closePercent);
              const orderPnlClass = orderPnl >= 0 ? 'positive' : 'negative';
              const orderPnlSign = orderPnl >= 0 ? '+' : '';
              return `
                <div class="tpsl-order-item ${order.type}">
                  <div class="tpsl-order-info">
                    <span class="tpsl-order-type ${order.type}">${order.type.toUpperCase()}</span>
                    <div class="tpsl-order-details">
                      <span>@ ${formatPrice(order.triggerPrice, pos.pair)}</span>
                      <span>${order.closePercent}%</span>
                    </div>
                  </div>
                  <div class="tpsl-order-actions">
                    <span class="tpsl-order-pnl ${orderPnlClass}">${orderPnlSign}${orderPnl.toFixed(2)}</span>
                    <button class="btn-delete-tpsl" data-order-id="${order.id}" title="Delete order">×</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    return `
      <div class="pos-item ${pos.type}" data-id="${pos.id}">
        <div class="pos-header">
          <span class="pos-pair">${pos.pair} <span class="pos-type-badge" style="background:${isLong ? 'var(--accent-green-transparent)' : 'var(--accent-red-transparent)'}; color:${isLong ? 'var(--accent-green)' : 'var(--accent-red)'};">${pos.type.toUpperCase()} ${pos.leverage}x</span></span>
          <span class="${pnlClass}" style="font-weight:700; font-family:'Roboto Mono';">${pnlSign}${pnl.toFixed(2)} VP</span>
        </div>
        
        <div class="pos-stats-grid">
          <div class="stat-col">
            <span class="stat-label">Size</span>
            <span class="stat-val">${pos.size.toFixed(2)} VP</span>
          </div>
          <div class="stat-col">
            <span class="stat-label">ROE</span>
            <span class="stat-val ${pnlClass}">${pnlSign}${roe.toFixed(2)}%</span>
          </div>
          <div class="stat-col">
            <span class="stat-label">Liq. Price</span>
            <span class="stat-val text-red">${formatPrice(pos.liqPrice, pos.pair)}</span>
          </div>
        </div>
        
        <div class="risk-wrap">
          <div class="risk-track">
            <div class="risk-fill" style="width: ${riskPct}%; background: ${riskColor};"></div>
          </div>
        </div>
        
        <div class="pos-details">
          <div class="pd-col">
            <span class="pd-label">Entry</span>
            <span class="pd-val">${formatPrice(pos.entry, pos.pair)}</span>
          </div>
          <div class="pd-col">
            <span class="pd-label">Mark</span>
            <span class="pd-val">${formatPrice(currentPrice, pos.pair)}</span>
          </div>
          <div class="pd-col">
            <span class="pd-label">Margin</span>
            <span class="pd-val">${pos.size.toFixed(2)}</span>
          </div>
        </div>
        
        <div class="pos-tpsl-actions">
          <button class="btn-tpsl tp" data-position-id="${pos.id}" data-type="tp">
            <span class="btn-tpsl-icon">🎯</span>
            <span>Set TP${tpOrders.length > 0 ? ` (${tpOrders.length})` : ''}</span>
          </button>
          <button class="btn-tpsl sl" data-position-id="${pos.id}" data-type="sl">
            <span class="btn-tpsl-icon">🛡️</span>
            <span>Set SL${slOrders.length > 0 ? ` (${slOrders.length})` : ''}</span>
          </button>
        </div>
        
        ${ordersHtml}
        
        <button class="close-btn" data-id="${pos.id}">Close Position</button>
      </div>
    `;
  }).join('');
  
  // Add event listeners for TP/SL buttons
  container.querySelectorAll('.btn-tpsl').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const posId = btn.dataset.positionId;
      const type = btn.dataset.type;
      TPSLModal.open(posId, type);
    });
  });
  
  // Add event listeners for delete TP/SL order buttons
  container.querySelectorAll('.btn-delete-tpsl').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const orderId = btn.dataset.orderId;
      if (confirm('Delete this order?')) {
        TPSLManager.deleteOrder(orderId);
        renderPositions();
        showToast('Order deleted', 'info');
      }
    });
  });
  
  // Add event listeners for close position buttons
  container.querySelectorAll('.close-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      closePosition(btn.dataset.id);
    });
  });
}

function closePosition(posId) {
  const idx = positions.findIndex(p => p.id === posId);
  if (idx === -1) return;
  
  const pos = positions[idx];
  const isLong = pos.type === 'long';
  const priceDiff = isLong ? (currentPrice - pos.entry) : (pos.entry - currentPrice);
  const pnl = (priceDiff / pos.entry) * pos.size * pos.leverage;
  
  balance += pos.size + pnl;
  
  tradeHistory.unshift({
    pair: pos.pair,
    type: pos.type,
    entry: pos.entry,
    exit: currentPrice,
    size: pos.size,
    leverage: pos.leverage,
    pnl: pnl,
    closedAt: Date.now(),
    closeReason: 'MANUAL'
  });
  
  // Delete associated TP/SL orders
  TPSLManager.deleteOrdersForPosition(pos.id);
  
  positions.splice(idx, 1);
  updateUI();
  
  showToast(`Position closed: ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP`, pnl >= 0 ? 'success' : 'error');
}

// =====================================================================
// PROFILE STATS
// =====================================================================
function updateProfileStats() {
  const total = tradeHistory.length;
  const wins = tradeHistory.filter(t => t.pnl > 0).length;
  const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
  
  document.getElementById('winRateVal').textContent = winRate + '%';
  document.getElementById('totalTradesVal').textContent = total + ' Trades';
  
  const chartEl = document.getElementById('winRateChart');
  chartEl.style.background = `conic-gradient(var(--accent-green) 0% ${winRate}%, var(--panel-light) ${winRate}% 100%)`;
  
  const totalPnl = tradeHistory.reduce((sum, t) => sum + t.pnl, 0);
  const pnlEl = document.getElementById('statPnL');
  pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + totalPnl.toFixed(2);
  pnlEl.className = totalPnl >= 0 ? 'text-green' : 'text-red';
  
  const pnlPill = document.getElementById('profilePnlPill');
  const pnlPct = balance > 0 ? ((totalPnl / (balance - totalPnl)) * 100) : 0;
  pnlPill.textContent = (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%';
  pnlPill.className = 'asset-pnl ' + (pnlPct >= 0 ? 'text-green' : 'text-red');
  
  renderHistory();
}

function renderHistory() {
  const container = document.getElementById('historyList');
  let filtered = [...tradeHistory];
  
  const now = Date.now();
  if (historyFilter === 'day') {
    filtered = filtered.filter(t => now - t.closedAt < 86400000);
  } else if (historyFilter === 'week') {
    filtered = filtered.filter(t => now - t.closedAt < 604800000);
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history</div>';
    return;
  }
  
  container.innerHTML = filtered.slice(0, 50).map(t => {
    const pnlClass = t.pnl >= 0 ? 'text-green' : 'text-red';
    const closeReason = t.closeReason ? ` (${t.closeReason})` : '';
    return `
      <div class="history-card">
        <div class="hc-header">
          <span class="hc-pair">${t.pair}</span>
          <span class="hc-type ${t.type}">${t.type.toUpperCase()} ${t.leverage}x</span>
        </div>
        <div class="hc-row"><span>Entry</span><span class="hc-val">${formatPrice(t.entry, t.pair)}</span></div>
        <div class="hc-row"><span>Exit${closeReason}</span><span class="hc-val">${formatPrice(t.exit, t.pair)}</span></div>
        <div class="hc-row"><span>Size</span><span class="hc-val">${t.size.toFixed(2)} VP</span></div>
        <div class="hc-row"><span>PnL</span><span class="hc-pnl ${pnlClass}">${t.pnl >= 0 ? '+' : ''}${t.pnl.toFixed(2)} VP</span></div>
        <div class="hc-row"><span>Closed</span><span style="color:var(--muted); font-size:11px;">${timeAgo(t.closedAt)}</span></div>
      </div>
    `;
  }).join('');
}

// =====================================================================
// TRADING
// =====================================================================
function openPosition(type) {
  const sizeInput = document.getElementById('sizeInput');
  const size = parseFloat(sizeInput.value) || 0;
  
  if (size < 10) {
    showToast('Minimum margin is 10 VP', 'error');
    return;
  }
  if (size > balance) {
    showToast('Insufficient balance', 'error');
    return;
  }
  
  const liqPct = 1 / leverage;
  const liqPrice = type === 'long' 
    ? currentPrice * (1 - liqPct + 0.005)
    : currentPrice * (1 + liqPct - 0.005);
  
  const pos = {
    id: 'pos_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    pair: currentPair,
    type,
    entry: currentPrice,
    size,
    leverage,
    liqPrice,
    openedAt: Date.now()
  };
  
  balance -= size;
  positions.push(pos);
  updateUI();
  
  showToast(`${type.toUpperCase()} position opened!`, 'success');
}

// =====================================================================
// CHART
// =====================================================================
async function initChart() {
  const container = document.getElementById('chart');
  container.innerHTML = '';
  
  chart = LightweightCharts.createChart(container, {
    layout: { background: { color: 'transparent' }, textColor: '#848E9C' },
    grid: { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal, vertLine: { color: 'rgba(255,255,255,0.3)', width: 1, style: 2 }, horzLine: { color: 'rgba(255,255,255,0.3)', width: 1, style: 2 } },
    rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)', scaleMargins: { top: 0.1, bottom: 0.1 } },
    timeScale: { borderColor: 'rgba(255,255,255,0.1)', timeVisible: true, secondsVisible: false },
    handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false },
    handleScale: { axisPressedMouseMove: true, mouseWheel: true, pinch: true }
  });
  
  candleSeries = chart.addCandlestickSeries({
    upColor: '#0ECB81', downColor: '#F6465D',
    borderUpColor: '#0ECB81', borderDownColor: '#F6465D',
    wickUpColor: '#0ECB81', wickDownColor: '#F6465D'
  });
  
  chart.subscribeCrosshairMove(param => {
    const tooltip = document.getElementById('ohlcTooltip');
    if (!param || !param.time || !param.seriesData || !param.seriesData.get(candleSeries)) {
      tooltip.classList.remove('visible');
      return;
    }
    const data = param.seriesData.get(candleSeries);
    if (data) {
      const changeClass = data.close >= data.open ? 'up' : 'down';
      document.getElementById('ohlcOpen').textContent = formatPrice(data.open, currentPair);
      document.getElementById('ohlcHigh').textContent = formatPrice(data.high, currentPair);
      document.getElementById('ohlcHigh').className = 'ohlc-value up';
      document.getElementById('ohlcLow').textContent = formatPrice(data.low, currentPair);
      document.getElementById('ohlcLow').className = 'ohlc-value down';
      document.getElementById('ohlcClose').textContent = formatPrice(data.close, currentPair);
      document.getElementById('ohlcClose').className = 'ohlc-value ' + changeClass;
      tooltip.classList.add('visible');
    }
  });
  
  await loadCandleData();
  
  new ResizeObserver(() => chart && chart.applyOptions({ width: container.clientWidth, height: container.clientHeight })).observe(container);
}

async function loadCandleData() {
  showChartLoading(true);
  try {
    const symbol = currentPair === 'BTC-USD' ? 'BTCUSDT' : 'ETHUSDT';
    const interval = getInterval(currentTimeframe);
    const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=300`);
    const data = await res.json();
    
    candleData = data.map(d => ({
      time: Math.floor(d[0] / 1000),
      open: parseFloat(d[1]),
      high: parseFloat(d[2]),
      low: parseFloat(d[3]),
      close: parseFloat(d[4]),
      volume: parseFloat(d[5])
    }));
    
    candleSeries.setData(candleData);
    
    if (candleData.length > 0) {
      currentPrice = candleData[candleData.length - 1].close;
      updateUI();
    }
    
    updateIndicators();
    updateVolumeChart();
    
  } catch (e) {
    console.error('Failed to load candle data:', e);
  }
  showChartLoading(false);
}

function getInterval(tf) {
  const map = { 60: '1m', 300: '5m', 900: '15m', 3600: '1h', 21600: '6h', 86400: '1d' };
  return map[tf] || '1m';
}

function showChartLoading(show) {
  const overlay = document.getElementById('chartLoadingOverlay');
  if (show) overlay.classList.add('active');
  else overlay.classList.remove('active');
}

// =====================================================================
// VOLUME CHART
// =====================================================================
function initVolumeChart() {
  const container = document.getElementById('volumeChart');
  container.innerHTML = '';
  
  volumeChart = LightweightCharts.createChart(container, {
    layout: { background: { color: 'transparent' }, textColor: '#848E9C' },
    grid: { vertLines: { visible: false }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
    rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)', scaleMargins: { top: 0.1, bottom: 0 } },
    timeScale: { visible: false },
    handleScroll: false,
    handleScale: false
  });
  
  volumeSeries = volumeChart.addHistogramSeries({
    priceFormat: { type: 'volume' },
    priceScaleId: 'right'
  });
  
  if (chart) {
    chart.timeScale().subscribeVisibleLogicalRangeChange(range => {
      if (range && volumeChart) volumeChart.timeScale().setVisibleLogicalRange(range);
    });
  }
  
  new ResizeObserver(() => volumeChart && volumeChart.applyOptions({ width: container.clientWidth, height: container.clientHeight })).observe(container);
}

function updateVolumeChart() {
  if (!volumeSeries || !candleData.length) return;
  
  const volData = candleData.map(d => ({
    time: d.time,
    value: d.volume,
    color: d.close >= d.open ? 'rgba(14, 203, 129, 0.5)' : 'rgba(246, 70, 93, 0.5)'
  }));
  
  volumeSeries.setData(volData);
}

// =====================================================================
// INDICATORS
// =====================================================================
function updateIndicators() {
  // EMA
  if (activeIndicators.ema) {
    if (!emaSeries) {
      emaSeries = chart.addLineSeries({ color: '#1E90FF', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
    }
    const emaData = calculateEMA(candleData, 20);
    emaSeries.setData(emaData);
  } else if (emaSeries) {
    chart.removeSeries(emaSeries);
    emaSeries = null;
  }
  
  // SMA
  if (activeIndicators.sma) {
    if (!smaSeries) {
      smaSeries = chart.addLineSeries({ color: '#A855F7', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
    }
    const smaData = calculateSMA(candleData, 50);
    smaSeries.setData(smaData);
  } else if (smaSeries) {
    chart.removeSeries(smaSeries);
    smaSeries = null;
  }
  
  // VWAP
  if (activeIndicators.vwap) {
    if (!vwapSeries) {
      vwapSeries = chart.addLineSeries({ color: '#F7931A', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
    }
    const vwapData = calculateVWAP(candleData);
    vwapSeries.setData(vwapData);
  } else if (vwapSeries) {
    chart.removeSeries(vwapSeries);
    vwapSeries = null;
  }
  
  // Volume
  if (activeIndicators.volume) {
    document.getElementById('volumeContainer').classList.add('visible');
    document.getElementById('chartCard').classList.add('has-volume');
    if (!volumeChart) initVolumeChart();
    updateVolumeChart();
  } else {
    document.getElementById('volumeContainer').classList.remove('visible');
    document.getElementById('chartCard').classList.remove('has-volume');
  }
}

function calculateEMA(data, period) {
  const result = [];
  const k = 2 / (period + 1);
  let ema = null;
  
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) continue;
    if (ema === null) {
      let sum = 0;
      for (let j = i - period + 1; j <= i; j++) sum += data[j].close;
      ema = sum / period;
    } else {
      ema = data[i].close * k + ema * (1 - k);
    }
    result.push({ time: data[i].time, value: ema });
  }
  return result;
}

function calculateSMA(data, period) {
  const result = [];
  for (let i = period - 1; i < data.length; i++) {
    let sum = 0;
    for (let j = i - period + 1; j <= i; j++) sum += data[j].close;
    result.push({ time: data[i].time, value: sum / period });
  }
  return result;
}

function calculateVWAP(data) {
  const result = [];
  let cumVol = 0;
  let cumTP = 0;
  
  for (const d of data) {
    const tp = (d.high + d.low + d.close) / 3;
    cumVol += d.volume;
    cumTP += tp * d.volume;
    if (cumVol > 0) result.push({ time: d.time, value: cumTP / cumVol });
  }
  return result;
}

// =====================================================================
// WEBSOCKET
// =====================================================================
function initWebSocket() {
  if (wsPrice) wsPrice.close();
  
  const symbol = currentPair === 'BTC-USD' ? 'btcusdt' : 'ethusdt';
  wsPrice = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@trade`);
  
  wsPrice.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const newPrice = parseFloat(data.p);
    
    if (newPrice !== currentPrice) {
      const priceEl = document.getElementById('priceDisplay');
      priceEl.classList.remove('text-green', 'text-red');
      priceEl.classList.add(newPrice > currentPrice ? 'text-green' : 'text-red');
      
      currentPrice = newPrice;
      priceEl.textContent = formatPrice(currentPrice, currentPair);
      
      // Check TP/SL orders
      TPSLManager.checkAndExecute(currentPrice);
      
      // Update positions PnL
      if (positions.length > 0) renderPositions();
      
      // Update last candle
      if (candleData.length > 0) {
        const lastCandle = candleData[candleData.length - 1];
        lastCandle.close = currentPrice;
        lastCandle.high = Math.max(lastCandle.high, currentPrice);
        lastCandle.low = Math.min(lastCandle.low, currentPrice);
        candleSeries.update(lastCandle);
      }
    }
  };
  
  wsPrice.onerror = () => setTimeout(initWebSocket, 5000);
  wsPrice.onclose = () => setTimeout(initWebSocket, 5000);
}

// =====================================================================
// ORDER BOOK & TRADES
// =====================================================================
async function loadOrderBook() {
  try {
    const symbol = currentPair === 'BTC-USD' ? 'BTCUSDT' : 'ETHUSDT';
    const res = await fetch(`https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=10`);
    const data = await res.json();
    
    const container = document.getElementById('orderBook');
    const maxQty = Math.max(
      ...data.bids.map(b => parseFloat(b[1])),
      ...data.asks.map(a => parseFloat(a[1]))
    );
    
    let html = '';
    
    // Asks (sells) - reversed
    data.asks.slice(0, 5).reverse().forEach(([price, qty]) => {
      const pct = (parseFloat(qty) / maxQty) * 100;
      html += `<div class="ob-row"><div class="ob-bg bg-red" style="width:${pct}%"></div><span class="text-red">${formatPrice(parseFloat(price), currentPair)}</span><span>${parseFloat(qty).toFixed(4)}</span></div>`;
    });
    
    // Bids (buys)
    data.bids.slice(0, 5).forEach(([price, qty]) => {
      const pct = (parseFloat(qty) / maxQty) * 100;
      html += `<div class="ob-row"><div class="ob-bg bg-green" style="width:${pct}%"></div><span class="text-green">${formatPrice(parseFloat(price), currentPair)}</span><span>${parseFloat(qty).toFixed(4)}</span></div>`;
    });
    
    container.innerHTML = html;
    document.getElementById('bookPairLabel').textContent = currentPair;
    document.getElementById('bookUpdated').textContent = new Date().toLocaleTimeString();
    
  } catch (e) {}
}

async function loadRecentTrades() {
  try {
    const symbol = currentPair === 'BTC-USD' ? 'BTCUSDT' : 'ETHUSDT';
    const res = await fetch(`https://api.binance.com/api/v3/trades?symbol=${symbol}&limit=10`);
    const data = await res.json();
    
    const container = document.getElementById('tradeHistory');
    container.innerHTML = data.reverse().map(t => {
      const isBuy = t.isBuyerMaker === false;
      const time = new Date(t.time).toLocaleTimeString();
      return `<div class="ob-row"><span class="${isBuy ? 'text-green' : 'text-red'}">${formatPrice(parseFloat(t.price), currentPair)}</span><span class="trade-time">${time}</span></div>`;
    }).join('');
    
  } catch (e) {}
}

// =====================================================================
// DRAWING TOOLS
// =====================================================================
function initDrawingTools() {
  const toggle = document.getElementById('drawingToolsToggle');
  const menu = document.getElementById('drawingToolsMenu');
  
  toggle.addEventListener('click', () => menu.classList.toggle('open'));
  
  document.querySelectorAll('.drawing-tool-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tool = btn.dataset.tool;
      
      if (tool === 'clear') {
        clearAllDrawings();
        return;
      }
      
      if (tool === 'cursor') {
        currentDrawingTool = null;
        document.querySelectorAll('.drawing-tool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        return;
      }
      
      currentDrawingTool = tool;
      document.querySelectorAll('.drawing-tool-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
}

function clearAllDrawings() {
  drawingState.lines.forEach(line => {
    if (line.series) chart.removeSeries(line.series);
  });
  drawingState.lines = [];
  showToast('Drawings cleared', 'info');
}

// =====================================================================
// NAVIGATION
// =====================================================================
function showView(viewId) {
  document.querySelectorAll('.view-section').forEach(v => {
    v.classList.remove('active');
    v.classList.add('hidden');
  });
  document.getElementById(viewId).classList.remove('hidden');
  document.getElementById(viewId).classList.add('active');
}

// =====================================================================
// REWARDS / ADS
// =====================================================================
function initAdsGram() {
  try {
    AdController = window.Adsgram.init({ blockId: "int-9418" });
  } catch (e) {
    console.log('AdsGram not available');
  }
}

function checkDailyReset() {
  const today = new Date().toDateString();
  if (dailyAdsDate !== today) {
    dailyAdsDate = today;
    dailyAdsToday = 0;
    saveData();
  }
}

function updateRewardsUI() {
  checkDailyReset();
  
  document.getElementById('totalAdsWatched').textContent = adsWatched;
  document.getElementById('totalEarnedFromAds').textContent = adsWatched;
  document.getElementById('dailyAdCounter').textContent = `${dailyAdsToday}/${DAILY_AD_LIMIT} today`;
  
  if (dailyAdsToday >= DAILY_AD_LIMIT) {
    document.getElementById('dailyAdCounter').classList.add('limit-reached');
    document.getElementById('btnWatchAd').disabled = true;
    document.getElementById('btnWatchAd').textContent = 'LIMIT';
  } else {
    document.getElementById('dailyAdCounter').classList.remove('limit-reached');
    document.getElementById('btnWatchAd').disabled = false;
    document.getElementById('btnWatchAd').textContent = 'WATCH';
  }
  
  // Progress
  const level = Math.floor(adsWatched / 10) + 1;
  const progress = (adsWatched % 10) * 10;
  document.getElementById('currentLevelText').textContent = 'Level ' + level;
  document.getElementById('adsProgressText').textContent = `${adsWatched % 10} / 10 Ads`;
  document.getElementById('adsProgressBar').style.width = progress + '%';
  
  // Milestones
  document.getElementById('ms-5').classList.toggle('active', adsWatched >= 5);
  document.getElementById('ms-10').classList.toggle('active', adsWatched >= 10);
}

async function watchAd() {
  if (dailyAdsToday >= DAILY_AD_LIMIT) {
    showToast('Daily limit reached', 'error');
    return;
  }
  
  const btn = document.getElementById('btnWatchAd');
  btn.classList.add('loading');
  btn.textContent = '...';
  
  try {
    if (AdController) {
      await AdController.show();
    } else {
      await new Promise(r => setTimeout(r, 1000));
    }
    
    balance += 1;
    adsWatched++;
    dailyAdsToday++;
    
    saveData();
    updateUI();
    updateRewardsUI();
    
    showToast('+1 VP earned!', 'success');
    
  } catch (e) {
    showToast('Ad not available', 'error');
  }
  
  btn.classList.remove('loading');
  updateRewardsUI();
}

// =====================================================================
// REFERRALS
// =====================================================================
function initReferrals() {
  if (!tgUser) return;
  
  const refLink = `https://t.me/YourBotName?start=ref_${tgUser.id}`;
  document.getElementById('refLinkInput').value = refLink;
  
  document.getElementById('btnCopyRefLink').addEventListener('click', () => {
    navigator.clipboard.writeText(refLink).then(() => {
      showToast('Link copied!', 'success');
    });
  });
  
  renderReferrals();
}

function renderReferrals() {
  const container = document.getElementById('refList');
  document.getElementById('refCountBadge').textContent = 'Invited: ' + referrals.length;
  
  if (referrals.length === 0) {
    container.innerHTML = '<div class="ref-status">No referrals yet</div>';
    return;
  }
  
  container.innerHTML = referrals.map(r => `
    <div class="ref-item">
      <div class="ref-item-left">
        <div class="ref-avatar"><img src="${r.photo || ''}" onerror="this.style.display='none'"></div>
        <span class="ref-name">${r.name || 'User'}</span>
      </div>
      <span class="ref-date">${new Date(r.joinedAt).toLocaleDateString()}</span>
    </div>
  `).join('');
}

// =====================================================================
// PNL MODAL
// =====================================================================
function initPnLModal() {
  const overlay = document.getElementById('pnlModalOverlay');
  const closeBtn = document.getElementById('pnlModalClose');
  const card = document.getElementById('netPnlCard');
  
  card.addEventListener('click', () => {
    overlay.classList.add('active');
    updatePnLModalStats();
    renderEquityChart();
    renderCalendar();
  });
  
  closeBtn.addEventListener('click', () => overlay.classList.remove('active'));
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('active');
  });
  
  // Period selector
  document.querySelectorAll('#equityPeriodSelector .period-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#equityPeriodSelector .period-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderEquityChart(btn.dataset.period);
    });
  });
  
  // Calendar navigation
  document.getElementById('calendarPrev').addEventListener('click', () => {
    calendarMonth.setMonth(calendarMonth.getMonth() - 1);
    renderCalendar();
  });
  document.getElementById('calendarNext').addEventListener('click', () => {
    calendarMonth.setMonth(calendarMonth.getMonth() + 1);
    renderCalendar();
  });
}

function updatePnLModalStats() {
  const wins = tradeHistory.filter(t => t.pnl > 0);
  const losses = tradeHistory.filter(t => t.pnl < 0);
  
  const totalWin = wins.reduce((s, t) => s + t.pnl, 0);
  const totalLoss = Math.abs(losses.reduce((s, t) => s + t.pnl, 0));
  
  const avgWin = wins.length > 0 ? totalWin / wins.length : 0;
  const avgLoss = losses.length > 0 ? totalLoss / losses.length : 1;
  const rr = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : '--';
  
  document.getElementById('modalAvgRR').textContent = rr + ':1';
  
  // Max drawdown (simplified)
  let maxDD = 0;
  let peak = balance;
  let running = balance;
  for (const t of [...tradeHistory].reverse()) {
    running -= t.pnl;
    if (running > peak) peak = running;
    const dd = (peak - running) / peak * 100;
    if (dd > maxDD) maxDD = dd;
  }
  document.getElementById('modalMaxDD').textContent = '-' + maxDD.toFixed(2) + '%';
  
  // Profit factor
  const pf = totalLoss > 0 ? (totalWin / totalLoss).toFixed(2) : '--';
  document.getElementById('modalProfitFactor').textContent = pf;
  
  // Avg trade
  const avgTrade = tradeHistory.length > 0 
    ? (tradeHistory.reduce((s, t) => s + t.pnl, 0) / tradeHistory.length).toFixed(2)
    : '--';
  document.getElementById('modalAvgTrade').textContent = avgTrade + ' VP';
}

function renderEquityChart(period = '7d') {
  const container = document.getElementById('equityChartContainer');
  container.innerHTML = '';
  
  if (tradeHistory.length === 0) {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:12px;">No data</div>';
    return;
  }
  
  equityChart = LightweightCharts.createChart(container, {
    layout: { background: { color: 'transparent' }, textColor: '#848E9C' },
    grid: { vertLines: { visible: false }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
    rightPriceScale: { borderColor: 'transparent' },
    timeScale: { borderColor: 'transparent', timeVisible: true },
    handleScroll: false,
    handleScale: false
  });
  
  equityLineSeries = equityChart.addAreaSeries({
    lineColor: '#0ECB81',
    topColor: 'rgba(14, 203, 129, 0.3)',
    bottomColor: 'rgba(14, 203, 129, 0)',
    lineWidth: 2
  });
  
  // Build equity curve
  const now = Date.now();
  const periods = { '7d': 7, '30d': 30, '90d': 90, 'all': 9999 };
  const days = periods[period] || 7;
  
  let filtered = tradeHistory.filter(t => (now - t.closedAt) < days * 86400000);
  if (filtered.length === 0) filtered = tradeHistory.slice(0, 20);
  
  let equity = balance;
  const data = [];
  for (const t of [...filtered].reverse()) {
    equity -= t.pnl;
    data.push({ time: Math.floor(t.closedAt / 1000), value: equity });
    equity += t.pnl;
  }
  data.push({ time: Math.floor(now / 1000), value: balance });
  
  equityLineSeries.setData(data.sort((a, b) => a.time - b.time));
  equityChart.timeScale().fitContent();
}

function renderCalendar() {
  const grid = document.getElementById('calendarGrid');
  const label = document.getElementById('calendarMonthLabel');
  
  const year = calendarMonth.getFullYear();
  const month = calendarMonth.getMonth();
  
  label.textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const startOffset = firstDay === 0 ? 6 : firstDay - 1;
  
  // Group trades by day
  const dailyPnl = {};
  tradeHistory.forEach(t => {
    const d = new Date(t.closedAt);
    if (d.getMonth() === month && d.getFullYear() === year) {
      const day = d.getDate();
      dailyPnl[day] = (dailyPnl[day] || 0) + t.pnl;
    }
  });
  
  const today = new Date();
  const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
  
  let html = '';
  
  // Empty cells for offset
  for (let i = 0; i < startOffset; i++) {
    html += '<div class="calendar-cell empty"></div>';
  }
  
  // Days
  for (let day = 1; day <= daysInMonth; day++) {
    const pnl = dailyPnl[day];
    let cls = 'calendar-cell';
    let content = day;
    
    if (pnl !== undefined) {
      cls += pnl >= 0 ? ' profit' : ' loss';
      if (Math.abs(pnl) > 50) cls += ' high';
    }
    
    if (isCurrentMonth && day === today.getDate()) cls += ' today';
    
    html += `<div class="${cls}" title="${pnl !== undefined ? (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' VP' : 'No trades'}">${content}</div>`;
  }
  
  grid.innerHTML = html;
}

// =====================================================================
// EVENT LISTENERS
// =====================================================================
function initEventListeners() {
  // Pair dropdown
  const dropdown = document.getElementById('pairDropdown');
  document.getElementById('pairTrigger').addEventListener('click', () => dropdown.classList.toggle('open'));
  document.querySelectorAll('.pair-item').forEach(item => {
    item.addEventListener('click', () => {
      const pair = item.dataset.pair;
      if (pair !== currentPair) {
        currentPair = pair;
        document.getElementById('triggerText').textContent = pair.replace('-', '/');
        document.querySelectorAll('.pair-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        dropdown.classList.remove('open');
        loadCandleData();
        initWebSocket();
        loadOrderBook();
        loadRecentTrades();
      }
    });
  });
  
  // Close dropdown on outside click
  document.addEventListener('click', (e) => {
    if (!dropdown.contains(e.target)) dropdown.classList.remove('open');
  });
  
  // Timeframe selector
  document.querySelectorAll('.tf-opt').forEach(opt => {
    opt.addEventListener('click', () => {
      document.querySelectorAll('.tf-opt').forEach(o => o.classList.remove('active'));
      opt.classList.add('active');
      currentTimeframe = parseInt(opt.dataset.tf);
      loadCandleData();
    });
  });
  
  // Leverage slider
  const leverageSlider = document.getElementById('leverageSlider');
  leverageSlider.addEventListener('input', () => {
    leverage = parseInt(leverageSlider.value);
    document.getElementById('leverageValText').textContent = leverage + 'x';
    updateSliderGradient(leverageSlider);
    updateLeverageChips();
  });
  
  // Leverage chips
  document.querySelectorAll('#leverageChips .chip').forEach(chip => {
    chip.addEventListener('click', () => {
      leverage = parseInt(chip.dataset.v);
      leverageSlider.value = leverage;
      document.getElementById('leverageValText').textContent = leverage + 'x';
      updateSliderGradient(leverageSlider);
      updateLeverageChips();
    });
  });
  
  // Margin slider
  const marginSlider = document.getElementById('marginSlider');
  marginSlider.addEventListener('input', () => {
    const pct = parseInt(marginSlider.value);
    const size = (balance * pct / 100).toFixed(0);
    document.getElementById('sizeInput').value = size;
    document.getElementById('marginPercentText').textContent = pct + '%';
    updateSliderGradient(marginSlider);
    updateMarginMarks(pct);
  });
  
  // Margin marks
  document.querySelectorAll('.margin-mark').forEach(mark => {
    mark.addEventListener('click', () => {
      const pct = parseInt(mark.dataset.pct);
      marginSlider.value = pct;
      const size = (balance * pct / 100).toFixed(0);
      document.getElementById('sizeInput').value = size;
      document.getElementById('marginPercentText').textContent = pct + '%';
      updateSliderGradient(marginSlider);
      updateMarginMarks(pct);
    });
  });
  
  // Size input
  document.getElementById('sizeInput').addEventListener('input', () => {
    const size = parseFloat(document.getElementById('sizeInput').value) || 0;
    const pct = balance > 0 ? Math.min(100, Math.round((size / balance) * 100)) : 0;
    marginSlider.value = pct;
    document.getElementById('marginPercentText').textContent = pct + '%';
    updateSliderGradient(marginSlider);
    updateMarginMarks(pct);
  });
  
  // Trade buttons
  document.getElementById('openLong').addEventListener('click', () => openPosition('long'));
  document.getElementById('openShort').addEventListener('click', () => openPosition('short'));
  
  // Indicators
  document.querySelectorAll('.indicator-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const ind = chip.dataset.indicator;
      activeIndicators[ind] = !activeIndicators[ind];
      chip.classList.toggle('active', activeIndicators[ind]);
      updateIndicators();
    });
  });
  
  // Navigation
  document.getElementById('btnProfile').addEventListener('click', () => showView('view-profile'));
  document.getElementById('btnCloseProfile').addEventListener('click', () => showView('view-trade'));
  document.getElementById('btnGoRewards').addEventListener('click', () => {
    showView('view-rewards');
    updateRewardsUI();
  });
  document.getElementById('btnBackFromRewards').addEventListener('click', () => showView('view-profile'));
  
  // History filters
  document.querySelectorAll('.h-filter').forEach(f => {
    f.addEventListener('click', () => {
      document.querySelectorAll('.h-filter').forEach(x => x.classList.remove('active'));
      f.classList.add('active');
      historyFilter = f.dataset.filter;
      renderHistory();
    });
  });
  
  // Balance toggle
  document.getElementById('btnToggleBalance').addEventListener('click', () => {
    balanceHidden = !balanceHidden;
    const icon = balanceHidden 
      ? 'https://img.icons8.com/ios-glyphs/60/ffffff/invisible.png'
      : 'https://img.icons8.com/ios-glyphs/60/ffffff/visible.png';
    document.getElementById('btnToggleBalance').src = icon;
    updateUI();
  });
  
  // Watch ad
  document.getElementById('btnWatchAd').addEventListener('click', watchAd);
}

function updateSliderGradient(slider) {
  const pct = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
  slider.style.background = `linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) ${pct}%, #2A2F36 ${pct}%, #2A2F36 100%)`;
}

function updateLeverageChips() {
  document.querySelectorAll('#leverageChips .chip').forEach(chip => {
    chip.classList.toggle('active', parseInt(chip.dataset.v) === leverage);
  });
}

function updateMarginMarks(pct) {
  document.querySelectorAll('.margin-mark').forEach(mark => {
    mark.classList.toggle('active', parseInt(mark.dataset.pct) === pct);
  });
}

// =====================================================================
// INITIALIZATION
// =====================================================================
async function init() {
  const loaderBar = document.getElementById('loaderBar');
  const loaderText = document.getElementById('loaderText');
  
  loaderBar.style.width = '10%';
  loaderText.textContent = 'LOADING DATA';
  
  // Telegram WebApp
  if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
    tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
    
    if (tgUser) {
      document.getElementById('profileName').textContent = tgUser.first_name || 'Trader';
      document.getElementById('profileId').textContent = 'ID: ' + tgUser.id;
      
      if (tgUser.photo_url) {
        document.getElementById('avatarImg').src = tgUser.photo_url;
        document.getElementById('avatarImg').style.display = 'block';
        document.getElementById('profileAvatarBig').src = tgUser.photo_url;
      }
    }
  }
  
  loaderBar.style.width = '30%';
  loaderText.textContent = 'LOADING SAVED DATA';
  loadData();
  
  loaderBar.style.width = '50%';
  loaderText.textContent = 'INITIALIZING CHART';
  await initChart();
  
  loaderBar.style.width = '70%';
  loaderText.textContent = 'CONNECTING MARKETS';
  initWebSocket();
  loadOrderBook();
  loadRecentTrades();
  
  loaderBar.style.width = '85%';
  loaderText.textContent = 'SETTING UP UI';
  initEventListeners();
  initDrawingTools();
  initAdsGram();
  initReferrals();
  initPnLModal();
  TPSLModal.init();
  
  loaderBar.style.width = '100%';
  loaderText.textContent = 'READY';
  
  updateUI();
  updateRewardsUI();
  
  // Hide loader
  setTimeout(() => {
    document.getElementById('app-loader').classList.add('hidden');
  }, 500);
  
  // Periodic updates
  setInterval(loadOrderBook, 5000);
  setInterval(loadRecentTrades, 3000);
  setInterval(() => {
    if (positions.length > 0) renderPositions();
  }, 1000);
}

// Start
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
