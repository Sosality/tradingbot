<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>TradeSim</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0B0E11;
      --panel: #1E2329;
      --panel-light: #2A2F36;
      --muted: #848E9C;
      --accent-green: #0ECB81;
      --accent-green-transparent: rgba(14, 203, 129, 0.15);
      --accent-red: #F6465D;
      --accent-red-transparent: rgba(246, 70, 93, 0.15);
      --white: #EAECEF;
      --border: rgba(255, 255, 255, 0.08);
      --gold: #F0B90B;
      --gold-gradient: linear-gradient(135deg, #F0B90B 0%, #B88A00 100%);
      --accent-blue: #1E90FF;
      --accent-purple: #A855F7;
      --accent-orange: #F7931A;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--white); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; position: relative; }

    .view-section {
      flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease;
      position: absolute; width: 100%; top: 0; left: 0; background: var(--bg);
    }
    .view-section.hidden { display: none; opacity: 0; pointer-events: none; z-index: -1; }
    .view-section.active { display: flex; opacity: 1; z-index: 10; }

    .header {
      flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; background: var(--panel); border-bottom: 1px solid var(--border); height: 60px; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo-img { height: 28px; width: auto; display: block; }

    .pair-dropdown { position: relative; font-family: 'Roboto Mono', monospace; }
    .pair-trigger {
      display: flex; align-items: center; gap: 8px; background: transparent; padding: 6px 12px;
      border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 15px; color: var(--white);
      transition: background 0.2s; user-select: none;
    }
    .pair-trigger:hover { background: rgba(255,255,255,0.05); }
    .pair-trigger .arrow { font-size: 10px; color: var(--muted); transition: transform 0.2s; }
    .pair-dropdown.open .pair-trigger .arrow { transform: rotate(180deg); }
    .pair-menu {
      position: absolute; top: 100%; left: 0; margin-top: 8px;
      background: rgba(30, 35, 41, 0.95); backdrop-filter: blur(10px);
      border: 1px solid var(--border); border-radius: 8px; width: 160px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; pointer-events: none;
      transform: translateY(-10px); transition: all 0.2s ease; z-index: 200;
      display: flex; flex-direction: column; padding: 4px;
    }
    .pair-dropdown.open .pair-menu { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .pair-item {
      padding: 10px 12px; font-size: 14px; font-weight: 500; color: var(--muted);
      cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
    }
    .pair-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
    .pair-item.active { background: rgba(255,255,255,0.08); color: var(--white); font-weight: 700; }
    .pair-item.active::after { content: '✓'; color: var(--accent-green); font-size: 12px; }

    .user-area { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 8px; border-radius: 8px; transition: background 0.2s; }
    .user-area:active { background: rgba(255,255,255,0.05); }
    .balance-group { text-align: right; line-height: 1.2; }
    .balance-label { font-size: 10px; color: var(--muted); display: block; }
    .balance-val { font-size: 13px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono', monospace; }
    .avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; border: 1px solid var(--border); }
    .avatar-sm img { width: 100%; height: 100%; object-fit: cover; }

    .container {
      flex: 1; display: flex; flex-direction: column;
      overflow-y: auto; overflow-x: hidden; padding: 12px; gap: 12px;
    }
    @media (min-width: 900px) {
      .container { display: grid; grid-template-columns: 1fr 340px; height: calc(100vh - 60px); overflow: hidden; }
      .left-col { overflow-y: auto; padding-right: 4px; }
      .right-col { overflow: hidden; height: 100%; }
      .ob-container, .pos-list { max-height: 400px; overflow-y: auto; }
    }

    .left-col { display: flex; flex-direction: column; gap: 12px; }
    .right-col { display: flex; flex-direction: column; gap: 12px; }
    .card { background: var(--panel); border-radius: 12px; padding: 12px; border: 1px solid var(--border); }

    .market-header {
      display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
      gap: 12px; min-width: 0; position: relative;
    }

    .price-block {
      display: flex; flex-direction: column; min-width: 0; flex-shrink: 0;
    }

    .price-label {
      color: var(--muted); font-size: 11px; margin-bottom: 4px;
    }

    .price-display { font-family: 'Roboto Mono', monospace; font-size: 32px; font-weight: 700; line-height: 1; letter-spacing: -1px; white-space: nowrap; }

    .chart-wrapper { position: relative; display: flex; flex-direction: column; gap: 0; }

    .chart-container {
      height: 280px; width: 100%; border-radius: 8px; overflow: hidden;
      position: relative; background: #111;
    }
    .chart-container.has-volume { border-radius: 8px 8px 0 0; }
    @media (min-width: 900px) { .chart-container { height: 40vh; } }

    .volume-container {
      height: 60px; width: 100%; background: #111;
      border-radius: 0 0 8px 8px; overflow: hidden; position: relative;
      border-top: 1px solid rgba(255,255,255,0.12);
      display: none;
    }
    .volume-container.visible { display: block; }

    .chart-loading-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(11, 14, 17, 0.7); display: flex; align-items: center; justify-content: center;
      z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
    }
    .chart-loading-overlay.active { opacity: 1; pointer-events: auto; }
    .chart-loading-spinner {
      width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-green); border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .ohlc-tooltip {
      position: absolute; top: 8px; left: 46px; z-index: 30;
      display: flex; align-items: center; gap: 8px;
      font-family: 'Roboto Mono', monospace; font-size: 10px; color: var(--muted);
      background: rgba(11, 14, 17, 0.85); padding: 4px 8px; border-radius: 4px;
      pointer-events: none; opacity: 0; transition: opacity 0.15s ease;
      max-width: calc(100% - 54px);
    }
    .ohlc-tooltip.visible { opacity: 1; }
    .ohlc-tooltip.ohlc-wrapped { flex-wrap: wrap; }
    .ohlc-tooltip .ohlc-item { display: flex; gap: 2px; white-space: nowrap; }
    .ohlc-tooltip .ohlc-label { color: var(--muted); }
    .ohlc-tooltip .ohlc-value { color: var(--white); font-weight: 500; }
    .ohlc-tooltip .ohlc-value.up { color: var(--accent-green); }
    .ohlc-tooltip .ohlc-value.down { color: var(--accent-red); }

    .drawing-tools-menu {
      position: absolute; top: 8px; left: 8px; z-index: 40;
      display: flex; flex-direction: column; gap: 2px;
    }
    .drawing-tools-toggle {
      width: 28px; height: 28px; background: rgba(30, 35, 41, 0.9);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--muted); font-size: 14px;
    }
    .drawing-tools-toggle:hover { background: var(--panel-light); color: var(--white); }
    .drawing-tools-toggle.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); }
    .drawing-tools-panel {
      display: flex; flex-direction: column; gap: 2px;
      opacity: 0; pointer-events: none; transform: translateY(-4px); transition: all 0.2s ease;
    }
    .drawing-tools-menu.open .drawing-tools-panel { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .drawing-tool-btn {
      width: 28px; height: 28px; background: rgba(30, 35, 41, 0.9);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--muted); font-size: 12px;
    }
    .drawing-tool-btn:hover { background: var(--panel-light); color: var(--white); }
    .drawing-tool-btn.active { background: rgba(30, 144, 255, 0.2); color: var(--accent-blue); border-color: var(--accent-blue); }
    .drawing-tool-btn svg { width: 14px; height: 14px; }

    .indicators-panel {
      display: flex; align-items: center; gap: 6px; padding: 8px 0; flex-wrap: wrap;
    }
    .indicator-chip {
      display: flex; align-items: center; gap: 4px; padding: 4px 10px;
      font-size: 11px; font-weight: 600; color: var(--muted);
      background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
      border-radius: 4px; cursor: pointer; transition: all 0.2s; user-select: none;
    }
    .indicator-chip:hover { background: rgba(255, 255, 255, 0.06); color: var(--white); }
    .indicator-chip.active.ema { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(30, 144, 255, 0.15); }
    .indicator-chip.active.sma { border-color: var(--accent-purple); color: var(--accent-purple); background: rgba(168, 85, 247, 0.15); }
    .indicator-chip.active.vwap { border-color: var(--accent-orange); color: var(--accent-orange); background: rgba(247, 147, 26, 0.15); }
    .indicator-chip.active.volume { border-color: var(--accent-green); color: var(--accent-green); background: var(--accent-green-transparent); }
    .indicator-dot {
      width: 6px; height: 6px; border-radius: 50%; background: currentColor;
      opacity: 0; transition: opacity 0.2s;
    }
    .indicator-chip.active .indicator-dot { opacity: 1; }

    .controls-area { display: flex; flex-direction: column; gap: 16px; margin-top: 12px; }
    .input-group { position: relative; }
    .input-label { position: absolute; top: 8px; left: 12px; font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .main-input {
      width: 100%; background: #111; border: 1px solid var(--border); color: var(--white);
      padding: 24px 12px 8px 12px; border-radius: 8px; font-size: 16px;
      font-family: 'Roboto Mono', monospace; outline: none; transition: border 0.2s;
    }
    .main-input:focus { border-color: var(--accent-green); }

    .slider-wrap { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
    .slider-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .slider-val { color: var(--accent-green); font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

    .range-slider {
      -webkit-appearance: none; width: 100%; height: 4px;
      background: linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) 0%, #2A2F36 0%, #2A2F36 100%);
      border-radius: 2px; outline: none; margin: 10px 0;
    }
    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid var(--accent-green); transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .range-slider::-webkit-slider-thumb:hover { transform: scale(1.1); box-shadow: 0 2px 12px rgba(14, 203, 129, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); }
    .range-slider::-webkit-slider-thumb:active { transform: scale(0.95); }
    .range-slider::-moz-range-thumb {
      width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid var(--accent-green);
    }

    .chips-row { display: flex; justify-content: space-between; gap: 4px; margin-top: 8px; }
    .chip { flex: 1; text-align: center; padding: 6px 0; font-size: 11px; background: #15181b; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); color: var(--muted); transition: 0.2s; }
    .chip.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); font-weight: 700; }

    .margin-slider-wrap { position: relative; padding: 0 10px; }
    .margin-slider-wrap .range-slider { width: 100%; }
    .margin-marks { display: flex; justify-content: space-between; margin-top: 4px; position: relative; }
    .margin-mark {
      font-size: 10px; color: var(--muted); cursor: pointer; padding: 2px 0; border-radius: 3px;
      transition: 0.2s; user-select: none; text-align: center; min-width: 28px;
    }
    .margin-mark:first-child { text-align: left; }
    .margin-mark:last-child { text-align: right; }
    .margin-mark:hover { color: var(--accent-green); }
    .margin-mark.active { color: var(--accent-green); font-weight: 600; }

    .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .btn-trade {
      padding: 14px; border-radius: 8px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; color: #fff;
      display: flex; flex-direction: column; align-items: center; line-height: 1.2; transition: filter 0.2s;
    }
    .btn-trade:active { filter: brightness(0.9); transform: scale(0.98); }
    .btn-trade span { font-size: 10px; font-weight: 400; opacity: 0.8; margin-top: 2px; }
    .btn-long { background: var(--accent-green); color: #052e1f; }
    .btn-short { background: var(--accent-red); color: #2d0a0f; }

    .ob-header { display: grid; grid-template-columns: 1fr 1fr; font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; padding: 0 6px; }
    .ob-container { font-size: 12px; font-family: 'Roboto Mono', monospace; display: flex; flex-direction: column; gap: 1px; overflow: hidden; }
    .ob-row { position: relative; display: grid; grid-template-columns: 1fr 1fr; align-items: center; height: 20px; padding: 0 6px; line-height: 1; white-space: nowrap; overflow: hidden; }
    .trade-time { text-align: right; opacity: 0.7; }
    .ob-bg { position: absolute; top: 0; bottom: 0; z-index: 0; opacity: 0.18; transition: width 0.2s ease; }
    .bg-red { left: 0; background: linear-gradient(to right, var(--accent-red), transparent); }
    .bg-green { right: 0; background: linear-gradient(to left, var(--accent-green), transparent); }
    .ob-row span { position: relative; z-index: 1; }
    .ob-row span:last-child { text-align: right; }
    .text-green { color: var(--accent-green); }
    .text-red { color: var(--accent-red); }

    .pos-list { display: flex; flex-direction: column; gap: 8px; }
    .pos-item { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; position: relative; overflow: hidden; }
    .pos-item.long { border-left: 4px solid var(--accent-green); }
    .pos-item.short { border-left: 4px solid var(--accent-red); }
    .pos-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; font-weight: 700; align-items: center; }
    .pos-pair { font-size: 15px; letter-spacing: 0.5px; }
    .pos-type-badge { font-size: 14px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

    .pos-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 8px 0; padding: 8px 0; border-top: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .stat-col { display: flex; flex-direction: column; gap: 4px; }
    .stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stat-val { font-size: 13px; font-weight: 700; font-family: 'Roboto Mono'; }

    .risk-wrap { margin-top: 4px; width: 100%; }
    .risk-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .risk-fill { height: 100%; width: 0%; background: var(--accent-green); transition: width 0.3s, background 0.3s; }

    .pos-details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
    .pd-col { display: flex; flex-direction: column; gap: 2px; }
    .pd-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .pd-val { font-size: 12px; color: var(--white); font-family: 'Roboto Mono'; font-weight: 700; }

    /* TP/SL Buttons in Position Card */
    .pos-tpsl-actions {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
      margin-top: 10px; padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .btn-tpsl {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.03); color: var(--muted);
      font-size: 12px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; user-select: none;
    }
    .btn-tpsl:hover { background: rgba(255,255,255,0.06); color: var(--white); }
    .btn-tpsl:active { transform: scale(0.97); }
    .btn-tpsl.tp { border-color: rgba(14, 203, 129, 0.3); }
    .btn-tpsl.tp:hover { border-color: var(--accent-green); color: var(--accent-green); background: var(--accent-green-transparent); }
    .btn-tpsl.sl { border-color: rgba(246, 70, 93, 0.3); }
    .btn-tpsl.sl:hover { border-color: var(--accent-red); color: var(--accent-red); background: var(--accent-red-transparent); }
    .btn-tpsl .tpsl-icon { font-size: 14px; }
    .btn-tpsl .tpsl-count {
      font-size: 10px; font-family: 'Roboto Mono'; padding: 1px 5px;
      border-radius: 4px; background: rgba(255,255,255,0.08);
      color: var(--muted); margin-left: 2px;
    }

    /* TP/SL Active Orders Summary in Position Card */
    .pos-tpsl-summary {
      margin-top: 8px; display: flex; flex-direction: column; gap: 4px;
    }
    .tpsl-summary-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 4px 8px; border-radius: 6px; font-size: 11px;
      font-family: 'Roboto Mono', monospace;
    }
    .tpsl-summary-row.tp-row {
      background: rgba(14, 203, 129, 0.08);
      border: 1px solid rgba(14, 203, 129, 0.15);
    }
    .tpsl-summary-row.sl-row {
      background: rgba(246, 70, 93, 0.08);
      border: 1px solid rgba(246, 70, 93, 0.15);
    }
    .tpsl-summary-label {
      font-weight: 600; font-size: 10px; text-transform: uppercase;
    }
    .tpsl-summary-row.tp-row .tpsl-summary-label { color: var(--accent-green); }
    .tpsl-summary-row.sl-row .tpsl-summary-label { color: var(--accent-red); }
    .tpsl-summary-price { color: var(--white); font-weight: 500; }
    .tpsl-summary-pct { color: var(--muted); font-size: 10px; }

    .close-btn {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--accent-red);
      padding: 8px 12px; border-radius: 8px; font-size: 12px; margin-top: 12px; width: 100%; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .close-btn:active { background: var(--accent-red); color: #fff; }

    /* ==================== TP/SL MODAL ==================== */
    .tpsl-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .tpsl-modal-overlay.active { opacity: 1; pointer-events: auto; }

    .tpsl-modal {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      max-height: 85vh; overflow-y: auto; z-index: 1001;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    .tpsl-modal-overlay.active .tpsl-modal { transform: translateY(0); }

    .tpsl-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--panel); z-index: 10;
    }
    .tpsl-modal-title {
      font-size: 16px; font-weight: 700; color: var(--white);
      display: flex; align-items: center; gap: 8px;
    }
    .tpsl-modal-title .tpsl-title-icon {
      width: 8px; height: 8px; border-radius: 50%;
    }
    .tpsl-modal-title .tpsl-title-icon.tp-icon { background: var(--accent-green); box-shadow: 0 0 8px rgba(14, 203, 129, 0.4); }
    .tpsl-modal-title .tpsl-title-icon.sl-icon { background: var(--accent-red); box-shadow: 0 0 8px rgba(246, 70, 93, 0.4); }

    .tpsl-modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 50%; cursor: pointer;
      color: var(--muted); font-size: 18px; transition: all 0.2s; border: none;
    }
    .tpsl-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }

    .tpsl-modal-content { padding: 16px 20px 24px; display: flex; flex-direction: column; gap: 16px; }

    /* Position Info Bar */
    .tpsl-pos-info {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; border-radius: 8px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      font-size: 12px;
    }
    .tpsl-pos-info-left { display: flex; align-items: center; gap: 8px; }
    .tpsl-pos-pair { font-weight: 700; color: var(--white); }
    .tpsl-pos-type {
      font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px;
    }
    .tpsl-pos-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
    .tpsl-pos-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
    .tpsl-pos-size { color: var(--muted); font-family: 'Roboto Mono'; }

    /* Tabs */
    .tpsl-tabs {
      display: flex; background: rgba(255,255,255,0.03);
      border-radius: 8px; padding: 3px; border: 1px solid var(--border);
    }
    .tpsl-tab {
      flex: 1; text-align: center; padding: 8px 12px;
      font-size: 12px; font-weight: 600; color: var(--muted);
      border-radius: 6px; cursor: pointer; transition: all 0.2s;
      user-select: none;
    }
    .tpsl-tab:hover { color: var(--white); }
    .tpsl-tab.active { background: var(--panel-light); color: var(--white); }

    /* Tab Content */
    .tpsl-tab-content { display: none; flex-direction: column; gap: 14px; }
    .tpsl-tab-content.active { display: flex; }

    /* Price Input */
    .tpsl-input-group { position: relative; }
    .tpsl-input-label {
      font-size: 10px; color: var(--muted); text-transform: uppercase;
      font-weight: 600; margin-bottom: 6px; display: block;
    }
    .tpsl-price-input {
      width: 100%; background: #111; border: 1px solid var(--border);
      color: var(--white); padding: 12px; border-radius: 8px;
      font-size: 16px; font-family: 'Roboto Mono', monospace;
      outline: none; transition: border 0.2s;
    }
    .tpsl-price-input:focus { border-color: var(--accent-green); }
    .tpsl-price-input.error { border-color: var(--accent-red); }
    .tpsl-price-input.tp-mode:focus { border-color: var(--accent-green); }
    .tpsl-price-input.sl-mode:focus { border-color: var(--accent-red); }

    .tpsl-input-hint {
      font-size: 10px; margin-top: 4px; min-height: 14px;
      transition: color 0.2s;
    }
    .tpsl-input-hint.error { color: var(--accent-red); }
    .tpsl-input-hint.valid { color: var(--accent-green); }
    .tpsl-input-hint.neutral { color: var(--muted); }

    /* PnL Preview */
    .tpsl-pnl-preview {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
      padding: 12px; border-radius: 8px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
    }
    .tpsl-pnl-item { display: flex; flex-direction: column; gap: 2px; }
    .tpsl-pnl-item:nth-child(even) { align-items: flex-end; }
    .tpsl-pnl-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .tpsl-pnl-value {
      font-size: 16px; font-weight: 700; font-family: 'Roboto Mono', monospace;
      transition: color 0.2s;
    }

    /* Volume Slider (Partial) */
    .tpsl-volume-section {
      display: flex; flex-direction: column; gap: 8px;
      padding: 12px; border-radius: 8px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
    }
    .tpsl-volume-header {
      display: flex; justify-content: space-between; align-items: center;
    }
    .tpsl-volume-label { font-size: 12px; color: var(--muted); font-weight: 600; }
    .tpsl-volume-val {
      font-size: 14px; font-weight: 700; font-family: 'Roboto Mono';
      color: var(--accent-green);
    }
    .tpsl-volume-slider {
      -webkit-appearance: none; width: 100%; height: 4px;
      background: linear-gradient(to right, var(--accent-green) 0%, #2A2F36 0%);
      border-radius: 2px; outline: none; margin: 6px 0;
    }
    .tpsl-volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      border: 2px solid var(--accent-green);
    }
    .tpsl-volume-slider::-moz-range-thumb {
      width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      border: 2px solid var(--accent-green);
    }
    .tpsl-volume-marks {
      display: flex; justify-content: space-between; margin-top: 2px;
    }
    .tpsl-volume-mark {
      font-size: 10px; color: var(--muted); cursor: pointer;
      padding: 2px 4px; border-radius: 3px; transition: 0.2s; user-select: none;
    }
    .tpsl-volume-mark:hover { color: var(--accent-green); }
    .tpsl-volume-mark.active { color: var(--accent-green); font-weight: 600; }
    .tpsl-volume-amount {
      font-size: 11px; color: var(--muted); text-align: center;
      font-family: 'Roboto Mono'; margin-top: 4px;
    }

    /* Existing Orders List */
    .tpsl-orders-section {
      display: flex; flex-direction: column; gap: 8px;
    }
    .tpsl-orders-header {
      display: flex; justify-content: space-between; align-items: center;
    }
    .tpsl-orders-title { font-size: 12px; font-weight: 700; color: var(--white); }
    .tpsl-orders-counter {
      font-size: 11px; color: var(--muted); font-family: 'Roboto Mono';
      padding: 2px 8px; border-radius: 4px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border);
    }
    .tpsl-orders-counter.limit { color: var(--accent-red); border-color: rgba(246,70,93,0.3); }

    .tpsl-order-card {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; border-radius: 8px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .tpsl-order-card:hover { border-color: rgba(255,255,255,0.15); }
    .tpsl-order-card-left { display: flex; flex-direction: column; gap: 2px; }
    .tpsl-order-card-price {
      font-size: 13px; font-weight: 700; font-family: 'Roboto Mono';
      color: var(--white);
    }
    .tpsl-order-card-meta {
      display: flex; align-items: center; gap: 8px;
      font-size: 10px; color: var(--muted);
    }
    .tpsl-order-card-pnl { font-weight: 600; }
    .tpsl-order-card-pnl.positive { color: var(--accent-green); }
    .tpsl-order-card-pnl.negative { color: var(--accent-red); }

    .tpsl-order-delete {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      background: rgba(246, 70, 93, 0.1); border: 1px solid rgba(246, 70, 93, 0.2);
      border-radius: 6px; cursor: pointer; color: var(--accent-red);
      font-size: 14px; transition: all 0.2s; flex-shrink: 0;
    }
    .tpsl-order-delete:hover { background: rgba(246, 70, 93, 0.2); border-color: var(--accent-red); }
    .tpsl-order-delete:active { transform: scale(0.9); }

    .tpsl-no-orders {
      text-align: center; padding: 12px; color: var(--muted); font-size: 12px;
    }

    /* Confirm Button */
    .tpsl-confirm-btn {
      width: 100%; padding: 14px; border-radius: 10px; border: none;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.2s; color: #fff;
    }
    .tpsl-confirm-btn:active { transform: scale(0.98); }
    .tpsl-confirm-btn:disabled {
      background: var(--panel-light) !important; color: var(--muted); cursor: not-allowed;
    }
    .tpsl-confirm-btn.tp-confirm { background: var(--accent-green); color: #052e1f; }
    .tpsl-confirm-btn.sl-confirm { background: var(--accent-red); color: #2d0a0f; }

    .profile-container { flex: 1; display: flex; flex-direction: column; padding: 16px; overflow-y: auto; gap: 20px; background: var(--bg); }
    .pro-header, .asset-card, .analysis-block, .rewards-banner, .hist-header-row { flex-shrink: 0; }
    .pro-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .pro-user { display: flex; align-items: center; gap: 12px; }
    .pro-avatar { width: 44px; height: 44px; border-radius: 50%; background: #333; overflow: hidden; border: 2px solid var(--panel); }
    .pro-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .pro-name { font-size: 16px; font-weight: 700; color: var(--white); line-height: 1.2; }
    .pro-id { font-size: 11px; color: var(--muted); font-family: monospace; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }

    .asset-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; position: relative; overflow: hidden; }
    .asset-label { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
    .eye-btn { width: 20px; height: 20px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; margin-left: 6px; display: block; }
    .eye-btn:active { opacity: 1; transform: scale(0.9); }
    .asset-val { font-size: 26px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono'; margin: 8px 0; }
    .asset-approx { font-size: 13px; color: var(--muted); }
    .asset-pnl { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); display: inline-flex; align-items: center; gap: 4px; margin-left: 8px; }
    .asset-rate { font-size: 11px; color: var(--muted); margin-top: 8px; display: block; }
    .pro-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .pro-btn { background: var(--panel-light); border: none; color: var(--white); padding: 10px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .pro-btn.primary { background: var(--gold); color: #000; }

    .analysis-block { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .an-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 110px; }
    .an-card.clickable { cursor: pointer; transition: all 0.2s; }
    .an-card.clickable:hover { border-color: rgba(255,255,255,0.15); background: rgba(30, 35, 41, 0.8); }
    .an-card.clickable:active { transform: scale(0.98); }
    .an-title { font-size: 11px; color: var(--muted); margin-bottom: 0; text-transform: uppercase; width: 100%; text-align: left; }
    .an-content-center { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }

    .donut-chart { width: 70px; height: 70px; border-radius: 50%; background: conic-gradient(var(--accent-green) 0% 0%, var(--panel-light) 0% 100%); position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; }
    .donut-chart::after { content: ''; position: absolute; width: 56px; height: 56px; background: var(--panel); border-radius: 50%; }
    .donut-val { position: absolute; z-index: 2; font-size: 12px; font-weight: 700; color: var(--white); }
    .an-text { font-size: 12px; color: var(--white); font-weight: 600; margin-top: 4px; }

    .pnl-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .pnl-modal-overlay.active { opacity: 1; pointer-events: auto; }
    .pnl-modal {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      max-height: 85vh; overflow-y: auto; z-index: 1001;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    .pnl-modal-overlay.active .pnl-modal { transform: translateY(0); }
    .pnl-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--panel); z-index: 10;
    }
    .pnl-modal-title { font-size: 16px; font-weight: 700; color: var(--white); }
    .pnl-modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 50%; cursor: pointer;
      color: var(--muted); font-size: 18px; transition: all 0.2s; border: none;
    }
    .pnl-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .pnl-modal-content { padding: 20px; display: flex; flex-direction: column; gap: 24px; }

    .stats-metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stats-metric-card {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 4px;
    }
    .stats-metric-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stats-metric-value { font-size: 18px; font-weight: 700; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .stats-metric-value.positive { color: var(--accent-green); }
    .stats-metric-value.negative { color: var(--accent-red); }

    .period-selector {
      display: flex; gap: 4px; background: rgba(255,255,255,0.03);
      padding: 3px; border-radius: 8px; border: 1px solid var(--border);
    }
    .period-btn {
      padding: 6px 12px; font-size: 11px; font-weight: 600; color: var(--muted);
      background: transparent; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;
    }
    .period-btn:hover { color: var(--white); }
    .period-btn.active { background: var(--panel-light); color: var(--white); }

    .chart-section { display: flex; flex-direction: column; gap: 12px; }
    .chart-section-header { display: flex; justify-content: space-between; align-items: center; }
    .chart-section-title { font-size: 13px; font-weight: 600; color: var(--white); }
    .equity-chart-container {
      height: 160px; background: rgba(0,0,0,0.2); border-radius: 8px;
      overflow: hidden; position: relative;
    }

    .calendar-pnl-container { display: flex; flex-direction: column; gap: 8px; }
    .calendar-month-nav {
      display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 8px;
    }
    .calendar-nav-btn {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border: none; border-radius: 6px;
      color: var(--muted); cursor: pointer; transition: all 0.2s; font-size: 16px;
    }
    .calendar-nav-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .calendar-month-label { font-size: 14px; font-weight: 600; color: var(--white); min-width: 120px; text-align: center; }
    .calendar-header { display: flex; justify-content: space-between; padding: 0 2px; }
    .calendar-day-label { font-size: 9px; color: var(--muted); width: 36px; text-align: center; font-weight: 600; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-cell {
      aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 600; font-family: 'Roboto Mono', monospace;
      cursor: default; transition: transform 0.15s; position: relative;
      background: rgba(255,255,255,0.03); color: var(--muted);
    }
    .calendar-cell:hover { transform: scale(1.1); z-index: 2; }
    .calendar-cell.empty { background: transparent; }
    .calendar-cell.profit { background: var(--accent-green-transparent); color: var(--accent-green); }
    .calendar-cell.loss { background: var(--accent-red-transparent); color: var(--accent-red); }
    .calendar-cell.profit.high { background: rgba(14, 203, 129, 0.3); }
    .calendar-cell.loss.high { background: rgba(246, 70, 93, 0.3); }
    .calendar-cell.today { border: 1px solid var(--gold); }
    .calendar-legend {
      display: flex; justify-content: center; gap: 16px; margin-top: 8px;
      padding-top: 8px; border-top: 1px solid var(--border);
    }
    .calendar-legend-item { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--muted); }
    .calendar-legend-dot { width: 10px; height: 10px; border-radius: 3px; }
    .calendar-legend-dot.profit { background: var(--accent-green-transparent); }
    .calendar-legend-dot.loss { background: var(--accent-red-transparent); }
    .calendar-legend-dot.no-trade { background: rgba(255,255,255,0.03); }

    .ref-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .ref-top { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .ref-title { font-weight: 800; font-size: 14px; }
    .ref-badge { font-size: 11px; color: var(--muted); background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); }
    .ref-row { display: flex; gap: 8px; align-items: center; }
    .ref-input { flex: 1; background: #111; border: 1px solid var(--border); color: var(--white); padding: 12px; border-radius: 10px; font-family: 'Roboto Mono', monospace; font-size: 12px; outline: none; width: 100%; }
    .ref-btn { background: var(--panel-light); border: 1px solid var(--border); color: var(--white); padding: 12px 12px; border-radius: 10px; font-weight: 700; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .ref-btn.primary { background: var(--gold); color: #000; border-color: rgba(240,185,11,0.4); }
    .ref-help { font-size: 11px; color: var(--muted); line-height: 1.35; }
    .ref-list { display: flex; flex-direction: column; gap: 8px; max-height: 180px; overflow-y: auto; padding-right: 2px; }
    .ref-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 10px; }
    .ref-item-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .ref-avatar { width: 28px; height: 28px; border-radius: 50%; background: #333; overflow: hidden; border: 1px solid var(--border); flex-shrink: 0; }
    .ref-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .ref-name { font-size: 12px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
    .ref-date { font-size: 10px; color: var(--muted); font-family: monospace; flex-shrink: 0; }
    .ref-status { font-size: 10px; color: var(--muted); }

    .rewards-banner {
      background: linear-gradient(90deg, #1E2329 0%, #252a33 100%); border: 1px solid rgba(240, 185, 11, 0.3);
      border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; position: relative; overflow: hidden;
    }
    .rewards-banner::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gold); }
    .rb-content h3 { margin: 0; font-size: 15px; color: var(--white); }
    .rb-content p { margin: 4px 0 0; font-size: 11px; color: var(--muted); }
    .rb-icon { display: flex; align-items: center; }

    .hist-header-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; }
    .hist-title { margin: 0; font-size: 15px; font-weight: 700; }
    .hist-filters { display: flex; background: var(--panel); border-radius: 8px; padding: 2px; border: 1px solid var(--border); }
    .h-filter { padding: 4px 10px; font-size: 11px; color: var(--muted); border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: 500; }
    .h-filter.active { background: var(--panel-light); color: var(--white); font-weight: 700; }

    .history-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 60px; }
    .history-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 8px; }
    .hc-header { display: flex; justify-content: space-between; align-items: center; }
    .hc-pair { font-weight: 700; font-size: 14px; }
    .hc-type { font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
    .hc-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
    .hc-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
    .hc-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); }
    .hc-val { color: var(--white); font-family: 'Roboto Mono'; }
    .hc-pnl { font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

    .rewards-container { padding: 20px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; padding-bottom: 100px; }
    .rewards-header { text-align: center; padding: 20px 0; }
    .rh-title { font-size: 22px; font-weight: 700; color: var(--white); margin-bottom: 8px; }
    .rh-sub { font-size: 13px; color: var(--muted); }
    .stats-row { display: flex; justify-content: center; gap: 32px; margin-top: 16px; }
    .stat-item { text-align: center; }
    .stat-item .stat-number { font-size: 24px; font-weight: 700; color: var(--gold); font-family: 'Roboto Mono'; }
    .stat-item .stat-desc { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .progress-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
    .prog-info { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; color: var(--white); font-weight: 600; }
    .prog-track { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative; }
    .prog-fill { height: 100%; background: var(--gold-gradient); width: 0%; transition: width 0.5s ease; border-radius: 4px; }
    .milestones { display: flex; justify-content: space-between; margin-top: 12px; }
    .ms-item { text-align: center; width: 30px; position: relative; }
    .ms-dot { width: 10px; height: 10px; background: #333; border: 2px solid var(--muted); border-radius: 50%; margin: 0 auto 4px; z-index: 2; position: relative; }
    .ms-item.active .ms-dot { background: var(--gold); border-color: var(--gold); box-shadow: 0 0 10px rgba(240, 185, 11, 0.4); }
    .ms-val { font-size: 10px; color: var(--muted); }

    .task-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .task-item { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
    .task-left h4 { margin: 0 0 4px; font-size: 14px; }
    .task-left p { margin: 0; font-size: 11px; color: var(--muted); }
    .task-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .daily-counter { font-size: 11px; color: var(--muted); font-family: 'Roboto Mono'; }
    .daily-counter.limit-reached { color: var(--accent-red); }
    .btn-claim { background: var(--gold); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .btn-claim:hover { filter: brightness(1.1); }
    .btn-claim:active { transform: scale(0.96); }
    .btn-claim:disabled { background: var(--panel-light); color: var(--muted); cursor: not-allowed; }
    .btn-claim.loading { opacity: 0.7; pointer-events: none; }

    .btn-back-float {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--panel-light); border: 1px solid var(--border); color: var(--white);
      padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 900; cursor: pointer;
    }

    #app-loader {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s;
    }
    #app-loader.hidden { opacity: 0; pointer-events: none; }
    .loader-logo { width: 80px; height: auto; margin-bottom: 20px; animation: pulse 2s infinite ease-in-out; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    .loader-bar-bg { width: 140px; height: 2px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .loader-bar-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.2s; }

    .tf-selector {
      display: flex; gap: 2px; background: rgba(255,255,255,0.03);
      padding: 2px; border-radius: 6px; height: fit-content;
      flex-shrink: 0; align-self: flex-start;
    }
    .tf-selector.tf-wrapped {
      display: grid; grid-template-columns: repeat(3, auto);
      grid-template-rows: auto auto; gap: 2px;
      width: auto; justify-content: end;
    }
    .tf-opt {
      padding: 4px 8px; font-size: 10px; color: var(--muted);
      border-radius: 4px; cursor: pointer; font-weight: 600;
      transition: 0.2s; user-select: none; white-space: nowrap; text-align: center;
    }
    .tf-opt:hover { color: var(--white); background: rgba(255,255,255,0.05); }
    .tf-opt.active { background: var(--panel-light); color: var(--gold); }
  </style>
</head>
<body>

<div id="app-loader">
  <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="TradeSim" class="loader-logo">
  <div class="loader-bar-bg"><div class="loader-bar-fill" id="loaderBar"></div></div>
  <div style="margin-top: 12px; font-size: 10px; color: var(--muted); font-family: monospace; letter-spacing: 1px;" id="loaderText">CONNECTING</div>
</div>

<div class="app">

  <div id="view-trade" class="view-section active">
    <header class="header">
      <div class="header-left">
        <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="Logo" class="logo-img">
        <div class="pair-dropdown" id="pairDropdown">
          <div class="pair-trigger" id="pairTrigger">
            <span id="triggerText">BTC/USD</span>
            <span class="arrow">▼</span>
          </div>
          <div class="pair-menu">
            <div class="pair-item active" data-pair="BTC-USD">BTC/USD</div>
            <div class="pair-item" data-pair="ETH-USD">ETH/USD</div>
          </div>
        </div>
      </div>
      <div class="user-area" id="btnProfile">
        <div class="balance-group">
          <span class="balance-label">Total Assets</span>
          <span class="balance-val" id="headerBalance">0.00 VP</span>
        </div>
        <div class="avatar-sm"><img id="avatarImg" src="" style="display:none"></div>
      </div>
    </header>

    <main class="container">
      <div class="left-col">
        <div class="card">
          <div class="market-header" id="marketHeader">
            <div class="price-block" id="priceBlock">
              <div class="price-label">Market Price</div>
              <div class="price-display text-green" id="priceDisplay">--.--</div>
            </div>
            <div class="tf-selector" id="timeframeSelector">
              <div class="tf-opt active" data-tf="60">1m</div>
              <div class="tf-opt" data-tf="300">5m</div>
              <div class="tf-opt" data-tf="900">15m</div>
              <div class="tf-opt" data-tf="3600">1h</div>
              <div class="tf-opt" data-tf="21600">6h</div>
              <div class="tf-opt" data-tf="86400">1d</div>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-container" id="chartCard">
              <div id="chart" style="width: 100%; height: 100%;"></div>
              <div class="chart-loading-overlay" id="chartLoadingOverlay">
                <div class="chart-loading-spinner"></div>
              </div>
              <div class="ohlc-tooltip" id="ohlcTooltip">
                <div class="ohlc-item"><span class="ohlc-label">O:</span><span class="ohlc-value" id="ohlcOpen">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">H:</span><span class="ohlc-value" id="ohlcHigh">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">L:</span><span class="ohlc-value" id="ohlcLow">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">C:</span><span class="ohlc-value" id="ohlcClose">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">V:</span><span class="ohlc-value" id="ohlcVol">-</span></div>
              </div>
              <div class="drawing-tools-menu" id="drawingToolsMenu">
                <div class="drawing-tools-toggle" id="drawingToolsToggle" title="Drawing Tools">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                  </svg>
                </div>
                <div class="drawing-tools-panel" id="drawingToolsPanel">
                  <div class="drawing-tool-btn" id="toolCursor" data-tool="cursor" title="Cursor">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>
                  </div>
                  <div class="drawing-tool-btn" id="toolTrendLine" data-tool="trendline" title="Trend Line">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="20" x2="20" y2="4"/></svg>
                  </div>
                  <div class="drawing-tool-btn" id="toolHorizLine" data-tool="horizline" title="Horizontal Line">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="12" x2="22" y2="12"/></svg>
                  </div>
                  <div class="drawing-tool-btn" id="toolClearAll" data-tool="clear" title="Clear All">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                  </div>
                </div>
              </div>
            </div>

            <div class="volume-container" id="volumeContainer">
              <div id="volumeChart" style="width: 100%; height: 100%;"></div>
            </div>

            <div class="indicators-panel" id="indicatorsPanel">
              <div class="indicator-chip ema" id="chipEMA" data-indicator="ema">
                <span class="indicator-dot"></span>
                <span>EMA 20</span>
              </div>
              <div class="indicator-chip sma" id="chipSMA" data-indicator="sma">
                <span class="indicator-dot"></span>
                <span>SMA 50</span>
              </div>
              <div class="indicator-chip vwap" id="chipVWAP" data-indicator="vwap">
                <span class="indicator-dot"></span>
                <span>VWAP</span>
              </div>
              <div class="indicator-chip volume" id="chipVolume" data-indicator="volume">
                <span class="indicator-dot"></span>
                <span>Volume</span>
              </div>
            </div>
          </div>

          <div class="controls-area">
            <div class="input-group">
              <span class="input-label">Margin (VP)</span>
              <input type="number" id="sizeInput" class="main-input" value="100" placeholder="10-10000" />
            </div>
            <div class="slider-wrap">
              <div class="slider-header"><span>Margin %</span><span class="slider-val" id="marginPercentText">0%</span></div>
              <div class="margin-slider-wrap">
                <input type="range" class="range-slider" id="marginSlider" min="0" max="100" step="1" value="0">
                <div class="margin-marks">
                  <span class="margin-mark" data-pct="0">0%</span>
                  <span class="margin-mark" data-pct="25">25%</span>
                  <span class="margin-mark" data-pct="50">50%</span>
                  <span class="margin-mark" data-pct="75">75%</span>
                  <span class="margin-mark" data-pct="100">100%</span>
                </div>
              </div>
            </div>
            <div class="slider-wrap">
              <div class="slider-header"><span>Leverage</span><span class="slider-val" id="leverageValText">10x</span></div>
              <input type="range" class="range-slider" id="leverageSlider" min="1" max="50" step="1" value="10">
              <div class="chips-row" id="leverageChips">
                <div class="chip" data-v="1">1x</div>
                <div class="chip" data-v="5">5x</div>
                <div class="chip active" data-v="10">10x</div>
                <div class="chip" data-v="20">20x</div>
                <div class="chip" data-v="50">50x</div>
              </div>
            </div>
            <div class="action-btns">
              <button id="openLong" class="btn-trade btn-long">Buy / Long <span>Up</span></button>
              <button id="openShort" class="btn-trade btn-short">Sell / Short <span>Down</span></button>
            </div>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px; padding-left: 4px;">Open Positions</div>
          <div id="positionsList" class="pos-list"><div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div></div>
        </div>
      </div>

      <div class="right-col">
        <div class="card" style="display:flex; flex-direction:column; min-height: 300px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between; align-items:center;">
            <span>Order Book</span>
            <div style="display:flex; gap:8px; align-items:center;">
              <span id="bookPairLabel" style="color:var(--muted); font-size:11px;">BTC-USD</span>
              <span id="bookUpdated" style="color:var(--muted); font-size:11px;">—</span>
            </div>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Amount</span></div>
          <div class="ob-container" id="orderBook" style="flex:1;"></div>
        </div>

        <div class="card" style="display:flex; flex-direction:column; min-height: 250px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between;">
            <span>Last Trades</span>
            <span style="color:var(--muted); font-size:11px;">Real-time</span>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Time</span></div>
          <div class="ob-container" id="tradeHistory" style="flex:1;"></div>
        </div>
      </div>
    </main>
  </div>

  <div id="view-profile" class="view-section hidden">
    <div class="profile-container">
      <div class="pro-header">
        <div class="pro-user">
          <div class="pro-avatar"><img id="profileAvatarBig" src=""></div>
          <div>
            <div class="pro-name" id="profileName">Trader</div>
            <div class="pro-id" id="profileId">ID: --</div>
          </div>
        </div>
        <div class="btn-close" id="btnCloseProfile" style="color:var(--muted); padding:8px; cursor:pointer;">✕</div>
      </div>

      <div class="asset-card">
        <div class="asset-label">
          Total Assets (VP)
          <img id="btnToggleBalance" class="eye-btn" src="https://img.icons8.com/ios-glyphs/60/ffffff/visible.png" alt="Show/Hide">
        </div>
        <div class="asset-val" id="profileBalance">0.00</div>
        <div style="display:flex; align-items:center;">
          <span class="asset-approx" id="profileBalanceApprox">≈ $0.00</span>
          <div class="asset-pnl text-green" id="profilePnlPill">+0.00%</div>
        </div>
        <span class="asset-rate">1 VP = $0.005</span>
        <div class="pro-actions">
          <button class="pro-btn primary">Deposit</button>
          <button class="pro-btn">Withdraw</button>
        </div>
      </div>

      <div class="analysis-block">
        <div class="an-card">
          <div class="an-title">Win Rate</div>
          <div class="an-content-center">
            <div class="donut-chart" id="winRateChart">
              <span class="donut-val" id="winRateVal">0%</span>
            </div>
            <div class="an-text" id="totalTradesVal" style="margin-top: 6px;">0 Trades</div>
          </div>
        </div>
        <div class="an-card clickable" id="netPnlCard">
          <div class="an-title">Net PnL</div>
          <div class="an-content-center">
            <div style="font-size:20px; font-weight:700; font-family:'Roboto Mono';" id="statPnL">0.00</div>
          </div>
          <div style="font-size:10px; color:var(--muted); width:100%; text-align:center;">Tap for details →</div>
        </div>
      </div>

      <div class="ref-card" id="refCard">
        <div class="ref-top">
          <div class="ref-title">Referrals</div>
          <div class="ref-badge" id="refCountBadge">Invited: 0</div>
        </div>
        <div class="ref-row">
          <input class="ref-input" id="refLinkInput" readonly value="Loading...">
          <button class="ref-btn primary" id="btnCopyRefLink">Copy</button>
        </div>
        <div class="ref-help" id="refHelpText">Share the link with friends. When they open the bot using your link, they will be automatically assigned as your referral.</div>
        <div class="ref-list" id="refList">
          <div class="ref-status" id="refStatus">Loading referrals...</div>
        </div>
      </div>

      <div class="rewards-banner" id="btnGoRewards">
        <div class="rb-content">
          <h3>Rewards Center</h3>
          <p>Complete tasks to unlock features</p>
        </div>
        <div class="rb-icon">
          <img src="https://i.postimg.cc/pdkwtBbQ/gift-thunder.png" style="width: 40px; height: auto;">
        </div>
      </div>

      <div>
        <div class="hist-header-row">
          <div class="hist-title">History</div>
          <div class="hist-filters">
            <div class="h-filter active" data-filter="all">All</div>
            <div class="h-filter" data-filter="day">24h</div>
            <div class="h-filter" data-filter="week">7d</div>
          </div>
        </div>
        <div class="history-list" id="historyList">
          <div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history</div>
        </div>
      </div>
    </div>
  </div>

  <div id="view-rewards" class="view-section hidden">
    <div class="rewards-container">
      <div class="rewards-header">
        <div class="rh-title">Achievement Progress</div>
        <div class="rh-sub">Watch ads & earn rewards</div>
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-number" id="totalAdsWatched">0</div>
            <div class="stat-desc">Ads Watched</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalEarnedFromAds">0</div>
            <div class="stat-desc">VP Earned</div>
          </div>
        </div>
      </div>

      <div class="progress-card">
        <div class="prog-info">
          <span id="currentLevelText">Level 1</span>
          <span id="adsProgressText">0 / 10 Ads</span>
        </div>
        <div class="prog-track">
          <div class="prog-fill" id="adsProgressBar" style="width: 0%;"></div>
        </div>
        <div class="milestones">
          <div class="ms-item active" id="ms-start"><div class="ms-dot"></div><span class="ms-val">Start</span></div>
          <div class="ms-item" id="ms-5"><div class="ms-dot"></div><span class="ms-val">5 Ads</span></div>
          <div class="ms-item" id="ms-10"><div class="ms-dot"></div><span class="ms-val">10 Ads</span></div>
        </div>
      </div>

      <div class="task-list">
        <div class="task-item">
          <div class="task-left">
            <h4>Watch Ad</h4>
            <p>Earn +1 VP per view</p>
          </div>
          <div class="task-right">
            <span class="daily-counter" id="dailyAdCounter">0/5 today</span>
            <button class="btn-claim" id="btnWatchAd">WATCH</button>
          </div>
        </div>
      </div>

      <button class="btn-back-float" id="btnBackFromRewards">Back to Profile</button>
    </div>
  </div>

</div>

<!-- PnL Modal -->
<div class="pnl-modal-overlay" id="pnlModalOverlay">
  <div class="pnl-modal" id="pnlModal">
    <div class="pnl-modal-header">
      <div class="pnl-modal-title">Trading Statistics</div>
      <button class="pnl-modal-close" id="pnlModalClose">×</button>
    </div>
    <div class="pnl-modal-content">
      <div class="stats-metrics-grid">
        <div class="stats-metric-card">
          <div class="stats-metric-label">Avg Risk:Reward</div>
          <div class="stats-metric-value" id="modalAvgRR">--</div>
        </div>
        <div class="stats-metric-card">
          <div class="stats-metric-label">Max Drawdown</div>
          <div class="stats-metric-value negative" id="modalMaxDD">--</div>
        </div>
        <div class="stats-metric-card">
          <div class="stats-metric-label">Profit Factor</div>
          <div class="stats-metric-value" id="modalProfitFactor">--</div>
        </div>
        <div class="stats-metric-card">
          <div class="stats-metric-label">Avg Trade</div>
          <div class="stats-metric-value" id="modalAvgTrade">--</div>
        </div>
      </div>
      <div class="chart-section">
        <div class="chart-section-header">
          <div class="chart-section-title">Equity Curve</div>
          <div class="period-selector" id="equityPeriodSelector">
            <button class="period-btn active" data-period="7d">7D</button>
            <button class="period-btn" data-period="30d">30D</button>
            <button class="period-btn" data-period="90d">90D</button>
            <button class="period-btn" data-period="all">All</button>
          </div>
        </div>
        <div class="equity-chart-container" id="equityChartContainer"></div>
      </div>
      <div class="chart-section">
        <div class="chart-section-title" style="margin-bottom: 12px;">Calendar PnL</div>
        <div class="calendar-pnl-container" id="calendarPnlContainer">
          <div class="calendar-month-nav">
            <button class="calendar-nav-btn" id="calendarPrev">‹</button>
            <span class="calendar-month-label" id="calendarMonthLabel">January 2025</span>
            <button class="calendar-nav-btn" id="calendarNext">›</button>
          </div>
          <div class="calendar-header">
            <span class="calendar-day-label">Mon</span>
            <span class="calendar-day-label">Tue</span>
            <span class="calendar-day-label">Wed</span>
            <span class="calendar-day-label">Thu</span>
            <span class="calendar-day-label">Fri</span>
            <span class="calendar-day-label">Sat</span>
            <span class="calendar-day-label">Sun</span>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
          <div class="calendar-legend">
            <div class="calendar-legend-item"><span class="calendar-legend-dot profit"></span><span>Profit</span></div>
            <div class="calendar-legend-item"><span class="calendar-legend-dot loss"></span><span>Loss</span></div>
            <div class="calendar-legend-item"><span class="calendar-legend-dot no-trade"></span><span>No Trade</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TP/SL Modal -->
<div class="tpsl-modal-overlay" id="tpslModalOverlay">
  <div class="tpsl-modal" id="tpslModal">
    <div class="tpsl-modal-header">
      <div class="tpsl-modal-title" id="tpslModalTitle">
        <span class="tpsl-title-icon tp-icon" id="tpslTitleIcon"></span>
        <span id="tpslTitleText">Take Profit</span>
      </div>
      <button class="tpsl-modal-close" id="tpslModalClose">×</button>
    </div>
    <div class="tpsl-modal-content">
      <!-- Position Info -->
      <div class="tpsl-pos-info">
        <div class="tpsl-pos-info-left">
          <span class="tpsl-pos-pair" id="tpslPosPair">BTC-USD</span>
          <span class="tpsl-pos-type" id="tpslPosType">LONG</span>
        </div>
        <span class="tpsl-pos-size" id="tpslPosSize">Size: 0</span>
      </div>

      <!-- Tabs -->
      <div class="tpsl-tabs">
        <div class="tpsl-tab active" id="tpslTabFull" data-tab="full">Full Position</div>
        <div class="tpsl-tab" id="tpslTabPartial" data-tab="partial">Partial</div>
      </div>

      <!-- Full Position Tab -->
      <div class="tpsl-tab-content active" id="tpslContentFull">
        <div class="tpsl-input-group">
          <label class="tpsl-input-label" id="tpslPriceLabelFull">Trigger Price</label>
          <input type="number" class="tpsl-price-input" id="tpslPriceInputFull" placeholder="Enter price..." step="any">
          <div class="tpsl-input-hint neutral" id="tpslHintFull">Enter a trigger price</div>
        </div>
        <div class="tpsl-pnl-preview">
          <div class="tpsl-pnl-item">
            <span class="tpsl-pnl-label">Est. PnL</span>
            <span class="tpsl-pnl-value" id="tpslPnlFull" style="color:var(--muted)">--</span>
          </div>
          <div class="tpsl-pnl-item">
            <span class="tpsl-pnl-label">ROE</span>
            <span class="tpsl-pnl-value" id="tpslRoeFull" style="color:var(--muted)">--</span>
          </div>
        </div>
      </div>

      <!-- Partial Tab -->
      <div class="tpsl-tab-content" id="tpslContentPartial">
        <div class="tpsl-input-group">
          <label class="tpsl-input-label" id="tpslPriceLabelPartial">Trigger Price</label>
          <input type="number" class="tpsl-price-input" id="tpslPriceInputPartial" placeholder="Enter price..." step="any">
          <div class="tpsl-input-hint neutral" id="tpslHintPartial">Enter a trigger price</div>
        </div>
        <div class="tpsl-volume-section">
          <div class="tpsl-volume-header">
            <span class="tpsl-volume-label">Close Volume</span>
            <span class="tpsl-volume-val" id="tpslVolumeVal">25%</span>
          </div>
          <input type="range" class="tpsl-volume-slider" id="tpslVolumeSlider" min="5" max="95" step="5" value="25">
          <div class="tpsl-volume-marks">
            <span class="tpsl-volume-mark" data-vpct="10">10%</span>
            <span class="tpsl-volume-mark active" data-vpct="25">25%</span>
            <span class="tpsl-volume-mark" data-vpct="50">50%</span>
            <span class="tpsl-volume-mark" data-vpct="75">75%</span>
          </div>
          <div class="tpsl-volume-amount" id="tpslVolumeAmount">Amount: 0.00</div>
        </div>
        <div class="tpsl-pnl-preview">
          <div class="tpsl-pnl-item">
            <span class="tpsl-pnl-label">Est. PnL</span>
            <span class="tpsl-pnl-value" id="tpslPnlPartial" style="color:var(--muted)">--</span>
          </div>
          <div class="tpsl-pnl-item">
            <span class="tpsl-pnl-label">ROE</span>
            <span class="tpsl-pnl-value" id="tpslRoePartial" style="color:var(--muted)">--</span>
          </div>
        </div>
      </div>

      <!-- Existing Orders List -->
      <div class="tpsl-orders-section" id="tpslOrdersSection">
        <div class="tpsl-orders-header">
          <span class="tpsl-orders-title" id="tpslOrdersTitle">Active Orders</span>
          <span class="tpsl-orders-counter" id="tpslOrdersCounter">0/3</span>
        </div>
        <div id="tpslOrdersList">
          <div class="tpsl-no-orders">No orders set</div>
        </div>
      </div>

      <!-- Confirm Button -->
      <button class="tpsl-confirm-btn tp-confirm" id="tpslConfirmBtn" disabled>Set Take Profit</button>
    </div>
  </div>
</div>
<script>
// =====================================================
// === GLOBAL STATE ===
// =====================================================
const tg = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
if (tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#0B0E11'); tg.setBackgroundColor('#0B0E11'); }

const API = 'https://trade-sim-api.dialogs-media.ru/api';
let userId = tg?.initDataUnsafe?.user?.id || null;
let userName = tg?.initDataUnsafe?.user?.first_name || 'Trader';
let userPhoto = tg?.initDataUnsafe?.user?.photo_url || '';
let startParam = tg?.initDataUnsafe?.start_param || null;

const state = {
  balance: 10000,
  pair: 'BTC-USD',
  timeframe: 60,
  leverage: 10,
  positions: [],
  history: [],
  currentPrice: 0,
  previousPrice: 0,
  candleData: [],
  volumeData: [],
  chartInstance: null,
  candleSeries: null,
  volumeSeries: null,
  volumeChartInstance: null,
  volumeBarSeries: null,
  emaSeries: null,
  smaSeries: null,
  vwapSeries: null,
  indicators: { ema: false, sma: false, vwap: false, volume: false },
  wsPrice: null,
  wsTrades: null,
  priceInterval: null,
  updateInterval: null,
  drawingMode: null,
  drawings: [],
  drawingStart: null,
  balanceHidden: false,
  historyFilter: 'all',
  equityChart: null,
  equitySeries: null,
  calendarDate: new Date(),
  // TP/SL state
  tpslModal: { open: false, posId: null, mode: 'tp', tab: 'full' },
  // ads
  adsWatched: 0,
  adsToday: 0,
  adsLastDate: '',
  totalAdEarnings: 0,
  // referrals
  referrals: [],
  refLink: ''
};

// =====================================================
// === LOADER ===
// =====================================================
(function initLoader() {
  const bar = document.getElementById('loaderBar');
  const txt = document.getElementById('loaderText');
  let p = 0;
  const msgs = ['CONNECTING', 'LOADING MARKET DATA', 'SYNCING PORTFOLIO', 'READY'];
  const iv = setInterval(() => {
    p += Math.random() * 18 + 8;
    if (p > 100) p = 100;
    bar.style.width = p + '%';
    txt.textContent = msgs[Math.min(Math.floor(p / 30), msgs.length - 1)];
    if (p >= 100) {
      clearInterval(iv);
      setTimeout(() => document.getElementById('app-loader').classList.add('hidden'), 400);
    }
  }, 300);
})();

// =====================================================
// === NAVIGATION ===
// =====================================================
function showView(viewId) {
  document.querySelectorAll('.view-section').forEach(v => { v.classList.remove('active'); v.classList.add('hidden'); });
  const el = document.getElementById(viewId);
  if (el) { el.classList.remove('hidden'); el.classList.add('active'); }
}
document.getElementById('btnProfile').onclick = () => { updateProfile(); showView('view-profile'); };
document.getElementById('btnCloseProfile').onclick = () => showView('view-trade');
document.getElementById('btnGoRewards').onclick = () => { updateRewardsView(); showView('view-rewards'); };
document.getElementById('btnBackFromRewards').onclick = () => { updateProfile(); showView('view-profile'); };

// =====================================================
// === PAIR DROPDOWN ===
// =====================================================
const pairDropdown = document.getElementById('pairDropdown');
document.getElementById('pairTrigger').onclick = (e) => { e.stopPropagation(); pairDropdown.classList.toggle('open'); };
document.addEventListener('click', () => pairDropdown.classList.remove('open'));
document.querySelectorAll('.pair-item').forEach(item => {
  item.onclick = () => {
    const p = item.dataset.pair;
    if (p === state.pair) return;
    state.pair = p;
    document.getElementById('triggerText').textContent = p.replace('-', '/');
    document.querySelectorAll('.pair-item').forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('bookPairLabel').textContent = p;
    pairDropdown.classList.remove('open');
    loadChart();
    connectWS();
  };
});

// =====================================================
// === TIMEFRAME ===
// =====================================================
document.querySelectorAll('.tf-opt').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.tf-opt').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.timeframe = parseInt(btn.dataset.tf);
    loadChart();
  };
});

// =====================================================
// === LEVERAGE & MARGIN ===
// =====================================================
const levSlider = document.getElementById('leverageSlider');
const levText = document.getElementById('leverageValText');
const levChips = document.querySelectorAll('#leverageChips .chip');
levSlider.oninput = () => { state.leverage = parseInt(levSlider.value); levText.textContent = state.leverage + 'x'; levChips.forEach(c => c.classList.toggle('active', parseInt(c.dataset.v) === state.leverage)); };
levChips.forEach(c => { c.onclick = () => { levSlider.value = c.dataset.v; levSlider.dispatchEvent(new Event('input')); }; });

const marginSlider = document.getElementById('marginSlider');
const marginText = document.getElementById('marginPercentText');
const marginMarks = document.querySelectorAll('.margin-mark');
marginSlider.oninput = () => {
  const pct = parseInt(marginSlider.value);
  marginText.textContent = pct + '%';
  const val = Math.floor(state.balance * pct / 100);
  document.getElementById('sizeInput').value = val > 0 ? val : '';
  updateSliderBg(marginSlider, pct, 100);
  marginMarks.forEach(m => m.classList.toggle('active', parseInt(m.dataset.pct) === pct));
};
marginMarks.forEach(m => { m.onclick = () => { marginSlider.value = m.dataset.pct; marginSlider.dispatchEvent(new Event('input')); }; });

function updateSliderBg(slider, val, max) {
  const pct = (val / max) * 100;
  slider.style.background = `linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) ${pct}%, #2A2F36 ${pct}%, #2A2F36 100%)`;
}
levSlider.addEventListener('input', () => updateSliderBg(levSlider, levSlider.value, 50));
updateSliderBg(levSlider, 10, 50);

// =====================================================
// === CHART ===
// =====================================================
let chartEl, volChartEl;
function initChart() {
  chartEl = document.getElementById('chart');
  volChartEl = document.getElementById('volumeChart');
  state.chartInstance = LightweightCharts.createChart(chartEl, getChartOpts(chartEl));
  state.candleSeries = state.chartInstance.addCandlestickSeries({ upColor: '#0ECB81', downColor: '#F6465D', borderUpColor: '#0ECB81', borderDownColor: '#F6465D', wickUpColor: '#0ECB81', wickDownColor: '#F6465D' });
  state.chartInstance.subscribeCrosshairMove(onCrosshairMove);
  window.addEventListener('resize', () => {
    if (state.chartInstance) state.chartInstance.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
    if (state.volumeChartInstance) state.volumeChartInstance.applyOptions({ width: volChartEl.clientWidth, height: volChartEl.clientHeight });
  });
}

function getChartOpts(el) {
  return {
    width: el.clientWidth, height: el.clientHeight,
    layout: { background: { color: '#111' }, textColor: '#848E9C', fontSize: 11, fontFamily: 'Roboto Mono' },
    grid: { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
    crosshair: { mode: 0, vertLine: { color: 'rgba(255,255,255,0.15)', width: 1, style: 2 }, horzLine: { color: 'rgba(255,255,255,0.15)', width: 1, style: 2, labelBackgroundColor: '#1E2329' } },
    timeScale: { borderColor: 'rgba(255,255,255,0.08)', timeVisible: true, secondsVisible: false },
    rightPriceScale: { borderColor: 'rgba(255,255,255,0.08)' },
    handleScroll: { vertTouchDrag: false }
  };
}

function showChartLoading(show) {
  document.getElementById('chartLoadingOverlay').classList.toggle('active', show);
}

async function loadChart() {
  showChartLoading(true);
  try {
    const sym = state.pair === 'BTC-USD' ? 'BTCUSDT' : 'ETHUSDT';
    const tfMap = { 60: '1m', 300: '5m', 900: '15m', 3600: '1h', 21600: '6h', 86400: '1d' };
    const interval = tfMap[state.timeframe] || '1m';
    const limit = 500;
    const resp = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${interval}&limit=${limit}`);
    const data = await resp.json();
    const candles = data.map(d => ({ time: Math.floor(d[0] / 1000), open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4]) }));
    const volumes = data.map(d => ({ time: Math.floor(d[0] / 1000), value: parseFloat(d[5]), color: parseFloat(d[4]) >= parseFloat(d[1]) ? 'rgba(14,203,129,0.4)' : 'rgba(246,70,93,0.4)' }));
    state.candleData = candles;
    state.volumeData = volumes;
    state.candleSeries.setData(candles);
    if (candles.length) {
      const last = candles[candles.length - 1];
      updatePrice(last.close);
    }
    updateIndicators();
    updateVolumeChart();
    state.chartInstance.timeScale().fitContent();
  } catch (e) { console.error('Chart load error:', e); }
  showChartLoading(false);
}

function updateVolumeChart() {
  const show = state.indicators.volume;
  const container = document.getElementById('volumeContainer');
  const chartCard = document.getElementById('chartCard');
  container.classList.toggle('visible', show);
  chartCard.classList.toggle('has-volume', show);
  if (show) {
    if (!state.volumeChartInstance) {
      state.volumeChartInstance = LightweightCharts.createChart(volChartEl, {
        ...getChartOpts(volChartEl), height: 60,
        rightPriceScale: { borderColor: 'rgba(255,255,255,0.08)', scaleMargins: { top: 0.1, bottom: 0 } },
        timeScale: { visible: false }
      });
      state.volumeBarSeries = state.volumeChartInstance.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: 'right' });
    }
    state.volumeBarSeries.setData(state.volumeData);
    state.volumeChartInstance.timeScale().fitContent();
    syncTimeScales();
  }
  setTimeout(() => {
    if (state.chartInstance) state.chartInstance.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
  }, 50);
}

function syncTimeScales() {
  if (!state.volumeChartInstance) return;
  state.chartInstance.timeScale().subscribeVisibleLogicalRangeChange(range => {
    if (range && state.volumeChartInstance) state.volumeChartInstance.timeScale().setVisibleLogicalRange(range);
  });
  state.volumeChartInstance.timeScale().subscribeVisibleLogicalRangeChange(range => {
    if (range && state.chartInstance) state.chartInstance.timeScale().setVisibleLogicalRange(range);
  });
}

// =====================================================
// === OHLC TOOLTIP ===
// =====================================================
function onCrosshairMove(param) {
  const tooltip = document.getElementById('ohlcTooltip');
  if (!param || !param.time || !param.seriesData) { tooltip.classList.remove('visible'); return; }
  const cd = param.seriesData.get(state.candleSeries);
  if (!cd) { tooltip.classList.remove('visible'); return; }
  const dp = state.pair === 'BTC-USD' ? 2 : 2;
  document.getElementById('ohlcOpen').textContent = cd.open?.toFixed(dp) ?? '-';
  document.getElementById('ohlcHigh').textContent = cd.high?.toFixed(dp) ?? '-';
  document.getElementById('ohlcLow').textContent = cd.low?.toFixed(dp) ?? '-';
  document.getElementById('ohlcClose').textContent = cd.close?.toFixed(dp) ?? '-';
  const cls = cd.close >= cd.open ? 'up' : 'down';
  ['ohlcOpen', 'ohlcHigh', 'ohlcLow', 'ohlcClose'].forEach(id => { const el = document.getElementById(id); el.className = 'ohlc-value ' + cls; });
  const vd = state.volumeData.find(v => v.time === cd.time);
  document.getElementById('ohlcVol').textContent = vd ? formatCompact(vd.value) : '-';
  tooltip.classList.add('visible');
}

function formatCompact(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toFixed(2);
}

// =====================================================
// === INDICATORS ===
// =====================================================
document.querySelectorAll('.indicator-chip').forEach(chip => {
  chip.onclick = () => {
    const ind = chip.dataset.indicator;
    state.indicators[ind] = !state.indicators[ind];
    chip.classList.toggle('active', state.indicators[ind]);
    if (ind === 'volume') { updateVolumeChart(); } else { updateIndicators(); }
  };
});

function updateIndicators() {
  // EMA
  if (state.indicators.ema) {
    if (!state.emaSeries) state.emaSeries = state.chartInstance.addLineSeries({ color: '#1E90FF', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
    state.emaSeries.setData(calcEMA(state.candleData, 20));
  } else if (state.emaSeries) { state.chartInstance.removeSeries(state.emaSeries); state.emaSeries = null; }
  // SMA
  if (state.indicators.sma) {
    if (!state.smaSeries) state.smaSeries = state.chartInstance.addLineSeries({ color: '#A855F7', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
    state.smaSeries.setData(calcSMA(state.candleData, 50));
  } else if (state.smaSeries) { state.chartInstance.removeSeries(state.smaSeries); state.smaSeries = null; }
  // VWAP
  if (state.indicators.vwap) {
    if (!state.vwapSeries) state.vwapSeries = state.chartInstance.addLineSeries({ color: '#F7931A', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
    state.vwapSeries.setData(calcVWAP(state.candleData, state.volumeData));
  } else if (state.vwapSeries) { state.chartInstance.removeSeries(state.vwapSeries); state.vwapSeries = null; }
}

function calcEMA(data, period) {
  const res = []; const k = 2 / (period + 1);
  let prev = null;
  for (const c of data) {
    if (prev === null) { prev = c.close; res.push({ time: c.time, value: c.close }); }
    else { prev = c.close * k + prev * (1 - k); res.push({ time: c.time, value: prev }); }
  }
  return res.slice(period - 1);
}

function calcSMA(data, period) {
  const res = [];
  for (let i = period - 1; i < data.length; i++) {
    let sum = 0;
    for (let j = i - period + 1; j <= i; j++) sum += data[j].close;
    res.push({ time: data[i].time, value: sum / period });
  }
  return res;
}

function calcVWAP(data, vol) {
  const res = []; let cumPV = 0, cumV = 0;
  for (let i = 0; i < data.length; i++) {
    const tp = (data[i].high + data[i].low + data[i].close) / 3;
    const v = vol[i] ? vol[i].value : 0;
    cumPV += tp * v; cumV += v;
    if (cumV > 0) res.push({ time: data[i].time, value: cumPV / cumV });
  }
  return res;
}

// =====================================================
// === DRAWING TOOLS ===
// =====================================================
const drawMenu = document.getElementById('drawingToolsMenu');
document.getElementById('drawingToolsToggle').onclick = () => drawMenu.classList.toggle('open');
document.querySelectorAll('.drawing-tool-btn').forEach(btn => {
  btn.onclick = () => {
    const tool = btn.dataset.tool;
    if (tool === 'clear') { state.drawings.forEach(d => { try { state.chartInstance.removeSeries(d); } catch(e){} }); state.drawings = []; return; }
    if (tool === 'cursor') { state.drawingMode = null; document.querySelectorAll('.drawing-tool-btn').forEach(b => b.classList.remove('active')); return; }
    state.drawingMode = tool;
    document.querySelectorAll('.drawing-tool-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  };
});

// =====================================================
// === WEBSOCKET ===
// =====================================================
function connectWS() {
  if (state.wsPrice) state.wsPrice.close();
  if (state.wsTrades) state.wsTrades.close();
  const sym = (state.pair === 'BTC-USD' ? 'btcusdt' : 'ethusdt');
  state.wsPrice = new WebSocket(`wss://stream.binance.com:9443/ws/${sym}@kline_1m`);
  state.wsPrice.onmessage = (e) => {
    const d = JSON.parse(e.data);
    if (d.k) {
      const k = d.k;
      const price = parseFloat(k.c);
      updatePrice(price);
      if (state.timeframe === 60 && state.candleSeries) {
        state.candleSeries.update({ time: Math.floor(k.t / 1000), open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: price });
      }
    }
  };
  state.wsTrades = new WebSocket(`wss://stream.binance.com:9443/ws/${sym}@trade`);
  state.wsTrades.onmessage = (e) => {
    const d = JSON.parse(e.data);
    addTradeToHistory(parseFloat(d.p), parseFloat(d.q), d.m);
  };
}

function updatePrice(price) {
  state.previousPrice = state.currentPrice;
  state.currentPrice = price;
  const dp = state.pair === 'BTC-USD' ? 2 : 2;
  const el = document.getElementById('priceDisplay');
  el.textContent = price.toFixed(dp);
  el.className = 'price-display ' + (price >= state.previousPrice ? 'text-green' : 'text-red');
  document.getElementById('headerBalance').textContent = state.balance.toFixed(2) + ' VP';
  updatePositionsPnL();
  checkTPSL();
}

// =====================================================
// === ORDER BOOK & TRADES ===
// =====================================================
function generateOrderBook() {
  if (!state.currentPrice) return;
  const book = document.getElementById('orderBook');
  const dp = state.pair === 'BTC-USD' ? 2 : 2;
  let html = '';
  const asks = [];
  for (let i = 8; i >= 1; i--) {
    const p = state.currentPrice + (Math.random() * 0.001 * state.currentPrice * i);
    const a = (Math.random() * 2 + 0.01).toFixed(4);
    asks.push({ p, a });
  }
  asks.sort((a, b) => b.p - a.p);
  for (const ask of asks) {
    const w = Math.random() * 80 + 10;
    html += `<div class="ob-row"><div class="ob-bg bg-red" style="width:${w}%"></div><span class="text-red">${ask.p.toFixed(dp)}</span><span>${ask.a}</span></div>`;
  }
  html += `<div class="ob-row" style="height:28px; font-size:14px; font-weight:700; justify-items:center;"><span class="${state.currentPrice >= state.previousPrice ? 'text-green' : 'text-red'}" style="grid-column:1/-1; text-align:center;">${state.currentPrice.toFixed(dp)}</span></div>`;
  for (let i = 1; i <= 8; i++) {
    const p = state.currentPrice - (Math.random() * 0.001 * state.currentPrice * i);
    const a = (Math.random() * 2 + 0.01).toFixed(4);
    const w = Math.random() * 80 + 10;
    html += `<div class="ob-row"><div class="ob-bg bg-green" style="width:${w}%"></div><span class="text-green">${p.toFixed(dp)}</span><span>${a}</span></div>`;
  }
  book.innerHTML = html;
  document.getElementById('bookUpdated').textContent = new Date().toLocaleTimeString();
}

const tradeBuffer = [];
function addTradeToHistory(price, qty, isSell) {
  const dp = state.pair === 'BTC-USD' ? 2 : 2;
  const t = new Date();
  tradeBuffer.unshift({ price, qty, isSell, time: t });
  if (tradeBuffer.length > 20) tradeBuffer.length = 20;
  const el = document.getElementById('tradeHistory');
  let html = '';
  for (const tr of tradeBuffer) {
    const cls = tr.isSell ? 'text-red' : 'text-green';
    html += `<div class="ob-row"><span class="${cls}">${tr.price.toFixed(dp)}</span><span class="trade-time">${tr.time.toLocaleTimeString()}</span></div>`;
  }
  el.innerHTML = html;
}

// =====================================================
// === OPEN POSITION ===
// =====================================================
document.getElementById('openLong').onclick = () => openPosition('long');
document.getElementById('openShort').onclick = () => openPosition('short');

function openPosition(type) {
  const size = parseFloat(document.getElementById('sizeInput').value);
  if (!size || size < 10 || size > state.balance) { showToast('Invalid margin amount'); return; }
  const pos = {
    id: Date.now().toString(36) + Math.random().toString(36).substr(2, 4),
    pair: state.pair,
    type,
    margin: size,
    leverage: state.leverage,
    size: size * state.leverage,
    entry: state.currentPrice,
    openTime: new Date(),
    pnl: 0,
    roe: 0,
    tp: [],  // array of {price, volumePct, id}
    sl: []   // array of {price, volumePct, id}
  };
  state.balance -= size;
  state.positions.push(pos);
  renderPositions();
  updateHeaderBalance();
  saveState();
  showToast(`${type.toUpperCase()} opened: ${pos.pair} @ ${pos.entry.toFixed(2)}`);
}

// =====================================================
// === TP/SL SYSTEM ===
// =====================================================
const MAX_TPSL_ORDERS = 3;

function openTPSLModal(posId, mode) {
  const pos = state.positions.find(p => p.id === posId);
  if (!pos) return;

  state.tpslModal = { open: true, posId, mode, tab: 'full' };

  // Title
  const titleIcon = document.getElementById('tpslTitleIcon');
  const titleText = document.getElementById('tpslTitleText');
  const confirmBtn = document.getElementById('tpslConfirmBtn');

  if (mode === 'tp') {
    titleIcon.className = 'tpsl-title-icon tp-icon';
    titleText.textContent = 'Take Profit';
    confirmBtn.className = 'tpsl-confirm-btn tp-confirm';
    confirmBtn.textContent = 'Set Take Profit';
  } else {
    titleIcon.className = 'tpsl-title-icon sl-icon';
    titleText.textContent = 'Stop Loss';
    confirmBtn.className = 'tpsl-confirm-btn sl-confirm';
    confirmBtn.textContent = 'Set Stop Loss';
  }

  // Position info
  document.getElementById('tpslPosPair').textContent = pos.pair;
  const typeEl = document.getElementById('tpslPosType');
  typeEl.textContent = pos.type.toUpperCase();
  typeEl.className = 'tpsl-pos-type ' + pos.type;
  document.getElementById('tpslPosSize').textContent = `Size: ${pos.size.toFixed(2)}`;

  // Reset tabs
  document.getElementById('tpslTabFull').classList.add('active');
  document.getElementById('tpslTabPartial').classList.remove('active');
  document.getElementById('tpslContentFull').classList.add('active');
  document.getElementById('tpslContentPartial').classList.remove('active');

  // Reset inputs
  document.getElementById('tpslPriceInputFull').value = '';
  document.getElementById('tpslPriceInputPartial').value = '';
  document.getElementById('tpslVolumeSlider').value = 25;
  document.getElementById('tpslVolumeVal').textContent = '25%';
  updateTPSLVolumeAmount(pos);

  // Reset hints
  setTPSLHint('tpslHintFull', 'neutral', 'Enter a trigger price');
  setTPSLHint('tpslHintPartial', 'neutral', 'Enter a trigger price');

  // Reset PnL previews
  ['tpslPnlFull', 'tpslRoeFull', 'tpslPnlPartial', 'tpslRoePartial'].forEach(id => {
    const el = document.getElementById(id);
    el.textContent = '--';
    el.style.color = 'var(--muted)';
  });

  confirmBtn.disabled = true;

  // Render existing orders
  renderTPSLOrders(pos, mode);

  // Show modal
  document.getElementById('tpslModalOverlay').classList.add('active');
}

function closeTPSLModal() {
  state.tpslModal.open = false;
  document.getElementById('tpslModalOverlay').classList.remove('active');
}

document.getElementById('tpslModalClose').onclick = closeTPSLModal;
document.getElementById('tpslModalOverlay').onclick = (e) => { if (e.target === document.getElementById('tpslModalOverlay')) closeTPSLModal(); };

// Tabs
document.querySelectorAll('.tpsl-tab').forEach(tab => {
  tab.onclick = () => {
    const t = tab.dataset.tab;
    state.tpslModal.tab = t;
    document.querySelectorAll('.tpsl-tab').forEach(tt => tt.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tpsl-tab-content').forEach(tc => tc.classList.remove('active'));
    document.getElementById(t === 'full' ? 'tpslContentFull' : 'tpslContentPartial').classList.add('active');
    validateTPSLInput();
  };
});

// Volume slider
const tpslVolSlider = document.getElementById('tpslVolumeSlider');
tpslVolSlider.oninput = () => {
  const v = parseInt(tpslVolSlider.value);
  document.getElementById('tpslVolumeVal').textContent = v + '%';
  updateSliderBg(tpslVolSlider, v, 95);
  const pos = state.positions.find(p => p.id === state.tpslModal.posId);
  if (pos) updateTPSLVolumeAmount(pos);
  document.querySelectorAll('.tpsl-volume-mark').forEach(m => m.classList.toggle('active', parseInt(m.dataset.vpct) === v));
  validateTPSLInput();
};
document.querySelectorAll('.tpsl-volume-mark').forEach(m => {
  m.onclick = () => { tpslVolSlider.value = m.dataset.vpct; tpslVolSlider.dispatchEvent(new Event('input')); };
});

function updateTPSLVolumeAmount(pos) {
  const pct = parseInt(tpslVolSlider.value);
  const amount = pos.size * pct / 100;
  document.getElementById('tpslVolumeAmount').textContent = `Amount: ${amount.toFixed(2)}`;
}

// Price input validation
document.getElementById('tpslPriceInputFull').oninput = () => validateTPSLInput();
document.getElementById('tpslPriceInputPartial').oninput = () => validateTPSLInput();

function validateTPSLInput() {
  const pos = state.positions.find(p => p.id === state.tpslModal.posId);
  if (!pos) return;
  const mode = state.tpslModal.mode;
  const tab = state.tpslModal.tab;
  const inputId = tab === 'full' ? 'tpslPriceInputFull' : 'tpslPriceInputPartial';
  const hintId = tab === 'full' ? 'tpslHintFull' : 'tpslHintPartial';
  const pnlId = tab === 'full' ? 'tpslPnlFull' : 'tpslPnlPartial';
  const roeId = tab === 'full' ? 'tpslRoeFull' : 'tpslRoePartial';

  const price = parseFloat(document.getElementById(inputId).value);
  const confirmBtn = document.getElementById('tpslConfirmBtn');
  const existingOrders = mode === 'tp' ? pos.tp : pos.sl;

  if (existingOrders.length >= MAX_TPSL_ORDERS) {
    setTPSLHint(hintId, 'error', `Max ${MAX_TPSL_ORDERS} orders reached. Delete one first.`);
    confirmBtn.disabled = true;
    return;
  }

  if (!price || isNaN(price) || price <= 0) {
    setTPSLHint(hintId, 'neutral', 'Enter a trigger price');
    document.getElementById(pnlId).textContent = '--';
    document.getElementById(pnlId).style.color = 'var(--muted)';
    document.getElementById(roeId).textContent = '--';
    document.getElementById(roeId).style.color = 'var(--muted)';
    confirmBtn.disabled = true;
    return;
  }

  // Validate direction
  let valid = true;
  let hint = '';
  if (mode === 'tp') {
    if (pos.type === 'long' && price <= pos.entry) { valid = false; hint = 'TP must be above entry for Long'; }
    if (pos.type === 'short' && price >= pos.entry) { valid = false; hint = 'TP must be below entry for Short'; }
  } else {
    if (pos.type === 'long' && price >= pos.entry) { valid = false; hint = 'SL must be below entry for Long'; }
    if (pos.type === 'short' && price <= pos.entry) { valid = false; hint = 'SL must be above entry for Short'; }
  }

  if (!valid) {
    setTPSLHint(hintId, 'error', hint);
    document.getElementById(pnlId).textContent = '--';
    document.getElementById(pnlId).style.color = 'var(--muted)';
    document.getElementById(roeId).textContent = '--';
    document.getElementById(roeId).style.color = 'var(--muted)';
    confirmBtn.disabled = true;
    return;
  }

  // Calculate preview PnL
  const volumePct = tab === 'partial' ? parseInt(tpslVolSlider.value) : 100;
  const sizeForCalc = pos.size * volumePct / 100;
  const marginForCalc = pos.margin * volumePct / 100;
  let pnl;
  if (pos.type === 'long') { pnl = (price - pos.entry) / pos.entry * sizeForCalc; }
  else { pnl = (pos.entry - price) / pos.entry * sizeForCalc; }
  const roe = marginForCalc > 0 ? (pnl / marginForCalc * 100) : 0;

  const pnlEl = document.getElementById(pnlId);
  const roeEl = document.getElementById(roeId);
  pnlEl.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' VP';
  pnlEl.style.color = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
  roeEl.textContent = (roe >= 0 ? '+' : '') + roe.toFixed(2) + '%';
  roeEl.style.color = roe >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

  const dist = Math.abs((price - state.currentPrice) / state.currentPrice * 100);
  setTPSLHint(hintId, 'valid', `Distance from market: ${dist.toFixed(2)}%`);
  confirmBtn.disabled = false;
}

function setTPSLHint(id, cls, text) {
  const el = document.getElementById(id);
  el.className = 'tpsl-input-hint ' + cls;
  el.textContent = text;
}

function renderTPSLOrders(pos, mode) {
  const orders = mode === 'tp' ? pos.tp : pos.sl;
  const listEl = document.getElementById('tpslOrdersList');
  const counterEl = document.getElementById('tpslOrdersCounter');
  const titleEl = document.getElementById('tpslOrdersTitle');

  titleEl.textContent = mode === 'tp' ? 'Active TP Orders' : 'Active SL Orders';
  counterEl.textContent = `${orders.length}/${MAX_TPSL_ORDERS}`;
  counterEl.classList.toggle('limit', orders.length >= MAX_TPSL_ORDERS);

  if (!orders.length) {
    listEl.innerHTML = '<div class="tpsl-no-orders">No orders set</div>';
    return;
  }

  let html = '';
  for (const order of orders) {
    const volLabel = order.volumePct === 100 ? 'Full' : `${order.volumePct}%`;
    const sizeForCalc = pos.size * order.volumePct / 100;
    const marginForCalc = pos.margin * order.volumePct / 100;
    let pnl;
    if (pos.type === 'long') { pnl = (order.price - pos.entry) / pos.entry * sizeForCalc; }
    else { pnl = (pos.entry - order.price) / pos.entry * sizeForCalc; }
    const pnlCls = pnl >= 0 ? 'positive' : 'negative';

    html += `
      <div class="tpsl-order-card">
        <div class="tpsl-order-card-left">
          <div class="tpsl-order-card-price">${order.price.toFixed(2)}</div>
          <div class="tpsl-order-card-meta">
            <span>${volLabel}</span>
            <span>•</span>
            <span class="tpsl-order-card-pnl ${pnlCls}">${(pnl >= 0 ? '+' : '') + pnl.toFixed(2)} VP</span>
          </div>
        </div>
        <div class="tpsl-order-delete" onclick="deleteTPSLOrder('${pos.id}','${mode}','${order.id}')">✕</div>
      </div>
    `;
  }
  listEl.innerHTML = html;
}

// Confirm TP/SL
document.getElementById('tpslConfirmBtn').onclick = () => {
  const { posId, mode, tab } = state.tpslModal;
  const pos = state.positions.find(p => p.id === posId);
  if (!pos) return;

  const orders = mode === 'tp' ? pos.tp : pos.sl;
  if (orders.length >= MAX_TPSL_ORDERS) { showToast(`Max ${MAX_TPSL_ORDERS} ${mode.toUpperCase()} orders`); return; }

  const inputId = tab === 'full' ? 'tpslPriceInputFull' : 'tpslPriceInputPartial';
  const price = parseFloat(document.getElementById(inputId).value);
  if (!price || isNaN(price)) return;

  const volumePct = tab === 'partial' ? parseInt(tpslVolSlider.value) : 100;
  const orderId = Date.now().toString(36) + Math.random().toString(36).substr(2, 3);

  orders.push({ id: orderId, price, volumePct });

  renderTPSLOrders(pos, mode);
  renderPositions();
  saveState();

  // Reset input
  document.getElementById(inputId).value = '';
  validateTPSLInput();

  showToast(`${mode.toUpperCase()} set @ ${price.toFixed(2)} (${volumePct}%)`);
};

function deleteTPSLOrder(posId, mode, orderId) {
  const pos = state.positions.find(p => p.id === posId);
  if (!pos) return;
  const arr = mode === 'tp' ? pos.tp : pos.sl;
  const idx = arr.findIndex(o => o.id === orderId);
  if (idx >= 0) arr.splice(idx, 1);
  renderTPSLOrders(pos, mode);
  renderPositions();
  validateTPSLInput();
  saveState();
  showToast(`${mode.toUpperCase()} order removed`);
}

// =====================================================
// === CHECK TP/SL TRIGGER ===
// =====================================================
function checkTPSL() {
  const price = state.currentPrice;
  if (!price) return;

  const toRemove = [];

  for (const pos of state.positions) {
    // Check TP orders
    const triggeredTP = [];
    for (const tp of pos.tp) {
      let triggered = false;
      if (pos.type === 'long' && price >= tp.price) triggered = true;
      if (pos.type === 'short' && price <= tp.price) triggered = true;
      if (triggered) triggeredTP.push(tp);
    }
    for (const tp of triggeredTP) {
      executeTPSL(pos, tp, 'tp');
    }

    // Check SL orders
    const triggeredSL = [];
    for (const sl of pos.sl) {
      let triggered = false;
      if (pos.type === 'long' && price <= sl.price) triggered = true;
      if (pos.type === 'short' && price >= sl.price) triggered = true;
      if (triggered) triggeredSL.push(sl);
    }
    for (const sl of triggeredSL) {
      executeTPSL(pos, sl, 'sl');
    }
  }

  // Clean up fully closed positions
  state.positions = state.positions.filter(p => p.size > 0.01);
  renderPositions();
  saveState();
}

function executeTPSL(pos, order, type) {
  const price = state.currentPrice;
  const closePct = order.volumePct / 100;
  const closeSize = pos.size * closePct;
  const closeMargin = pos.margin * closePct;

  let pnl;
  if (pos.type === 'long') { pnl = (price - pos.entry) / pos.entry * closeSize; }
  else { pnl = (pos.entry - price) / pos.entry * closeSize; }

  state.balance += closeMargin + pnl;

  // Add to history
  state.history.unshift({
    pair: pos.pair, type: pos.type, entry: pos.entry, exit: price,
    leverage: pos.leverage, margin: closeMargin, size: closeSize,
    pnl, closeTime: new Date(), closedBy: type.toUpperCase()
  });

  // Reduce position
  pos.size -= closeSize;
  pos.margin -= closeMargin;

  // Remove the triggered order
  const arr = type === 'tp' ? pos.tp : pos.sl;
  const idx = arr.findIndex(o => o.id === order.id);
  if (idx >= 0) arr.splice(idx, 1);

  const label = type === 'tp' ? '🎯 TP Hit' : '🛑 SL Hit';
  showToast(`${label}: ${pos.pair} ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP`);
  updateHeaderBalance();

  // If modal is open for this position, update it
  if (state.tpslModal.open && state.tpslModal.posId === pos.id) {
    if (pos.size <= 0.01) { closeTPSLModal(); }
    else { renderTPSLOrders(pos, state.tpslModal.mode); }
  }
}

// =====================================================
// === POSITIONS ===
// =====================================================
function renderPositions() {
  const el = document.getElementById('positionsList');
  if (!state.positions.length) {
    el.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>';
    return;
  }
  let html = '';
  for (const pos of state.positions) {
    const dp = 2;
    const pnl = pos.pnl || 0;
    const roe = pos.roe || 0;
    const pnlCls = pnl >= 0 ? 'text-green' : 'text-red';
    const typeCls = pos.type === 'long' ? 'long' : 'short';
    const typeBg = pos.type === 'long' ? 'var(--accent-green-transparent)' : 'var(--accent-red-transparent)';
    const typeColor = pos.type === 'long' ? 'var(--accent-green)' : 'var(--accent-red)';
    const liqPrice = calcLiquidation(pos);
    const riskPct = calcRiskPercent(pos, liqPrice);
    const riskColor = riskPct < 50 ? 'var(--accent-green)' : riskPct < 80 ? '#F0B90B' : 'var(--accent-red)';

    let tpslSummaryHtml = '';
    if (pos.tp.length || pos.sl.length) {
      tpslSummaryHtml = '<div class="pos-tpsl-summary">';
      for (const tp of pos.tp) {
        const dist = ((tp.price - pos.entry) / pos.entry * 100 * (pos.type === 'long' ? 1 : -1)).toFixed(2);
        const volLabel = tp.volumePct === 100 ? '' : ` (${tp.volumePct}%)`;
        tpslSummaryHtml += `<div class="tpsl-summary-row tp-row"><span class="tpsl-summary-label">TP${volLabel}</span><span class="tpsl-summary-price">${tp.price.toFixed(dp)}</span><span class="tpsl-summary-pct">+${Math.abs(dist)}%</span></div>`;
      }
      for (const sl of pos.sl) {
        const dist = ((sl.price - pos.entry) / pos.entry * 100 * (pos.type === 'long' ? 1 : -1)).toFixed(2);
        const volLabel = sl.volumePct === 100 ? '' : ` (${sl.volumePct}%)`;
        tpslSummaryHtml += `<div class="tpsl-summary-row sl-row"><span class="tpsl-summary-label">SL${volLabel}</span><span class="tpsl-summary-price">${sl.price.toFixed(dp)}</span><span class="tpsl-summary-pct">${dist}%</span></div>`;
      }
      tpslSummaryHtml += '</div>';
    }

    html += `
      <div class="pos-item ${typeCls}">
        <div class="pos-header">
          <div>
            <span class="pos-pair">${pos.pair}</span>
            <span class="pos-type-badge" style="background:${typeBg}; color:${typeColor}; font-size:11px;">${pos.type.toUpperCase()} ${pos.leverage}x</span>
          </div>
          <span class="${pnlCls}" style="font-family:'Roboto Mono'; font-weight:700; font-size:16px;">
            ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP
          </span>
        </div>
        <div class="pos-stats-grid">
          <div class="stat-col">
            <span class="stat-label">ROE</span>
            <span class="stat-val ${pnlCls}">${roe >= 0 ? '+' : ''}${roe.toFixed(2)}%</span>
          </div>
          <div class="stat-col">
            <span class="stat-label">Size</span>
            <span class="stat-val">${pos.size.toFixed(2)}</span>
          </div>
          <div class="stat-col">
            <span class="stat-label">Margin</span>
            <span class="stat-val">${pos.margin.toFixed(2)}</span>
          </div>
        </div>
        <div class="risk-wrap">
          <div class="risk-track"><div class="risk-fill" style="width:${Math.min(riskPct, 100)}%; background:${riskColor};"></div></div>
        </div>
        <div class="pos-details">
          <div class="pd-col"><span class="pd-label">Entry</span><span class="pd-val">${pos.entry.toFixed(dp)}</span></div>
          <div class="pd-col"><span class="pd-label">Market</span><span class="pd-val">${state.currentPrice.toFixed(dp)}</span></div>
          <div class="pd-col"><span class="pd-label">Liq. Price</span><span class="pd-val" style="color:var(--accent-red)">${liqPrice.toFixed(dp)}</span></div>
        </div>
        ${tpslSummaryHtml}
        <div class="pos-tpsl-actions">
          <button class="btn-tpsl tp" onclick="openTPSLModal('${pos.id}','tp')">
            <span class="tpsl-icon">🎯</span>
            <span>Take Profit</span>
            ${pos.tp.length ? `<span class="tpsl-count">${pos.tp.length}</span>` : ''}
          </button>
          <button class="btn-tpsl sl" onclick="openTPSLModal('${pos.id}','sl')">
            <span class="tpsl-icon">🛡</span>
            <span>Stop Loss</span>
            ${pos.sl.length ? `<span class="tpsl-count">${pos.sl.length}</span>` : ''}
          </button>
        </div>
        <button class="close-btn" onclick="closePosition('${pos.id}')">Close Position</button>
      </div>
    `;
  }
  el.innerHTML = html;
}

function updatePositionsPnL() {
  for (const pos of state.positions) {
    if (pos.type === 'long') { pos.pnl = (state.currentPrice - pos.entry) / pos.entry * pos.size; }
    else { pos.pnl = (pos.entry - state.currentPrice) / pos.entry * pos.size; }
    pos.roe = pos.margin > 0 ? (pos.pnl / pos.margin * 100) : 0;

    // Auto-liquidation
    const liq = calcLiquidation(pos);
    const liquidated = pos.type === 'long' ? state.currentPrice <= liq : state.currentPrice >= liq;
    if (liquidated) { liquidatePosition(pos.id); }
  }
  renderPositions();
}

function calcLiquidation(pos) {
  if (pos.type === 'long') return pos.entry * (1 - 1 / pos.leverage * 0.95);
  return pos.entry * (1 + 1 / pos.leverage * 0.95);
}

function calcRiskPercent(pos, liq) {
  const dist = Math.abs(state.currentPrice - liq);
  const total = Math.abs(pos.entry - liq);
  if (total === 0) return 100;
  return Math.max(0, (1 - dist / total) * 100);
}

function closePosition(id) {
  const idx = state.positions.findIndex(p => p.id === id);
  if (idx < 0) return;
  const pos = state.positions[idx];
  const pnl = pos.pnl;
  state.balance += pos.margin + pnl;
  state.history.unshift({
    pair: pos.pair, type: pos.type, entry: pos.entry, exit: state.currentPrice,
    leverage: pos.leverage, margin: pos.margin, size: pos.size,
    pnl, closeTime: new Date(), closedBy: 'Manual'
  });
  state.positions.splice(idx, 1);
  renderPositions();
  updateHeaderBalance();
  saveState();
  showToast(`Closed: ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP`);
  if (state.tpslModal.open && state.tpslModal.posId === id) closeTPSLModal();
}

function liquidatePosition(id) {
  const idx = state.positions.findIndex(p => p.id === id);
  if (idx < 0) return;
  const pos = state.positions[idx];
  state.history.unshift({
    pair: pos.pair, type: pos.type, entry: pos.entry, exit: state.currentPrice,
    leverage: pos.leverage, margin: pos.margin, size: pos.size,
    pnl: -pos.margin, closeTime: new Date(), closedBy: 'Liquidation'
  });
  state.positions.splice(idx, 1);
  renderPositions();
  updateHeaderBalance();
  saveState();
  showToast('💀 Position liquidated!');
  if (state.tpslModal.open && state.tpslModal.posId === id) closeTPSLModal();
}

// =====================================================
// === PROFILE ===
// =====================================================
function updateHeaderBalance() {
  const total = state.balance + state.positions.reduce((s, p) => s + p.margin + p.pnl, 0);
  document.getElementById('headerBalance').textContent = total.toFixed(2) + ' VP';
}

function updateProfile() {
  document.getElementById('profileName').textContent = userName;
  document.getElementById('profileId').textContent = 'ID: ' + (userId || '---');
  if (userPhoto) {
    document.getElementById('profileAvatarBig').src = userPhoto;
    document.getElementById('avatarImg').src = userPhoto;
    document.getElementById('avatarImg').style.display = 'block';
  }
  const total = state.balance + state.positions.reduce((s, p) => s + p.margin + p.pnl, 0);
  if (state.balanceHidden) {
    document.getElementById('profileBalance').textContent = '••••••';
    document.getElementById('profileBalanceApprox').textContent = '≈ ••••••';
  } else {
    document.getElementById('profileBalance').textContent = total.toFixed(2);
    document.getElementById('profileBalanceApprox').textContent = '≈ $' + (total * 0.005).toFixed(2);
  }
  const initBal = 10000;
  const pnlPct = ((total - initBal) / initBal * 100);
  const pill = document.getElementById('profilePnlPill');
  pill.textContent = (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%';
  pill.className = 'asset-pnl ' + (pnlPct >= 0 ? 'text-green' : 'text-red');

  // Win rate
  const wins = state.history.filter(h => h.pnl > 0).length;
  const total_t = state.history.length;
  const wr = total_t > 0 ? (wins / total_t * 100) : 0;
  document.getElementById('winRateVal').textContent = wr.toFixed(0) + '%';
  document.getElementById('totalTradesVal').textContent = total_t + ' Trades';
  document.getElementById('winRateChart').style.background = `conic-gradient(var(--accent-green) 0% ${wr}%, var(--panel-light) ${wr}% 100%)`;

  // Net PnL
  const netPnl = state.history.reduce((s, h) => s + h.pnl, 0);
  const pnlEl = document.getElementById('statPnL');
  pnlEl.textContent = (netPnl >= 0 ? '+' : '') + netPnl.toFixed(2);
  pnlEl.style.color = netPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

  renderHistory();
  loadReferrals();
}

document.getElementById('btnToggleBalance').onclick = () => {
  state.balanceHidden = !state.balanceHidden;
  updateProfile();
};

// =====================================================
// === HISTORY ===
// =====================================================
document.querySelectorAll('.h-filter').forEach(f => {
  f.onclick = () => {
    document.querySelectorAll('.h-filter').forEach(ff => ff.classList.remove('active'));
    f.classList.add('active');
    state.historyFilter = f.dataset.filter;
    renderHistory();
  };
});

function renderHistory() {
  const el = document.getElementById('historyList');
  let list = [...state.history];
  const now = Date.now();
  if (state.historyFilter === 'day') list = list.filter(h => now - new Date(h.closeTime).getTime() < 86400000);
  if (state.historyFilter === 'week') list = list.filter(h => now - new Date(h.closeTime).getTime() < 604800000);
  if (!list.length) {
    el.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history</div>';
    return;
  }
  let html = '';
  for (const h of list.slice(0, 50)) {
    const pnlCls = h.pnl >= 0 ? 'text-green' : 'text-red';
    const typeCls = h.type === 'long' ? 'long' : 'short';
    const closedLabel = h.closedBy ? ` (${h.closedBy})` : '';
    html += `
      <div class="history-card">
        <div class="hc-header">
          <span class="hc-pair">${h.pair}</span>
          <span class="hc-type ${typeCls}">${h.type.toUpperCase()} ${h.leverage}x</span>
        </div>
        <div class="hc-row"><span>Entry</span><span class="hc-val">${h.entry.toFixed(2)}</span></div>
        <div class="hc-row"><span>Exit${closedLabel}</span><span class="hc-val">${h.exit.toFixed(2)}</span></div>
        <div class="hc-row"><span>Margin</span><span class="hc-val">${h.margin.toFixed(2)}</span></div>
        <div class="hc-row"><span>PnL</span><span class="hc-pnl ${pnlCls}">${h.pnl >= 0 ? '+' : ''}${h.pnl.toFixed(2)} VP</span></div>
        <div style="font-size:10px; color:var(--muted); text-align:right;">${new Date(h.closeTime).toLocaleString()}</div>
      </div>
    `;
  }
  el.innerHTML = html;
}

// =====================================================
// === PNL MODAL (statistics) ===
// =====================================================
document.getElementById('netPnlCard').onclick = () => openPnlModal();
document.getElementById('pnlModalClose').onclick = () => document.getElementById('pnlModalOverlay').classList.remove('active');
document.getElementById('pnlModalOverlay').onclick = (e) => { if (e.target.id === 'pnlModalOverlay') document.getElementById('pnlModalOverlay').classList.remove('active'); };

function openPnlModal() {
  document.getElementById('pnlModalOverlay').classList.add('active');
  const hist = state.history;
  // Avg RR
  const wins = hist.filter(h => h.pnl > 0);
  const losses = hist.filter(h => h.pnl < 0);
  const avgWin = wins.length ? wins.reduce((s, h) => s + h.pnl, 0) / wins.length : 0;
  const avgLoss = losses.length ? Math.abs(losses.reduce((s, h) => s + h.pnl, 0) / losses.length) : 0;
  document.getElementById('modalAvgRR').textContent = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : '--';

  // Max DD
  let peak = 10000, maxDD = 0, equity = 10000;
  for (const h of [...hist].reverse()) {
    equity += h.pnl;
    if (equity > peak) peak = equity;
    const dd = (peak - equity) / peak * 100;
    if (dd > maxDD) maxDD = dd;
  }
  document.getElementById('modalMaxDD').textContent = '-' + maxDD.toFixed(2) + '%';

  // Profit factor
  const grossProfit = wins.reduce((s, h) => s + h.pnl, 0);
  const grossLoss = Math.abs(losses.reduce((s, h) => s + h.pnl, 0));
  document.getElementById('modalProfitFactor').textContent = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : '--';

  // Avg trade
  const avgTrade = hist.length ? hist.reduce((s, h) => s + h.pnl, 0) / hist.length : 0;
  const atEl = document.getElementById('modalAvgTrade');
  atEl.textContent = (avgTrade >= 0 ? '+' : '') + avgTrade.toFixed(2);
  atEl.className = 'stats-metric-value ' + (avgTrade >= 0 ? 'positive' : 'negative');

  renderEquityChart();
  renderCalendar();
}

// Equity chart
document.querySelectorAll('#equityPeriodSelector .period-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#equityPeriodSelector .period-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderEquityChart(btn.dataset.period);
  };
});

function renderEquityChart(period = '7d') {
  const container = document.getElementById('equityChartContainer');
  if (state.equityChart) { state.equityChart.remove(); state.equityChart = null; }

  state.equityChart = LightweightCharts.createChart(container, {
    width: container.clientWidth, height: 160,
    layout: { background: { color: 'transparent' }, textColor: '#848E9C', fontSize: 10, fontFamily: 'Roboto Mono' },
    grid: { vertLines: { visible: false }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
    rightPriceScale: { borderColor: 'rgba(255,255,255,0.08)' },
    timeScale: { borderColor: 'rgba(255,255,255,0.08)', timeVisible: true },
    crosshair: { mode: 0 }, handleScroll: { vertTouchDrag: false }
  });

  state.equitySeries = state.equityChart.addAreaSeries({
    topColor: 'rgba(14, 203, 129, 0.3)', bottomColor: 'rgba(14, 203, 129, 0.02)',
    lineColor: '#0ECB81', lineWidth: 2, priceLineVisible: false
  });

  let data = [];
  let eq = 10000;
  const hist = [...state.history].reverse();
  const now = Date.now();
  const periodMs = { '7d': 7 * 86400000, '30d': 30 * 86400000, '90d': 90 * 86400000, 'all': Infinity };
  const cutoff = now - (periodMs[period] || Infinity);

  for (const h of hist) {
    const t = new Date(h.closeTime).getTime();
    if (t < cutoff) continue;
    eq += h.pnl;
    data.push({ time: Math.floor(t / 1000), value: eq });
  }
  if (!data.length) data = [{ time: Math.floor(now / 1000), value: 10000 }];
  state.equitySeries.setData(data);
  state.equityChart.timeScale().fitContent();
}

// Calendar
document.getElementById('calendarPrev').onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); renderCalendar(); };
document.getElementById('calendarNext').onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); renderCalendar(); };

function renderCalendar() {
  const d = state.calendarDate;
  const year = d.getFullYear(), month = d.getMonth();
  document.getElementById('calendarMonthLabel').textContent = new Date(year, month).toLocaleString('en', { month: 'long', year: 'numeric' });

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const offset = (firstDay + 6) % 7;

  // Group PnL by day
  const dayPnl = {};
  for (const h of state.history) {
    const ct = new Date(h.closeTime);
    if (ct.getFullYear() === year && ct.getMonth() === month) {
      const day = ct.getDate();
      dayPnl[day] = (dayPnl[day] || 0) + h.pnl;
    }
  }

  const maxAbs = Math.max(1, ...Object.values(dayPnl).map(Math.abs));
  const today = new Date();
  const grid = document.getElementById('calendarGrid');
  let html = '';
  for (let i = 0; i < offset; i++) html += '<div class="calendar-cell empty"></div>';
  for (let day = 1; day <= daysInMonth; day++) {
    const pnl = dayPnl[day] || 0;
    let cls = '';
    if (pnl > 0) { cls = 'profit' + (Math.abs(pnl) / maxAbs > 0.5 ? ' high' : ''); }
    else if (pnl < 0) { cls = 'loss' + (Math.abs(pnl) / maxAbs > 0.5 ? ' high' : ''); }
    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
    html += `<div class="calendar-cell ${cls} ${isToday ? 'today' : ''}" title="${pnl !== 0 ? (pnl > 0 ? '+' : '') + pnl.toFixed(2) + ' VP' : 'No trades'}">${day}</div>`;
  }
  grid.innerHTML = html;
}

// =====================================================
// === REWARDS / ADS ===
// =====================================================
let adController = null;
try { adController = window.Adsgram ? Adsgram.init({ blockId: '5765' }) : null; } catch(e) {}

function updateRewardsView() {
  document.getElementById('totalAdsWatched').textContent = state.adsWatched;
  document.getElementById('totalEarnedFromAds').textContent = state.totalAdEarnings;
  const todayStr = new Date().toDateString();
  if (state.adsLastDate !== todayStr) { state.adsToday = 0; state.adsLastDate = todayStr; }
  const counter = document.getElementById('dailyAdCounter');
  counter.textContent = `${state.adsToday}/5 today`;
  counter.classList.toggle('limit-reached', state.adsToday >= 5);
  document.getElementById('btnWatchAd').disabled = state.adsToday >= 5;
  const level = Math.floor(state.adsWatched / 10) + 1;
  document.getElementById('currentLevelText').textContent = 'Level ' + level;
  const progress = (state.adsWatched % 10);
  document.getElementById('adsProgressText').textContent = `${progress} / 10 Ads`;
  document.getElementById('adsProgressBar').style.width = (progress * 10) + '%';
}

document.getElementById('btnWatchAd').onclick = async () => {
  if (state.adsToday >= 5) return;
  const btn = document.getElementById('btnWatchAd');
  btn.classList.add('loading');
  try {
    if (adController) { await adController.show(); }
    state.adsWatched++;
    state.adsToday++;
    state.totalAdEarnings++;
    state.balance += 1;
    updateRewardsView();
    updateHeaderBalance();
    saveState();
    showToast('+1 VP earned!');
  } catch(e) { showToast('Ad not available'); }
  btn.classList.remove('loading');
};

// =====================================================
// === REFERRALS ===
// =====================================================
async function loadReferrals() {
  if (!userId) {
    document.getElementById('refLinkInput').value = 'Login via Telegram';
    document.getElementById('refStatus').textContent = 'Login via Telegram to use referrals';
    return;
  }
  const link = `https://t.me/TradeSim_real_bot?start=ref_${userId}`;
  state.refLink = link;
  document.getElementById('refLinkInput').value = link;
  try {
    const resp = await fetch(`${API}/referrals?user_id=${userId}`);
    if (resp.ok) {
      const data = await resp.json();
      state.referrals = data.referrals || [];
      document.getElementById('refCountBadge').textContent = 'Invited: ' + state.referrals.length;
      const listEl = document.getElementById('refList');
      if (!state.referrals.length) {
        listEl.innerHTML = '<div class="ref-status">No referrals yet. Share your link!</div>';
      } else {
        let html = '';
        for (const r of state.referrals) {
          html += `<div class="ref-item"><div class="ref-item-left"><div class="ref-avatar"><img src="${r.photo_url || ''}" onerror="this.style.display='none'"></div><span class="ref-name">${r.first_name || 'User'}</span></div><span class="ref-date">${r.joined || ''}</span></div>`;
        }
        listEl.innerHTML = html;
      }
    }
  } catch(e) {
    document.getElementById('refStatus').textContent = 'Could not load referrals';
  }
}

document.getElementById('btnCopyRefLink').onclick = () => {
  if (!state.refLink) return;
  navigator.clipboard.writeText(state.refLink).then(() => showToast('Link copied!')).catch(() => {
    const inp = document.getElementById('refLinkInput');
    inp.select();
    document.execCommand('copy');
    showToast('Link copied!');
  });
};

// =====================================================
// === PERSISTENCE ===
// =====================================================
function saveState() {
  try {
    const data = {
      balance: state.balance,
      positions: state.positions,
      history: state.history,
      adsWatched: state.adsWatched,
      adsToday: state.adsToday,
      adsLastDate: state.adsLastDate,
      totalAdEarnings: state.totalAdEarnings
    };
    localStorage.setItem('tradesim_state', JSON.stringify(data));
    if (userId) {
      fetch(`${API}/save`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, ...data }) }).catch(() => {});
    }
  } catch(e) {}
}

function loadState() {
  try {
    const raw = localStorage.getItem('tradesim_state');
    if (raw) {
      const data = JSON.parse(raw);
      Object.assign(state, {
        balance: data.balance ?? 10000,
        positions: (data.positions || []).map(p => ({ ...p, tp: p.tp || [], sl: p.sl || [] })),
        history: data.history || [],
        adsWatched: data.adsWatched || 0,
        adsToday: data.adsToday || 0,
        adsLastDate: data.adsLastDate || '',
        totalAdEarnings: data.totalAdEarnings || 0
      });
    }
  } catch(e) {}
}

async function loadStateFromServer() {
  if (!userId) return;
  try {
    const resp = await fetch(`${API}/load?user_id=${userId}`);
    if (resp.ok) {
      const data = await resp.json();
      if (data && data.balance !== undefined) {
        state.balance = data.balance;
        state.positions = (data.positions || []).map(p => ({ ...p, tp: p.tp || [], sl: p.sl || [] }));
        state.history = data.history || [];
        state.adsWatched = data.adsWatched || 0;
        state.adsToday = data.adsToday || 0;
        state.adsLastDate = data.adsLastDate || '';
        state.totalAdEarnings = data.totalAdEarnings || 0;
        localStorage.setItem('tradesim_state', JSON.stringify(data));
      }
    }
  } catch(e) {}
}

// Register referral
async function registerReferral() {
  if (!userId || !startParam) return;
  if (!startParam.startsWith('ref_')) return;
  const referrerId = startParam.replace('ref_', '');
  if (referrerId === String(userId)) return;
  try {
    await fetch(`${API}/referral`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        referrer_id: referrerId,
        user_id: userId,
        first_name: userName,
        photo_url: userPhoto
      })
    });
  } catch(e) {}
}

// =====================================================
// === TOAST ===
// =====================================================
function showToast(msg) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  Object.assign(toast.style, {
    position: 'fixed', bottom: '80px', left: '50%', transform: 'translateX(-50%)',
    background: 'rgba(30,35,41,0.95)', color: '#EAECEF', padding: '10px 20px',
    borderRadius: '8px', fontSize: '13px', fontWeight: '600', zIndex: '9999',
    border: '1px solid rgba(255,255,255,0.1)', boxShadow: '0 4px 20px rgba(0,0,0,0.4)',
    transition: 'opacity 0.3s', whiteSpace: 'nowrap'
  });
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
}

// =====================================================
// === INIT ===
// =====================================================
async function init() {
  loadState();
  await loadStateFromServer();
  registerReferral();
  initChart();
  await loadChart();
  connectWS();
  renderPositions();
  updateHeaderBalance();

  // Order book update
  setInterval(generateOrderBook, 2000);
  generateOrderBook();

  // Auto-save
  setInterval(saveState, 30000);

  // Responsive TF selector
  function checkTFLayout() {
    const header = document.getElementById('marketHeader');
    const sel = document.getElementById('timeframeSelector');
    if (header.offsetWidth < 400) { sel.classList.add('tf-wrapped'); } else { sel.classList.remove('tf-wrapped'); }
  }
  checkTFLayout();
  window.addEventListener('resize', checkTFLayout);
}

init();
</script>
</body>
</html>
