<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>TradeSim — Telegram Mini App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ————— BASE STYLES ————— */
:root {
  --bg: #0B0E11;
  --panel: #1E2329;
  --muted: #848E9C;
  --accent-green: #0ECB81;
  --accent-red: #F6465D;
  --border: rgba(255,255,255,0.05);
  --white: #EAECEF;
  --input-bg: #2B3139;
  --glass: rgba(255,255,255,0.02);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  background: var(--bg); color: var(--white);
  font-family: 'Inter', sans-serif;
  overflow-x: hidden; /* Prevent horizontal scroll */
}

/* ————— LAYOUT ————— */
.app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  /* Support for iOS safe areas */
  padding-bottom: env(safe-area-inset-bottom); 
}

.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}
.brand { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; }

/* Pair Switcher */
.pair-switch { display: flex; background: #000; border-radius: 8px; padding: 2px; }
.pair-btn {
  padding: 6px 12px; font-size: 12px; font-weight: 600;
  color: var(--muted); cursor: pointer; border-radius: 6px;
  transition: all 0.2s;
}
.pair-btn.active { background: var(--panel); color: var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.5); }

/* Main Grid */
.container {
  display: grid;
  grid-template-columns: 1fr 340px; /* Desktop default */
  gap: 12px;
  padding: 12px;
  flex: 1;
}

/* ————— CARDS ————— */
.card {
  background: var(--panel); border-radius: 12px;
  padding: 12px; border: 1px solid var(--border);
}

/* ————— CHART SECTION ————— */
.chart-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
.price-main { font-family: "Roboto Mono", monospace; font-size: 24px; font-weight: 700; }
.chart-wrap {
  width: 100%; height: 400px; /* Fixed height for consistency */
  border-radius: 8px; overflow: hidden; position: relative;
}

/* ————— CONTROLS & LEVERAGE ————— */
.controls-area { margin-top: 12px; display: flex; flex-direction: column; gap: 12px; }

.input-group { display: flex; gap: 10px; }
.input-field {
  flex: 1; background: var(--input-bg); border: 1px solid var(--border);
  color: var(--white); padding: 12px; border-radius: 8px;
  font-size: 14px; outline: none; transition: border 0.2s;
}
.input-field:focus { border-color: var(--accent-green); }

/* Leverage Slider Styling */
.leverage-container {
  background: var(--glass); padding: 10px; border-radius: 8px; border: 1px solid var(--border);
}
.leverage-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
.leverage-val { color: var(--accent-green); font-weight: 700; font-family: "Roboto Mono"; }

.slider-wrap { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
input[type=range] {
  -webkit-appearance: none; width: 100%; height: 4px; background: #333; border-radius: 2px; outline: none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: 18px; height: 18px; border-radius: 50%;
  background: var(--accent-green); cursor: pointer;
  box-shadow: 0 0 10px rgba(14, 203, 129, 0.4);
}

.chips-row { display: flex; justify-content: space-between; gap: 4px; }
.chip {
  flex: 1; text-align: center; font-size: 11px; padding: 6px 0;
  background: #252a30; border-radius: 4px; cursor: pointer; color: var(--muted);
  border: 1px solid transparent; transition: all 0.2s;
}
.chip.active {
  background: rgba(14, 203, 129, 0.15); color: var(--accent-green); border-color: var(--accent-green);
}

/* Action Buttons */
.actions { display: flex; gap: 10px; }
.btn {
  flex: 1; padding: 14px; border: none; border-radius: 8px;
  font-weight: 700; font-size: 14px; cursor: pointer; color: #fff;
  transition: opacity 0.2s;
}
.btn:active { opacity: 0.8; }
.btn-buy { background: var(--accent-green); color: #000; }
.btn-sell { background: var(--accent-red); color: #fff; }

/* ————— ORDER BOOK & TRADES ————— */
.sidebar { display: flex; flex-direction: column; gap: 12px; overflow: hidden; }
.list-header { font-size: 13px; font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; }
.ob-list, .trades-list {
  font-size: 12px; font-family: "Roboto Mono", monospace;
  display: flex; flex-direction: column; gap: 4px;
}
.row { display: flex; justify-content: space-between; padding: 2px 4px; }
.row.buy .p { color: var(--accent-green); }
.row.sell .p { color: var(--accent-red); }
.row .s { color: var(--white); opacity: 0.8; }
.row .t { color: var(--muted); }

/* ————— POSITIONS ————— */
.pos-list { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }
.pos-card {
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
}
.pos-info h4 { margin: 0; font-size: 14px; display: flex; align-items: center; gap: 6px; }
.pos-meta { font-size: 11px; color: var(--muted); margin-top: 4px; }
.pnl-box { text-align: right; }
.pnl-val { font-weight: 700; font-size: 14px; font-family: "Roboto Mono"; }
.btn-close {
  background: rgba(255,255,255,0.1); border: none; color: var(--white);
  padding: 4px 10px; font-size: 11px; border-radius: 4px; margin-top: 4px; cursor: pointer;
}

/* ————— LOADER ————— */
#loader {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: var(--bg); z-index: 999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.5s;
}
.loader-bar { width: 150px; height: 3px; background: #333; margin-top: 15px; border-radius: 3px; overflow: hidden; }
.loader-progress { width: 0%; height: 100%; background: var(--accent-green); transition: width 0.3s; }

/* ————— RESPONSIVE MEDIA QUERIES ————— */
@media (max-width: 900px) {
  .container {
    grid-template-columns: 1fr; /* Stack vertically on mobile */
    padding: 8px;
    padding-bottom: 40px;
  }
  .chart-wrap { height: 320px; }
  .sidebar {
    /* On mobile, limit height of orderbook to avoid huge scroll */
    max-height: 400px; 
    overflow-y: auto;
  }
}
</style>
</head>
<body>

<div id="loader">
  <div style="font-weight:700; font-size:20px;">⧉ TradeSim</div>
  <div class="loader-bar"><div class="loader-progress" id="loadProg"></div></div>
  <div style="font-size:12px; color:var(--muted); margin-top:8px" id="loadText">Loading...</div>
</div>

<div class="app">
  <header class="header">
    <div class="brand">
      <span>⧉ TradeSim</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="pair-switch">
        <div class="pair-btn active" data-pair="BTC-USD">BTC</div>
        <div class="pair-btn" data-pair="ETH-USD">ETH</div>
      </div>
      <div style="text-align:right; font-size:12px;">
        <div id="balanceDisplay" style="font-family:'Roboto Mono'; font-weight:700">0.00 VP</div>
        <div id="usernameDisplay" style="color:var(--muted); font-size:10px">Guest</div>
      </div>
    </div>
  </header>

  <main class="container">
    
    <div class="main-col">
      <div class="card">
        <div class="chart-header">
          <div>
            <div id="pairTitle" style="font-weight:700; color:var(--muted); font-size:12px">BTC/USD Perpetual</div>
            <div id="priceDisplay" class="price-main">0.00</div>
          </div>
          <div style="font-size:11px; color:var(--muted);">WS: <span id="wsStatus">connecting...</span></div>
        </div>
        
        <div id="chartContainer" class="chart-wrap"></div>

        <div class="controls-area">
          <div class="input-group">
            <input type="number" id="marginInput" class="input-field" placeholder="Margin (VP)" value="100">
          </div>

          <div class="leverage-container">
            <div class="leverage-header">
              <span>Leverage</span>
              <span class="leverage-val" id="leverageDisplay">20x</span>
            </div>
            
            <div class="slider-wrap">
              <span style="font-size:10px; color:var(--muted)">1x</span>
              <input type="range" id="leverageSlider" min="1" max="50" step="1" value="20">
              <span style="font-size:10px; color:var(--muted)">50x</span>
            </div>

            <div class="chips-row">
              <div class="chip" data-v="5">5x</div>
              <div class="chip" data-v="10">10x</div>
              <div class="chip active" data-v="20">20x</div>
              <div class="chip" data-v="50">50x</div>
            </div>
          </div>

          <div class="actions">
            <button id="btnLong" class="btn btn-buy">Buy / Long</button>
            <button id="btnShort" class="btn btn-sell">Sell / Short</button>
          </div>
        </div>
      </div>

      <div id="positionsArea" style="margin-top:12px;">
        <div style="font-size:14px; font-weight:700; margin-bottom:8px">Open Positions</div>
        <div id="positionsList" class="pos-list">
          <div style="text-align:center; padding:20px; color:var(--muted); font-size:13px">No open positions</div>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div class="card" style="flex:1; min-height:200px">
        <div class="list-header"><span>Order Book</span> <span style="color:var(--muted)" id="obPair">BTC</span></div>
        <div id="orderBook" class="ob-list"></div>
      </div>
      
      <div class="card" style="flex:1; min-height:200px">
        <div class="list-header"><span>Recent Trades</span></div>
        <div id="tradeHistory" class="trades-list"></div>
      </div>
    </aside>

  </main>
</div>

<script>
(async function(){
  // ——————————————————————————————————————
  // 1. CONFIG & INIT
  // ——————————————————————————————————————
  const API_BASE = "https://tradingbot-p9n8.onrender.com";
  const WS_URL = "wss://tradingbot-backend-2yws.onrender.com";
  
  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready();
    tg.expand(); // Force full screen in Telegram
    // Set header color to match app
    tg.setHeaderColor('#1E2329'); 
    tg.setBackgroundColor('#0B0E11');
  }

  let state = {
    pair: "BTC-USD",
    price: 0,
    userId: null,
    balance: 0,
    leverage: 20, // Default leverage
    positions: []
  };

  // UI References
  const els = {
    loader: document.getElementById('loader'),
    prog: document.getElementById('loadProg'),
    text: document.getElementById('loadText'),
    price: document.getElementById('priceDisplay'),
    balance: document.getElementById('balanceDisplay'),
    user: document.getElementById('usernameDisplay'),
    slider: document.getElementById('leverageSlider'),
    levDisplay: document.getElementById('leverageDisplay'),
    chips: document.querySelectorAll('.chip'),
    posList: document.getElementById('positionsList'),
    chart: document.getElementById('chartContainer'),
    ob: document.getElementById('orderBook'),
    trades: document.getElementById('tradeHistory'),
    ws: document.getElementById('wsStatus')
  };

  function setLoader(pct, msg) {
    els.prog.style.width = pct + "%";
    if(msg) els.text.textContent = msg;
  }

  // ——————————————————————————————————————
  // 2. CHART SETUP
  // ——————————————————————————————————————
  const chart = LightweightCharts.createChart(els.chart, {
    layout: { background: { color: '#1E2329' }, textColor: '#848E9C' },
    grid: { vertLines: { color: '#2B3139' }, horzLines: { color: '#2B3139' } },
    timeScale: { borderColor: '#2B3139', timeVisible: true },
    rightPriceScale: { borderColor: '#2B3139' },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });

  let series = chart.addCandlestickSeries({
    upColor: '#0ECB81', borderUpColor: '#0ECB81', wickUpColor: '#0ECB81',
    downColor: '#F6465D', borderDownColor: '#F6465D', wickDownColor: '#F6465D',
  });

  // Resize Observer for Chart
  new ResizeObserver(entries => {
    if(entries.length === 0 || !entries[0].contentRect) return;
    const { width, height } = entries[0].contentRect;
    chart.applyOptions({ width, height });
  }).observe(els.chart);

  let lastCandle = null;

  // ——————————————————————————————————————
  // 3. LEVERAGE LOGIC (Sync Slider & Chips)
  // ——————————————————————————————————————
  function updateLeverage(val) {
    state.leverage = parseInt(val);
    
    // Update Slider UI
    els.slider.value = state.leverage;
    // Update Text
    els.levDisplay.textContent = state.leverage + "x";
    
    // Update Chips Highlight
    els.chips.forEach(chip => {
      const v = parseInt(chip.dataset.v);
      if(v === state.leverage) chip.classList.add('active');
      else chip.classList.remove('active');
    });
  }

  // Slider Event
  els.slider.addEventListener('input', (e) => updateLeverage(e.target.value));

  // Chips Event
  els.chips.forEach(chip => {
    chip.addEventListener('click', () => updateLeverage(chip.dataset.v));
  });

  // ——————————————————————————————————————
  // 4. API & AUTH
  // ——————————————————————————————————————
  async function initAuth() {
    try {
      const initData = tg?.initData || "";
      const res = await fetch(API_BASE + "/api/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(initData ? { initData } : {})
      });
      const data = await res.json();
      
      if(data.ok && data.user) {
        state.userId = data.user.user_id;
        state.balance = Number(data.user.balance || 0);
        state.positions = data.positions || [];
        
        els.user.textContent = "@" + (data.user.username || "User");
        updateBalance();
        renderPositions();
      }
    } catch(e) { console.error("Auth failed", e); }
  }

  function updateBalance() {
    els.balance.textContent = state.balance.toFixed(2) + " VP";
  }

  // ——————————————————————————————————————
  // 5. WEBSOCKET & DATA
  // ——————————————————————————————————————
  let socket;
  let historyLoaded = false;

  function connectWS() {
    socket = new WebSocket(WS_URL);
    socket.onopen = () => {
      els.ws.textContent = "connected";
      els.ws.style.color = "var(--accent-green)";
      socket.send(JSON.stringify({ type:"subscribe", pair:state.pair }));
    };
    
    socket.onmessage = (evt) => {
      const msg = JSON.parse(evt.data);
      if(msg.pair !== state.pair) return;

      if(msg.type === "price") {
        const p = Number(msg.price);
        state.price = p;
        els.price.textContent = p.toFixed(2);
        
        // Live Candle Update
        if(lastCandle) {
          const now = Math.floor(Date.now()/1000);
          const minTime = now - (now % 60);
          if(minTime === lastCandle.time) {
            lastCandle.high = Math.max(lastCandle.high, p);
            lastCandle.low = Math.min(lastCandle.low, p);
            lastCandle.close = p;
            series.update(lastCandle);
          } else {
            lastCandle = { time: minTime, open: lastCandle.close, high: p, low: p, close: p };
            series.update(lastCandle);
          }
        }
        updatePositionsPnL();
      }

      if(msg.type === "history") {
        const data = msg.data.map(c => ({ 
          time: c.time, open: c.open, high: c.high, low: c.low, close: c.close 
        }));
        if(data.length) {
          series.setData(data);
          lastCandle = data[data.length - 1];
          chart.timeScale().fitContent();
          state.price = lastCandle.close;
          els.price.textContent = state.price.toFixed(2);
          historyLoaded = true;
        }
      }

      if(msg.type === "orderBook") renderOrderBook(msg.buy, msg.sell);
      if(msg.type === "trades") renderTrades(msg.trades);
    };

    socket.onclose = () => {
      els.ws.textContent = "closed";
      els.ws.style.color = "var(--accent-red)";
      setTimeout(connectWS, 2000);
    };
  }

  // ——————————————————————————————————————
  // 6. TRADING LOGIC
  // ——————————————————————————————————————
  async function sendOrder(type) {
    const margin = parseFloat(document.getElementById('marginInput').value);
    if(!margin || margin <= 0) return tg?.showAlert("Invalid margin");
    
    if(!state.userId) return tg?.showAlert("Login failed");

    const size = margin * state.leverage;
    
    try {
      const res = await fetch(API_BASE + "/api/order/open", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: state.userId,
          pair: state.pair,
          type: type,
          size: size,
          leverage: state.leverage,
          entryPrice: state.price
        })
      });
      const d = await res.json();
      if(d.ok) {
        state.positions.push(d.position);
        if(d.newBalance !== undefined) { state.balance = d.newBalance; updateBalance(); }
        renderPositions();
        tg?.HapticFeedback.notificationOccurred('success');
      } else {
        tg?.showAlert(d.error || "Error");
      }
    } catch(e) { console.error(e); }
  }

  document.getElementById('btnLong').onclick = () => sendOrder("LONG");
  document.getElementById('btnShort').onclick = () => sendOrder("SHORT");

  async function closePos(id) {
    if(!confirm("Close position?")) return;
    try {
      const res = await fetch(API_BASE + "/api/order/close", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ userId: state.userId, positionId: id, closePrice: state.price })
      });
      const d = await res.json();
      if(d.ok) {
        state.positions = state.positions.filter(p => (p.id!=id && p._id!=id));
        if(d.newBalance !== undefined) { state.balance = d.newBalance; updateBalance(); }
        renderPositions();
        tg?.HapticFeedback.notificationOccurred('success');
      }
    } catch(e) { alert("Net Error"); }
  }
  window.closePos = closePos; // Expose for HTML onclick

  // ——————————————————————————————————————
  // 7. RENDERING
  // ——————————————————————————————————————
  function renderPositions() {
    if(!state.positions.length) {
      els.posList.innerHTML = '<div style="text-align:center; padding:15px; color:var(--muted); font-size:13px">No active positions</div>';
      return;
    }
    els.posList.innerHTML = state.positions.map(p => {
      const isLong = (p.type||"LONG").toUpperCase() === "LONG";
      const color = isLong ? "var(--accent-green)" : "var(--accent-red)";
      const label = isLong ? "LONG" : "SHORT";
      return `
      <div class="pos-card">
        <div class="pos-info">
          <h4 style="color:${color}">● ${label} ${state.pair}</h4>
          <div class="pos-meta">
            Size: ${Number(p.size).toFixed(0)} VP (x${p.leverage})<br>
            Entry: ${Number(p.entryPrice).toFixed(2)}
          </div>
        </div>
        <div class="pnl-box">
          <div class="pnl-val" id="pnl-${p.id||p._id}">0.00</div>
          <button class="btn-close" onclick="closePos('${p.id||p._id}')">Close</button>
        </div>
      </div>`;
    }).join("");
    updatePositionsPnL();
  }

  function updatePositionsPnL() {
    state.positions.forEach(p => {
      const el = document.getElementById(`pnl-${p.id||p._id}`);
      if(!el) return;
      const entry = Number(p.entryPrice);
      const sz = Number(p.size);
      const isLong = (p.type||"LONG").toUpperCase() === "LONG";
      
      let pnl = 0;
      if(entry > 0) {
        const pct = (state.price - entry) / entry;
        pnl = pct * sz * (isLong ? 1 : -1);
      }
      
      el.textContent = (pnl>0?"+":"") + pnl.toFixed(2) + " VP";
      el.style.color = pnl >= 0 ? "var(--accent-green)" : "var(--accent-red)";
    });
  }

  function renderOrderBook(b, s) {
    // Limit rows for performance
    const rows = [];
    s.slice(0, 8).reverse().forEach(x => rows.push(`<div class="row sell"><span class="p">${x.price.toFixed(1)}</span><span class="s">${x.size.toFixed(3)}</span></div>`));
    b.slice(0, 8).forEach(x => rows.push(`<div class="row buy"><span class="p">${x.price.toFixed(1)}</span><span class="s">${x.size.toFixed(3)}</span></div>`));
    els.ob.innerHTML = rows.join("");
  }

  function renderTrades(list) {
    els.trades.innerHTML = list.slice().reverse().slice(0, 15).map(t => {
      const c = t.side==="buy"?"var(--accent-green)":"var(--accent-red)";
      return `<div class="row"><span style="color:${c}">${t.price.toFixed(1)}</span><span class="s">${t.size.toFixed(3)}</span><span class="t">${new Date(t.time).toLocaleTimeString().split(':').slice(0,2).join(':')}</span></div>`;
    }).join("");
  }

  // Pair Switching
  document.querySelectorAll('.pair-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.pair-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const newPair = btn.dataset.pair;
      if(newPair === state.pair) return;
      
      // Reset Chart
      state.pair = newPair;
      series.setData([]);
      lastCandle = null;
      document.getElementById('pairTitle').textContent = newPair.replace('-','/') + " Perpetual";
      document.getElementById('obPair').textContent = newPair.split('-')[0];
      
      // Reconnect WS
      socket.close(); // Will trigger auto-reconnect logic which reads new state.pair
    };
  });

  // ——————————————————————————————————————
  // 8. BOOTSTRAP
  // ——————————————————————————————————————
  setLoader(30, "Authenticating...");
  await initAuth();
  
  setLoader(60, "Connecting Markets...");
  connectWS();
  
  // Wait for history or timeout
  let ticks = 0;
  const waiter = setInterval(() => {
    ticks++;
    if(historyLoaded || ticks > 20) {
      clearInterval(waiter);
      setLoader(100, "Ready");
      setTimeout(() => {
        els.loader.style.opacity = 0;
        setTimeout(()=>els.loader.style.display='none', 500);
      }, 500);
    }
  }, 200);

})();
</script>
</body>
</html>
