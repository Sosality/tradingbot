<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>TradeSim</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* â€”â€”â€”â€”â€” CORE STYLES â€”â€”â€”â€”â€” */
:root {
  --bg: #0B0E11;
  --panel: #1E2329;
  --panel-light: #2A2F36;
  --muted: #848E9C;
  --accent-green: #0ECB81;
  --accent-green-transparent: rgba(14, 203, 129, 0.15);
  --accent-red: #F6465D;
  --accent-red-transparent: rgba(246, 70, 93, 0.15);
  --white: #EAECEF;
  --border: rgba(255, 255, 255, 0.08);
  --gold: #F0B90B;
  --gold-gradient: linear-gradient(135deg, #F0B90B 0%, #B88A00 100%);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; margin: 0; background: var(--bg); color: var(--white); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }

/* Scrollbar styling */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

/* â€”â€”â€”â€”â€” LAYOUT & VIEWS â€”â€”â€”â€”â€” */
.app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; position: relative; }

/* View Switching */
.view-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
  transition: opacity 0.3s ease, transform 0.3s ease;
  position: absolute; width: 100%; top:0; left:0; /* Stack views */
  background: var(--bg);
}

.view-section.hidden {
  display: none;
  opacity: 0;
  pointer-events: none;
  z-index: -1;
}

.view-section.active {
    display: flex;
    opacity: 1;
    z-index: 10;
}

/* HEADER */
.header {
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  height: 60px;
  z-index: 100;
}

.header-left { display: flex; align-items: center; gap: 16px; }
.logo-img { height: 28px; width: auto; display: block; }

/* CUSTOM DROPDOWN */
.pair-dropdown { position: relative; font-family: 'Roboto Mono', monospace; }
.pair-trigger {
    display: flex; align-items: center; gap: 8px;
    background: transparent; padding: 6px 12px; border-radius: 6px;
    cursor: pointer; font-weight: 700; font-size: 15px; color: var(--white);
    transition: background 0.2s; user-select: none;
}
.pair-trigger:hover { background: rgba(255,255,255,0.05); }
.pair-trigger .arrow { font-size: 10px; color: var(--muted); transition: transform 0.2s; }
.pair-dropdown.open .pair-trigger .arrow { transform: rotate(180deg); }
.pair-menu {
    position: absolute; top: 100%; left: 0; margin-top: 8px;
    background: rgba(30, 35, 41, 0.95); backdrop-filter: blur(10px);
    border: 1px solid var(--border); border-radius: 8px; width: 160px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; pointer-events: none;
    transform: translateY(-10px); transition: all 0.2s ease; z-index: 200;
    display: flex; flex-direction: column; padding: 4px;
}
.pair-dropdown.open .pair-menu { opacity: 1; pointer-events: auto; transform: translateY(0); }
.pair-item {
    padding: 10px 12px; font-size: 14px; font-weight: 500; color: var(--muted);
    cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
}
.pair-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
.pair-item.active { background: rgba(255,255,255,0.08); color: var(--white); font-weight: 700; }
.pair-item.active::after { content: 'âœ“'; color: var(--accent-green); font-size: 12px; }

/* User Area */
.user-area { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 8px; border-radius: 8px; transition: background 0.2s; }
.user-area:active { background: rgba(255,255,255,0.05); }
.balance-group { text-align: right; line-height: 1.2; }
.balance-label { font-size: 10px; color: var(--muted); display: block; }
.balance-val { font-size: 13px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono', monospace; }
.avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; border: 1px solid var(--border); }
.avatar-sm img { width: 100%; height: 100%; object-fit: cover; }

/* â€”â€”â€”â€”â€” MAIN CONTAINER â€”â€”â€”â€”â€” */
.container {
  flex: 1; display: flex; flex-direction: column;
  overflow-y: auto; overflow-x: hidden; padding: 12px; gap: 12px;
}

@media (min-width: 900px) {
  .container { display: grid; grid-template-columns: 1fr 320px; height: calc(100vh - 60px); overflow: hidden; }
  .left-col { overflow-y: auto; padding-right: 4px; }
  .right-col { overflow: hidden; }
}

.left-col { display: flex; flex-direction: column; gap: 12px; }
.right-col { display: flex; flex-direction: column; gap: 12px; }

.card { background: var(--panel); border-radius: 12px; padding: 12px; border: 1px solid var(--border); }

/* MARKET INFO & CHART */
.market-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 12px; }
.price-display { font-family: 'Roboto Mono', monospace; font-size: 32px; font-weight: 700; line-height: 1; letter-spacing: -1px; }
.chart-container { height: 350px; width: 100%; border-radius: 8px; overflow: hidden; position: relative; background: #111; }
@media (min-width: 900px) { .chart-container { height: 50vh; } }

/* CONTROLS */
.controls-area { display: flex; flex-direction: column; gap: 16px; margin-top: 12px; }
.input-group { position: relative; }
.input-label { position: absolute; top: 8px; left: 12px; font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
.main-input {
  width: 100%; background: #111; border: 1px solid var(--border); color: var(--white);
  padding: 24px 12px 8px 12px; border-radius: 8px; font-size: 16px; font-family: 'Roboto Mono', monospace; outline: none; transition: border 0.2s;
}
.main-input:focus { border-color: var(--accent-green); }

.leverage-wrap { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
.lev-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
.lev-val { color: var(--accent-green); font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }
.range-slider { -webkit-appearance: none; width: 100%; height: 4px; background: #2A2F36; border-radius: 2px; outline: none; margin: 10px 0; }
.range-slider::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; 
  background: var(--white); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); border: 2px solid var(--accent-green); margin-top: -7px; 
}
.chips-row { display: flex; justify-content: space-between; gap: 4px; margin-top: 8px; }
.chip { flex: 1; text-align: center; padding: 6px 0; font-size: 11px; background: #15181b; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); color: var(--muted); transition: 0.2s; }
.chip.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); font-weight: 700; }

.action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
.btn-trade {
  padding: 14px; border-radius: 8px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; color: #fff;
  display: flex; flex-direction: column; align-items: center; line-height: 1.2; transition: filter 0.2s;
}
.btn-trade:active { filter: brightness(0.9); transform: scale(0.98); }
.btn-trade span { font-size: 10px; font-weight: 400; opacity: 0.8; margin-top: 2px; }
.btn-long { background: var(--accent-green); color: #052e1f; }
.btn-short { background: var(--accent-red); color: #2d0a0f; }

/* â€”â€”â€”â€”â€” ORDER BOOK & TRADES â€”â€”â€”â€”â€” */
.ob-header { display: grid; grid-template-columns: 1fr 1fr; font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; padding: 0 6px; }
.ob-container { font-size: 12px; font-family: 'Roboto Mono', monospace; display: flex; flex-direction: column; gap: 1px; overflow: hidden; }
.ob-row { position: relative; display: grid; grid-template-columns: 1fr 1fr; align-items: center; height: 20px; padding: 0 6px; line-height: 1; white-space: nowrap; overflow: hidden; }
.trade-time { text-align: right; opacity: 0.7; }
.ob-bg { position: absolute; top: 0; bottom: 0; z-index: 0; opacity: 0.18; transition: width 0.2s ease; }
.bg-red { left: 0; background: linear-gradient(to right, var(--accent-red), transparent); }
.bg-green { right: 0; background: linear-gradient(to left, var(--accent-green), transparent); }
.ob-row span { position: relative; z-index: 1; }

/* FIX: Ğ’Ñ‹Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ñ‚Ğ¾Ñ€ÑƒÑ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºÑƒ (Amount) Ğ²Ğ¿Ñ€Ğ°Ğ²Ğ¾ */
.ob-row span:last-child { text-align: right; }

.text-green { color: var(--accent-green); }
.text-red   { color: var(--accent-red); }

/* â€”â€”â€”â€”â€” POSITIONS â€”â€”â€”â€”â€” */
.pos-list { display: flex; flex-direction: column; gap: 8px; }
.pos-item { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
.pos-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 700; }
.pos-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: var(--muted); }
.pos-val { color: var(--white); font-family: 'Roboto Mono'; margin-top: 2px; }
.close-btn { 
  background: transparent; border: 1px solid var(--border); color: var(--white); 
  padding: 6px 12px; border-radius: 4px; font-size: 11px; margin-top: 10px; width: 100%; cursor: pointer; font-weight: 600;
}

/* â€”â€”â€”â€”â€” NEW PROFILE DESIGN (BINANCE STYLE) â€”â€”â€”â€”â€” */
.profile-container {
  flex: 1; display: flex; flex-direction: column;
  padding: 16px; overflow-y: auto; gap: 20px;
  background: var(--bg);
}

.pro-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.pro-user { display: flex; align-items: center; gap: 12px; }
.pro-avatar { width: 44px; height: 44px; border-radius: 50%; background: #333; overflow: hidden; border: 2px solid var(--panel); }
.pro-avatar img { width: 100%; height: 100%; object-fit: cover; }
.pro-name { font-size: 16px; font-weight: 700; color: var(--white); line-height: 1.2; }
.pro-id { font-size: 11px; color: var(--muted); font-family: monospace; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }

.asset-card {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 16px; padding: 20px;
  position: relative; overflow: hidden;
}
.asset-label { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
.asset-val { font-size: 26px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono'; margin: 8px 0; }
.asset-approx { font-size: 13px; color: var(--muted); }
.asset-pnl { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); display: inline-flex; align-items: center; gap: 4px; margin-left: 8px; }

.pro-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
.pro-btn {
  background: var(--panel-light); border: none; color: var(--white);
  padding: 10px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer;
  transition: 0.2s;
}
.pro-btn.primary { background: var(--gold); color: #000; }

/* Analysis Block */
.analysis-block {
  display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
}
.an-card {
  background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
  padding: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.an-title { font-size: 11px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; width: 100%; text-align: left; }

/* Donut Chart CSS */
.donut-chart {
  width: 70px; height: 70px; border-radius: 50%;
  background: conic-gradient(var(--accent-green) 0% 0%, var(--panel-light) 0% 100%);
  position: relative; display: flex; align-items: center; justify-content: center;
  margin-bottom: 4px;
}
.donut-chart::after {
  content: ''; position: absolute; width: 56px; height: 56px;
  background: var(--panel); border-radius: 50%;
}
.donut-val { position: absolute; z-index: 2; font-size: 12px; font-weight: 700; color: var(--white); }
.an-text { font-size: 12px; color: var(--white); font-weight: 600; margin-top: 4px; }

/* Rewards Banner */
.rewards-banner {
  background: linear-gradient(90deg, #1E2329 0%, #252a33 100%);
  border: 1px solid rgba(240, 185, 11, 0.3);
  border-radius: 12px; padding: 16px;
  display: flex; justify-content: space-between; align-items: center;
  cursor: pointer; position: relative; overflow: hidden;
}
.rewards-banner::before {
  content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
  background: var(--gold);
}
.rb-content h3 { margin: 0; font-size: 15px; color: var(--white); }
.rb-content p { margin: 4px 0 0; font-size: 11px; color: var(--muted); }
.rb-icon { display: flex; align-items: center; }

/* History List Clean */
.hist-title { font-size: 15px; font-weight: 700; margin: 10px 0; }
.history-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 60px; }
.history-card {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 12px; padding: 14px;
  display: flex; flex-direction: column; gap: 8px;
}
.hc-header { display: flex; justify-content: space-between; align-items: center; }
.hc-pair { font-weight: 700; font-size: 14px; }
.hc-type { font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
.hc-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
.hc-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
.hc-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); }
.hc-val { color: var(--white); font-family: 'Roboto Mono'; }
.hc-pnl { font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

/* â€”â€”â€”â€”â€” REWARDS VIEW STYLES â€”â€”â€”â€”â€” */
.rewards-container {
    padding: 20px; display: flex; flex-direction: column; gap: 24px;
}
.rewards-header { text-align: center; padding: 20px 0; }
.rh-title { font-size: 22px; font-weight: 700; color: var(--white); margin-bottom: 8px; }
.rh-sub { font-size: 13px; color: var(--muted); }

.progress-card {
    background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px;
}
.prog-info { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; color: var(--white); font-weight: 600; }
.prog-track { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative; }
.prog-fill { height: 100%; background: var(--gold-gradient); width: 0%; transition: width 0.5s ease; border-radius: 4px; }

.milestones { display: flex; justify-content: space-between; margin-top: 12px; }
.ms-item { text-align: center; width: 30px; position: relative; }
.ms-dot { width: 10px; height: 10px; background: #333; border: 2px solid var(--muted); border-radius: 50%; margin: 0 auto 4px; z-index: 2; position: relative; }
.ms-item.active .ms-dot { background: var(--gold); border-color: var(--gold); box-shadow: 0 0 10px rgba(240, 185, 11, 0.4); }
.ms-val { font-size: 10px; color: var(--muted); }

.task-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
.task-item {
    background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center;
}
.task-left h4 { margin: 0 0 4px; font-size: 14px; }
.task-left p { margin: 0; font-size: 11px; color: var(--muted); }
.btn-claim {
    background: var(--gold); color: #000; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 12px; cursor: pointer;
}
.btn-claim:disabled { background: var(--panel-light); color: var(--muted); cursor: not-allowed; }

.btn-back-float {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: var(--panel-light); border: 1px solid var(--border); color: var(--white);
    padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 900;
}

/* â€”â€”â€”â€”â€” LOADER â€”â€”â€”â€”â€” */
#app-loader {
  position: fixed; inset: 0; background: var(--bg); z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.4s;
}
#app-loader.hidden { opacity: 0; pointer-events: none; }
.loader-logo { width: 80px; height: auto; margin-bottom: 20px; animation: pulse 2s infinite ease-in-out; }
@keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
.loader-bar-bg { width: 140px; height: 2px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
.loader-bar-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.2s; }
</style>
</head>

<body>

<div id="app-loader">
  <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="TradeSim" class="loader-logo">
  <div class="loader-bar-bg"><div class="loader-bar-fill" id="loaderBar"></div></div>
  <div style="margin-top: 12px; font-size: 10px; color: var(--muted); font-family: monospace; letter-spacing: 1px;" id="loaderText">CONNECTING</div>
</div>

<div class="app">
  
  <div id="view-trade" class="view-section active">
    <header class="header">
      <div class="header-left">
        <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="Logo" class="logo-img">
        
        <div class="pair-dropdown" id="pairDropdown">
            <div class="pair-trigger" id="pairTrigger">
                <span id="triggerText">BTC/USD</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="pair-menu">
                <div class="pair-item active" data-pair="BTC-USD">BTC/USD</div>
                <div class="pair-item" data-pair="ETH-USD">ETH/USD</div>
            </div>
        </div>
      </div>
      <div class="user-area" id="btnProfile">
        <div class="balance-group">
          <span class="balance-label">Total Assets</span>
          <span class="balance-val" id="headerBalance">0.00 VP</span>
        </div>
        <div class="avatar-sm"><img id="avatarImg" src="" style="display:none"></div>
      </div>
    </header>

    <main class="container">
      <div class="left-col">
        <div class="card">
          <div class="market-header">
            <div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;">Market Price</div>
              <div class="price-display text-green" id="priceDisplay">--.--</div>
            </div>
          </div>
          <div class="chart-container" id="chartCard"><div id="chart" style="width: 100%; height: 100%;"></div></div>
          <div class="controls-area">
            <div class="input-group">
              <span class="input-label">Margin (VP)</span>
              <input type="number" id="sizeInput" class="main-input" value="100" placeholder="10-10000" />
            </div>
            <div class="leverage-wrap">
              <div class="lev-header"><span>Leverage</span><span class="lev-val" id="leverageValText">10x</span></div>
              <input type="range" class="range-slider" id="leverageSlider" min="1" max="50" step="1" value="10">
              <div class="chips-row" id="leverageChips">
                <div class="chip" data-v="1">1x</div>
                <div class="chip" data-v="5">5x</div>
                <div class="chip active" data-v="10">10x</div>
                <div class="chip" data-v="20">20x</div>
                <div class="chip" data-v="50">50x</div>
              </div>
            </div>
            <div class="action-btns">
              <button id="openLong" class="btn-trade btn-long">Buy / Long <span>Up</span></button>
              <button id="openShort" class="btn-trade btn-short">Sell / Short <span>Down</span></button>
            </div>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px; padding-left: 4px;">Open Positions</div>
          <div id="positionsList" class="pos-list"><div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div></div>
        </div>
      </div>

      <div class="right-col">
        <div class="card" style="display:flex; flex-direction:column; min-height: 300px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between; align-items:center;">
            <span>Order Book</span>
            <div style="display:flex; gap:8px; align-items:center;">
              <span id="bookPairLabel" style="color:var(--muted); font-size:11px;">BTC-USD</span>
              <span id="bookUpdated" style="color:var(--muted); font-size:11px;">â€”</span>
            </div>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Amount</span></div>
          <div class="ob-container" id="orderBook" style="flex:1;"></div>
        </div>

        <div class="card" style="display:flex; flex-direction:column; min-height: 250px;">
           <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between;">
             <span>Last Trades</span>
             <span style="color:var(--muted); font-size:11px;">Real-time</span>
           </div>
           <div class="ob-header"><span>Price</span><span style="text-align:right">Time</span></div>
           <div class="ob-container" id="tradeHistory" style="flex:1;"></div>
        </div>
      </div>
    </main>
  </div>

  <div id="view-profile" class="view-section hidden">
    <div class="profile-container">
      
      <div class="pro-header">
        <div class="pro-user">
          <div class="pro-avatar"><img id="profileAvatarBig" src=""></div>
          <div>
             <div class="pro-name" id="profileName">Trader</div>
             <div class="pro-id" id="profileId">ID: --</div>
          </div>
        </div>
        <div class="btn-close" id="btnCloseProfile" style="color:var(--muted); padding:8px; cursor:pointer;">âœ•</div>
      </div>

      <div class="asset-card">
         <div class="asset-label">Total Assets (VP) <span>ğŸ‘</span></div>
         <div class="asset-val" id="profileBalance">0.00</div>
         <div style="display:flex; align-items:center;">
           <span class="asset-approx">â‰ˆ $0.00</span>
           <div class="asset-pnl text-green" id="profilePnlPill">+0.00%</div>
         </div>

         <div class="pro-actions">
           <button class="pro-btn primary">Deposit</button>
           <button class="pro-btn">Withdraw</button>
         </div>
      </div>

      <div class="analysis-block">
        <div class="an-card">
           <div class="an-title">Win Rate</div>
           <div class="donut-chart" id="winRateChart" style="background: conic-gradient(var(--accent-green) 0% 0%, var(--panel-light) 0% 100%);">
             <span class="donut-val" id="winRateVal">0%</span>
           </div>
           <div class="an-text" id="totalTradesVal">0 Trades</div>
        </div>
        <div class="an-card">
           <div class="an-title">Net PnL</div>
           <div style="font-size:18px; font-weight:700; font-family:'Roboto Mono'; margin-bottom:4px;" id="statPnL">0.00</div>
           <div style="font-size:10px; color:var(--muted);">All Time</div>
        </div>
      </div>

      <div class="rewards-banner" id="btnGoRewards">
         <div class="rb-content">
            <h3>Rewards Center</h3>
            <p>Complete tasks to unlock features</p>
         </div>
         <div class="rb-icon">
             <img src="https://i.postimg.cc/pdkwtBbQ/gift-thunder.png" style="width: 40px; height: auto;">
         </div>
      </div>

      <div>
        <div class="hist-title">Recent History</div>
        <div class="history-list" id="historyList">
           <div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history</div>
        </div>
      </div>

    </div>
  </div>

  <div id="view-rewards" class="view-section hidden">
     <div class="rewards-container">
        <div class="rewards-header">
           <div class="rh-title">Achievement Progress</div>
           <div class="rh-sub">Watch ads & trade to level up</div>
        </div>

        <div class="progress-card">
           <div class="prog-info">
              <span>Level 1</span>
              <span>1 / 10 Ads</span>
           </div>
           <div class="prog-track">
              <div class="prog-fill" style="width: 10%;"></div>
           </div>
           <div class="milestones">
              <div class="ms-item active"><div class="ms-dot"></div><span class="ms-val">Start</span></div>
              <div class="ms-item"><div class="ms-dot"></div><span class="ms-val">5 Ads</span></div>
              <div class="ms-item"><div class="ms-dot"></div><span class="ms-val">10 Ads</span></div>
           </div>
        </div>

        <div class="task-list">
           <div class="task-item">
              <div class="task-left">
                 <h4>Watch Daily Ad</h4>
                 <p>Get +1 Progress Point</p>
              </div>
              <button class="btn-claim">WATCH</button>
           </div>
           <div class="task-item">
              <div class="task-left">
                 <h4>Make 5 Trades</h4>
                 <p>Reward: 50 VP Bonus</p>
              </div>
              <button class="btn-claim" disabled>LOCKED</button>
           </div>
        </div>

        <button class="btn-back-float" id="btnBackFromRewards">Back to Profile</button>
     </div>
  </div>

</div>

<script>
(async function(){
  const $ = (id) => document.getElementById(id);
  
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // CONFIG
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  const WSS_PRICE_URL = "wss://tradingbot-backend-2yws.onrender.com"; 
  const API_BASE = "https://tradingbot-p9n8.onrender.com";
  // Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ğ°Ñ€ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ½Ğ°Ñ‚ÑŒ Ñ†ĞµĞ½Ñ‹ Ğ´Ğ°Ğ¶Ğµ Ğ² Ñ„Ğ¾Ğ½Ğµ
  const ALL_PAIRS = ["BTC-USD", "ETH-USD"]; 

  let currentUserId = null;

  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready();
    try { tg.expand(); } catch(e){}
    tg.setHeaderColor('#1E2329');
    tg.setBackgroundColor('#0B0E11');
    tg.enableClosingConfirmation();
  }

  let selectedPair = "BTC-USD";
  
  // Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 2: Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ñ†ĞµĞ½Ñ‹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾
  let marketPrices = {}; 
  
  let profile = { balance: 0, name: "Trader", id: 0, photo: "" };
  let currentLeverage = 10;
  let localTrades = [];
  let remoteHistory = []; 

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // UTILS
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  function formatPrice(val) {
      const num = Number(val);
      if(isNaN(num)) return "--.--";
      if(num < 1) return num.toFixed(5);
      if(num < 10) return num.toFixed(4);
      return num.toFixed(2);
  }

  function normalizePair(p) {
    if (!p) return "";
    return String(p).trim().replace("/", "-").toUpperCase();
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // NAVIGATION & VIEWS
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  const viewTrade = $('view-trade');
  const viewProfile = $('view-profile');
  const viewRewards = $('view-rewards');

  function showView(viewId) {
    document.querySelectorAll('.view-section').forEach(el => {
        el.classList.remove('active');
        el.classList.add('hidden');
    });
    const target = $(viewId);
    target.classList.remove('hidden');
    target.classList.add('active');

    if(viewId === 'view-profile') {
        if(tg) tg.BackButton.show();
    } else if (viewId === 'view-trade') {
        if(tg) tg.BackButton.hide();
    }
  }

  $('btnProfile').onclick = () => { renderProfile(); showView('view-profile'); };
  $('btnCloseProfile').onclick = () => showView('view-trade');
  $('btnGoRewards').onclick = () => showView('view-rewards');
  $('btnBackFromRewards').onclick = () => showView('view-profile');

  if(tg) {
    tg.BackButton.onClick(() => {
        if(viewRewards.classList.contains('active')) showView('view-profile');
        else if(viewProfile.classList.contains('active')) showView('view-trade');
    });
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // PROFILE LOGIC
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  async function renderProfile() {
    $('profileName').textContent = profile.name || "Trader";
    $('profileId').textContent = "ID: " + profile.id;
    $('profileBalance').textContent = profile.balance.toFixed(2);
    if(profile.photo) $('profileAvatarBig').src = profile.photo;

    try {
        const res = await fetch(API_BASE + "/api/user/history?userId=" + currentUserId);
        const data = await res.json();
        if(data.ok) remoteHistory = data.history;
    } catch(e) { console.error("History fetch error", e); }

    let totalPnL = 0;
    let wins = 0;
    let count = remoteHistory.length;

    remoteHistory.forEach(h => {
        const p = Number(h.pnl);
        totalPnL += p;
        if(p > 0) wins++;
    });

    const pnlEl = $('statPnL');
    pnlEl.textContent = (totalPnL > 0 ? "+" : "") + totalPnL.toFixed(2) + " VP";
    pnlEl.className = (totalPnL >= 0 ? "text-green" : "text-red");
    
    let winRate = count > 0 ? Math.round((wins / count) * 100) : 0;
    $('winRateVal').textContent = winRate + "%";
    $('totalTradesVal').textContent = count + " Trades";
    
    const chartColor = winRate >= 50 ? '#0ECB81' : '#F6465D';
    $('winRateChart').style.background = `conic-gradient(${chartColor} 0% ${winRate}%, var(--panel-light) ${winRate}% 100%)`;

    renderHistoryList();
  }

  function renderHistoryList() {
    const list = $('historyList');
    list.innerHTML = "";
    if(remoteHistory.length === 0) {
      list.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history yet</div>';
      return;
    }
    remoteHistory.slice(0, 20).forEach(h => {
      const pnlVal = Number(h.pnl);
      const sizeVal = Number(h.size);
      const entryVal = Number(h.entry_price);
      const exitVal = Number(h.exit_price);
      const pnlClass = pnlVal >= 0 ? "text-green" : "text-red";
      const dateStr = new Date(h.closed_at).toLocaleString([], {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
      
      const div = document.createElement('div');
      div.className = "history-card";
      div.innerHTML = `
        <div class="hc-header">
          <div class="hc-pair">${h.pair || "UNK"}</div>
          <div class="hc-type ${h.type === 'LONG' ? 'long' : 'short'}">${h.type} x${h.leverage}</div>
        </div>
        <div class="hc-row">
          <span>Size: <span class="hc-val">${sizeVal.toFixed(0)}</span></span>
          <span>${dateStr}</span>
        </div>
        <div class="hc-row">
          <span>Entry: <span class="hc-val">${formatPrice(entryVal)}</span></span>
          <span>Exit: <span class="hc-val">${formatPrice(exitVal)}</span></span>
        </div>
        <div class="hc-row" style="margin-top:4px; border-top:1px solid var(--border); padding-top:4px;">
          <span>PnL</span>
          <span class="hc-pnl ${pnlClass}">${pnlVal > 0 ? '+' : ''}${pnlVal.toFixed(2)} VP</span>
        </div>
      `;
      list.appendChild(div);
    });
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // PAIR SELECTOR
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  const pairDropdown = $('pairDropdown');
  const pairTrigger = $('pairTrigger');
  const triggerText = $('triggerText');
  const pairItems = document.querySelectorAll('.pair-item');

  pairTrigger.addEventListener('click', (e) => { e.stopPropagation(); pairDropdown.classList.toggle('open'); });
  document.addEventListener('click', () => pairDropdown.classList.remove('open'));

  pairItems.forEach(item => {
    item.addEventListener('click', () => {
        const newPair = item.dataset.pair;
        if(newPair === selectedPair) return;
        
        pairItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        triggerText.textContent = item.textContent;
        
        switchPair(newPair);
    });
  });
  
  function switchPair(newPair) {
    selectedPair = newPair;
    $('bookPairLabel').textContent = selectedPair;

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ†ĞµĞ½Ğ½Ğ¸Ğº ÑÑ€Ğ°Ğ·Ñƒ, ĞµÑĞ»Ğ¸ Ñ†ĞµĞ½Ğ° ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
    const cachedPrice = marketPrices[selectedPair];
    if (cachedPrice) {
        $('priceDisplay').textContent = formatPrice(cachedPrice);
    } else {
        $('priceDisplay').textContent = "--.--";
    }

    // Ğ¡Ğ±Ñ€Ğ¾Ñ ÑÑ‚Ğ°ĞºĞ°Ğ½Ğ° Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ´ĞµĞ»Ğ¾Ğº (Ğ¾Ğ½Ğ¸ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€Ñ‹)
    $('orderBook').innerHTML = '';
    $('tradeHistory').innerHTML = "";
    localTrades = [];

    // Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ“Ñ€Ğ°Ñ„Ğ¸ĞºĞ°
    candleSeries.setData([]);
    lastCandle = null;
    chart.timeScale().fitContent();
    chart.priceScale('right').applyOptions({ autoScale: true });

    // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹
    if (socket && socket.readyState === WebSocket.OPEN) {
       // ĞœÑ‹ Ğ¸ Ñ‚Ğ°Ğº Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ½Ğ° Ğ²ÑĞµ, Ğ½Ğ¾ ÑÑ‚Ğ¾Ñ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ° Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞµ
       socket.send(JSON.stringify({ type: "subscribe", pair: newPair }));
    }
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // CHART SETUP
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  const chartEl = $('chart');
  const chart = LightweightCharts.createChart(chartEl, {
    width: chartEl.clientWidth,
    height: chartEl.clientHeight,
    layout: { background: { type: 'solid', color: '#0B0E11' }, textColor: '#5E6673' },
    grid: { horzLines: { color: 'rgba(255,255,255,0.03)' }, vertLines: { color: 'rgba(255,255,255,0.03)' } },
    rightPriceScale: { borderVisible: false, autoScale: true, scaleMargins: { top: 0.1, bottom: 0.1 } }, 
    timeScale: { borderVisible: false, timeVisible: true, rightOffset: 5 },
    crosshair: { vertLine: { color: 'rgba(255,255,255,0.1)', style: 3 }, horzLine: { color: 'rgba(255,255,255,0.1)', style: 3 } }
  });

  let candleSeries = chart.addCandlestickSeries({
    upColor: '#0ECB81', borderUpColor: '#0ECB81', wickUpColor: '#0ECB81',
    downColor: '#F6465D', borderDownColor: '#F6465D', wickDownColor: '#F6465D'
  });

  new ResizeObserver(entries => {
    if (entries.length === 0 || entries[0].target !== chartEl) { return; }
    const newRect = entries[0].contentRect;
    chart.applyOptions({ width: newRect.width, height: newRect.height });
   }).observe(chartEl);

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // LEVERAGE & UI
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  const slider = $('leverageSlider');
  const levDisplay = $('leverageValText');
  const levChips = document.querySelectorAll('.chip');

  function updateLeverageUI(val) {
    currentLeverage = parseInt(val);
    slider.value = currentLeverage;
    levDisplay.textContent = currentLeverage + 'x';
    levChips.forEach(chip => {
      chip.classList.toggle('active', parseInt(chip.dataset.v) === currentLeverage);
    });
  }
  slider.addEventListener('input', (e) => updateLeverageUI(e.target.value));
  levChips.forEach(chip => chip.addEventListener('click', () => updateLeverageUI(chip.dataset.v)));
  updateLeverageUI(10);

  let historyResolve = null;
  const historyPromise = new Promise(r => historyResolve = r);

  function updateBalanceUI() {
    const val = profile.balance.toFixed(2);
    $('headerBalance').textContent = val + " VP";
    $('profileBalance').textContent = val;
  }

  async function initSession() {
    try {
      let initData = tg?.initData || "";
      let res = await fetch(API_BASE + "/api/init", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify(initData ? {initData} : {})
      });
      let data = await res.json();
      if(data.ok && data.user) {
        currentUserId = data.user.user_id;
        profile.balance = Number(data.user.balance || 0);
        profile.name = (data.user.first_name || "User");
        profile.id = data.user.user_id;
        
        window._positions = data.positions || [];
        if(data.user.photo_url) { 
          profile.photo = data.user.photo_url;
          $('avatarImg').src = data.user.photo_url; 
          $('avatarImg').style.display = 'block'; 
        }
        updateBalanceUI();
        
        // Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€Ğ°Ğ· Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ
        renderPositions(true);
      }
    } catch(e) { console.error(e); }
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // WEBSOCKET & DATA STREAM
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  let socket = null;
  let lastCandle = null;

  function connectWS() {
    socket = new WebSocket(WSS_PRICE_URL);

    socket.onopen = () => {
      // Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 2: ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ÑÑ ĞĞ Ğ’Ğ¡Ğ• ĞŸĞĞ Ğ« ÑÑ€Ğ°Ğ·Ñƒ
      ALL_PAIRS.forEach(pair => {
         socket.send(JSON.stringify({ type: "subscribe", pair: pair }));
      });
    };

    socket.onmessage = (evt) => {
      let msg;
      try { msg = JSON.parse(evt.data); } catch (e) { return; }
      if (!msg || !msg.type) return;

      const msgPairNorm = normalizePair(msg.pair);
      const selPairNorm = normalizePair(selectedPair);

      // 1. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞµÑˆ Ñ†ĞµĞ½ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ°Ñ€
      if (msg.type === "price" && msg.pair && msg.price) {
          marketPrices[msgPairNorm] = Number(msg.price);
          
          // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ñ†ĞµĞ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹ - Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ UI
          if (msgPairNorm === selPairNorm) {
             const prevPrice = marketPrices[msgPairNorm]; // (ÑÑ‚Ğ°Ñ€Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ) - Ñ‚ÑƒÑ‚ Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ½ĞµÑ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ, Ğ½Ğ¾ Ğ´Ğ»Ñ Ñ†Ğ²ĞµÑ‚Ğ° Ğ¿Ğ¾Ğ¹Ğ´ĞµÑ‚
             // Ğ›ÑƒÑ‡ÑˆĞµ Ğ±Ñ‹Ğ»Ğ¾ Ğ±Ñ‹ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ prevPrice Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾, Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ñ‹:
             const currentPrice = Number(msg.price);
             $('priceDisplay').textContent = formatPrice(currentPrice);
             
             // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ²ĞµÑ‡ĞµĞ¹
             if (lastCandle) {
                const now = Math.floor(Date.now()/1000);
                const minTime = now - (now % 60);
                if (minTime === lastCandle.time) {
                  lastCandle.high = Math.max(lastCandle.high, currentPrice);
                  lastCandle.low = Math.min(lastCandle.low, currentPrice);
                  lastCandle.close = currentPrice;
                  candleSeries.update(lastCandle);
                } else {
                  lastCandle = { time: minTime, open: lastCandle.close, high: currentPrice, low: currentPrice, close: currentPrice };
                  candleSeries.update(lastCandle);
                }
             }
          }
          // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ PnL (Ğ±ĞµĞ· Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¿ĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²ĞºĞ¸ DOM!)
          renderPositions(false); 
          return;
      }

      // Order Book Ğ¸ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹
      if (msgPairNorm !== selPairNorm) return;

      if (msg.type === "orderBook") {
          renderOrderBook(msg.buy || msg.bids, msg.sell || msg.asks);
          return;
      }

      if (msg.type === "history") {
        const data = msg.data.map(c => ({ time:c.time, open:c.open, high:c.high, low:c.low, close:c.close }));
        candleSeries.setData(data);
        chart.timeScale().fitContent();
        chart.priceScale('right').applyOptions({ autoScale: true });

        if (data.length) {
          lastCandle = data[data.length-1];
          marketPrices[selPairNorm] = lastCandle.close; // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ†ĞµĞ½Ñƒ
          $('priceDisplay').textContent = formatPrice(lastCandle.close);
        }
        if (historyResolve) { historyResolve(); historyResolve = null; }
        return;
      }

      if (msg.type === "trades") {
        const newTrades = msg.trades || [];
        localTrades = [...newTrades, ...localTrades];
        if (localTrades.length > 20) localTrades = localTrades.slice(0, 20);
        renderTrades(localTrades);
        return;
      }
    };

    socket.onclose = () => setTimeout(connectWS, 2000);
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // UI RENDERERS (FIXED)
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  
  // Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 1: "Ğ£Ğ¼Ğ½Ñ‹Ğ¹" Ñ€ĞµĞ½Ğ´ĞµÑ€ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹. ĞĞµ ÑƒĞ½Ğ¸Ñ‡Ñ‚Ğ¾Ğ¶Ğ°ĞµÑ‚ DOM, ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾.
  function renderPositions(forceRebuild = false) {
    const list = $('positionsList');
    if (!window._positions) window._positions = [];
    const positions = window._positions;

    // 1. Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ½ĞµÑ‚
    if (positions.length === 0) {
        if (list.innerHTML.includes("pos-item")) { // Ğ•ÑĞ»Ğ¸ Ñ‚Ğ°Ğ¼ Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸, Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµĞ¼
            list.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>';
        } else if (forceRebuild) {
            list.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>';
        }
        return;
    }

    // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºÑƒ "No open positions", ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ñ‚Ğ°Ğ¼ ĞµÑÑ‚ÑŒ Ğ¸ Ğ¼Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
    if (positions.length > 0 && list.innerText.includes("No open positions")) {
        list.innerHTML = "";
    }

    // 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ (ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ½ĞµÑ‚ Ğ² _positions, Ğ½Ğ¾ ĞµÑÑ‚ÑŒ Ğ² DOM)
    const existingIds = Array.from(list.querySelectorAll('.pos-item')).map(el => el.dataset.id);
    const currentIds = positions.map(p => String(p.id || p._id));
    
    // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ»Ğ¸ÑˆĞ½Ğ¸Ğµ DOM ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹
    existingIds.forEach(domId => {
        if (!currentIds.includes(domId)) {
            const el = document.getElementById('pos-item-' + domId);
            if(el) el.remove();
        }
    });
    
    // Ğ•ÑĞ»Ğ¸ Ğ²ÑĞµ ÑƒĞ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ğ¸ ÑÑ‚Ğ°Ğ»Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¾
    if(list.children.length === 0 && positions.length === 0) {
         list.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>';
         return;
    }

    // 3. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹
    [...positions].reverse().forEach(pos => {
      const id = String(pos.id || pos._id);
      const pair = normalizePair(pos.pair || "BTC-USD");
      
      // Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 2: Ğ‘ĞµÑ€ĞµĞ¼ Ñ†ĞµĞ½Ñƒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹ Ğ¸Ğ· marketPrices
      const currentAssetPrice = marketPrices[pair]; 
      
      const entry = Number(pos.entry_price || pos.entryPrice);
      const size = Number(pos.size);
      const type = (pos.type || "LONG").toUpperCase();
      const lev = Number(pos.leverage || 1);
      
      let pnl = 0;
      let markPriceDisplay = "--.--";

      if(currentAssetPrice > 0) {
        markPriceDisplay = formatPrice(currentAssetPrice);
        const diff = (currentAssetPrice - entry) / entry;
        pnl = diff * size * (type==="SHORT"? -1 : 1);
      }
      
      const pnlClass = pnl >= 0 ? "text-green" : "text-red";
      const pnlText = (pnl > 0 ? '+' : '') + pnl.toFixed(2) + " VP";

      // Ğ˜Ñ‰ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚
      let div = document.getElementById('pos-item-' + id);
      
      if (!div) {
          // Ğ¡ĞĞ—Ğ”ĞĞ•Ğœ ĞĞĞ’Ğ«Ğ™
          div = document.createElement('div');
          div.className = "pos-item";
          div.id = 'pos-item-' + id;
          div.dataset.id = id;
          
          div.innerHTML = `
            <div class="pos-header">
               <span class="${type==='LONG'?'text-green':'text-red'}">${type} ${pair} <span class="lev-badge">x${lev}</span></span>
               <span class="pnl-val ${pnlClass}">${pnlText}</span>
            </div>
            <div class="pos-details">
               <div>Entry <div class="pos-val">${formatPrice(entry)}</div></div>
               <div>Mark <div class="pos-val mark-val">${markPriceDisplay}</div></div>
               <div>Size <div class="pos-val">${size.toFixed(0)}</div></div>
               <div>Margin <div class="pos-val">${(size/lev).toFixed(2)}</div></div>
            </div>
            <button class="close-btn" data-id="${id}">Close Position</button>
            <style>.lev-badge {font-size:10px; opacity:0.7; border:1px solid currentColor; padding:1px 3px; border-radius:3px;}</style>
          `;
          list.appendChild(div); // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² ĞºĞ¾Ğ½ĞµÑ† (Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¼Ñ‹ Ğ´ĞµĞ»Ğ°ĞµĞ¼ reverse forEach, Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ğ°Ğ¶ĞµĞ½, Ğ½Ğ¾ Ğ·Ğ´ĞµÑÑŒ ÑƒĞ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¼)
          
          // Ğ’ĞµÑˆĞ°ĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸
          div.querySelector('.close-btn').onclick = () => closePosition(id, pair);
      } else {
          // ĞĞ‘ĞĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ®Ğ©Ğ˜Ğ™ (Ğ‘Ğ•Ğ— Ğ¿ĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²ĞºĞ¸ Ğ²ÑĞµĞ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°)
          // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ PnL
          const pnlEl = div.querySelector('.pnl-val');
          if(pnlEl.textContent !== pnlText) {
             pnlEl.textContent = pnlText;
             pnlEl.className = `pnl-val ${pnlClass}`;
          }
          // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Mark Price
          const markEl = div.querySelector('.mark-val');
          if(markEl.textContent !== markPriceDisplay) {
             markEl.textContent = markPriceDisplay;
          }
      }
    });
  }

  function smartUpdateOrderBook(buys = [], sells = [], topLevels = 10) {
    const container = $('orderBook');
    const maxLevels = topLevels;
    const bidMap = new Map();
    buys.forEach(l => { const s = Number(l.size) || 0; if (s > 0) bidMap.set(Number(l.price).toFixed(2), s); });
    const askMap = new Map();
    sells.forEach(l => { const s = Number(l.size) || 0; if (s > 0) askMap.set(Number(l.price).toFixed(2), s); });

    let sortedAsks = Array.from(askMap.entries()).map(([p, s]) => ({ price: Number(p), size: s, type: 'ask' })).sort((a, b) => a.price - b.price).slice(0, maxLevels).reverse();
    let sortedBids = Array.from(bidMap.entries()).map(([p, s]) => ({ price: Number(p), size: s, type: 'bid' })).sort((a, b) => b.price - a.price).slice(0, maxLevels);
    const renderList = [...sortedAsks, ...sortedBids];
    const maxVol = Math.max(...renderList.map(x => x.size), 0.0000001);
    
    // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ğ°Ñ, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ‚Ğ¾Ğ¶Ğµ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ, Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ° Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ, Ñ‚Ğ°Ğº ĞºĞ°Ğº ÑÑ‚Ğ°ĞºĞ°Ğ½ Ğ½Ğµ Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ğ¸Ğ½Ğ¿ÑƒÑ‚Ñ‹
    container.innerHTML = ""; 
    
    renderList.forEach(level => {
      const isAsk = level.type === 'ask';
      const row = document.createElement('div');
      row.className = 'ob-row';
      row.innerHTML = `<div class="ob-bg ${isAsk ? 'bg-red' : 'bg-green'}" style="width:${(level.size / maxVol) * 100}%"></div><span class="price-cell ${isAsk ? 'text-red' : 'text-green'}">${formatPrice(level.price)}</span><span class="size-cell" style="text-align:right;">${level.size.toFixed(5)}</span>`;
      container.appendChild(row);
    });
    
    const updEl = $('bookUpdated');
    if (updEl) updEl.textContent = new Date().toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
  }

  function renderOrderBook(buys, sells) {
    const b = Array.isArray(buys) ? buys : (buys?.bids || []);
    const s = Array.isArray(sells) ? sells : (sells?.asks || []);
    smartUpdateOrderBook(b, s, 10);
  }

  function renderTrades(trades) {
    const el = $('tradeHistory');
    if(!Array.isArray(trades)) return;
    let html = "";
    trades.forEach(t => {
      const color = t.side === 'buy' ? 'text-green' : 'text-red';
      const timeStr = new Date(t.time).toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
      html += `<div class="ob-row"><span class="${color}">${formatPrice(t.price)}</span><span class="trade-time">${timeStr}</span></div>`;
    });
    el.innerHTML = html;
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // ACTIONS
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  async function openPosition(type) {
    const margin = Number($('sizeInput').value);
    const currentPrice = marketPrices[selectedPair]; // Ğ‘ĞµÑ€ĞµĞ¼ Ñ†ĞµĞ½Ñƒ Ğ¸Ğ· Ğ½Ğ°ÑˆĞµĞ³Ğ¾ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ°

    if(!margin || margin <= 0) return alert("Enter margin");
    if(!currentPrice) return alert("Waiting for price...");
    
    const size = margin * currentLeverage; 
    if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

    try {
      const res = await fetch(API_BASE + "/api/order/open", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ userId: currentUserId, pair: selectedPair, type, size, leverage: currentLeverage, entryPrice: currentPrice })
      });
      const data = await res.json();
      if(data.ok) {
        window._positions.push(data.position);
        if(data.newBalance) { profile.balance = data.newBalance; updateBalanceUI(); }
        renderPositions(true); // Ğ¤Ğ¾Ñ€ÑĞ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°)
        if(tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
      } else { 
          alert(data.error || "Error"); 
      }
    } catch(e) { console.error(e); }
  }

  // Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ pair, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ·ÑÑ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½ÑƒÑ Ñ†ĞµĞ½Ñƒ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
  async function closePosition(id, pair) {
    const pos = window._positions.find(p => (p.id == id || p._id == id));
    if(!pos) return;

    // Ğ‘ĞµÑ€ĞµĞ¼ Ñ†ĞµĞ½Ñƒ Ğ˜ĞœĞ•ĞĞĞ Ğ­Ğ¢ĞĞ™ Ğ¿Ğ°Ñ€Ñ‹
    const closePrice = marketPrices[pair || pos.pair];

    if(!closePrice) return alert("Price not available for " + pair);

    if(!confirm("Close position?")) return;
    try {
      const res = await fetch(API_BASE + "/api/order/close", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ userId: currentUserId, positionId: id, closePrice: closePrice })
      });
      const data = await res.json();
      if(data.ok) {
        window._positions = window._positions.filter(p => (p.id!=id && p._id!=id));
        if(data.newBalance) { profile.balance = data.newBalance; updateBalanceUI(); }
        
        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ¸Ğ· DOM Ğ°ĞºĞºÑƒÑ€Ğ°Ñ‚Ğ½Ğ¾
        const el = document.getElementById('pos-item-' + id);
        if(el) el.remove();
        renderPositions(false); // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¿ÑƒÑÑ‚Ğ¾ Ğ»Ğ¸ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ
        
        if(tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
      }
    } catch(e) { console.error(e); }
  }

  $('openLong').onclick = () => openPosition("LONG");
  $('openShort').onclick = () => openPosition("SHORT");
  
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // INIT
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  const loaderEl = $('app-loader');
  const loaderBar = $('loaderBar');
  function setProgress(pct, txt) { loaderBar.style.width = pct + '%'; $('loaderText').textContent = txt; }

  setProgress(20, "AUTH...");
  await initSession();
  
  setProgress(50, "STREAM...");
  connectWS();
  
  // Ğ–Ğ´ĞµĞ¼ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚
  await Promise.race([historyPromise, new Promise(r => setTimeout(r, 4000))]);
  setProgress(100, "READY");
  
  setTimeout(() => {
    loaderEl.classList.add('hidden');
    setTimeout(() => loaderEl.style.display = 'none', 400);
  }, 500);

})();
</script>
</body>
</html>
