<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TradeSim — BTC/ETH Futures (Telegram auth)</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- Lightweight-charts -->
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ————— ТВОЙ СТИЛЬ БЕЗ ИЗМЕНЕНИЙ ————— */
:root{
  --bg:#0B0E11;
  --panel:#1E2329;
  --muted:#98A0A6;
  --accent-green:#0ECB81;
  --accent-red:#F6465D;
  --glass: rgba(255,255,255,0.02);
  --white:#E6EEF3;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--white);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
.app{display:flex;flex-direction:column;height:100vh;}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid rgba(255,255,255,0.03)}
.brand{display:flex;align-items:center;gap:12px}
.logo{font-weight:700;font-size:18px}
.profile{display:flex;align-items:center;gap:12px}
.avatar{width:44px;height:44px;border-radius:50%;background:#222;overflow:hidden;flex-shrink:0}
.avatar img{width:100%;height:100%;object-fit:cover}
.profile-info{display:flex;flex-direction:column;font-size:13px}
.profile-name{font-weight:600}
.profile-username{color:var(--muted);font-size:12px}
.profile-balance{font-family:"Roboto Mono",monospace;color:#cfd8dc;font-weight:700;margin-top:4px;font-size:13px}
.container{display:grid;grid-template-columns:1fr 360px;gap:12px;padding:12px;height:calc(100vh - 72px);overflow:hidden;}
.left-col{display:flex;flex-direction:column;gap:12px}
.card{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 4px 18px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
.chart-wrap{height:56vh;border-radius:10px;overflow:hidden;}
.top-stats{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
.price{font-family:"Roboto Mono",monospace;font-size:28px;font-weight:700}
.price-change{font-weight:700;padding:6px 8px;border-radius:8px;font-size:13px}
.price-change.up{background:rgba(14,190,131,0.12);color:var(--accent-green)}
.price-change.down{background:rgba(246,70,93,0.10);color:var(--accent-red)}
.controls{display:flex;gap:10px;margin-top:8px}
.controls input, .controls select{background:#111;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);color:var(--white);font-size:14px}
.segment{display:flex;gap:8px}
.chip{padding:8px 10px;border-radius:8px;background:#15181b;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
.chip.active{border-color:rgba(255,255,255,0.06);box-shadow:0 4px 10px rgba(0,0,0,0.6)}
.right-col{display:flex;flex-direction:column;gap:12px}
.side-section{display:flex;flex-direction:column;gap:8px;overflow:hidden}
.orderbook-list{display:flex;flex-direction:column;gap:6px;font-size:13px;color:var(--muted);max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg, transparent, rgba(255,255,255,0.01))}
.orderbook-row{display:flex;justify-content:space-between;gap:8px;padding:6px 8px;border-radius:6px}
.orderbook-row .price{width:100px}
.orderbook-row.buy .price{color:var(--accent-green)}
.orderbook-row.sell .price{color:var(--accent-red)}
.trade-history{max-height:160px;overflow:auto;padding:8px}
.trade-row{display:flex;justify-content:space-between;padding:6px 8px;border-radius:6px;font-size:13px}
.pos-card{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.01)}
.bottom-nav{display:flex;gap:8px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-top:1px solid rgba(255,255,255,0.02)}
.btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn-primary{background:var(--accent-green);color:#001}
.btn-danger{background:var(--accent-red);color:#001}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--white)}
.pair-switch { display:flex; gap:8px; align-items:center; margin-right:8px; }
.pair-btn { padding:6px 8px; border-radius:8px; background:#101216; border:1px solid rgba(255,255,255,0.02); cursor:pointer; color:var(--muted) }
.pair-btn.active { color:var(--white); border-color:rgba(255,255,255,0.06); box-shadow:0 6px 18px rgba(0,0,0,0.6) }
</style>
</head>

<body>
<div class="app">

<!-- HEADER — без изменений -->
<header class="header">
  <div class="brand">
    <div class="logo">⧉ TradeSim</div>
    <div style="color:var(--muted);font-size:13px">BTC/ETH Futures demo</div>
  </div>

  <div style="display:flex;align-items:center;gap:12px">
    <div class="pair-switch" id="pairSwitch">
      <div class="pair-btn active" data-pair="BTC-USD">BTC</div>
      <div class="pair-btn" data-pair="ETH-USD">ETH</div>
    </div>

    <div class="profile" id="profileArea">
      <div class="avatar" id="avatarWrap"><img id="avatarImg" src=""></div>
      <div class="profile-info">
        <div class="profile-name" id="profileName">—</div>
        <div class="profile-username" id="profileUsername">@—</div>
        <div class="profile-balance" id="profileBalance">Баланс: 0 VP</div>
      </div>
    </div>
  </div>
</header>

<!-- MAIN LAYOUT — без изменений -->
<main class="container">
  <section class="left-col">
    <div class="card">
      <div class="top-stats">
        <div>
          <div style="color:var(--muted);font-size:12px">Пара</div>
          <div style="display:flex;align-items:center;gap:12px;margin-top:6px">
            <div style="font-weight:700" id="pairLabel">BTC / USD</div>
            <div id="marketTag" style="background:var(--glass);padding:4px 8px;border-radius:8px;color:var(--muted);font-size:12px">Perpetual (sim)</div>
          </div>
        </div>

        <div style="text-align:right">
          <div class="price" id="priceDisplay">—</div>
          <div id="priceChange" class="price-change">—</div>
        </div>
      </div>

      <div class="chart-wrap card" id="chartCard">
        <div id="chart" style="width:100%;height:100%;"></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
        <div class="controls" style="flex:1">
          <input id="sizeInput" type="number" placeholder="Сумма (VP)" value="100" />
          <div class="segment" id="leverageSegment" style="align-items:center">
            <div class="chip" data-value="1">x1</div>
            <div class="chip" data-value="5">x5</div>
            <div class="chip active" data-value="10">x10</div>
            <div class="chip" data-value="20">x20</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-left:12px">
          <button id="openLong" class="btn btn-primary">BUY / LONG</button>
          <button id="openShort" class="btn btn-danger">SELL / SHORT</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Positions</div>
        <div style="color:var(--muted);font-size:13px">live</div>
      </div>
      <div id="positionsList" style="margin-top:10px"></div>
    </div>
  </section>

  <aside class="right-col">
    <div class="card side-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Order Book</div>
        <div style="color:var(--muted);font-size:13px" id="bookPairLabel">BTC-USD</div>
      </div>
      <div class="orderbook-list" id="orderBook"></div>
    </div>

    <div class="card side-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Trade History</div>
        <div style="color:var(--muted);font-size:13px" id="tradesPairLabel">BTC-USD</div>
      </div>
      <div class="trade-history" id="tradeHistory"></div>
    </div>
  </aside>
</main>

<div class="bottom-nav">
  <button id="btnProfile" class="btn btn-ghost">Профиль</button>
  <button id="btnFutures" class="btn btn-primary">Перейти в Фьючерсы</button>
  <div style="flex:1"></div>
  <div style="color:var(--muted);font-size:13px;padding:6px 8px">WS: <span id="wsStatus">—</span></div>
</div>

</div> <!-- app -->

<script>
(async function(){

// ==============================
// CONFIG
// ==============================
const WSS_PRICE_URL = "wss://tradingbot-backend-2yws.onrender.com"; // твой WSS

// ==============================
// TELEGRAM PROFILE (без изменений)
// ==============================
const tg = window.Telegram?.WebApp;
let profile = { first_name:"Guest", username:"", avatar:"", balance:0 };

if (tg?.initDataUnsafe?.user){
  const u = tg.initDataUnsafe.user;
  profile = {
    first_name: u.first_name || "Guest",
    username: u.username || "",
    avatar: u.photo_url || "",
    balance: 0
  };
}

document.getElementById("avatarImg").src = profile.avatar;
document.getElementById("profileName").textContent = profile.first_name;
document.getElementById("profileUsername").textContent = profile.username ? "@"+profile.username : "";
document.getElementById("profileBalance").textContent = "Баланс: 0 VP";

// ==============================
// CHART (без изменений, только доступ к chart/timeScale)
// ==============================
const chartDiv = document.getElementById("chart");
const chart = LightweightCharts.createChart(chartDiv,{
  width: chartDiv.clientWidth,
  height: chartDiv.clientHeight,
  layout:{ background:{color:getComputedStyle(document.body).getPropertyValue('--bg')}, textColor:'#D1D8DE' },
  grid:{ horzLines:{color:'rgba(255,255,255,0.03)'}, vertLines:{color:'rgba(255,255,255,0.03)'} },
  priceScale:{ borderVisible:false },
  timeScale:{ borderVisible:false }
});

const candleSeries = chart.addCandlestickSeries({
  upColor:'rgba(14,190,131,1)',
  borderUpColor:'rgba(14,190,131,1)',
  wickUpColor:'rgba(14,190,131,1)',
  downColor:'rgba(246,70,93,1)',
  borderDownColor:'rgba(246,70,93,1)',
  wickDownColor:'rgba(246,70,93,1)'
});

window.addEventListener("resize",()=>{
  chart.applyOptions({ width:chartDiv.clientWidth, height:chartDiv.clientHeight });
});

// ==============================
// STATE
// ==============================
let selectedPair = "BTC-USD";
let currentPrice = 0;
let lastCandle = null;

// локальный стор истории (кэш)
const pairHistory = {
  "BTC-USD": [],
  "ETH-USD": []
};

document.getElementById("pairLabel").textContent = "BTC / USD";
document.getElementById("bookPairLabel").textContent = selectedPair;
document.getElementById("tradesPairLabel").textContent = selectedPair;

// ==============================
// WS CLIENT
// ==============================
let socket = null;
const wsStatus = document.getElementById("wsStatus");

function connectWS(){
  socket = new WebSocket(WSS_PRICE_URL);

  socket.onopen = () => {
    wsStatus.textContent = "connected";
    // сразу подпишемся на выбранную пару
    subscribePair(selectedPair);
  };

  socket.onclose = () => {
    wsStatus.textContent = "closed";
    setTimeout(connectWS,1500);
  };

  socket.onerror = () => {
    wsStatus.textContent = "error";
  };

  socket.onmessage = evt => {
    try {
      const msg = JSON.parse(evt.data);
      handleWS(msg);
    } catch(e){ console.error("WS parse error", e); }
  };
}

function subscribePair(pair){
  if (socket && socket.readyState === WebSocket.OPEN){
    socket.send(JSON.stringify({ type:"subscribe", pair }));
  }
}

function unsubscribePair(pair){
  if (socket && socket.readyState === WebSocket.OPEN){
    socket.send(JSON.stringify({ type:"unsubscribe", pair }));
  }
}

// ==============================
// WS HANDLER
// ==============================
function handleWS(msg){
  if (!msg.type) return;

  // ======== LONGER HISTORY HANDLING ========
  if (msg.type === "history") {
      if (!msg.pair) return;
      if (!pairHistory[msg.pair]) pairHistory[msg.pair] = [];

      // Сохраняем массив свечей (ожидаем уже в формате time/open/..)
      pairHistory[msg.pair] = msg.data.map(c => ({
          time: c.time,
          open: c.open,
          high: c.high,
          low: c.low,
          close: c.close
      }));

      // Если это текущая выбранная пара — рисуем и СБРАСЫВАЕМ зум
      if (msg.pair === selectedPair) {
          const candles = pairHistory[msg.pair];
          if (candles.length > 0) {
              candleSeries.setData(candles);

              // Сбрасываем зум: явно задаём видимый диапазон по всей истории
              const firstTime = candles[0].time;
              const lastTime = candles[candles.length - 1].time;
              // Устанавливаем видимую область ровно под данные — это надёжнее, чем только fitContent()
              try {
                chart.timeScale().setVisibleRange({ from: firstTime, to: lastTime });
              } catch(e){
                // fallback
                chart.timeScale().fitContent();
              }

              lastCandle = candles[candles.length - 1];
              currentPrice = lastCandle ? lastCandle.close : 0;
              updatePriceUI();
          } else {
              // если пришла пустая история — очищаем график
              candleSeries.setData([]);
              chart.timeScale().fitContent();
              lastCandle = null;
              currentPrice = 0;
              updatePriceUI();
          }
      }
      return;
  }

  // ======== PRICE UPDATES ========
  if (msg.type === "price" && msg.pair === selectedPair){
    currentPrice = Number(msg.price);

    // обновление свечи (1m)
    const now = Math.floor(Date.now() / 1000);
    const minute = Math.floor(now/60)*60;
    if (!lastCandle || lastCandle.time !== minute){
      lastCandle = {
        time: minute,
        open: currentPrice,
        high: currentPrice,
        low: currentPrice,
        close: currentPrice
      };
    } else {
      lastCandle.high = Math.max(lastCandle.high,currentPrice);
      lastCandle.low  = Math.min(lastCandle.low,currentPrice);
      lastCandle.close=currentPrice;
    }
    candleSeries.update(lastCandle);
    updatePriceUI();
  }

  // ======== ORDERBOOK / TRADES ========
  if (msg.type === "orderBook" && msg.pair === selectedPair){
    renderOrderBook(msg.buy,msg.sell);
  }

  if (msg.type === "trades" && msg.pair === selectedPair){
    renderTrades(msg.trades);
  }
}

// ==============================
// UI RENDER (без изменений)
// ==============================
function updatePriceUI(){
  document.getElementById("priceDisplay").textContent = currentPrice ? currentPrice.toFixed(2) : "—";
}

function renderOrderBook(buys,sells){
  const el = document.getElementById("orderBook");
  el.innerHTML = "";

  sells.slice(0,20).forEach(s=>{
    const r=document.createElement("div");
    r.className="orderbook-row sell";
    r.innerHTML=`<div class="price">${s.price.toFixed(2)}</div><div>${s.size.toFixed(4)}</div>`;
    el.appendChild(r);
  });

  el.appendChild(Object.assign(document.createElement("div"),{style:"height:6px"}));

  buys.slice(0,20).forEach(b=>{
    const r=document.createElement("div");
    r.className="orderbook-row buy";
    r.innerHTML=`<div class="price">${b.price.toFixed(2)}</div><div>${b.size.toFixed(4)}</div>`;
    el.appendChild(r);
  });
}

function renderTrades(list){
  const el=document.getElementById("tradeHistory");
  el.innerHTML="";
  (list||[]).slice().reverse().forEach(t=>{
    const row=document.createElement("div");
    row.className="trade-row";
    const color = t.side==="buy" ? "var(--accent-green)" : "var(--accent-red)";
    row.innerHTML = `
      <div style="color:${color};font-family:Roboto Mono">${t.price.toFixed(2)}</div>
      <div>${t.size.toFixed(3)}</div>
      <div style="color:var(--muted);font-size:12px">${new Date(t.time).toLocaleTimeString()}</div>
    `;
    el.appendChild(row);
  });
}

// ==============================
// PAIR SWITCH — теперь надежно сбрасываем график и подписку
// ==============================
document.querySelectorAll(".pair-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{

    // UI активная кнопка
    document.querySelectorAll(".pair-btn").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");

    const newPair = btn.dataset.pair;
    if (newPair === selectedPair) return;

    // 1) Unsubscribe old
    unsubscribePair(selectedPair);

    // 2) Reset chart & UI (сброс зума)
    candleSeries.setData([]);               // очищаем свечи
    try { chart.timeScale().fitContent(); } catch(e){/* noop */} // сброс визуала
    lastCandle = null;
    currentPrice = 0;
    updatePriceUI();

    // clean UI blocks
    document.getElementById("orderBook").innerHTML="";
    document.getElementById("tradeHistory").innerHTML="";

    // 3) switch var
    selectedPair = newPair;
    document.getElementById("pairLabel").textContent = newPair.replace("-"," / ");
    document.getElementById("bookPairLabel").textContent = newPair;
    document.getElementById("tradesPairLabel").textContent = newPair;

    // 4) If we have local cache - show it and reset view
    if (pairHistory[selectedPair] && pairHistory[selectedPair].length > 0) {
        const candles = pairHistory[selectedPair];
        candleSeries.setData(candles);
        try {
          chart.timeScale().setVisibleRange({ from: candles[0].time, to: candles[candles.length-1].time });
        } catch(e){
          chart.timeScale().fitContent();
        }
        lastCandle = candles[candles.length - 1];
        currentPrice = lastCandle?.close || 0;
        updatePriceUI();
    }

    // 5) Subscribe new - server отправит историю и всё остальное
    subscribePair(selectedPair);
  });
});

// ==============================
// START
// ==============================
connectWS();

})();
</script>

</body>
</html>
