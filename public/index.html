<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Crypto Futures</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
    body {
        margin: 0;
        background: #0d0d0d;
        color: #ffffff;
        font-family: Arial, sans-serif;
    }

    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px;
        background: #111;
        border-bottom: 1px solid #222;
    }

    #profile {
        display: flex;
        gap: 14px;
        align-items: center;
    }

    #profile img {
        width: 42px;
        height: 42px;
        border-radius: 50%;
    }

    #chart {
        width: 100%;
        height: 380px;
    }

    .trade-box {
        padding: 14px;
        background: #111;
        border-top: 1px solid #222;
    }

    input {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        background: #222;
        border: none;
        color: white;
        border-radius: 6px;
    }

    button.buy {
        width: 100%;
        margin-top: 14px;
        background: #0f8f4d;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 17px;
        color: white;
    }

    button.sell {
        width: 100%;
        margin-top: 8px;
        background: #b3252a;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 17px;
        color: white;
    }
</style>
</head>

<body>

<header>
    <div style="font-size: 20px;">Crypto Futures</div>
    <div id="profile">
        <img id="p_photo">
        <div>
            <div id="p_name"></div>
            <div id="p_balance" style="color:#0f8f4d;font-size:14px;"></div>
        </div>
    </div>
</header>

<div id="chart"></div>

<div class="trade-box">
    <input id="amount" type="number" placeholder="Количество (min 0.001)">
    <button class="buy" onclick="makeTrade('buy')">Купить</button>
    <button class="sell" onclick="makeTrade('sell')">Продать</button>
</div>

<script>
const tg = window.Telegram.WebApp;

// === Прячем логи ===
console.log = function(){};

tg.expand();

// === 1. Проверяем сидят ли мы в Telegram ===
if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
    document.body.innerHTML = "<h2>Открой Mini App через Telegram</h2>";
    throw new Error("NO_TELEGRAM");
}

const initData = tg.initData;

// === 2. Авторизация ===
async function initSession() {
    const req = await fetch("/api/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData })
    });

    const res = await req.json();
    if (!res.ok) {
        document.body.innerHTML = "<h3>Ошибка инициализации</h3>";
        return;
    }

    const user = tg.initDataUnsafe.user;

    // Профиль
    document.getElementById("p_name").innerText =
        user.first_name + " " + (user.last_name || "");
    document.getElementById("p_photo").src = user.photo_url;
    document.getElementById("p_balance").innerText =
        "Баланс: " + res.user.balance + " USDT";
}

initSession();

// === 3. Загружаем историю ===
async function loadHistory() {
    const r = await fetch("https://tradingbot-backend-2yws.onrender.com/history");
    const data = await r.json();
    return data.candles;
}

// === 4. Отрисовка графика ===
const chart = LightweightCharts.createChart(document.getElementById("chart"), {
    layout: { background: { color: "#0d0d0d" }, textColor: "white" },
    grid: {vertLines: {color:"#222"}, horzLines:{color:"#222"}},
    candleStyle: { upColor:"#0f8f4d", downColor:"#b3252a" },
});
const series = chart.addCandlestickSeries();

loadHistory().then(candles => {
    series.setData(candles);
});

// === 5. Real-time WebSocket ===
const ws = new WebSocket("wss://tradingbot-backend-2yws.onrender.com");

ws.onmessage = msg => {
    const data = JSON.parse(msg.data);
    if (data.type === "price") {
        series.update({
            time: Math.floor(data.time / 1000),
            open: data.price,
            high: data.price,
            low: data.price,
            close: data.price
        });
    }
};

// === 6. Сделки ===
function makeTrade(type) {
    const amount = Number(document.getElementById("amount").value);

    if (amount <= 0) {
        alert("Количество должно быть больше 0");
        return;
    }

    alert(type.toUpperCase() + " " + amount);
}
</script>

</body>
</html>
