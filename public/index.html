<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>TradeSim</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ————— CORE STYLES ————— */
:root {
  --bg: #0B0E11;
  --panel: #1E2329;
  --panel-light: #2A2F36;
  --muted: #848E9C;
  --accent-green: #0ECB81;
  --accent-red: #F6465D;
  --white: #EAECEF;
  --border: rgba(255, 255, 255, 0.05);
  --thumb-size: 20px;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; margin: 0; background: var(--bg); color: var(--white); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }

/* Scrollbar styling */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

/* ————— LAYOUT ————— */
.app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }

/* HEADER REDESIGN */
.header {
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  height: 60px;
}

.header-left { display: flex; align-items: center; gap: 16px; }

.logo-img {
  height: 32px;
  width: auto;
  display: block;
}

/* Custom Select for Pairs */
.pair-select-wrapper {
  position: relative;
}
.pair-select {
  appearance: none;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--white);
  padding: 6px 32px 6px 12px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  outline: none;
}
.pair-select-wrapper::after {
  content: '▼';
  font-size: 10px;
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
  pointer-events: none;
}

/* User Area (Balance + Avatar) */
.user-area {
  display: flex; align-items: center; gap: 10px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 8px;
  transition: background 0.2s;
}
.user-area:active { background: rgba(255,255,255,0.05); }

.balance-group {
  text-align: right;
  line-height: 1.2;
}
.balance-label { font-size: 10px; color: var(--muted); display: block; }
.balance-val { font-size: 13px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono', monospace; }

.avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; border: 1px solid var(--border); }
.avatar-sm img { width: 100%; height: 100%; object-fit: cover; }

/* ————— MAIN CONTAINER ————— */
.container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 12px;
  gap: 12px;
  /* Removed bottom padding since nav is gone */
}

/* Desktop override */
@media (min-width: 900px) {
  .container {
    display: grid;
    grid-template-columns: 1fr 320px;
    height: calc(100vh - 60px);
    overflow: hidden;
  }
  .left-col { overflow-y: auto; padding-right: 4px; }
  .right-col { display: flex; flex-direction: column; gap: 12px; overflow: hidden; }
}

.card {
  background: var(--panel);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid var(--border);
}

/* ————— MARKET INFO ————— */
.market-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 12px; }
.price-display { font-family: 'Roboto Mono', monospace; font-size: 32px; font-weight: 700; line-height: 1; }
.price-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

/* ————— CHART ————— */
.chart-container {
  height: 350px; 
  width: 100%; 
  border-radius: 8px; 
  overflow: hidden; 
  position: relative;
  background: #111; 
}
@media (min-width: 900px) { .chart-container { height: 50vh; } }

/* ————— TRADING CONTROLS ————— */
.controls-area { display: flex; flex-direction: column; gap: 16px; margin-top: 12px; }

.input-group { position: relative; }
.input-label { position: absolute; top: 8px; left: 12px; font-size: 10px; color: var(--muted); }
.main-input {
  width: 100%; background: #111; border: 1px solid var(--border); color: var(--white);
  padding: 22px 12px 8px 12px; border-radius: 8px; font-size: 16px; font-family: 'Roboto Mono', monospace; outline: none;
}
.main-input:focus { border-color: var(--accent-green); }

/* Leverage Slider Styling */
.leverage-wrap { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
.lev-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
.lev-val { color: var(--accent-green); font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

.range-slider {
  -webkit-appearance: none; width: 100%; height: 6px; background: #2A2F36; border-radius: 3px; outline: none; margin: 10px 0;
}
.range-slider::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: var(--thumb-size); height: var(--thumb-size); border-radius: 50%; 
  background: var(--white); cursor: pointer; box-shadow: 0 0 10px rgba(0,0,0,0.5);
  border: 2px solid var(--accent-green);
  margin-top: -7px; 
}
.range-slider::-webkit-slider-runnable-track { height: 6px; border-radius: 3px; }

.chips-row { display: flex; justify-content: space-between; gap: 4px; margin-top: 4px; }
.chip {
  flex: 1; text-align: center; padding: 6px 0; font-size: 11px; background: #15181b; 
  border-radius: 6px; cursor: pointer; border: 1px solid var(--border); color: var(--muted); transition: 0.2s;
}
.chip:hover { background: rgba(255,255,255,0.05); }
.chip.active { background: rgba(14, 203, 129, 0.15); color: var(--accent-green); border-color: var(--accent-green); font-weight: 700; }

.action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
.btn-trade {
  padding: 14px; border-radius: 8px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; color: #fff;
  display: flex; flex-direction: column; align-items: center; line-height: 1.2;
}
.btn-trade span { font-size: 10px; font-weight: 400; opacity: 0.8; }
.btn-long { background: var(--accent-green); color: #052e1f; }
.btn-short { background: var(--accent-red); color: #2d0a0f; }

/* ————— ORDER BOOK & TRADES ————— */
.ob-container { font-size: 12px; font-family: 'Roboto Mono', monospace; display: flex; flex-direction: column; gap: 4px; }
.ob-row { display: flex; justify-content: space-between; padding: 2px 0; position: relative; z-index: 1; }
.text-green { color: var(--accent-green); }
.text-red { color: var(--accent-red); }

/* ————— POSITIONS ————— */
.pos-list { display: flex; flex-direction: column; gap: 8px; }
.pos-item { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
.pos-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 700; }
.pos-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: var(--muted); }
.pos-val { color: var(--white); font-family: 'Roboto Mono'; margin-top: 2px; }
.close-btn { 
  background: transparent; border: 1px solid var(--border); color: var(--white); 
  padding: 4px 12px; border-radius: 4px; font-size: 11px; margin-top: 8px; width: 100%; cursor: pointer;
}

/* ————— LOADER ————— */
#app-loader {
  position: fixed; inset: 0; background: var(--bg); z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.4s;
}
#app-loader.hidden { opacity: 0; pointer-events: none; }
.loader-bar-bg { width: 160px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 20px; }
.loader-bar-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.2s; }
</style>
</head>

<body>

<div id="app-loader">
  <div style="font-size: 20px; font-weight: 700; letter-spacing: -0.5px;">⧉ TradeSim</div>
  <div class="loader-bar-bg"><div class="loader-bar-fill" id="loaderBar"></div></div>
  <div style="margin-top: 10px; font-size: 11px; color: var(--muted); font-family: monospace;" id="loaderText">Initializing...</div>
</div>

<div class="app">

  <header class="header">
    <div class="header-left">
      <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="Logo" class="logo-img">
      
      <div class="pair-select-wrapper">
        <select id="pairSelect" class="pair-select">
          <option value="BTC-USD" selected>BTC/USD</option>
          <option value="ETH-USD">ETH/USD</option>
          </select>
      </div>
    </div>

    <div class="user-area" id="btnProfile">
      <div class="balance-group">
        <span class="balance-label">Balance</span>
        <span class="balance-val" id="headerBalance">0.00 VP</span>
      </div>
      <div class="avatar-sm">
        <img id="avatarImg" src="" style="display:none">
      </div>
    </div>
  </header>

  <main class="container">
    
    <div class="left-col">
      <div class="card">
        <div class="market-header">
          <div>
            <div style="color:var(--muted); font-size:11px;">Market Price</div>
            <div class="price-display text-green" id="priceDisplay">--.--</div>
          </div>
          </div>

        <div class="chart-container" id="chartCard">
          <div id="chart" style="width: 100%; height: 100%;"></div>
        </div>

        <div class="controls-area">
          <div class="input-group">
            <span class="input-label">Margin (VP)</span>
            <input type="number" id="sizeInput" class="main-input" value="100" placeholder="10-10000" />
          </div>

          <div class="leverage-wrap">
            <div class="lev-header">
              <span>Leverage</span>
              <span class="lev-val" id="leverageValText">10x</span>
            </div>
            <input type="range" class="range-slider" id="leverageSlider" min="1" max="50" step="1" value="10">
            <div class="chips-row" id="leverageChips">
              <div class="chip" data-v="1">1x</div>
              <div class="chip" data-v="5">5x</div>
              <div class="chip active" data-v="10">10x</div>
              <div class="chip" data-v="20">20x</div>
              <div class="chip" data-v="50">50x</div>
            </div>
          </div>

          <div class="action-btns">
            <button id="openLong" class="btn-trade btn-long">Buy / Long <span>Up</span></button>
            <button id="openShort" class="btn-trade btn-short">Sell / Short <span>Down</span></button>
          </div>
        </div>
      </div>

      <div style="margin-top: 12px;">
        <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px;">Open Positions</div>
        <div id="positionsList" class="pos-list">
           <div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>
        </div>
      </div>
    </div>

    <div class="right-col">
      <div class="card" style="flex:1; display:flex; flex-direction:column;">
        <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between;">
          <span>Order Book</span>
          <span style="color:var(--muted); font-size:11px;" id="bookPairLabel">BTC-USD</span>
        </div>
        <div class="ob-container" id="orderBook" style="overflow-y:auto; flex:1; max-height: 300px;"></div>
      </div>

      <div class="card" style="flex:1; display:flex; flex-direction:column;">
         <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between;">
           <span>Last Trades</span>
           <span style="color:var(--muted); font-size:11px;">Real-time</span>
         </div>
         <div class="ob-container" id="tradeHistory" style="overflow-y:auto; flex:1; max-height: 200px;"></div>
      </div>
    </div>

  </main>
  </div>

<script>
(async function(){
  const $ = (id) => document.getElementById(id);
  
  // ————————————————————————————————————————————
  // LOADER
  // ————————————————————————————————————————————
  const loaderEl = $('app-loader');
  const loaderBar = $('loaderBar');
  const loaderText = $('loaderText');
  function setProgress(pct, txt) {
    loaderBar.style.width = pct + '%';
    if(txt) loaderText.textContent = txt;
  }

  // ————————————————————————————————————————————
  // CONFIG
  // ————————————————————————————————————————————
  const WSS_PRICE_URL = "wss://tradingbot-backend-2yws.onrender.com";
  const API_BASE = "https://tradingbot-p9n8.onrender.com";
  let currentUserId = null;

  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready();
    try { tg.expand(); } catch(e){}
    tg.setHeaderColor('#1E2329');
    tg.setBackgroundColor('#0B0E11');
  }

  let selectedPair = "BTC-USD";
  let currentPrice = 0;
  let profile = { balance: 0 };
  let currentLeverage = 10;
  
  // ————————————————————————————————————————————
  // CHART SETUP
  // ————————————————————————————————————————————
  const chartEl = $('chart');
  const chart = LightweightCharts.createChart(chartEl, {
    width: chartEl.clientWidth,
    height: chartEl.clientHeight,
    layout: { background: { type: 'solid', color: '#0B0E11' }, textColor: '#848E9C' },
    grid: { horzLines: { color: 'rgba(255,255,255,0.02)' }, vertLines: { color: 'rgba(255,255,255,0.02)' } },
    rightPriceScale: { borderVisible: false, autoScale: true }, 
    timeScale: { borderVisible: false, timeVisible: true },
    crosshair: { vertLine: { color: 'rgba(255,255,255,0.1)', style: 0 }, horzLine: { color: 'rgba(255,255,255,0.1)', style: 0 } }
  });

  let candleSeries = chart.addCandlestickSeries({
    upColor: '#0ECB81', borderUpColor: '#0ECB81', wickUpColor: '#0ECB81',
    downColor: '#F6465D', borderDownColor: '#F6465D', wickDownColor: '#F6465D'
  });

  new ResizeObserver(entries => {
    if (entries.length === 0 || entries[0].target !== chartEl) { return; }
    const newRect = entries[0].contentRect;
    chart.applyOptions({ width: newRect.width, height: newRect.height });
  }).observe(chartEl);

  // ————————————————————————————————————————————
  // LEVERAGE LOGIC
  // ————————————————————————————————————————————
  const slider = $('leverageSlider');
  const levDisplay = $('leverageValText');
  const levChips = document.querySelectorAll('.chip');

  function updateLeverageUI(val) {
    currentLeverage = parseInt(val);
    slider.value = currentLeverage;
    levDisplay.textContent = currentLeverage + 'x';
    levChips.forEach(chip => {
      const chipVal = parseInt(chip.dataset.v);
      chip.classList.toggle('active', chipVal === currentLeverage);
    });
  }
  slider.addEventListener('input', (e) => updateLeverageUI(e.target.value));
  levChips.forEach(chip => chip.addEventListener('click', () => updateLeverageUI(chip.dataset.v)));
  updateLeverageUI(10);

  // ————————————————————————————————————————————
  // DATA LOGIC
  // ————————————————————————————————————————————
  let historyResolve = null;
  const historyPromise = new Promise(r => historyResolve = r);

  function updateBalanceUI() {
    // New Header Balance Logic
    $('headerBalance').textContent = profile.balance.toFixed(2) + " VP";
  }

  async function initSession() {
    try {
      let initData = tg?.initData || "";
      let res = await fetch(API_BASE + "/api/init", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify(initData ? {initData} : {})
      });
      let data = await res.json();
      if(data.ok && data.user) {
        currentUserId = data.user.user_id;
        profile.balance = Number(data.user.balance || 0);
        window._positions = data.positions || [];
        if(data.user.photo_url) { $('avatarImg').src = data.user.photo_url; $('avatarImg').style.display = 'block'; }
        
        updateBalanceUI();
        renderPositions();
      }
    } catch(e) { console.error(e); }
  }

  // Socket
  let socket = null;
  let lastCandle = null;

  function connectWS() {
    socket = new WebSocket(WSS_PRICE_URL);
    socket.onopen = () => {
      socket.send(JSON.stringify({ type:"subscribe", pair: selectedPair }));
    };
    socket.onmessage = (evt) => {
      const msg = JSON.parse(evt.data);
      if(!msg.type) return;

      if(msg.type === "price" && msg.pair === selectedPair) {
        currentPrice = Number(msg.price);
        $('priceDisplay').textContent = currentPrice.toFixed(2);
        
        const prev = lastCandle ? lastCandle.close : currentPrice;
        $('priceDisplay').className = currentPrice >= prev ? "price-display text-green" : "price-display text-red";

        if(lastCandle) {
           const now = Math.floor(Date.now()/1000);
           const minTime = now - (now % 60);
           if(minTime === lastCandle.time) {
             lastCandle.high = Math.max(lastCandle.high, currentPrice);
             lastCandle.low = Math.min(lastCandle.low, currentPrice);
             lastCandle.close = currentPrice;
             candleSeries.update(lastCandle);
           } else {
             lastCandle = { time: minTime, open: lastCandle.close, high: currentPrice, low: currentPrice, close: currentPrice };
             candleSeries.update(lastCandle);
           }
        }
        renderPositions();
      }

      if(msg.type === "history" && msg.pair === selectedPair) {
        const data = msg.data.map(c => ({ time:c.time, open:c.open, high:c.high, low:c.low, close:c.close }));
        candleSeries.setData(data);
        
        if(data.length) {
          lastCandle = data[data.length-1];
          currentPrice = lastCandle.close;
          $('priceDisplay').textContent = currentPrice.toFixed(2);
          
          // Force Scale Fit
          chart.timeScale().fitContent();
        }
        
        if(historyResolve) { historyResolve(); historyResolve = null; }
      }

      if(msg.type === "orderBook" && msg.pair === selectedPair) renderOrderBook(msg.buy, msg.sell);
      if(msg.type === "trades" && msg.pair === selectedPair) renderTrades(msg.trades);
    };
    socket.onclose = () => setTimeout(connectWS, 2000);
  }

  // ————————————————————————————————————————————
  // UI RENDERERS
  // ————————————————————————————————————————————
  function renderPositions() {
    const list = $('positionsList');
    if(!window._positions || window._positions.length === 0) {
      list.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>';
      return;
    }
    list.innerHTML = "";
    window._positions.forEach(pos => {
      const entry = Number(pos.entry_price || pos.entryPrice);
      const size = Number(pos.size);
      const type = (pos.type || "LONG").toUpperCase();
      const lev = Number(pos.leverage || 1);
      
      let pnl = 0;
      if(currentPrice > 0) {
        const diff = (currentPrice - entry) / entry;
        pnl = diff * size * (type==="SHORT"? -1 : 1);
      }
      const pnlClass = pnl >= 0 ? "text-green" : "text-red";
      
      const div = document.createElement('div');
      div.className = "pos-item";
      div.innerHTML = `
        <div class="pos-header">
           <span class="${type==='LONG'?'text-green':'text-red'}">${type} ${selectedPair} <span style="font-size:10px; opacity:0.7; border:1px solid currentColor; padding:1px 3px; border-radius:3px;">x${lev}</span></span>
           <span class="${pnlClass}">${pnl>0?'+':''}${pnl.toFixed(2)} VP</span>
        </div>
        <div class="pos-details">
           <div>Entry <div class="pos-val">${entry.toFixed(2)}</div></div>
           <div>Mark <div class="pos-val">${currentPrice.toFixed(2)}</div></div>
           <div>Size <div class="pos-val">${size.toFixed(0)}</div></div>
           <div>Margin <div class="pos-val">${(size/lev).toFixed(2)}</div></div>
        </div>
        <button class="close-btn" data-id="${pos.id || pos._id}">Close Position</button>
      `;
      list.appendChild(div);
    });
    list.querySelectorAll('.close-btn').forEach(b => b.onclick = () => closePosition(b.dataset.id));
  }

  function renderOrderBook(buys, sells) {
    const el = $('orderBook');
    let html = "";
    sells.slice(0, 7).reverse().forEach(s => {
      html += `<div class="ob-row"><span class="text-red">${s.price.toFixed(2)}</span><span>${s.size.toFixed(3)}</span></div>`;
    });
    html += `<div style="height:1px; background:var(--border); margin: 4px 0;"></div>`;
    buys.slice(0, 7).forEach(b => {
      html += `<div class="ob-row"><span class="text-green">${b.price.toFixed(2)}</span><span>${b.size.toFixed(3)}</span></div>`;
    });
    el.innerHTML = html;
  }

  function renderTrades(trades) {
    const el = $('tradeHistory');
    let html = "";
    trades.slice().reverse().forEach(t => {
      const color = t.side === 'buy' ? 'text-green' : 'text-red';
      html += `<div class="ob-row"><span class="${color}">${t.price.toFixed(2)}</span><span style="opacity:0.7">${t.size.toFixed(4)}</span><span style="color:var(--muted)">${new Date(t.time).toLocaleTimeString([], {hour12:false})}</span></div>`;
    });
    el.innerHTML = html;
  }

  // ————————————————————————————————————————————
  // ACTIONS
  // ————————————————————————————————————————————
  async function openPosition(type) {
    const margin = Number($('sizeInput').value);
    if(!margin || margin <= 0) return alert("Please enter valid margin");
    const size = margin * currentLeverage; 
    
    try {
      const res = await fetch(API_BASE + "/api/order/open", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ userId: currentUserId, pair: selectedPair, type, size, leverage: currentLeverage, entryPrice: currentPrice })
      });
      const data = await res.json();
      if(data.ok) {
        window._positions.push(data.position);
        if(data.newBalance) { profile.balance = data.newBalance; updateBalanceUI(); }
        renderPositions();
        tg.HapticFeedback.notificationOccurred('success');
      } else { alert(data.error || "Error"); }
    } catch(e) { console.error(e); }
  }

  async function closePosition(id) {
    if(!confirm("Close this position?")) return;
    try {
      const res = await fetch(API_BASE + "/api/order/close", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ userId: currentUserId, positionId: id, closePrice: currentPrice })
      });
      const data = await res.json();
      if(data.ok) {
        window._positions = window._positions.filter(p => (p.id!=id && p._id!=id));
        if(data.newBalance) { profile.balance = data.newBalance; updateBalanceUI(); }
        renderPositions();
        tg.HapticFeedback.notificationOccurred('success');
      }
    } catch(e) { console.error(e); }
  }

  $('openLong').onclick = () => openPosition("LONG");
  $('openShort').onclick = () => openPosition("SHORT");

  // ————————————————————————————————————————————
  // NEW HEADER LOGIC
  // ————————————————————————————————————————————
  
  // 1. Pair Switching via Dropdown
  $('pairSelect').addEventListener('change', (e) => {
    const newPair = e.target.value;
    if(newPair === selectedPair) return;
    
    // Unsubscribe
    if(socket) socket.send(JSON.stringify({ type:"unsubscribe", pair: selectedPair }));
    selectedPair = newPair;
    
    // UI Reset
    $('bookPairLabel').textContent = selectedPair;
    $('priceDisplay').textContent = "--.--";
    $('orderBook').innerHTML = "";
    $('tradeHistory').innerHTML = "";
    
    // Chart Reset (Critical for fix)
    candleSeries.setData([]);
    chart.priceScale('right').applyOptions({ autoScale: true });
    chart.timeScale().fitContent();

    // Subscribe new
    if(socket) socket.send(JSON.stringify({ type:"subscribe", pair: selectedPair }));
  });

  // 2. Profile Click
  $('btnProfile').onclick = () => {
    // Logic for Profile navigation
    // Since we don't have a second page, we just simulate feedback for now
    tg.HapticFeedback.impactOccurred('light');
    alert("Navigating to Profile of User: " + (currentUserId || "Guest"));
  };

  // ————————————————————————————————————————————
  // INIT
  // ————————————————————————————————————————————
  setProgress(20, "Authenticating...");
  await initSession();
  
  setProgress(50, "Connecting market stream...");
  connectWS();
  
  await Promise.race([historyPromise, new Promise(r => setTimeout(r, 4000))]);
  setProgress(100, "Ready");
  
  setTimeout(() => {
    loaderEl.classList.add('hidden');
    setTimeout(() => loaderEl.style.display = 'none', 400);
  }, 500);

})();
</script>
</body>
</html>
