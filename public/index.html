<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Telegram Login Debug</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <h2>–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
  <pre id="log"></pre>

  <script>
    function log(a) {
      const box = document.getElementById("log");
      box.textContent += "\n" + a;
      console.log(a);
    }

    // === Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω ===
    const tg = window.Telegram.WebApp;

    log("=== DEBUG START ===");

    log("initData = " + tg.initData);
    log("initDataUnsafe = " + JSON.stringify(tg.initDataUnsafe, null, 2));

    if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
      log("‚ùå Telegram WebApp –Ω–µ –¥–∞–ª user ‚Äî MINI APP –ù–ï –ó–ê–ü–£–©–ï–ù –ß–ï–†–ï–ó TELEGRAM");
      document.body.innerHTML = "<h3>–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram</h3>";
      throw new Error("NO TG DATA");
    }

    const initData = tg.initData;
    const userId = tg.initDataUnsafe.user.id;
    log("userId = " + userId);

    async function initSession() {
      log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å /api/init ...");

      const res = await fetch("/api/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData }) // <-- –í–û–¢ –ü–†–ê–í–ò–õ–¨–ù–û
      });

      const data = await res.json();
      log("üì• –û—Ç–≤–µ—Ç –æ—Ç /api/init = " + JSON.stringify(data, null, 2));

      if (data.error) {
        log("‚ùå –û—à–∏–±–∫–∞: " + data.error);
      } else {
        document.body.innerHTML =
          "<h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å " + userId + "</h2>" +
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      }
    }

    initSession();
  </script>
</body>
</html>
