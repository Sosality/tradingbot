<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Futures Sim ‚Äî Debug & Auth</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg: #0A0A0A;
      --panel: #0F1113;
      --muted: #9aa4ad;
      --ok: #0EBE83;
      --err: #FF6B6B;
      --text: #E6EEF3;
    }
    body { margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text); }
    .wrap { padding:16px; max-width:820px; margin:0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    h1 { font-size:18px; margin:0; }
    .status { padding:8px 10px; background:var(--panel); border-radius:8px; margin-top:12px; }
    pre#debug { background:#071018; border:1px solid #111; padding:12px; border-radius:8px; color:#cfeef5; white-space:pre-wrap; max-height:56vh; overflow:auto; }
    .controls { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .btn { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn-primary { background:var(--ok); color:#001; }
    .btn-ghost { background:#111; color:var(--text); border:1px solid #222; }
    .hint { color:var(--muted); font-size:13px; margin-top:8px; }
    .error { color:var(--err); font-weight:700; }
    .success { color:var(--ok); font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Crypto Futures Sim ‚Äî Debug / Telegram Auth</h1>
        <div class="hint">–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ Telegram (–∫–Ω–æ–ø–∫–∞ web_app). –≠—Ç–æ—Ç —ç–∫—Ä–∞–Ω –¥–µ—Ç–∞–ª—å–Ω–æ –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –Ω–µ–¥–æ—Å—Ç–∞—ë—Ç.</div>
      </div>
      <div id="topStatus" class="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </header>

    <div class="controls" style="margin-top:12px;">
      <button id="tryOpenTG" class="btn btn-primary">–û—Ç–∫—Ä—ã—Ç—å Telegram (tg://)</button>
      <button id="clearDebug" class="btn btn-ghost">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>

    <div id="result" style="margin-top:12px;"></div>

    <h3 style="margin-top:16px">üõ† Debug output</h3>
    <pre id="debug">–ó–∞–ø—É—Å–∫ –æ—Ç–ª–∞–¥–∫–∏...</pre>
  </div>

<script>
(async function(){
  const dbgEl = document.getElementById('debug');
  const topStatus = document.getElementById('topStatus');
  const resultEl = document.getElementById('result');
  const tryOpenBtn = document.getElementById('tryOpenTG');
  const clearBtn = document.getElementById('clearDebug');

  function log(...args){
    console.log(...args);
    const text = args.map(a => {
      try { return (typeof a === 'object') ? JSON.stringify(a, null, 2) : String(a); }
      catch(e){ return String(a); }
    }).join(' ');
    dbgEl.textContent += text + '\n';
    dbgEl.scrollTop = dbgEl.scrollHeight;
  }

  clearBtn.onclick = ()=> dbgEl.textContent = '';

  // tryOpen: attempts to open Telegram App via deep link; set BOT_USERNAME manually if you want
  tryOpenBtn.onclick = () => {
    const BOT_USERNAME = ""; // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —É–∫–∞–∂–∏ —Å—é–¥–∞ username –±–æ—Ç–∞ –±–µ–∑ @, –Ω–∞–ø—Ä–∏–º–µ—Ä "my_bot"
    if (!BOT_USERNAME) {
      alert("–£–∫–∞–∂–∏—Ç–µ BOT_USERNAME –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ (–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é BOT_USERNAME –≤ –∫–æ–¥–µ) –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤—Ä—É—á–Ω—É—é.");
      return;
    }
    const deep = `tg://resolve?domain=${BOT_USERNAME}`;
    const web = `https://t.me/${BOT_USERNAME}`;
    // try deep link then fallback to web
    window.location.href = deep;
    setTimeout(()=> window.location.href = web, 700);
  };

  log("=== DEBUG START ===");
  log("window.Telegram =", window.Telegram);
  log("Telegram =", typeof Telegram !== 'undefined' ? Telegram : "undefined");
  log("Telegram.WebApp =", Telegram?.WebApp ?? "undefined");
  topStatus.textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram.WebApp...";

  if (!window.Telegram || !Telegram?.WebApp) {
    topStatus.innerHTML = "<span class='error'>‚ùå Telegram WebApp –ù–ï –Ω–∞–π–¥–µ–Ω</span>";
    resultEl.innerHTML = "<div class='hint'>–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É web_app –≤ –±–æ—Ç–µ (–Ω–µ –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ).</div>";
    log("Telegram.WebApp –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –æ—Ç–∫—Ä—ã—Ç–∞ –≤–Ω–µ Telegram WebView.");
    return;
  }

  // We have Telegram.WebApp
  topStatus.innerHTML = "<span class='success'>‚úî Telegram WebApp –Ω–∞–π–¥–µ–Ω</span>";
  try { Telegram.WebApp.expand?.(); } catch(e){}

  const rawInitData = Telegram.WebApp.initData;
  const unsafe = Telegram.WebApp.initDataUnsafe;
  log("initData (raw) =", rawInitData);
  log("initDataUnsafe =", unsafe);

  const userId = unsafe?.user?.id ?? null;
  log("userId =", userId);

  if (!rawInitData) {
    // Very unlikely because we see initDataUnsafe exists, but handle
    topStatus.innerHTML = "<span class='error'>‚ùå initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>";
    resultEl.innerHTML = "<div class='hint'>Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ initData. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â—ë —Ä–∞–∑.</div>";
    log("initData –ø—É—Å—Ç–æ–µ ‚Äî –Ω–µ–ª—å–∑—è –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏.");
    return;
  }

  // Prepare payload: include both initData and userId for compatibility
  const payload = { initData: rawInitData, userId };

  log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ø–æ–ø—ã—Ç–∫–∞ 1: /auth/init) ...");
  topStatus.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ initData –Ω–∞ —Å–µ—Ä–≤–µ—Ä...";

  async function postJSON(url, body){
    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body)
      });
      const json = await resp.json().catch(()=>({ error: "invalid_json" }));
      return { ok: resp.ok, status: resp.status, json };
    } catch (err) {
      return { ok:false, status:0, error: err.message || String(err) };
    }
  }

  // try /auth/init (new server), then fallback to /api/init (older server)
  let attemptOrder = ['/auth/init', '/api/init'];
  let finalResp = null;

  for (const endpoint of attemptOrder){
    log("POST ->", endpoint);
    const r = await postJSON(endpoint, payload);
    log("->", endpoint, "status:", r.status, "ok:", r.ok, "body:", r.json ?? r.error);
    // If server returned 200 and a success-like response, accept it
    if (r.ok && r.json && (r.json.success || r.json.user || r.json.balance !== undefined || r.json.ok)) {
      finalResp = { endpoint, r };
      break;
    }
    // If server responded with meaningful error other than NO_INIT_DATA, stop and show it
    if (r.json && r.json.error && r.json.error !== 'NO_INIT_DATA' && r.json.error !== 'INVALID_TG_AUTH' && r.json.error !== 'NO_INIT_DATA') {
      finalResp = { endpoint, r };
      break;
    }
    // If server explicitly returned NO_INIT_DATA or INVALID_TG_AUTH, we continue to next endpoint
    // If request failed (network), also continue to next endpoint
  }

  if (!finalResp) {
    topStatus.innerHTML = "<span class='error'>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/–ø—Ä–æ–≤–µ—Ä–∏—Ç—å initData</span>";
    resultEl.innerHTML = "<div class='error'>–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏–Ω—è–ª initData (–ø–æ–ø—Ä–æ–±–æ–≤–∞–Ω—ã /auth/init –∏ /api/init). –ü–æ—Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.</div>";
    log("–§–∏–Ω–∞–ª ‚Äî –Ω–∏ –æ–¥–∏–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –ø—Ä–∏–Ω—è–ª initData –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.");
    return;
  }

  // Process finalResp
  const { endpoint, r } = finalResp;
  log("–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç", endpoint, r);

  if (!r.ok) {
    // non-200
    const errText = r.json?.error ?? r.error ?? "Unknown error";
    topStatus.innerHTML = "<span class='error'>‚ùå –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª –æ—à–∏–±–∫–æ–π</span>";
    resultEl.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ (${endpoint}): ${errText}</div><div class="hint">–ü—Ä–æ–≤–µ—Ä—å BOT_TOKEN –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ initData.</div>`;
    return;
  }

  // OK case
  topStatus.innerHTML = "<span class='success'>‚úî –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞</span>";
  let infoHtml = `<div class="success">–£—Å–ø–µ—Ö: –æ—Ç–≤–µ—Ç –æ—Ç ${endpoint}</div><pre>${JSON.stringify(r.json, null, 2)}</pre>`;
  resultEl.innerHTML = infoHtml;
  log("–£—Å–ø–µ—à–Ω–æ: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª:", r.json);

})();
</script>
</body>
</html>
