<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Futures Sim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        body { background-color: #111; color: #fff; font-family: sans-serif; margin: 0; padding: 0; }
        #chart { width: 100%; height: 50vh; }
        .ui-panel { padding: 15px; background: #1e1e1e; height: 50vh; overflow-y: auto; }
        .price-display { font-size: 24px; font-weight: bold; }
        .balance { font-size: 14px; color: #aaa; margin-bottom: 15px; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-long { background: #26a69a; }
        .btn-short { background: #ef5350; }
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-radius: 5px; background: #333; color: #fff; }
        .pos-card { background: #2a2a2a; padding: 10px; margin-bottom: 7px; border-radius: 6px; display: flex; justify-content: space-between; }
        .positions { margin-top: 10px; }
    </style>
</head>
<body>

<div style="padding:10px; display:flex; justify-content:space-between;">
    <span>BTC/USDT</span>
    <span id="price" class="price-display">Загрузка...</span>
</div>

<div id="chart"></div>

<div class="ui-panel">
    <div class="balance">Баланс: <span id="balance">0</span> VP</div>

    <input type="number" id="amount" placeholder="Сумма (VP)" value="100">
    <select id="leverage">
        <option value="1">x1</option>
        <option value="5">x5</option>
        <option value="10" selected>x10</option>
        <option value="20">x20</option>
    </select>

    <div class="controls">
        <button class="btn-long" onclick="openOrder('LONG')">BUY / LONG</button>
        <button class="btn-short" onclick="openOrder('SHORT')">SELL / SHORT</button>
    </div>

    <div class="positions" id="positionsList"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    if (!window.Telegram?.WebApp) {
        window.Telegram = { WebApp: {
            initDataUnsafe: { user: { id: 'test_user_1' }},
            expand: ()=>{}, enableClosingConfirmation: ()=>{},
            showAlert: alert, HapticFeedback:{impactOccurred:()=>{},notificationOccurred:()=>{}}
        }};
    }

    const tg = Telegram.WebApp;
    tg.expand();

    const userId = tg.initDataUnsafe?.user?.id || "test_user_1";
    let currentPrice = 0;
    let positions = [];
    let lastCandle = null;

    const chartContainer = document.getElementById('chart');
    const { createChart } = LightweightCharts;
    const chart = createChart(chartContainer, {
        layout: { background: { color: '#111' }, textColor: '#DDD' },
        grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } },
        timeScale: { timeVisible: true, secondsVisible: false }
    });
    const candleSeries = chart.addCandlestickSeries();

    new ResizeObserver(() => {
        chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
    }).observe(chartContainer);

    fetch('/api/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
    })
    .then(r=>r.json())
    .then(user => {
        document.getElementById('balance').innerText = user.balance.toFixed(2);
        positions = user.positions;
        renderPositions();
    });

    function loadHistory() {
        fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=200')
            .then(r => r.json())
            .then(data => {
                const candles = data.map(c => ({
                    time: c[0]/1000,
                    open: +c[1],
                    high: +c[2],
                    low: +c[3],
                    close: +c[4]
                }));
                candleSeries.setData(candles);
                lastCandle = candles[candles.length-1];
                chart.timeScale().fitContent();
            });
    }
    loadHistory();

    function updatePriceAndChart() {
        fetch('/api/price')
            .then(r => r.json())
            .then(data => {
                if (!data.price) return;
                currentPrice = data.price;
                document.getElementById('price').innerText = currentPrice.toFixed(2);

                const now = Math.floor(Date.now() / 1000);
                const minute = Math.floor(now / 60) * 60;

                if (!lastCandle || lastCandle.time !== minute) {
                    lastCandle = { time: minute, open: currentPrice, high: currentPrice, low: currentPrice, close: currentPrice };
                    candleSeries.update(lastCandle);
                } else {
                    lastCandle.high = Math.max(lastCandle.high, currentPrice);
                    lastCandle.low = Math.min(lastCandle.low, currentPrice);
                    lastCandle.close = currentPrice;
                    candleSeries.update(lastCandle);
                }
                updatePositionsPnL();
            });
    }
    setInterval(updatePriceAndChart, 1000);

    window.openOrder = function(type){
        const margin = +document.getElementById('amount').value;
        const leverage = +document.getElementById('leverage').value;

        fetch('/api/order/open', {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, type, margin, leverage })
        })
        .then(r=>r.json())
        .then(res=>{
            if(res.error) return tg.showAlert(res.error);
            positions.push(res.position);
            document.getElementById('balance').innerText = res.balance.toFixed(2);
            renderPositions();
        });
    }

    window.closeOrder = function(id){
        fetch('/api/order/close', {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, positionId:id })
        })
        .then(r=>r.json())
        .then(res=>{
            positions = positions.filter(p=>p.id!==id);
            document.getElementById('balance').innerText=res.balance.toFixed(2);
            renderPositions();
        });
    }

    function renderPositions(){
        const list = document.getElementById("positionsList");
        list.innerHTML = "";
        positions.forEach(p=>{
            const el = document.createElement("div");
            el.className="pos-card";
            el.id="pos-"+p.id;
            el.innerHTML = `
                <div><b>${p.type} x${p.leverage}</b><br>${p.entryPrice.toFixed(2)}</div>
                <div style="text-align:right;">
                    <span class="pnl">0.00</span> VP<br>
                    <button onclick="closeOrder(${p.id})" style="background:#444;padding:5px;border-radius:5px;">✖</button>
                </div>`;
            list.appendChild(el);
        });
    }

    function updatePositionsPnL(){
        positions.forEach(p => {
            let pnl = (p.type==='LONG')
                ? ((currentPrice - p.entryPrice) / p.entryPrice) * p.size
                : ((p.entryPrice - currentPrice) / p.entryPrice) * p.size;

            const el = document.querySelector(`#pos-${p.id} .pnl`);
            if(el){
                el.innerText=pnl.toFixed(2);
                el.style.color=pnl>=0?'#26a69a':'#ef5350';
            }
        });
    }
});
</script>

</body>
</html>
