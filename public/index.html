<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>TradeSim</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0B0E11;
      --panel: #1E2329;
      --panel-light: #2A2F36;
      --muted: #848E9C;
      --accent-green: #0ECB81;
      --accent-green-transparent: rgba(14, 203, 129, 0.15);
      --accent-red: #F6465D;
      --accent-red-transparent: rgba(246, 70, 93, 0.15);
      --white: #EAECEF;
      --border: rgba(255, 255, 255, 0.08);
      --gold: #F0B90B;
      --gold-gradient: linear-gradient(135deg, #F0B90B 0%, #B88A00 100%);
      --accent-blue: #1E90FF;
      --accent-purple: #A855F7;
      --accent-orange: #F7931A;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--white); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; position: relative; }

    .view-section {
      flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease;
      position: absolute; width: 100%; top: 0; left: 0; background: var(--bg);
    }
    .view-section.hidden { display: none; opacity: 0; pointer-events: none; z-index: -1; }
    .view-section.active { display: flex; opacity: 1; z-index: 10; }

    .header {
      flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; background: var(--panel); border-bottom: 1px solid var(--border); height: 60px; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo-img { height: 28px; width: auto; display: block; }

    .pair-dropdown { position: relative; font-family: 'Roboto Mono', monospace; }
    .pair-trigger {
      display: flex; align-items: center; gap: 8px; background: transparent; padding: 6px 12px;
      border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 15px; color: var(--white);
      transition: background 0.2s; user-select: none;
    }
    .pair-trigger:hover { background: rgba(255,255,255,0.05); }
    .pair-trigger .arrow { font-size: 10px; color: var(--muted); transition: transform 0.2s; }
    .pair-dropdown.open .pair-trigger .arrow { transform: rotate(180deg); }
    .pair-menu {
      position: absolute; top: 100%; left: 0; margin-top: 8px;
      background: rgba(30, 35, 41, 0.95); backdrop-filter: blur(10px);
      border: 1px solid var(--border); border-radius: 8px; width: 160px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; pointer-events: none;
      transform: translateY(-10px); transition: all 0.2s ease; z-index: 200;
      display: flex; flex-direction: column; padding: 4px;
    }
    .pair-dropdown.open .pair-menu { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .pair-item {
      padding: 10px 12px; font-size: 14px; font-weight: 500; color: var(--muted);
      cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
    }
    .pair-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
    .pair-item.active { background: rgba(255,255,255,0.08); color: var(--white); font-weight: 700; }
    .pair-item.active::after { content: '✓'; color: var(--accent-green); font-size: 12px; }

    .user-area { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 8px; border-radius: 8px; transition: background 0.2s; }
    .user-area:active { background: rgba(255,255,255,0.05); }
    .balance-group { text-align: right; line-height: 1.2; }
    .balance-label { font-size: 10px; color: var(--muted); display: block; }
    .balance-val { font-size: 13px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono', monospace; }
    .avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; border: 1px solid var(--border); }
    .avatar-sm img { width: 100%; height: 100%; object-fit: cover; }

    .container {
      flex: 1; display: flex; flex-direction: column;
      overflow-y: auto; overflow-x: hidden; padding: 12px; gap: 12px;
    }
    @media (min-width: 900px) {
      .container { display: grid; grid-template-columns: 1fr 340px; height: calc(100vh - 60px); overflow: hidden; }
      .left-col { overflow-y: auto; padding-right: 4px; }
      .right-col { overflow: hidden; height: 100%; }
      .ob-container, .pos-list { max-height: 400px; overflow-y: auto; }
    }

    .left-col { display: flex; flex-direction: column; gap: 12px; }
    .right-col { display: flex; flex-direction: column; gap: 12px; }
    .card { background: var(--panel); border-radius: 12px; padding: 12px; border: 1px solid var(--border); }

    .market-header {
      display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
      gap: 12px; min-width: 0; position: relative;
    }

    .price-block { display: flex; flex-direction: column; min-width: 0; flex-shrink: 0; }
    .price-label { color: var(--muted); font-size: 11px; margin-bottom: 4px; }
    .price-display { font-family: 'Roboto Mono', monospace; font-size: 32px; font-weight: 700; line-height: 1; letter-spacing: -1px; white-space: nowrap; }

    .chart-wrapper { position: relative; display: flex; flex-direction: column; gap: 0; }

    .chart-container {
      height: 280px; width: 100%; border-radius: 8px; overflow: hidden;
      position: relative; background: #111;
    }
    .chart-container.has-volume { border-radius: 8px 8px 0 0; }
    @media (min-width: 900px) { .chart-container { height: 40vh; } }

    .volume-container {
      height: 60px; width: 100%; background: #111;
      border-radius: 0 0 8px 8px; overflow: hidden; position: relative;
      border-top: 1px solid rgba(255,255,255,0.12); display: none;
    }
    .volume-container.visible { display: block; }

    .chart-loading-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(11, 14, 17, 0.7); display: flex; align-items: center; justify-content: center;
      z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
    }
    .chart-loading-overlay.active { opacity: 1; pointer-events: auto; }
    .chart-loading-spinner {
      width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-green); border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .ohlc-tooltip {
      position: absolute; top: 8px; left: 46px; z-index: 30;
      display: flex; align-items: center; gap: 8px;
      font-family: 'Roboto Mono', monospace; font-size: 10px; color: var(--muted);
      background: rgba(11, 14, 17, 0.85); padding: 4px 8px; border-radius: 4px;
      pointer-events: none; opacity: 0; transition: opacity 0.15s ease;
      max-width: calc(100% - 54px);
    }
    .ohlc-tooltip.visible { opacity: 1; }
    .ohlc-tooltip.ohlc-wrapped { flex-wrap: wrap; }
    .ohlc-tooltip .ohlc-item { display: flex; gap: 2px; white-space: nowrap; }
    .ohlc-tooltip .ohlc-label { color: var(--muted); }
    .ohlc-tooltip .ohlc-value { color: var(--white); font-weight: 500; }
    .ohlc-tooltip .ohlc-value.up { color: var(--accent-green); }
    .ohlc-tooltip .ohlc-value.down { color: var(--accent-red); }

    .drawing-tools-menu {
      position: absolute; top: 8px; left: 8px; z-index: 40;
      display: flex; flex-direction: column; gap: 2px;
    }
    .drawing-tools-toggle {
      width: 28px; height: 28px; background: rgba(30, 35, 41, 0.9);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--muted); font-size: 14px;
    }
    .drawing-tools-toggle:hover { background: var(--panel-light); color: var(--white); }
    .drawing-tools-toggle.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); }
    .drawing-tools-panel {
      display: flex; flex-direction: column; gap: 2px;
      opacity: 0; pointer-events: none; transform: translateY(-4px); transition: all 0.2s ease;
    }
    .drawing-tools-menu.open .drawing-tools-panel { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .drawing-tool-btn {
      width: 28px; height: 28px; background: rgba(30, 35, 41, 0.9);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--muted); font-size: 12px;
    }
    .drawing-tool-btn:hover { background: var(--panel-light); color: var(--white); }
    .drawing-tool-btn.active { background: rgba(30, 144, 255, 0.2); color: var(--accent-blue); border-color: var(--accent-blue); }
    .drawing-tool-btn svg { width: 14px; height: 14px; }

    .indicators-panel { display: flex; align-items: center; gap: 6px; padding: 8px 0; flex-wrap: wrap; }
    .indicator-chip {
      display: flex; align-items: center; gap: 4px; padding: 4px 10px;
      font-size: 11px; font-weight: 600; color: var(--muted);
      background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
      border-radius: 4px; cursor: pointer; transition: all 0.2s; user-select: none;
    }
    .indicator-chip:hover { background: rgba(255, 255, 255, 0.06); color: var(--white); }
    .indicator-chip.active.ema { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(30, 144, 255, 0.15); }
    .indicator-chip.active.sma { border-color: var(--accent-purple); color: var(--accent-purple); background: rgba(168, 85, 247, 0.15); }
    .indicator-chip.active.vwap { border-color: var(--accent-orange); color: var(--accent-orange); background: rgba(247, 147, 26, 0.15); }
    .indicator-chip.active.volume { border-color: var(--accent-green); color: var(--accent-green); background: var(--accent-green-transparent); }
    .indicator-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: 0; transition: opacity 0.2s; }
    .indicator-chip.active .indicator-dot { opacity: 1; }

    .controls-area { display: flex; flex-direction: column; gap: 16px; margin-top: 12px; }
    .input-group { position: relative; }
    .input-label { position: absolute; top: 8px; left: 12px; font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .main-input {
      width: 100%; background: #111; border: 1px solid var(--border); color: var(--white);
      padding: 24px 12px 8px 12px; border-radius: 8px; font-size: 16px;
      font-family: 'Roboto Mono', monospace; outline: none; transition: border 0.2s;
    }
    .main-input:focus { border-color: var(--accent-green); }

    .slider-wrap { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
    .slider-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .slider-val { color: var(--accent-green); font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

    .range-slider {
      -webkit-appearance: none; width: 100%; height: 4px;
      background: linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) 0%, #2A2F36 0%, #2A2F36 100%);
      border-radius: 2px; outline: none; margin: 10px 0;
    }
    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid var(--accent-green); transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .range-slider::-webkit-slider-thumb:hover { transform: scale(1.1); box-shadow: 0 2px 12px rgba(14, 203, 129, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); }
    .range-slider::-webkit-slider-thumb:active { transform: scale(0.95); }
    .range-slider::-moz-range-thumb {
      width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid var(--accent-green);
    }

    .chips-row { display: flex; justify-content: space-between; gap: 4px; margin-top: 8px; }
    .chip { flex: 1; text-align: center; padding: 6px 0; font-size: 11px; background: #15181b; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); color: var(--muted); transition: 0.2s; }
    .chip.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); font-weight: 700; }

    .margin-slider-wrap { position: relative; padding: 0 10px; }
    .margin-slider-wrap .range-slider { width: 100%; }
    .margin-marks { display: flex; justify-content: space-between; margin-top: 4px; position: relative; }
    .margin-mark {
      font-size: 10px; color: var(--muted); cursor: pointer; padding: 2px 0; border-radius: 3px;
      transition: 0.2s; user-select: none; text-align: center; min-width: 28px;
    }
    .margin-mark:first-child { text-align: left; }
    .margin-mark:last-child { text-align: right; }
    .margin-mark:hover { color: var(--accent-green); }
    .margin-mark.active { color: var(--accent-green); font-weight: 600; }

    .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .btn-trade {
      padding: 14px; border-radius: 8px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; color: #fff;
      display: flex; flex-direction: column; align-items: center; line-height: 1.2; transition: filter 0.2s;
    }
    .btn-trade:active { filter: brightness(0.9); transform: scale(0.98); }
    .btn-trade span { font-size: 10px; font-weight: 400; opacity: 0.8; margin-top: 2px; }
    .btn-long { background: var(--accent-green); color: #052e1f; }
    .btn-short { background: var(--accent-red); color: #2d0a0f; }

    .ob-header { display: grid; grid-template-columns: 1fr 1fr; font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; padding: 0 6px; }
    .ob-container { font-size: 12px; font-family: 'Roboto Mono', monospace; display: flex; flex-direction: column; gap: 1px; overflow: hidden; }
    .ob-row { position: relative; display: grid; grid-template-columns: 1fr 1fr; align-items: center; height: 20px; padding: 0 6px; line-height: 1; white-space: nowrap; overflow: hidden; }
    .trade-time { text-align: right; opacity: 0.7; }
    .ob-bg { position: absolute; top: 0; bottom: 0; z-index: 0; opacity: 0.18; transition: width 0.2s ease; }
    .bg-red { left: 0; background: linear-gradient(to right, var(--accent-red), transparent); }
    .bg-green { right: 0; background: linear-gradient(to left, var(--accent-green), transparent); }
    .ob-row span { position: relative; z-index: 1; }
    .ob-row span:last-child { text-align: right; }
    .text-green { color: var(--accent-green); }
    .text-red { color: var(--accent-red); }

    .pos-list { display: flex; flex-direction: column; gap: 8px; }
    .pos-item { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; position: relative; overflow: hidden; }
    .pos-item.long { border-left: 4px solid var(--accent-green); }
    .pos-item.short { border-left: 4px solid var(--accent-red); }
    .pos-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; font-weight: 700; align-items: center; }
    .pos-pair { font-size: 15px; letter-spacing: 0.5px; }
    .pos-type-badge { font-size: 14px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

    .pos-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 8px 0; padding: 8px 0; border-top: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .stat-col { display: flex; flex-direction: column; gap: 4px; }
    .stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stat-val { font-size: 13px; font-weight: 700; font-family: 'Roboto Mono'; }

    .risk-wrap { margin-top: 4px; width: 100%; }
    .risk-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .risk-fill { height: 100%; width: 0%; background: var(--accent-green); transition: width 0.3s, background 0.3s; }

    .pos-details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
    .pd-col { display: flex; flex-direction: column; gap: 2px; }
    .pd-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .pd-val { font-size: 12px; color: var(--white); font-family: 'Roboto Mono'; font-weight: 700; }

    .close-btn {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--accent-red);
      padding: 8px 12px; border-radius: 8px; font-size: 12px; margin-top: 12px; width: 100%; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .close-btn:active { background: var(--accent-red); color: #fff; }

    .pos-tpsl-actions {
      display: flex; gap: 8px; margin-top: 12px; padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .btn-tpsl {
      flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 10px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    .btn-tpsl:hover { background: rgba(255,255,255,0.06); }
    .btn-tpsl:active { transform: scale(0.98); }
    .btn-tpsl.tp { color: var(--accent-green); }
    .btn-tpsl.tp:hover { border-color: var(--accent-green); background: var(--accent-green-transparent); }
    .btn-tpsl.sl { color: var(--accent-red); }
    .btn-tpsl.sl:hover { border-color: var(--accent-red); background: var(--accent-red-transparent); }
    .btn-tpsl-icon { font-size: 14px; }
    .btn-tpsl .tpsl-count { font-size: 10px; opacity: 0.7; font-weight: 400; }

    .pos-tpsl-orders {
      margin-top: 10px; padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .tpsl-orders-title {
      font-size: 11px; color: var(--muted); text-transform: uppercase;
      font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
    }
    .tpsl-orders-count {
      background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 10px;
      font-size: 10px; color: var(--white);
    }
    .tpsl-orders-list { display: flex; flex-direction: column; gap: 6px; }
    .tpsl-order-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border-radius: 8px; font-size: 12px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      font-family: 'Roboto Mono', monospace;
    }
    .tpsl-order-item.tp-order { border-left: 3px solid var(--accent-green); }
    .tpsl-order-item.sl-order { border-left: 3px solid var(--accent-red); }
    .tpsl-order-info { display: flex; flex-direction: column; gap: 2px; }
    .tpsl-order-type { font-weight: 700; font-size: 11px; text-transform: uppercase; }
    .tpsl-order-type.tp-type { color: var(--accent-green); }
    .tpsl-order-type.sl-type { color: var(--accent-red); }
    .tpsl-order-details {
      display: flex; gap: 12px; font-size: 11px; color: var(--muted);
    }
    .tpsl-order-details span { display: flex; align-items: center; gap: 4px; }
    .tpsl-order-actions { display: flex; align-items: center; gap: 8px; }
    .tpsl-order-pnl { font-size: 11px; font-weight: 600; }
    .tpsl-order-roe { font-size: 9px; font-weight: 600; }
    .btn-delete-tpsl {
      width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
      background: rgba(246, 70, 93, 0.1); border: 1px solid transparent;
      border-radius: 6px; color: var(--accent-red); cursor: pointer;
      transition: all 0.2s; font-size: 14px;
    }
    .btn-delete-tpsl:hover { background: var(--accent-red-transparent); border-color: var(--accent-red); }
    .btn-delete-tpsl:active { transform: scale(0.9); }

    .tpsl-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .tpsl-modal-overlay.active { opacity: 1; pointer-events: auto; }

    .tpsl-modal {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      max-height: 90vh; overflow-y: auto; z-index: 1001;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    .tpsl-modal-overlay.active .tpsl-modal { transform: translateY(0); }

    .tpsl-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--panel); z-index: 10;
    }
    .tpsl-modal-header-left { display: flex; flex-direction: column; gap: 2px; }
    .tpsl-modal-title { font-size: 16px; font-weight: 700; color: var(--white); }
    .tpsl-modal-subtitle { font-size: 12px; color: var(--muted); }
    .tpsl-modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 50%; cursor: pointer;
      color: var(--muted); font-size: 18px; transition: all 0.2s; border: none;
    }
    .tpsl-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }

    .tpsl-modal-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }

    .tpsl-position-info {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; background: rgba(255,255,255,0.03);
      border: 1px solid var(--border); border-radius: 10px;
    }
    .tpsl-position-left { display: flex; align-items: center; gap: 10px; }
    .tpsl-position-type {
      padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700;
    }
    .tpsl-position-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
    .tpsl-position-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
    .tpsl-position-pair { font-size: 14px; font-weight: 600; color: var(--white); }
    .tpsl-position-leverage { font-size: 12px; color: var(--muted); margin-left: 4px; }
    .tpsl-position-right { text-align: right; }
    .tpsl-position-entry-label { font-size: 11px; color: var(--muted); }
    .tpsl-position-entry-val { font-size: 14px; font-weight: 600; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .tpsl-position-mark-label { font-size: 10px; color: var(--muted); margin-top: 2px; }
    .tpsl-position-mark-val { font-size: 12px; font-weight: 600; font-family: 'Roboto Mono', monospace; color: var(--gold); }

    .tpsl-tabs {
      display: flex; gap: 4px; background: rgba(255,255,255,0.03);
      padding: 4px; border-radius: 10px; border: 1px solid var(--border);
    }
    .tpsl-tab {
      flex: 1; padding: 10px 16px; font-size: 13px; font-weight: 600;
      color: var(--muted); background: transparent; border: none;
      border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .tpsl-tab:hover { color: var(--white); }
    .tpsl-tab.active { background: var(--panel-light); color: var(--white); }

    .tpsl-tab-content { display: none; flex-direction: column; gap: 16px; }
    .tpsl-tab-content.active { display: flex; }

    .tpsl-input-group { display: flex; flex-direction: column; gap: 8px; }
    .tpsl-input-label {
      font-size: 12px; font-weight: 600; color: var(--muted);
      display: flex; align-items: center; justify-content: space-between;
    }
    .tpsl-input-hint { font-size: 11px; font-weight: 400; }
    .tpsl-input-wrapper { position: relative; display: flex; gap: 8px; }
    .tpsl-input {
      flex: 1; background: #111; border: 1px solid var(--border);
      color: var(--white); padding: 14px 16px; border-radius: 10px;
      font-size: 16px; font-family: 'Roboto Mono', monospace;
      outline: none; transition: border 0.2s;
    }
    .tpsl-input:focus { border-color: var(--gold); }
    .tpsl-input.error { border-color: var(--accent-red); }
    .tpsl-market-btn {
      padding: 14px 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--border);
      border-radius: 10px; color: var(--muted); font-size: 10px; font-weight: 600;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    .tpsl-market-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .tpsl-input-error {
      font-size: 11px; color: var(--accent-red); min-height: 16px;
    }

    .tpsl-size-section { display: flex; flex-direction: column; gap: 12px; }
    .tpsl-size-header {
      display: flex; justify-content: space-between; align-items: center;
    }
    .tpsl-size-label { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; }
    .tpsl-size-value {
      font-size: 14px; font-weight: 700; color: var(--accent-green);
      font-family: 'Roboto Mono', monospace;
    }
    .tpsl-size-slider-wrap { padding: 0 4px; }
    .tpsl-size-marks {
      display: flex; justify-content: space-between; margin-top: 6px;
    }
    .tpsl-size-mark {
      font-size: 10px; color: var(--muted); cursor: pointer;
      padding: 4px 8px; border-radius: 4px; transition: 0.2s;
    }
    .tpsl-size-mark:hover { color: var(--accent-green); background: rgba(255,255,255,0.05); }
    .tpsl-size-mark.active { color: var(--accent-green); font-weight: 600; }
    .tpsl-available-info {
      display: flex; justify-content: space-between; font-size: 11px;
      color: var(--muted); padding: 8px 12px; background: rgba(255,255,255,0.02);
      border-radius: 6px; border: 1px solid var(--border);
    }
    .tpsl-available-info span:last-child { color: var(--white); font-family: 'Roboto Mono', monospace; }

    .tpsl-pnl-preview {
      display: flex; flex-direction: column; gap: 8px; padding: 16px;
      background: rgba(255,255,255,0.02); border: 1px solid var(--border);
      border-radius: 10px;
    }
    .tpsl-pnl-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 13px;
    }
    .tpsl-pnl-label { color: var(--muted); }
    .tpsl-pnl-value { font-weight: 600; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .tpsl-pnl-value.positive { color: var(--accent-green); }
    .tpsl-pnl-value.negative { color: var(--accent-red); }
    .tpsl-pnl-divider { height: 1px; background: var(--border); margin: 4px 0; }

    .tpsl-existing-orders {
      padding: 12px 16px; background: rgba(240, 185, 11, 0.1);
      border: 1px solid rgba(240, 185, 11, 0.3); border-radius: 10px;
    }
    .tpsl-existing-title {
      font-size: 12px; font-weight: 600; color: var(--gold);
      display: flex; align-items: center; gap: 6px; margin-bottom: 8px;
    }
    .tpsl-existing-list { display: flex; flex-direction: column; gap: 6px; }
    .tpsl-existing-item {
      display: flex; justify-content: space-between; font-size: 12px;
      padding: 8px 10px; background: rgba(0,0,0,0.2); border-radius: 6px;
    }
    .tpsl-existing-item-type { font-weight: 600; }
    .tpsl-existing-item-type.tp { color: var(--accent-green); }
    .tpsl-existing-item-type.sl { color: var(--accent-red); }
    .tpsl-existing-item-info { color: var(--muted); font-family: 'Roboto Mono', monospace; font-size: 11px; }

    .tpsl-limit-notice {
      text-align: center; font-size: 11px; color: var(--accent-red);
      padding: 12px; background: var(--accent-red-transparent);
      border-radius: 8px; font-weight: 600;
    }

    .tpsl-submit-btn {
      width: 100%; padding: 16px; border-radius: 10px; border: none;
      font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .tpsl-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .tpsl-submit-btn:not(:disabled):active { transform: scale(0.98); }
    .tpsl-submit-btn.tp-confirm { background: var(--accent-green); color: #052e1f; }
    .tpsl-submit-btn.sl-confirm { background: var(--accent-red); color: #fff; }

    .toast-notification {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600;
      z-index: 9999; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }

    .profile-container { flex: 1; display: flex; flex-direction: column; padding: 16px; overflow-y: auto; gap: 20px; background: var(--bg); }
    .pro-header, .asset-card, .analysis-block, .rewards-banner, .hist-header-row { flex-shrink: 0; }
    .pro-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .pro-user { display: flex; align-items: center; gap: 12px; }
    .pro-avatar { width: 44px; height: 44px; border-radius: 50%; background: #333; overflow: hidden; border: 2px solid var(--panel); }
    .pro-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .pro-name { font-size: 16px; font-weight: 700; color: var(--white); line-height: 1.2; }
    .pro-id { font-size: 11px; color: var(--muted); font-family: monospace; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }

    .asset-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; position: relative; overflow: hidden; }
    .asset-label { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
    .eye-btn { width: 20px; height: 20px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; margin-left: 6px; display: block; }
    .eye-btn:active { opacity: 1; transform: scale(0.9); }
    .asset-val { font-size: 26px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono'; margin: 8px 0; }
    .asset-approx { font-size: 13px; color: var(--muted); }
    .asset-pnl { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); display: inline-flex; align-items: center; gap: 4px; margin-left: 8px; }
    .asset-rate { font-size: 11px; color: var(--muted); margin-top: 8px; display: block; }
    .pro-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .pro-btn { background: var(--panel-light); border: none; color: var(--white); padding: 10px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .pro-btn.primary { background: var(--gold); color: #000; }

    .analysis-block { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .an-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 110px; }
    .an-card.clickable { cursor: pointer; transition: all 0.2s; }
    .an-card.clickable:hover { border-color: rgba(255,255,255,0.15); background: rgba(30, 35, 41, 0.8); }
    .an-card.clickable:active { transform: scale(0.98); }
    .an-title { font-size: 11px; color: var(--muted); margin-bottom: 0; text-transform: uppercase; width: 100%; text-align: left; }
    .an-content-center { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }

    .donut-chart { width: 70px; height: 70px; border-radius: 50%; background: conic-gradient(var(--accent-green) 0% 0%, var(--panel-light) 0% 100%); position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; }
    .donut-chart::after { content: ''; position: absolute; width: 56px; height: 56px; background: var(--panel); border-radius: 50%; }
    .donut-val { position: absolute; z-index: 2; font-size: 12px; font-weight: 700; color: var(--white); }
    .an-text { font-size: 12px; color: var(--white); font-weight: 600; margin-top: 4px; }

    .pnl-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .pnl-modal-overlay.active { opacity: 1; pointer-events: auto; }
    .pnl-modal {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      max-height: 85vh; overflow-y: auto; z-index: 1001;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    .pnl-modal-overlay.active .pnl-modal { transform: translateY(0); }
    .pnl-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--panel); z-index: 10;
    }
    .pnl-modal-title { font-size: 16px; font-weight: 700; color: var(--white); }
    .pnl-modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 50%; cursor: pointer;
      color: var(--muted); font-size: 18px; transition: all 0.2s; border: none;
    }
    .pnl-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .pnl-modal-content { padding: 20px; display: flex; flex-direction: column; gap: 24px; }

    .stats-metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stats-metric-card {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 4px;
    }
    .stats-metric-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stats-metric-value { font-size: 18px; font-weight: 700; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .stats-metric-value.positive { color: var(--accent-green); }
    .stats-metric-value.negative { color: var(--accent-red); }

    .period-selector {
      display: flex; gap: 4px; background: rgba(255,255,255,0.03);
      padding: 3px; border-radius: 8px; border: 1px solid var(--border);
    }
    .period-btn {
      padding: 6px 12px; font-size: 11px; font-weight: 600; color: var(--muted);
      background: transparent; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;
    }
    .period-btn:hover { color: var(--white); }
    .period-btn.active { background: var(--panel-light); color: var(--white); }

    .chart-section { display: flex; flex-direction: column; gap: 12px; }
    .chart-section-header { display: flex; justify-content: space-between; align-items: center; }
    .chart-section-title { font-size: 13px; font-weight: 600; color: var(--white); }
    .equity-chart-container {
      height: 160px; background: rgba(0,0,0,0.2); border-radius: 8px;
      overflow: hidden; position: relative;
    }

    .calendar-pnl-container { display: flex; flex-direction: column; gap: 8px; }
    .calendar-month-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 8px; }
    .calendar-nav-btn {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border: none; border-radius: 6px;
      color: var(--muted); cursor: pointer; transition: all 0.2s; font-size: 16px;
    }
    .calendar-nav-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .calendar-month-label { font-size: 14px; font-weight: 600; color: var(--white); min-width: 120px; text-align: center; }
    .calendar-header { display: flex; justify-content: space-between; padding: 0 2px; }
    .calendar-day-label { font-size: 9px; color: var(--muted); width: 36px; text-align: center; font-weight: 600; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-cell {
      aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 600; font-family: 'Roboto Mono', monospace;
      cursor: default; transition: transform 0.15s; position: relative;
      background: rgba(255,255,255,0.03); color: var(--muted);
    }
    .calendar-cell:hover { transform: scale(1.1); z-index: 2; }
    .calendar-cell.empty { background: transparent; }
    .calendar-cell.profit { background: var(--accent-green-transparent); color: var(--accent-green); }
    .calendar-cell.loss { background: var(--accent-red-transparent); color: var(--accent-red); }
    .calendar-cell.profit.high { background: rgba(14, 203, 129, 0.3); }
    .calendar-cell.loss.high { background: rgba(246, 70, 93, 0.3); }
    .calendar-cell.today { border: 1px solid var(--gold); }
    .calendar-legend {
      display: flex; justify-content: center; gap: 16px; margin-top: 8px;
      padding-top: 8px; border-top: 1px solid var(--border);
    }
    .calendar-legend-item { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--muted); }
    .calendar-legend-dot { width: 10px; height: 10px; border-radius: 3px; }
    .calendar-legend-dot.profit { background: var(--accent-green-transparent); }
    .calendar-legend-dot.loss { background: var(--accent-red-transparent); }
    .calendar-legend-dot.no-trade { background: rgba(255,255,255,0.03); }

    .ref-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .ref-top { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .ref-title { font-weight: 800; font-size: 14px; }
    .ref-badge { font-size: 11px; color: var(--muted); background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); }
    .ref-row { display: flex; gap: 8px; align-items: center; }
    .ref-input { flex: 1; background: #111; border: 1px solid var(--border); color: var(--white); padding: 12px; border-radius: 10px; font-family: 'Roboto Mono', monospace; font-size: 12px; outline: none; width: 100%; }
    .ref-btn { background: var(--panel-light); border: 1px solid var(--border); color: var(--white); padding: 12px 12px; border-radius: 10px; font-weight: 700; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .ref-btn.primary { background: var(--gold); color: #000; border-color: rgba(240,185,11,0.4); }
    .ref-help { font-size: 11px; color: var(--muted); line-height: 1.35; }
    .ref-list { display: flex; flex-direction: column; gap: 8px; max-height: 180px; overflow-y: auto; padding-right: 2px; }
    .ref-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 10px; }
    .ref-item-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .ref-avatar { width: 28px; height: 28px; border-radius: 50%; background: #333; overflow: hidden; border: 1px solid var(--border); flex-shrink: 0; }
    .ref-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .ref-name { font-size: 12px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
    .ref-date { font-size: 10px; color: var(--muted); font-family: monospace; flex-shrink: 0; }
    .ref-status { font-size: 10px; color: var(--muted); }

    .rewards-banner {
      background: linear-gradient(90deg, #1E2329 0%, #252a33 100%); border: 1px solid rgba(240, 185, 11, 0.3);
      border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; position: relative; overflow: hidden;
    }
    .rewards-banner::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gold); }
    .rb-content h3 { margin: 0; font-size: 15px; color: var(--white); }
    .rb-content p { margin: 4px 0 0; font-size: 11px; color: var(--muted); }
    .rb-icon { display: flex; align-items: center; }

    .hist-header-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; }
    .hist-title { margin: 0; font-size: 15px; font-weight: 700; }
    .hist-filters { display: flex; background: var(--panel); border-radius: 8px; padding: 2px; border: 1px solid var(--border); }
    .h-filter { padding: 4px 10px; font-size: 11px; color: var(--muted); border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: 500; }
    .h-filter.active { background: var(--panel-light); color: var(--white); font-weight: 700; }

    .history-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 60px; }
    .history-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 8px; }
    .hc-header { display: flex; justify-content: space-between; align-items: center; }
    .hc-pair { font-weight: 700; font-size: 14px; }
    .hc-type { font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
    .hc-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
    .hc-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
    .hc-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); }
    .hc-val { color: var(--white); font-family: 'Roboto Mono'; }
    .hc-pnl { font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

    .rewards-container { padding: 20px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; padding-bottom: 100px; }
    .rewards-header { text-align: center; padding: 20px 0; }
    .rh-title { font-size: 22px; font-weight: 700; color: var(--white); margin-bottom: 8px; }
    .rh-sub { font-size: 13px; color: var(--muted); }
    .stats-row { display: flex; justify-content: center; gap: 32px; margin-top: 16px; }
    .stat-item { text-align: center; }
    .stat-item .stat-number { font-size: 24px; font-weight: 700; color: var(--gold); font-family: 'Roboto Mono'; }
    .stat-item .stat-desc { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .progress-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
    .prog-info { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; color: var(--white); font-weight: 600; }
    .prog-track { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative; }
    .prog-fill { height: 100%; background: var(--gold-gradient); width: 0%; transition: width 0.5s ease; border-radius: 4px; }
    .milestones { display: flex; justify-content: space-between; margin-top: 12px; }
    .ms-item { text-align: center; width: 30px; position: relative; }
    .ms-dot { width: 10px; height: 10px; background: #333; border: 2px solid var(--muted); border-radius: 50%; margin: 0 auto 4px; z-index: 2; position: relative; }
    .ms-item.active .ms-dot { background: var(--gold); border-color: var(--gold); box-shadow: 0 0 10px rgba(240, 185, 11, 0.4); }
    .ms-val { font-size: 10px; color: var(--muted); }

    .task-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .task-item { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
    .task-left h4 { margin: 0 0 4px; font-size: 14px; }
    .task-left p { margin: 0; font-size: 11px; color: var(--muted); }
    .task-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .daily-counter { font-size: 11px; color: var(--muted); font-family: 'Roboto Mono'; }
    .daily-counter.limit-reached { color: var(--accent-red); }
    .btn-claim { background: var(--gold); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .btn-claim:hover { filter: brightness(1.1); }
    .btn-claim:active { transform: scale(0.96); }
    .btn-claim:disabled { background: var(--panel-light); color: var(--muted); cursor: not-allowed; }
    .btn-claim.loading { opacity: 0.7; pointer-events: none; }

    .btn-back-float {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--panel-light); border: 1px solid var(--border); color: var(--white);
      padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 900; cursor: pointer;
    }

    #app-loader {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s;
    }
    #app-loader.hidden { opacity: 0; pointer-events: none; }
    .loader-logo { width: 80px; height: auto; margin-bottom: 20px; animation: pulse 2s infinite ease-in-out; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    .loader-bar-bg { width: 140px; height: 2px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .loader-bar-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.2s; }

    .tf-selector {
      display: flex; gap: 2px; background: rgba(255,255,255,0.03);
      padding: 2px; border-radius: 6px; height: fit-content; flex-shrink: 0; align-self: flex-start;
    }
    .tf-selector.tf-wrapped {
      display: grid; grid-template-columns: repeat(3, auto); grid-template-rows: auto auto;
      gap: 2px; width: auto; justify-content: end;
    }
    .tf-opt {
      padding: 4px 8px; font-size: 10px; color: var(--muted); border-radius: 4px;
      cursor: pointer; font-weight: 600; transition: 0.2s; user-select: none; white-space: nowrap; text-align: center;
    }
    .tf-opt:hover { color: var(--white); background: rgba(255,255,255,0.05); }
    .tf-opt.active { background: var(--panel-light); color: var(--gold); }
  </style>
</head>
<body>

<div id="app-loader">
  <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="TradeSim" class="loader-logo">
  <div class="loader-bar-bg"><div class="loader-bar-fill" id="loaderBar"></div></div>
  <div style="margin-top: 12px; font-size: 10px; color: var(--muted); font-family: monospace; letter-spacing: 1px;" id="loaderText">CONNECTING</div>
</div>

<div class="app">

  <div id="view-trade" class="view-section active">
    <header class="header">
      <div class="header-left">
        <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="Logo" class="logo-img">
        <div class="pair-dropdown" id="pairDropdown">
          <div class="pair-trigger" id="pairTrigger">
            <span id="triggerText">BTC/USD</span>
            <span class="arrow">▼</span>
          </div>
          <div class="pair-menu">
            <div class="pair-item active" data-pair="BTC-USD">BTC/USD</div>
            <div class="pair-item" data-pair="ETH-USD">ETH/USD</div>
          </div>
        </div>
      </div>
      <div class="user-area" id="btnProfile">
        <div class="balance-group">
          <span class="balance-label">Total Assets</span>
          <span class="balance-val" id="headerBalance">0.00 VP</span>
        </div>
        <div class="avatar-sm"><img id="avatarImg" src="" style="display:none"></div>
      </div>
    </header>

    <main class="container">
      <div class="left-col">
        <div class="card">
          <div class="market-header" id="marketHeader">
            <div class="price-block" id="priceBlock">
              <div class="price-label">Market Price</div>
              <div class="price-display text-green" id="priceDisplay">--.--</div>
            </div>
            <div class="tf-selector" id="timeframeSelector">
              <div class="tf-opt active" data-tf="60">1m</div>
              <div class="tf-opt" data-tf="300">5m</div>
              <div class="tf-opt" data-tf="900">15m</div>
              <div class="tf-opt" data-tf="3600">1h</div>
              <div class="tf-opt" data-tf="21600">6h</div>
              <div class="tf-opt" data-tf="86400">1d</div>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-container" id="chartCard">
              <div id="chart" style="width: 100%; height: 100%;"></div>
              <div class="chart-loading-overlay" id="chartLoadingOverlay">
                <div class="chart-loading-spinner"></div>
              </div>
              <div class="ohlc-tooltip" id="ohlcTooltip">
                <div class="ohlc-item"><span class="ohlc-label">O:</span><span class="ohlc-value" id="ohlcOpen">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">H:</span><span class="ohlc-value" id="ohlcHigh">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">L:</span><span class="ohlc-value" id="ohlcLow">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">C:</span><span class="ohlc-value" id="ohlcClose">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">V:</span><span class="ohlc-value" id="ohlcVol">-</span></div>
              </div>
              <div class="drawing-tools-menu" id="drawingToolsMenu">
                <div class="drawing-tools-toggle" id="drawingToolsToggle" title="Drawing Tools">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/>
                  </svg>
                </div>
                <div class="drawing-tools-panel" id="drawingToolsPanel">
                  <div class="drawing-tool-btn" id="toolCursor" data-tool="cursor" title="Cursor"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg></div>
                  <div class="drawing-tool-btn" id="toolTrendLine" data-tool="trendline" title="Trend Line"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="20" x2="20" y2="4"/></svg></div>
                  <div class="drawing-tool-btn" id="toolHorizLine" data-tool="horizline" title="Horizontal Line"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="12" x2="22" y2="12"/></svg></div>
                  <div class="drawing-tool-btn" id="toolClearAll" data-tool="clear" title="Clear All"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
                </div>
              </div>
            </div>
            <div class="volume-container" id="volumeContainer"><div id="volumeChart" style="width: 100%; height: 100%;"></div></div>
            <div class="indicators-panel" id="indicatorsPanel">
              <div class="indicator-chip ema" id="chipEMA" data-indicator="ema"><span class="indicator-dot"></span><span>EMA 20</span></div>
              <div class="indicator-chip sma" id="chipSMA" data-indicator="sma"><span class="indicator-dot"></span><span>SMA 50</span></div>
              <div class="indicator-chip vwap" id="chipVWAP" data-indicator="vwap"><span class="indicator-dot"></span><span>VWAP</span></div>
              <div class="indicator-chip volume" id="chipVolume" data-indicator="volume"><span class="indicator-dot"></span><span>Volume</span></div>
            </div>
          </div>

          <div class="controls-area">
            <div class="input-group">
              <span class="input-label">Margin (VP)</span>
              <input type="number" id="sizeInput" class="main-input" value="100" placeholder="10-10000" />
            </div>
            <div class="slider-wrap">
              <div class="slider-header"><span>Margin %</span><span class="slider-val" id="marginPercentText">0%</span></div>
              <div class="margin-slider-wrap">
                <input type="range" class="range-slider" id="marginSlider" min="0" max="100" step="1" value="0">
                <div class="margin-marks">
                  <span class="margin-mark" data-pct="0">0%</span>
                  <span class="margin-mark" data-pct="25">25%</span>
                  <span class="margin-mark" data-pct="50">50%</span>
                  <span class="margin-mark" data-pct="75">75%</span>
                  <span class="margin-mark" data-pct="100">100%</span>
                </div>
              </div>
            </div>
            <div class="slider-wrap">
              <div class="slider-header"><span>Leverage</span><span class="slider-val" id="leverageValText">10x</span></div>
              <input type="range" class="range-slider" id="leverageSlider" min="1" max="50" step="1" value="10">
              <div class="chips-row" id="leverageChips">
                <div class="chip" data-v="1">1x</div>
                <div class="chip" data-v="5">5x</div>
                <div class="chip active" data-v="10">10x</div>
                <div class="chip" data-v="20">20x</div>
                <div class="chip" data-v="50">50x</div>
              </div>
            </div>
            <div class="action-btns">
              <button id="openLong" class="btn-trade btn-long">Buy / Long <span>Up</span></button>
              <button id="openShort" class="btn-trade btn-short">Sell / Short <span>Down</span></button>
            </div>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px; padding-left: 4px;">Open Positions</div>
          <div id="positionsList" class="pos-list"><div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div></div>
        </div>
      </div>

      <div class="right-col">
        <div class="card" style="display:flex; flex-direction:column; min-height: 300px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between; align-items:center;">
            <span>Order Book</span>
            <div style="display:flex; gap:8px; align-items:center;">
              <span id="bookPairLabel" style="color:var(--muted); font-size:11px;">BTC-USD</span>
              <span id="bookUpdated" style="color:var(--muted); font-size:11px;">—</span>
            </div>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Amount</span></div>
          <div class="ob-container" id="orderBook" style="flex:1;"></div>
        </div>
        <div class="card" style="display:flex; flex-direction:column; min-height: 250px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between;">
            <span>Last Trades</span>
            <span style="color:var(--muted); font-size:11px;">Real-time</span>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Time</span></div>
          <div class="ob-container" id="tradeHistory" style="flex:1;"></div>
        </div>
      </div>
    </main>
  </div>

  <div id="view-profile" class="view-section hidden">
    <div class="profile-container">
      <div class="pro-header">
        <div class="pro-user">
          <div class="pro-avatar"><img id="profileAvatarBig" src=""></div>
          <div>
            <div class="pro-name" id="profileName">Trader</div>
            <div class="pro-id" id="profileId">ID: --</div>
          </div>
        </div>
        <div class="btn-close" id="btnCloseProfile" style="color:var(--muted); padding:8px; cursor:pointer;">✕</div>
      </div>
      <div class="asset-card">
        <div class="asset-label">Total Assets (VP)<img id="btnToggleBalance" class="eye-btn" src="https://img.icons8.com/ios-glyphs/60/ffffff/visible.png" alt="Show/Hide"></div>
        <div class="asset-val" id="profileBalance">0.00</div>
        <div style="display:flex; align-items:center;">
          <span class="asset-approx" id="profileBalanceApprox">≈ $0.00</span>
          <div class="asset-pnl text-green" id="profilePnlPill">+0.00%</div>
        </div>
        <span class="asset-rate">1 VP = $0.005</span>
        <div class="pro-actions">
          <button class="pro-btn primary">Deposit</button>
          <button class="pro-btn">Withdraw</button>
        </div>
      </div>
      <div class="analysis-block">
        <div class="an-card">
          <div class="an-title">Win Rate</div>
          <div class="an-content-center">
            <div class="donut-chart" id="winRateChart"><span class="donut-val" id="winRateVal">0%</span></div>
            <div class="an-text" id="totalTradesVal" style="margin-top: 6px;">0 Trades</div>
          </div>
        </div>
        <div class="an-card clickable" id="netPnlCard">
          <div class="an-title">Net PnL</div>
          <div class="an-content-center">
            <div style="font-size:20px; font-weight:700; font-family:'Roboto Mono';" id="statPnL">0.00</div>
          </div>
          <div style="font-size:10px; color:var(--muted); width:100%; text-align:center;">Tap for details →</div>
        </div>
      </div>
      <div class="ref-card" id="refCard">
        <div class="ref-top"><div class="ref-title">Referrals</div><div class="ref-badge" id="refCountBadge">Invited: 0</div></div>
        <div class="ref-row"><input class="ref-input" id="refLinkInput" readonly value="Loading..."><button class="ref-btn primary" id="btnCopyRefLink">Copy</button></div>
        <div class="ref-help" id="refHelpText">Share the link with friends. When they open the bot using your link, they will be automatically assigned as your referral.</div>
        <div class="ref-list" id="refList"><div class="ref-status" id="refStatus">Loading referrals...</div></div>
      </div>
      <div class="rewards-banner" id="btnGoRewards">
        <div class="rb-content"><h3>Rewards Center</h3><p>Complete tasks to unlock features</p></div>
        <div class="rb-icon"><img src="https://i.postimg.cc/pdkwtBbQ/gift-thunder.png" style="width: 40px; height: auto;"></div>
      </div>
      <div>
        <div class="hist-header-row">
          <div class="hist-title">History</div>
          <div class="hist-filters">
            <div class="h-filter active" data-filter="all">All</div>
            <div class="h-filter" data-filter="day">24h</div>
            <div class="h-filter" data-filter="week">7d</div>
          </div>
        </div>
        <div class="history-list" id="historyList"><div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history</div></div>
      </div>
    </div>
  </div>

  <div id="view-rewards" class="view-section hidden">
    <div class="rewards-container">
      <div class="rewards-header">
        <div class="rh-title">Achievement Progress</div>
        <div class="rh-sub">Watch ads & earn rewards</div>
        <div class="stats-row">
          <div class="stat-item"><div class="stat-number" id="totalAdsWatched">0</div><div class="stat-desc">Ads Watched</div></div>
          <div class="stat-item"><div class="stat-number" id="totalEarnedFromAds">0</div><div class="stat-desc">VP Earned</div></div>
        </div>
      </div>
      <div class="progress-card">
        <div class="prog-info"><span id="currentLevelText">Level 1</span><span id="adsProgressText">0 / 10 Ads</span></div>
        <div class="prog-track"><div class="prog-fill" id="adsProgressBar" style="width: 0%;"></div></div>
        <div class="milestones">
          <div class="ms-item active" id="ms-start"><div class="ms-dot"></div><span class="ms-val">Start</span></div>
          <div class="ms-item" id="ms-5"><div class="ms-dot"></div><span class="ms-val">5 Ads</span></div>
          <div class="ms-item" id="ms-10"><div class="ms-dot"></div><span class="ms-val">10 Ads</span></div>
        </div>
      </div>
      <div class="task-list">
        <div class="task-item">
          <div class="task-left"><h4>Watch Ad</h4><p>Earn +1 VP per view</p></div>
          <div class="task-right">
            <span class="daily-counter" id="dailyAdCounter">0/5 today</span>
            <button class="btn-claim" id="btnWatchAd">WATCH</button>
          </div>
        </div>
      </div>
      <button class="btn-back-float" id="btnBackFromRewards">Back to Profile</button>
    </div>
  </div>

</div>

<!-- PnL Modal -->
<div class="pnl-modal-overlay" id="pnlModalOverlay">
  <div class="pnl-modal" id="pnlModal">
    <div class="pnl-modal-header">
      <div class="pnl-modal-title">Trading Statistics</div>
      <button class="pnl-modal-close" id="pnlModalClose">×</button>
    </div>
    <div class="pnl-modal-content">
      <div class="stats-metrics-grid">
        <div class="stats-metric-card"><div class="stats-metric-label">Avg Risk:Reward</div><div class="stats-metric-value" id="modalAvgRR">--</div></div>
        <div class="stats-metric-card"><div class="stats-metric-label">Max Drawdown</div><div class="stats-metric-value negative" id="modalMaxDD">--</div></div>
        <div class="stats-metric-card"><div class="stats-metric-label">Profit Factor</div><div class="stats-metric-value" id="modalProfitFactor">--</div></div>
        <div class="stats-metric-card"><div class="stats-metric-label">Avg Trade</div><div class="stats-metric-value" id="modalAvgTrade">--</div></div>
      </div>
      <div class="chart-section">
        <div class="chart-section-header">
          <div class="chart-section-title">Equity Curve</div>
          <div class="period-selector" id="equityPeriodSelector">
            <button class="period-btn active" data-period="7d">7D</button>
            <button class="period-btn" data-period="30d">30D</button>
            <button class="period-btn" data-period="90d">90D</button>
            <button class="period-btn" data-period="all">All</button>
          </div>
        </div>
        <div class="equity-chart-container" id="equityChartContainer"></div>
      </div>
      <div class="chart-section">
        <div class="chart-section-title" style="margin-bottom: 12px;">Calendar PnL</div>
        <div class="calendar-pnl-container" id="calendarPnlContainer">
          <div class="calendar-month-nav">
            <button class="calendar-nav-btn" id="calendarPrev">‹</button>
            <span class="calendar-month-label" id="calendarMonthLabel">January 2025</span>
            <button class="calendar-nav-btn" id="calendarNext">›</button>
          </div>
          <div class="calendar-header">
            <span class="calendar-day-label">Mon</span><span class="calendar-day-label">Tue</span><span class="calendar-day-label">Wed</span><span class="calendar-day-label">Thu</span><span class="calendar-day-label">Fri</span><span class="calendar-day-label">Sat</span><span class="calendar-day-label">Sun</span>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
          <div class="calendar-legend">
            <div class="calendar-legend-item"><span class="calendar-legend-dot profit"></span><span>Profit</span></div>
            <div class="calendar-legend-item"><span class="calendar-legend-dot loss"></span><span>Loss</span></div>
            <div class="calendar-legend-item"><span class="calendar-legend-dot no-trade"></span><span>No Trade</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TP/SL Modal -->
<div class="tpsl-modal-overlay" id="tpslModalOverlay">
  <div class="tpsl-modal" id="tpslModal">
    <div class="tpsl-modal-header">
      <div class="tpsl-modal-header-left">
        <div class="tpsl-modal-title" id="tpslModalTitle">Take Profit</div>
        <div class="tpsl-modal-subtitle" id="tpslModalSubtitle">Lock in profits at target price</div>
      </div>
      <button class="tpsl-modal-close" id="tpslModalClose">×</button>
    </div>
    <div class="tpsl-modal-content">
      <div class="tpsl-position-info">
        <div class="tpsl-position-left">
          <div class="tpsl-position-type long" id="tpslPositionType">LONG</div>
          <div>
            <span class="tpsl-position-pair" id="tpslPositionPair">BTC-USD</span>
            <span class="tpsl-position-leverage" id="tpslPositionLeverage">x10</span>
          </div>
        </div>
        <div class="tpsl-position-right">
          <div class="tpsl-position-entry-label">Entry Price</div>
          <div class="tpsl-position-entry-val" id="tpslEntryPrice">0.00</div>
          <div class="tpsl-position-mark-label">Mark Price</div>
          <div class="tpsl-position-mark-val" id="tpslMarkPrice">0.00</div>
        </div>
      </div>

      <div class="tpsl-tabs">
        <button class="tpsl-tab active" id="tpslTabFull" data-tab="full">Position TP/SL</button>
        <button class="tpsl-tab" id="tpslTabPartial" data-tab="partial">Partial TP/SL</button>
      </div>

      <div class="tpsl-tab-content active" id="tabFull">
        <div class="tpsl-input-group">
          <div class="tpsl-input-label">
            <span>Trigger Price</span>
            <span class="tpsl-input-hint" id="tpslPriceHint">Must be above current price</span>
          </div>
          <div class="tpsl-input-wrapper">
            <input type="number" class="tpsl-input" id="tpslPriceInput" placeholder="0.00" step="any">
            <button class="tpsl-market-btn" id="tpslMarketBtn">Market</button>
          </div>
          <div class="tpsl-input-error" id="tpslErrorText"></div>
        </div>

        <div class="tpsl-pnl-preview">
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Expected PnL</span>
            <span class="tpsl-pnl-value" id="tpslExpectedPnl">-- VP</span>
          </div>
          <div class="tpsl-pnl-divider"></div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">ROE</span>
            <span class="tpsl-pnl-value" id="tpslExpectedRoe">--%</span>
          </div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Close Size</span>
            <span class="tpsl-pnl-value" id="tpslCloseSize">100%</span>
          </div>
        </div>

        <div class="tpsl-existing-orders" id="tpslExistingOrders" style="display: none;">
          <div class="tpsl-existing-title">
            <span>⚠️</span>
            <span>Existing Orders</span>
          </div>
          <div class="tpsl-existing-list" id="tpslExistingList"></div>
        </div>

        <div id="tpslLimitNotice" class="tpsl-limit-notice" style="display:none;">
          Maximum 3 orders reached for this type
        </div>

        <button class="tpsl-submit-btn tp-confirm" id="tpslSubmitFull" disabled>
          <span>Confirm Take Profit</span>
        </button>
      </div>

      <div class="tpsl-tab-content" id="tabPartial">
        <div class="tpsl-input-group">
          <div class="tpsl-input-label">
            <span>Trigger Price</span>
            <span class="tpsl-input-hint" id="tpslPriceHintPartial">Must be above current price</span>
          </div>
          <div class="tpsl-input-wrapper">
            <input type="number" class="tpsl-input" id="tpslPriceInputPartial" placeholder="0.00" step="any">
            <button class="tpsl-market-btn" id="tpslMarketBtnPartial">Market</button>
          </div>
          <div class="tpsl-input-error" id="tpslErrorTextPartial"></div>
        </div>

        <div class="tpsl-size-section">
          <div class="tpsl-size-header">
            <span class="tpsl-size-label">Close Size</span>
            <span class="tpsl-size-value" id="tpslSizeValue">50%</span>
          </div>
          <div class="tpsl-size-slider-wrap">
            <input type="range" class="range-slider" id="tpslSizeSlider" min="10" max="100" step="5" value="50">
          </div>
          <div class="tpsl-size-marks">
            <span class="tpsl-size-mark" data-size="25">25%</span>
            <span class="tpsl-size-mark active" data-size="50">50%</span>
            <span class="tpsl-size-mark" data-size="75">75%</span>
            <span class="tpsl-size-mark" data-size="100">100%</span>
          </div>
          <div class="tpsl-available-info">
            <span>Available to close</span>
            <span id="tpslAvailableSize">100%</span>
          </div>
        </div>

        <div class="tpsl-pnl-preview">
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Expected PnL</span>
            <span class="tpsl-pnl-value" id="tpslExpectedPnlPartial">-- VP</span>
          </div>
          <div class="tpsl-pnl-divider"></div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">ROE</span>
            <span class="tpsl-pnl-value" id="tpslExpectedRoePartial">--%</span>
          </div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Close Amount</span>
            <span class="tpsl-pnl-value" id="tpslCloseSizePartial">-- VP</span>
          </div>
        </div>

        <div class="tpsl-existing-orders" id="tpslExistingOrdersPartial" style="display: none;">
          <div class="tpsl-existing-title">
            <span>⚠️</span>
            <span>Existing Orders (<span id="tpslUsedPercent">0</span>% used)</span>
          </div>
          <div class="tpsl-existing-list" id="tpslExistingListPartial"></div>
        </div>

        <div id="tpslLimitNoticePartial" class="tpsl-limit-notice" style="display:none;">
          Maximum 3 orders reached for this type
        </div>

        <button class="tpsl-submit-btn tp-confirm" id="tpslSubmitPartial" disabled>
          <span>Confirm Take Profit</span>
        </button>
      </div>
    </div>
  </div>
</div>
<script>
// ─── CONFIG ───
const API_BASE = ''; // same origin
const WS_BASE  = location.protocol === 'https:' ? 'wss://' : 'ws://';
const VP_RATE  = 0.005;
const MAX_TPSL_PER_TYPE = 3;
const DAILY_AD_LIMIT = 5;
const AD_BLOCK_ID = ''; // Adsgram block id

// ─── TELEGRAM WEB APP ───
const tg = window.Telegram?.WebApp;
let tgUser = null, authToken = '';
if (tg) {
  tg.ready(); tg.expand(); tg.disableVerticalSwipes?.();
  tgUser = tg.initDataUnsafe?.user;
  authToken = tg.initData || '';
}

// ─── STATE ───
let state = {
  pair: 'BTC-USD',
  tf: 60,
  balance: 10000,
  positions: [],
  history: [],
  referrals: [],
  refCode: '',
  adsWatched: 0,
  adsToday: 0,
  adsEarned: 0,
  lastAdDate: '',
  currentPrice: 0,
  prevPrice: 0,
  balanceHidden: false,
  drawingTool: null,
  drawingLines: [],
  indicators: { ema: false, sma: false, vwap: false, volume: false },
  calendarMonth: new Date().getMonth(),
  calendarYear: new Date().getFullYear(),
  equityPeriod: '7d',
  histFilter: 'all',
  tpslModal: { open: false, posId: null, type: 'tp', tab: 'full' },
  pnlModal: false
};

// ─── DOM REFS ───
const $ = id => document.getElementById(id);
const priceDisplay = $('priceDisplay');
const headerBalance = $('headerBalance');
const sizeInput = $('sizeInput');
const leverageSlider = $('leverageSlider');
const leverageValText = $('leverageValText');
const marginSlider = $('marginSlider');
const marginPercentText = $('marginPercentText');
const positionsList = $('positionsList');
const orderBookEl = $('orderBook');
const tradeHistoryEl = $('tradeHistory');
const historyListEl = $('historyList');

// ─── CHART ───
let chart, candleSeries, volumeChart, volumeSeries;
let emaSeries, smaSeries, vwapSeries;
let candleData = [], volData = [];
let chartReady = false;

function initChart() {
  const container = $('chart');
  container.innerHTML = '';
  chart = LightweightCharts.createChart(container, {
    layout: { background: { type: 'solid', color: '#111' }, textColor: '#848E9C', fontSize: 11, fontFamily: "'Roboto Mono', monospace" },
    grid: { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
    crosshair: { mode: 0, vertLine: { color: 'rgba(255,255,255,0.1)', width: 1, style: 2, labelBackgroundColor: '#2A2F36' }, horzLine: { color: 'rgba(255,255,255,0.1)', width: 1, style: 2, labelBackgroundColor: '#2A2F36' } },
    timeScale: { timeVisible: true, secondsVisible: false, borderColor: 'rgba(255,255,255,0.06)', fixLeftEdge: true, fixRightEdge: true },
    rightPriceScale: { borderColor: 'rgba(255,255,255,0.06)', scaleMargins: { top: 0.1, bottom: 0.08 } },
    handleScroll: { vertTouchDrag: false },
  });

  candleSeries = chart.addCandlestickSeries({
    upColor: '#0ECB81', downColor: '#F6465D', borderUpColor: '#0ECB81', borderDownColor: '#F6465D',
    wickUpColor: '#0ECB81', wickDownColor: '#F6465D',
  });

  // Volume sub-chart
  const volContainer = $('volumeChart');
  volContainer.innerHTML = '';
  volumeChart = LightweightCharts.createChart(volContainer, {
    layout: { background: { type: 'solid', color: '#111' }, textColor: '#848E9C', fontSize: 10, fontFamily: "'Roboto Mono', monospace" },
    grid: { vertLines: { visible: false }, horzLines: { color: 'rgba(255,255,255,0.02)' } },
    timeScale: { visible: false, fixLeftEdge: true, fixRightEdge: true },
    rightPriceScale: { borderColor: 'rgba(255,255,255,0.06)', scaleMargins: { top: 0.1, bottom: 0 } },
    crosshair: { mode: 0 },
    handleScroll: { vertTouchDrag: false },
  });
  volumeSeries = volumeChart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: 'right' });

  // Sync time scales
  chart.timeScale().subscribeVisibleLogicalRangeChange(range => {
    if (range) volumeChart.timeScale().setVisibleLogicalRange(range);
  });
  volumeChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
    if (range) chart.timeScale().setVisibleLogicalRange(range);
  });

  // Crosshair tooltip
  chart.subscribeCrosshairMove(param => {
    const tooltip = $('ohlcTooltip');
    if (!param || !param.time || !param.seriesData?.size) { tooltip.classList.remove('visible'); return; }
    const d = param.seriesData.get(candleSeries);
    if (!d) { tooltip.classList.remove('visible'); return; }
    const dp = getPriceDecimals();
    $('ohlcOpen').textContent = d.open?.toFixed(dp) ?? '-';
    $('ohlcHigh').textContent = d.high?.toFixed(dp) ?? '-';
    $('ohlcLow').textContent = d.low?.toFixed(dp) ?? '-';
    $('ohlcClose').textContent = d.close?.toFixed(dp) ?? '-';
    const cls = d.close >= d.open ? 'up' : 'down';
    ['ohlcOpen','ohlcHigh','ohlcLow','ohlcClose'].forEach(id => { $(id).className = 'ohlc-value ' + cls; });
    // Volume
    const vd = candleData.find(c => c.time === param.time);
    $('ohlcVol').textContent = vd?.volume ? formatVol(vd.volume) : '-';
    tooltip.classList.add('visible');
  });

  chartReady = true;
  chart.timeScale().fitContent();
}

function getPriceDecimals() { return state.pair === 'BTC-USD' ? 2 : 2; }
function formatPrice(p) { return Number(p).toFixed(getPriceDecimals()); }
function formatVol(v) { return v >= 1e9 ? (v/1e9).toFixed(1)+'B' : v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(1)+'K' : v.toFixed(0); }
function formatBalance(b) { return state.balanceHidden ? '•••••' : Number(b).toFixed(2); }

// ─── DATA FETCHING ───
async function fetchCandles() {
  showChartLoading(true);
  try {
    const r = await fetch(`${API_BASE}/api/candles?pair=${state.pair}&tf=${state.tf}`);
    const data = await r.json();
    if (!data?.length) return;
    candleData = data.map(c => ({
      time: c.time, open: c.open, high: c.high, low: c.low, close: c.close, volume: c.volume || 0
    })).sort((a,b) => a.time - b.time);

    // deduplicate by time
    const seen = new Set();
    candleData = candleData.filter(c => { if (seen.has(c.time)) return false; seen.add(c.time); return true; });

    candleSeries.setData(candleData);
    updateVolumeData();
    updateIndicators();
    chart.timeScale().fitContent();
    if (candleData.length) {
      const last = candleData[candleData.length - 1];
      updatePrice(last.close);
    }
  } catch(e) { console.error('Fetch candles error:', e); }
  showChartLoading(false);
}

function showChartLoading(show) {
  $('chartLoadingOverlay').classList.toggle('active', show);
}

function updateVolumeData() {
  if (!state.indicators.volume) return;
  const vData = candleData.map(c => ({
    time: c.time, value: c.volume || 0,
    color: c.close >= c.open ? 'rgba(14,203,129,0.35)' : 'rgba(246,70,93,0.35)'
  }));
  volumeSeries.setData(vData);
}

// ─── INDICATORS ───
function calcEMA(data, period) {
  const result = []; const k = 2 / (period + 1);
  let prev = data[0]?.close || 0;
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) { prev = (data.slice(0, i+1).reduce((s,c) => s+c.close, 0)) / (i+1); result.push({ time: data[i].time, value: prev }); continue; }
    const val = data[i].close * k + prev * (1 - k); result.push({ time: data[i].time, value: val }); prev = val;
  }
  return result;
}

function calcSMA(data, period) {
  const result = [];
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) { result.push({ time: data[i].time, value: data.slice(0, i+1).reduce((s,c)=>s+c.close,0)/(i+1) }); continue; }
    const sum = data.slice(i - period + 1, i + 1).reduce((s,c) => s + c.close, 0);
    result.push({ time: data[i].time, value: sum / period });
  }
  return result;
}

function calcVWAP(data) {
  const result = []; let cumVol = 0, cumTP = 0;
  for (const c of data) {
    const tp = (c.high + c.low + c.close) / 3;
    const vol = c.volume || 1;
    cumTP += tp * vol; cumVol += vol;
    result.push({ time: c.time, value: cumVol > 0 ? cumTP / cumVol : tp });
  }
  return result;
}

function updateIndicators() {
  if (!chartReady || !candleData.length) return;

  // EMA
  if (state.indicators.ema) {
    if (!emaSeries) emaSeries = chart.addLineSeries({ color: '#1E90FF', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
    emaSeries.setData(calcEMA(candleData, 20));
  } else if (emaSeries) { chart.removeSeries(emaSeries); emaSeries = null; }

  // SMA
  if (state.indicators.sma) {
    if (!smaSeries) smaSeries = chart.addLineSeries({ color: '#A855F7', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
    smaSeries.setData(calcSMA(candleData, 50));
  } else if (smaSeries) { chart.removeSeries(smaSeries); smaSeries = null; }

  // VWAP
  if (state.indicators.vwap) {
    if (!vwapSeries) vwapSeries = chart.addLineSeries({ color: '#F7931A', lineWidth: 1, lineStyle: 2, priceLineVisible: false, lastValueVisible: false });
    vwapSeries.setData(calcVWAP(candleData));
  } else if (vwapSeries) { chart.removeSeries(vwapSeries); vwapSeries = null; }

  // Volume panel
  const vc = $('volumeContainer');
  if (state.indicators.volume) {
    vc.classList.add('visible');
    $('chartCard').classList.add('has-volume');
    updateVolumeData();
  } else {
    vc.classList.remove('visible');
    $('chartCard').classList.remove('has-volume');
  }
}

// ─── WEBSOCKET ───
let ws = null, wsRetry = 0;
function connectWS() {
  const url = `${WS_BASE}${location.host}/ws/price?pair=${state.pair}`;
  ws = new WebSocket(url);
  ws.onopen = () => { wsRetry = 0; };
  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'price') handlePriceTick(msg);
      else if (msg.type === 'orderbook') handleOrderbook(msg);
      else if (msg.type === 'trade') handleTradeMsg(msg);
      else if (msg.type === 'candle') handleCandleUpdate(msg);
    } catch(err) {}
  };
  ws.onclose = () => { setTimeout(() => { wsRetry++; connectWS(); }, Math.min(1000 * wsRetry, 10000)); };
  ws.onerror = () => ws.close();
}

function handlePriceTick(msg) {
  updatePrice(msg.price);
  updatePositionsPnL();
  checkTPSL();
}

function handleCandleUpdate(msg) {
  if (!chartReady) return;
  const c = msg.candle;
  if (!c) return;
  const bar = { time: c.time, open: c.open, high: c.high, low: c.low, close: c.close };

  const idx = candleData.findIndex(x => x.time === c.time);
  if (idx >= 0) {
    candleData[idx] = { ...bar, volume: c.volume || candleData[idx].volume };
  } else {
    candleData.push({ ...bar, volume: c.volume || 0 });
    candleData.sort((a,b) => a.time - b.time);
  }
  candleSeries.update(bar);

  if (state.indicators.volume) {
    const vbar = { time: c.time, value: c.volume || 0, color: c.close >= c.open ? 'rgba(14,203,129,0.35)' : 'rgba(246,70,93,0.35)' };
    volumeSeries.update(vbar);
  }
  if (state.indicators.ema || state.indicators.sma || state.indicators.vwap) updateIndicators();
}

function updatePrice(p) {
  state.prevPrice = state.currentPrice;
  state.currentPrice = Number(p);
  const formatted = formatPrice(state.currentPrice);
  priceDisplay.textContent = formatted;
  priceDisplay.className = 'price-display ' + (state.currentPrice >= state.prevPrice ? 'text-green' : 'text-red');
}

// ─── ORDERBOOK & TRADES ───
function handleOrderbook(msg) {
  if (!msg.bids || !msg.asks) return;
  const dp = getPriceDecimals();
  let html = '';
  const asks = (msg.asks || []).slice(0, 8).reverse();
  const bids = (msg.bids || []).slice(0, 8);
  const maxAsk = Math.max(...asks.map(a => a[1]), 1);
  const maxBid = Math.max(...bids.map(b => b[1]), 1);

  for (const a of asks) {
    const pct = (a[1] / maxAsk * 100).toFixed(0);
    html += `<div class="ob-row"><div class="ob-bg bg-red" style="width:${pct}%"></div><span class="text-red">${Number(a[0]).toFixed(dp)}</span><span>${formatVol(a[1])}</span></div>`;
  }
  // Spread
  if (asks.length && bids.length) {
    const spread = Math.abs(Number(asks[asks.length-1]?.[0] || 0) - Number(bids[0]?.[0] || 0));
    html += `<div class="ob-row" style="justify-content:center; color:var(--gold); font-weight:700; font-size:14px; height:28px;">${formatPrice(state.currentPrice)} <span style="font-size:10px; color:var(--muted); margin-left:8px;">Spread: ${spread.toFixed(dp)}</span></div>`;
  }
  for (const b of bids) {
    const pct = (b[1] / maxBid * 100).toFixed(0);
    html += `<div class="ob-row"><div class="ob-bg bg-green" style="width:${pct}%"></div><span class="text-green">${Number(b[0]).toFixed(dp)}</span><span>${formatVol(b[1])}</span></div>`;
  }
  orderBookEl.innerHTML = html;
  $('bookPairLabel').textContent = state.pair;
  $('bookUpdated').textContent = new Date().toLocaleTimeString();
}

function handleTradeMsg(msg) {
  const trades = msg.trades || [msg];
  const dp = getPriceDecimals();
  for (const t of trades) {
    const row = document.createElement('div');
    row.className = 'ob-row';
    const cls = t.side === 'buy' ? 'text-green' : 'text-red';
    row.innerHTML = `<span class="${cls}">${Number(t.price).toFixed(dp)}</span><span class="trade-time">${new Date(t.time || Date.now()).toLocaleTimeString()}</span>`;
    tradeHistoryEl.prepend(row);
  }
  while (tradeHistoryEl.children.length > 30) tradeHistoryEl.lastChild.remove();
}

// ─── POSITIONS ───
function openPosition(side) {
  const margin = Number(sizeInput.value);
  const lev = Number(leverageSlider.value);
  if (!margin || margin < 10 || margin > state.balance) { showToast('Invalid margin', 'error'); return; }
  if (!state.currentPrice) { showToast('Waiting for price...', 'error'); return; }

  const pos = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
    pair: state.pair, side, margin, leverage: lev,
    entryPrice: state.currentPrice, openTime: Date.now(),
    tpOrders: [], slOrders: [],
    originalMargin: margin
  };
  state.balance -= margin;
  state.positions.push(pos);
  updateUI();
  showToast(`${side.toUpperCase()} opened at ${formatPrice(pos.entryPrice)}`, 'success');
  saveState();
}

function closePosition(id, partial = 1) {
  const idx = state.positions.findIndex(p => p.id === id);
  if (idx < 0) return;
  const pos = state.positions[idx];
  const pnl = calcPnL(pos) * partial;
  const returnMargin = pos.margin * partial;

  state.balance += returnMargin + pnl;

  // Save to history
  state.history.push({
    ...pos, closePrice: state.currentPrice, closeTime: Date.now(),
    pnl: pnl, closedMargin: returnMargin
  });

  if (partial >= 1) {
    state.positions.splice(idx, 1);
  } else {
    pos.margin *= (1 - partial);
  }

  updateUI();
  showToast(`Position closed. PnL: ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP`, pnl >= 0 ? 'success' : 'error');
  saveState();
}

function calcPnL(pos) {
  if (!state.currentPrice || !pos.entryPrice) return 0;
  const dir = pos.side === 'long' ? 1 : -1;
  const priceDiff = (state.currentPrice - pos.entryPrice) * dir;
  const pct = priceDiff / pos.entryPrice;
  return pos.margin * pos.leverage * pct;
}

function calcROE(pos) {
  if (!pos.margin) return 0;
  return (calcPnL(pos) / pos.margin) * 100;
}

function calcLiqPrice(pos) {
  const dir = pos.side === 'long' ? 1 : -1;
  return pos.entryPrice * (1 - dir / pos.leverage * 0.95);
}

function updatePositionsPnL() {
  state.positions.forEach(pos => {
    const el = document.querySelector(`[data-pos-id="${pos.id}"]`);
    if (!el) return;
    const pnl = calcPnL(pos);
    const roe = calcROE(pos);
    const pnlEl = el.querySelector('.pos-pnl-val');
    const roeEl = el.querySelector('.pos-roe-val');
    const markEl = el.querySelector('.pos-mark-val');
    const riskEl = el.querySelector('.risk-fill');
    if (pnlEl) { pnlEl.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' VP'; pnlEl.className = 'stat-val pos-pnl-val ' + (pnl >= 0 ? 'text-green' : 'text-red'); }
    if (roeEl) { roeEl.textContent = (roe >= 0 ? '+' : '') + roe.toFixed(2) + '%'; roeEl.className = 'stat-val pos-roe-val ' + (roe >= 0 ? 'text-green' : 'text-red'); }
    if (markEl) markEl.textContent = formatPrice(state.currentPrice);
    if (riskEl) {
      const liq = calcLiqPrice(pos);
      const distToLiq = Math.abs(state.currentPrice - liq) / state.currentPrice * 100;
      const risk = Math.max(0, Math.min(100, 100 - distToLiq * 2));
      riskEl.style.width = risk + '%';
      riskEl.style.background = risk > 70 ? 'var(--accent-red)' : risk > 40 ? 'var(--gold)' : 'var(--accent-green)';
    }
  });

  // Update TPSL order PnL if any are displayed
  document.querySelectorAll('.tpsl-order-item').forEach(el => {
    const orderId = el.dataset.orderId;
    const posId = el.dataset.posId;
    if (!orderId || !posId) return;
    const pos = state.positions.find(p => p.id === posId);
    if (!pos) return;
    const allOrders = [...(pos.tpOrders||[]), ...(pos.slOrders||[])];
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;
    const pnlEl = el.querySelector('.tpsl-order-pnl');
    const roeEl = el.querySelector('.tpsl-order-roe');
    if (pnlEl && roeEl) {
      const dir = pos.side === 'long' ? 1 : -1;
      const priceDiff = (order.price - pos.entryPrice) * dir;
      const size = (order.sizePercent || 100) / 100;
      const expectedPnl = pos.margin * pos.leverage * (priceDiff / pos.entryPrice) * size;
      const expectedRoe = (expectedPnl / (pos.margin * size)) * 100;
      pnlEl.textContent = (expectedPnl >= 0 ? '+' : '') + expectedPnl.toFixed(2) + ' VP';
      pnlEl.className = 'tpsl-order-pnl ' + (expectedPnl >= 0 ? 'text-green' : 'text-red');
      roeEl.textContent = (expectedRoe >= 0 ? '+' : '') + expectedRoe.toFixed(1) + '%';
      roeEl.className = 'tpsl-order-roe ' + (expectedRoe >= 0 ? 'text-green' : 'text-red');
    }
  });
}

// ─── TP/SL CHECK ───
function checkTPSL() {
  const p = state.currentPrice;
  if (!p) return;
  const toClose = [];

  state.positions.forEach(pos => {
    // Check TP orders
    (pos.tpOrders || []).forEach(order => {
      const triggered = pos.side === 'long' ? p >= order.price : p <= order.price;
      if (triggered) toClose.push({ posId: pos.id, order, type: 'tp' });
    });
    // Check SL orders
    (pos.slOrders || []).forEach(order => {
      const triggered = pos.side === 'long' ? p <= order.price : p >= order.price;
      if (triggered) toClose.push({ posId: pos.id, order, type: 'sl' });
    });
    // Check liquidation
    const liq = calcLiqPrice(pos);
    const liquidated = pos.side === 'long' ? p <= liq : p >= liq;
    if (liquidated) toClose.push({ posId: pos.id, order: { sizePercent: 100 }, type: 'liquidation' });
  });

  toClose.forEach(({ posId, order, type }) => {
    const pos = state.positions.find(p => p.id === posId);
    if (!pos) return;
    const size = (order.sizePercent || 100) / 100;

    if (type === 'liquidation') {
      state.history.push({ ...pos, closePrice: state.currentPrice, closeTime: Date.now(), pnl: -pos.margin, closedMargin: 0, liquidated: true });
      state.positions = state.positions.filter(p => p.id !== posId);
      showToast(`⚠️ Position LIQUIDATED!`, 'error');
    } else {
      const pnl = calcPnL(pos) * size;
      const returnMargin = pos.margin * size;
      state.balance += returnMargin + pnl;
      state.history.push({ ...pos, closePrice: state.currentPrice, closeTime: Date.now(), pnl, closedMargin: returnMargin, closedBy: type.toUpperCase() });

      if (size >= 1) {
        state.positions = state.positions.filter(p => p.id !== posId);
      } else {
        pos.margin *= (1 - size);
        // Remove the triggered order
        if (type === 'tp') pos.tpOrders = pos.tpOrders.filter(o => o.id !== order.id);
        else pos.slOrders = pos.slOrders.filter(o => o.id !== order.id);
      }
      showToast(`${type.toUpperCase()} triggered! PnL: ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP`, pnl >= 0 ? 'success' : 'error');
    }
    updateUI();
    saveState();
  });
}

// ─── RENDER POSITIONS ───
function renderPositions() {
  if (!state.positions.length) {
    positionsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted); font-size:13px;">No open positions</div>';
    return;
  }

  positionsList.innerHTML = state.positions.map(pos => {
    const pnl = calcPnL(pos);
    const roe = calcROE(pos);
    const liq = calcLiqPrice(pos);
    const distToLiq = Math.abs(state.currentPrice - liq) / state.currentPrice * 100;
    const risk = Math.max(0, Math.min(100, 100 - distToLiq * 2));
    const totalTpSl = (pos.tpOrders?.length || 0) + (pos.slOrders?.length || 0);

    let tpslOrdersHtml = '';
    if (totalTpSl > 0) {
      const allOrders = [
        ...(pos.tpOrders || []).map(o => ({ ...o, orderType: 'tp' })),
        ...(pos.slOrders || []).map(o => ({ ...o, orderType: 'sl' }))
      ];
      tpslOrdersHtml = `<div class="pos-tpsl-orders">
        <div class="tpsl-orders-title">Active Orders <span class="tpsl-orders-count">${totalTpSl}</span></div>
        <div class="tpsl-orders-list">${allOrders.map(o => {
          const dir = pos.side === 'long' ? 1 : -1;
          const priceDiff = (o.price - pos.entryPrice) * dir;
          const sz = (o.sizePercent || 100) / 100;
          const expPnl = pos.margin * pos.leverage * (priceDiff / pos.entryPrice) * sz;
          const expRoe = (expPnl / (pos.margin * sz)) * 100;
          return `<div class="tpsl-order-item ${o.orderType}-order" data-order-id="${o.id}" data-pos-id="${pos.id}">
            <div class="tpsl-order-info">
              <div class="tpsl-order-type ${o.orderType}-type">${o.orderType === 'tp' ? 'Take Profit' : 'Stop Loss'}</div>
              <div class="tpsl-order-details">
                <span>@ ${formatPrice(o.price)}</span>
                <span>${o.sizePercent || 100}%</span>
              </div>
            </div>
            <div class="tpsl-order-actions">
              <div style="text-align:right;">
                <div class="tpsl-order-pnl ${expPnl >= 0 ? 'text-green' : 'text-red'}">${expPnl >= 0 ? '+' : ''}${expPnl.toFixed(2)} VP</div>
                <div class="tpsl-order-roe ${expRoe >= 0 ? 'text-green' : 'text-red'}">${expRoe >= 0 ? '+' : ''}${expRoe.toFixed(1)}%</div>
              </div>
              <button class="btn-delete-tpsl" onclick="deleteTPSLOrder('${pos.id}','${o.id}','${o.orderType}')">×</button>
            </div>
          </div>`;
        }).join('')}</div>
      </div>`;
    }

    return `<div class="pos-item ${pos.side}" data-pos-id="${pos.id}">
      <div class="pos-header">
        <div><span class="pos-pair">${pos.pair}</span><span class="pos-type-badge" style="background:${pos.side==='long' ? 'var(--accent-green-transparent)' : 'var(--accent-red-transparent)'}; color:${pos.side==='long' ? 'var(--accent-green)' : 'var(--accent-red)'};">${pos.side.toUpperCase()} ${pos.leverage}x</span></div>
        <span style="font-size:11px; color:var(--muted);">${new Date(pos.openTime).toLocaleString()}</span>
      </div>
      <div class="pos-stats-grid">
        <div class="stat-col"><div class="stat-label">PnL</div><div class="stat-val pos-pnl-val ${pnl>=0?'text-green':'text-red'}">${pnl>=0?'+':''}${pnl.toFixed(2)} VP</div></div>
        <div class="stat-col"><div class="stat-label">ROE</div><div class="stat-val pos-roe-val ${roe>=0?'text-green':'text-red'}">${roe>=0?'+':''}${roe.toFixed(2)}%</div></div>
        <div class="stat-col"><div class="stat-label">Mark</div><div class="stat-val pos-mark-val">${formatPrice(state.currentPrice)}</div></div>
      </div>
      <div class="risk-wrap"><div class="risk-track"><div class="risk-fill" style="width:${risk}%; background:${risk>70?'var(--accent-red)':risk>40?'var(--gold)':'var(--accent-green)'}"></div></div></div>
      <div class="pos-details">
        <div class="pd-col"><div class="pd-label">Entry</div><div class="pd-val">${formatPrice(pos.entryPrice)}</div></div>
        <div class="pd-col"><div class="pd-label">Margin</div><div class="pd-val">${pos.margin.toFixed(2)} VP</div></div>
        <div class="pd-col"><div class="pd-label">Liq. Price</div><div class="pd-val text-red">${formatPrice(liq)}</div></div>
      </div>
      <div class="pos-tpsl-actions">
        <button class="btn-tpsl tp" onclick="openTPSLModal('${pos.id}','tp')"><span class="btn-tpsl-icon">🎯</span><span>Take Profit</span><span class="tpsl-count">(${pos.tpOrders?.length || 0}/${MAX_TPSL_PER_TYPE})</span></button>
        <button class="btn-tpsl sl" onclick="openTPSLModal('${pos.id}','sl')"><span class="btn-tpsl-icon">🛡️</span><span>Stop Loss</span><span class="tpsl-count">(${pos.slOrders?.length || 0}/${MAX_TPSL_PER_TYPE})</span></button>
      </div>
      ${tpslOrdersHtml}
      <button class="close-btn" onclick="closePosition('${pos.id}')">Close Position</button>
    </div>`;
  }).join('');
}

function deleteTPSLOrder(posId, orderId, type) {
  const pos = state.positions.find(p => p.id === posId);
  if (!pos) return;
  if (type === 'tp') pos.tpOrders = (pos.tpOrders || []).filter(o => o.id !== orderId);
  else pos.slOrders = (pos.slOrders || []).filter(o => o.id !== orderId);
  renderPositions();
  saveState();
  showToast(`${type.toUpperCase()} order removed`, 'success');
}

// ─── TP/SL MODAL ───
function openTPSLModal(posId, type) {
  const pos = state.positions.find(p => p.id === posId);
  if (!pos) return;

  state.tpslModal = { open: true, posId, type, tab: 'full' };

  // Configure modal
  const isTP = type === 'tp';
  $('tpslModalTitle').textContent = isTP ? 'Take Profit' : 'Stop Loss';
  $('tpslModalSubtitle').textContent = isTP ? 'Lock in profits at target price' : 'Limit losses at stop price';
  $('tpslPositionType').textContent = pos.side.toUpperCase();
  $('tpslPositionType').className = 'tpsl-position-type ' + pos.side;
  $('tpslPositionPair').textContent = pos.pair;
  $('tpslPositionLeverage').textContent = 'x' + pos.leverage;
  $('tpslEntryPrice').textContent = formatPrice(pos.entryPrice);
  $('tpslMarkPrice').textContent = formatPrice(state.currentPrice);

  // Set price hints
  const hint = isTP
    ? (pos.side === 'long' ? 'Must be above entry price' : 'Must be below entry price')
    : (pos.side === 'long' ? 'Must be below entry price' : 'Must be above entry price');
  $('tpslPriceHint').textContent = hint;
  $('tpslPriceHintPartial').textContent = hint;

  // Submit button styling
  const btnCls = isTP ? 'tpsl-submit-btn tp-confirm' : 'tpsl-submit-btn sl-confirm';
  $('tpslSubmitFull').className = btnCls;
  $('tpslSubmitPartial').className = btnCls;
  $('tpslSubmitFull').querySelector('span').textContent = isTP ? 'Confirm Take Profit' : 'Confirm Stop Loss';
  $('tpslSubmitPartial').querySelector('span').textContent = isTP ? 'Confirm Take Profit' : 'Confirm Stop Loss';

  // Reset inputs
  $('tpslPriceInput').value = '';
  $('tpslPriceInputPartial').value = '';
  $('tpslSizeSlider').value = 50;
  $('tpslSizeValue').textContent = '50%';
  $('tpslErrorText').textContent = '';
  $('tpslErrorTextPartial').textContent = '';

  // Show existing orders
  updateTPSLExistingOrders(pos, type);

  // Check limits
  const orders = isTP ? (pos.tpOrders || []) : (pos.slOrders || []);
  const limitReached = orders.length >= MAX_TPSL_PER_TYPE;
  $('tpslLimitNotice').style.display = limitReached ? 'block' : 'none';
  $('tpslLimitNoticePartial').style.display = limitReached ? 'block' : 'none';
  $('tpslSubmitFull').disabled = limitReached;
  $('tpslSubmitPartial').disabled = limitReached;

  // Available size
  const usedPercent = orders.reduce((s, o) => s + (o.sizePercent || 100), 0);
  $('tpslAvailableSize').textContent = Math.max(0, 100 - usedPercent) + '%';
  $('tpslUsedPercent').textContent = usedPercent;

  // Reset tabs
  switchTPSLTab('full');

  // Open
  $('tpslModalOverlay').classList.add('active');
}

function closeTPSLModal() {
  $('tpslModalOverlay').classList.remove('active');
  state.tpslModal.open = false;
}

function switchTPSLTab(tab) {
  state.tpslModal.tab = tab;
  $('tpslTabFull').classList.toggle('active', tab === 'full');
  $('tpslTabPartial').classList.toggle('active', tab === 'partial');
  $('tabFull').classList.toggle('active', tab === 'full');
  $('tabPartial').classList.toggle('active', tab === 'partial');
}

function updateTPSLExistingOrders(pos, type) {
  const orders = type === 'tp' ? (pos.tpOrders || []) : (pos.slOrders || []);
  const el1 = $('tpslExistingOrders');
  const el2 = $('tpslExistingOrdersPartial');
  if (!orders.length) { el1.style.display = 'none'; el2.style.display = 'none'; return; }
  el1.style.display = 'block';
  el2.style.display = 'block';

  const html = orders.map(o => `<div class="tpsl-existing-item">
    <span class="tpsl-existing-item-type ${type}">${type.toUpperCase()} @ ${formatPrice(o.price)}</span>
    <span class="tpsl-existing-item-info">${o.sizePercent || 100}% size</span>
  </div>`).join('');
  $('tpslExistingList').innerHTML = html;
  $('tpslExistingListPartial').innerHTML = html;
}

function validateTPSLPrice(price, pos, type) {
  if (!price || isNaN(price) || price <= 0) return 'Enter a valid price';
  const isTP = type === 'tp';
  if (pos.side === 'long') {
    if (isTP && price <= pos.entryPrice) return 'TP must be above entry price';
    if (!isTP && price >= pos.entryPrice) return 'SL must be below entry price';
  } else {
    if (isTP && price >= pos.entryPrice) return 'TP must be below entry price';
    if (!isTP && price <= pos.entryPrice) return 'SL must be above entry price';
  }
  return null;
}

function calcTPSLPnL(pos, price, sizePercent) {
  const dir = pos.side === 'long' ? 1 : -1;
  const priceDiff = (price - pos.entryPrice) * dir;
  const pct = priceDiff / pos.entryPrice;
  const size = (sizePercent || 100) / 100;
  const pnl = pos.margin * pos.leverage * pct * size;
  const roe = (pnl / (pos.margin * size)) * 100;
  return { pnl, roe };
}

function submitTPSL(tab) {
  const { posId, type } = state.tpslModal;
  const pos = state.positions.find(p => p.id === posId);
  if (!pos) return;

  const priceInput = tab === 'full' ? $('tpslPriceInput') : $('tpslPriceInputPartial');
  const errorEl = tab === 'full' ? $('tpslErrorText') : $('tpslErrorTextPartial');
  const price = Number(priceInput.value);
  const sizePercent = tab === 'full' ? 100 : Number($('tpslSizeSlider').value);

  const err = validateTPSLPrice(price, pos, type);
  if (err) { errorEl.textContent = err; priceInput.classList.add('error'); return; }

  // Check limit
  const orders = type === 'tp' ? (pos.tpOrders || []) : (pos.slOrders || []);
  if (orders.length >= MAX_TPSL_PER_TYPE) { showToast('Maximum orders reached', 'error'); return; }

  // Check total size
  const usedSize = orders.reduce((s, o) => s + (o.sizePercent || 100), 0);
  if (usedSize + sizePercent > 100 && tab === 'partial') { errorEl.textContent = 'Total size exceeds 100%'; return; }

  const order = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,5),
    price, sizePercent, createdAt: Date.now()
  };

  if (type === 'tp') {
    if (!pos.tpOrders) pos.tpOrders = [];
    pos.tpOrders.push(order);
  } else {
    if (!pos.slOrders) pos.slOrders = [];
    pos.slOrders.push(order);
  }

  closeTPSLModal();
  renderPositions();
  saveState();
  showToast(`${type.toUpperCase()} order set at ${formatPrice(price)}`, 'success');
}

// ─── TPSL Modal input listeners ───
function setupTPSLInputs() {
  // Full tab price input
  $('tpslPriceInput').addEventListener('input', () => {
    const { posId, type } = state.tpslModal;
    const pos = state.positions.find(p => p.id === posId);
    if (!pos) return;
    const price = Number($('tpslPriceInput').value);
    $('tpslPriceInput').classList.remove('error');
    $('tpslErrorText').textContent = '';
    const err = validateTPSLPrice(price, pos, type);
    $('tpslSubmitFull').disabled = !!err;
    if (!err) {
      const { pnl, roe } = calcTPSLPnL(pos, price, 100);
      $('tpslExpectedPnl').textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' VP';
      $('tpslExpectedPnl').className = 'tpsl-pnl-value ' + (pnl >= 0 ? 'positive' : 'negative');
      $('tpslExpectedRoe').textContent = (roe >= 0 ? '+' : '') + roe.toFixed(2) + '%';
      $('tpslExpectedRoe').className = 'tpsl-pnl-value ' + (roe >= 0 ? 'positive' : 'negative');
      $('tpslCloseSize').textContent = '100%';
    } else {
      $('tpslExpectedPnl').textContent = '-- VP';
      $('tpslExpectedPnl').className = 'tpsl-pnl-value';
      $('tpslExpectedRoe').textContent = '--%';
      $('tpslExpectedRoe').className = 'tpsl-pnl-value';
    }
  });

  // Partial tab price input
  $('tpslPriceInputPartial').addEventListener('input', updatePartialPreview);
  $('tpslSizeSlider').addEventListener('input', () => {
    $('tpslSizeValue').textContent = $('tpslSizeSlider').value + '%';
    updatePartialPreview();
  });

  // Market buttons
  $('tpslMarketBtn').addEventListener('click', () => { $('tpslPriceInput').value = state.currentPrice; $('tpslPriceInput').dispatchEvent(new Event('input')); });
  $('tpslMarketBtnPartial').addEventListener('click', () => { $('tpslPriceInputPartial').value = state.currentPrice; $('tpslPriceInputPartial').dispatchEvent(new Event('input')); });

  // Tabs
  $('tpslTabFull').addEventListener('click', () => switchTPSLTab('full'));
  $('tpslTabPartial').addEventListener('click', () => switchTPSLTab('partial'));

  // Submit
  $('tpslSubmitFull').addEventListener('click', () => submitTPSL('full'));
  $('tpslSubmitPartial').addEventListener('click', () => submitTPSL('partial'));

  // Close
  $('tpslModalClose').addEventListener('click', closeTPSLModal);
  $('tpslModalOverlay').addEventListener('click', (e) => { if (e.target === $('tpslModalOverlay')) closeTPSLModal(); });

  // Size marks
  document.querySelectorAll('.tpsl-size-mark').forEach(el => {
    el.addEventListener('click', () => {
      $('tpslSizeSlider').value = el.dataset.size;
      $('tpslSizeValue').textContent = el.dataset.size + '%';
      document.querySelectorAll('.tpsl-size-mark').forEach(m => m.classList.remove('active'));
      el.classList.add('active');
      updatePartialPreview();
    });
  });
}

function updatePartialPreview() {
  const { posId, type } = state.tpslModal;
  const pos = state.positions.find(p => p.id === posId);
  if (!pos) return;
  const price = Number($('tpslPriceInputPartial').value);
  const size = Number($('tpslSizeSlider').value);
  $('tpslPriceInputPartial').classList.remove('error');
  $('tpslErrorTextPartial').textContent = '';
  const err = validateTPSLPrice(price, pos, type);
  const orders = type === 'tp' ? (pos.tpOrders || []) : (pos.slOrders || []);
  const limitReached = orders.length >= MAX_TPSL_PER_TYPE;
  $('tpslSubmitPartial').disabled = !!err || limitReached;
  if (!err) {
    const { pnl, roe } = calcTPSLPnL(pos, price, size);
    $('tpslExpectedPnlPartial').textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' VP';
    $('tpslExpectedPnlPartial').className = 'tpsl-pnl-value ' + (pnl >= 0 ? 'positive' : 'negative');
    $('tpslExpectedRoePartial').textContent = (roe >= 0 ? '+' : '') + roe.toFixed(2) + '%';
    $('tpslExpectedRoePartial').className = 'tpsl-pnl-value ' + (roe >= 0 ? 'positive' : 'negative');
    $('tpslCloseSizePartial').textContent = (pos.margin * size / 100).toFixed(2) + ' VP';
  }
}

// ─── HISTORY ───
function renderHistory() {
  let filtered = [...state.history].reverse();
  const now = Date.now();
  if (state.histFilter === 'day') filtered = filtered.filter(h => now - h.closeTime < 86400000);
  else if (state.histFilter === 'week') filtered = filtered.filter(h => now - h.closeTime < 604800000);

  if (!filtered.length) {
    historyListEl.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history</div>';
    return;
  }

  historyListEl.innerHTML = filtered.map(h => `
    <div class="history-card">
      <div class="hc-header">
        <span class="hc-pair">${h.pair}</span>
        <span class="hc-type ${h.side}">${h.side.toUpperCase()} ${h.leverage}x</span>
      </div>
      <div class="hc-row"><span>Entry</span><span class="hc-val">${formatPrice(h.entryPrice)}</span></div>
      <div class="hc-row"><span>Exit</span><span class="hc-val">${formatPrice(h.closePrice)}</span></div>
      <div class="hc-row"><span>Margin</span><span class="hc-val">${h.margin?.toFixed(2)} VP</span></div>
      ${h.closedBy ? `<div class="hc-row"><span>Closed by</span><span class="hc-val" style="color:var(--gold);">${h.closedBy}</span></div>` : ''}
      ${h.liquidated ? `<div class="hc-row"><span>Status</span><span class="hc-val text-red">LIQUIDATED</span></div>` : ''}
      <div class="hc-row"><span>PnL</span><span class="hc-pnl ${h.pnl>=0?'text-green':'text-red'}">${h.pnl>=0?'+':''}${h.pnl?.toFixed(2)} VP</span></div>
      <div class="hc-row"><span>Time</span><span style="font-size:10px; color:var(--muted);">${new Date(h.closeTime).toLocaleString()}</span></div>
    </div>
  `).join('');
}

// ─── PROFILE STATS ───
function updateProfileStats() {
  const bal = state.balance + state.positions.reduce((s, p) => s + p.margin + calcPnL(p), 0);
  $('profileBalance').textContent = formatBalance(bal);
  $('profileBalanceApprox').textContent = state.balanceHidden ? '≈ $•••••' : `≈ $${(bal * VP_RATE).toFixed(2)}`;
  headerBalance.textContent = formatBalance(bal) + (state.balanceHidden ? '' : ' VP');

  const totalTrades = state.history.length;
  const wins = state.history.filter(h => h.pnl > 0).length;
  const winRate = totalTrades ? ((wins / totalTrades) * 100).toFixed(0) : 0;
  $('winRateVal').textContent = winRate + '%';
  $('totalTradesVal').textContent = totalTrades + ' Trades';
  $('winRateChart').style.background = `conic-gradient(var(--accent-green) 0% ${winRate}%, var(--panel-light) ${winRate}% 100%)`;

  const netPnl = state.history.reduce((s, h) => s + (h.pnl || 0), 0);
  $('statPnL').textContent = (netPnl >= 0 ? '+' : '') + netPnl.toFixed(2) + ' VP';
  $('statPnL').style.color = netPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

  // PnL pill
  const initialBalance = 10000;
  const pnlPct = ((bal - initialBalance) / initialBalance * 100).toFixed(2);
  $('profilePnlPill').textContent = (pnlPct >= 0 ? '+' : '') + pnlPct + '%';
  $('profilePnlPill').className = 'asset-pnl ' + (pnlPct >= 0 ? 'text-green' : 'text-red');

  // User info
  if (tgUser) {
    $('profileName').textContent = tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '');
    $('profileId').textContent = 'ID: ' + tgUser.id;
    if (tgUser.photo_url) {
      $('profileAvatarBig').src = tgUser.photo_url;
      $('avatarImg').src = tgUser.photo_url;
      $('avatarImg').style.display = 'block';
    }
  }
}

// ─── PNL MODAL ───
function openPnLModal() {
  state.pnlModal = true;
  $('pnlModalOverlay').classList.add('active');
  updatePnLModalStats();
  renderEquityChart();
  renderCalendar();
}

function closePnLModal() {
  state.pnlModal = false;
  $('pnlModalOverlay').classList.remove('active');
}

function updatePnLModalStats() {
  const hist = state.history;
  if (!hist.length) return;

  const wins = hist.filter(h => h.pnl > 0);
  const losses = hist.filter(h => h.pnl <= 0);
  const grossProfit = wins.reduce((s, h) => s + h.pnl, 0);
  const grossLoss = Math.abs(losses.reduce((s, h) => s + h.pnl, 0));
  const avgWin = wins.length ? grossProfit / wins.length : 0;
  const avgLoss = losses.length ? grossLoss / losses.length : 0;

  $('modalAvgRR').textContent = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) + ':1' : '--';
  $('modalProfitFactor').textContent = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : grossProfit > 0 ? '∞' : '--';
  $('modalAvgTrade').textContent = (hist.reduce((s, h) => s + h.pnl, 0) / hist.length).toFixed(2) + ' VP';

  // Max drawdown
  let peak = 10000, maxDD = 0, equity = 10000;
  hist.forEach(h => {
    equity += h.pnl || 0;
    if (equity > peak) peak = equity;
    const dd = (peak - equity) / peak * 100;
    if (dd > maxDD) maxDD = dd;
  });
  $('modalMaxDD').textContent = '-' + maxDD.toFixed(2) + '%';
}

let equityChartInstance = null;
function renderEquityChart() {
  const container = $('equityChartContainer');
  container.innerHTML = '';
  if (!state.history.length) { container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:12px;">No data yet</div>'; return; }

  equityChartInstance = LightweightCharts.createChart(container, {
    layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#848E9C', fontSize: 10 },
    grid: { vertLines: { visible: false }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
    timeScale: { borderVisible: false, fixLeftEdge: true, fixRightEdge: true },
    rightPriceScale: { borderVisible: false },
    crosshair: { mode: 0 },
    handleScroll: { vertTouchDrag: false },
  });

  const areaSeries = equityChartInstance.addAreaSeries({
    topColor: 'rgba(14, 203, 129, 0.3)', bottomColor: 'rgba(14, 203, 129, 0.02)',
    lineColor: '#0ECB81', lineWidth: 2,
  });

  let equity = 10000;
  const now = Date.now();
  const periodMs = { '7d': 7*86400000, '30d': 30*86400000, '90d': 90*86400000, 'all': Infinity }[state.equityPeriod];
  const filteredHist = state.history.filter(h => now - h.closeTime < periodMs).sort((a,b) => a.closeTime - b.closeTime);

  const points = [{ time: Math.floor((filteredHist[0]?.closeTime || now) / 1000) - 86400, value: 10000 }];
  filteredHist.forEach(h => {
    equity += h.pnl || 0;
    points.push({ time: Math.floor(h.closeTime / 1000), value: equity });
  });

  // Deduplicate
  const seen = new Set();
  const uniquePoints = points.filter(p => { if (seen.has(p.time)) return false; seen.add(p.time); return true; });

  areaSeries.setData(uniquePoints);
  equityChartInstance.timeScale().fitContent();
}

// ─── CALENDAR ───
function renderCalendar() {
  const year = state.calendarYear;
  const month = state.calendarMonth;
  $('calendarMonthLabel').textContent = new Date(year, month, 1).toLocaleDateString('en', { month: 'long', year: 'numeric' });

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const offset = firstDay === 0 ? 6 : firstDay - 1; // Monday start
  const today = new Date();

  // Compute daily PnL
  const dailyPnl = {};
  state.history.forEach(h => {
    const d = new Date(h.closeTime);
    if (d.getFullYear() === year && d.getMonth() === month) {
      const key = d.getDate();
      dailyPnl[key] = (dailyPnl[key] || 0) + (h.pnl || 0);
    }
  });

  const maxAbsPnl = Math.max(...Object.values(dailyPnl).map(Math.abs), 1);
  let html = '';
  for (let i = 0; i < offset; i++) html += '<div class="calendar-cell empty"></div>';
  for (let d = 1; d <= daysInMonth; d++) {
    const pnl = dailyPnl[d];
    let cls = '';
    if (pnl !== undefined) {
      cls = pnl >= 0 ? 'profit' : 'loss';
      if (Math.abs(pnl) > maxAbsPnl * 0.5) cls += ' high';
    }
    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
    if (isToday) cls += ' today';
    html += `<div class="calendar-cell ${cls}" title="${pnl !== undefined ? (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' VP' : 'No trades'}">${pnl !== undefined ? (pnl >= 0 ? '+' : '') + pnl.toFixed(0) : d}</div>`;
  }
  $('calendarGrid').innerHTML = html;
}

// ─── REFERRALS ───
async function loadReferrals() {
  if (!tgUser) return;
  state.refCode = tgUser.id?.toString() || 'demo';
  const botUsername = 'YourBotUsername'; // Replace with actual bot username
  $('refLinkInput').value = `https://t.me/${botUsername}?start=ref_${state.refCode}`;

  try {
    const r = await fetch(`${API_BASE}/api/referrals?userId=${tgUser.id}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
    if (r.ok) {
      const data = await r.json();
      state.referrals = data.referrals || [];
      $('refCountBadge').textContent = 'Invited: ' + state.referrals.length;
      renderReferralList();
    }
  } catch(e) {
    $('refStatus').textContent = 'Could not load referrals';
  }
}

function renderReferralList() {
  const list = $('refList');
  if (!state.referrals.length) { list.innerHTML = '<div class="ref-status">No referrals yet. Share your link!</div>'; return; }
  list.innerHTML = state.referrals.map(r => `
    <div class="ref-item">
      <div class="ref-item-left">
        <div class="ref-avatar">${r.photo ? `<img src="${r.photo}">` : ''}</div>
        <span class="ref-name">${r.name || 'User'}</span>
      </div>
      <span class="ref-date">${new Date(r.joinDate).toLocaleDateString()}</span>
    </div>
  `).join('');
}

// ─── ADS / REWARDS ───
function initRewards() {
  const today = new Date().toDateString();
  if (state.lastAdDate !== today) { state.adsToday = 0; state.lastAdDate = today; }
  updateRewardsUI();
}

function updateRewardsUI() {
  $('totalAdsWatched').textContent = state.adsWatched;
  $('totalEarnedFromAds').textContent = state.adsEarned;
  $('dailyAdCounter').textContent = `${state.adsToday}/${DAILY_AD_LIMIT} today`;
  $('dailyAdCounter').classList.toggle('limit-reached', state.adsToday >= DAILY_AD_LIMIT);
  $('btnWatchAd').disabled = state.adsToday >= DAILY_AD_LIMIT;

  // Progress
  const level = Math.floor(state.adsWatched / 10) + 1;
  const progress = (state.adsWatched % 10) / 10 * 100;
  $('currentLevelText').textContent = 'Level ' + level;
  $('adsProgressText').textContent = `${state.adsWatched % 10} / 10 Ads`;
  $('adsProgressBar').style.width = progress + '%';

  // Milestones
  const adsInLevel = state.adsWatched % 10;
  $('ms-start').classList.add('active');
  $('ms-5').classList.toggle('active', adsInLevel >= 5);
  $('ms-10').classList.toggle('active', adsInLevel >= 10 || state.adsWatched >= 10);
}

async function watchAd() {
  if (state.adsToday >= DAILY_AD_LIMIT) { showToast('Daily limit reached', 'error'); return; }

  const btn = $('btnWatchAd');
  btn.classList.add('loading');
  btn.textContent = 'Loading...';

  try {
    if (AD_BLOCK_ID && window.Adsgram) {
      const adController = window.Adsgram.init({ blockId: AD_BLOCK_ID });
      await adController.show();
    } else {
      await new Promise(r => setTimeout(r, 1500)); // Simulate
    }

    state.adsWatched++;
    state.adsToday++;
    state.adsEarned++;
    state.balance += 1;
    updateRewardsUI();
    updateProfileStats();
    saveState();
    showToast('+1 VP earned!', 'success');
  } catch(e) {
    showToast('Ad not available', 'error');
  }

  btn.classList.remove('loading');
  btn.textContent = 'WATCH';
}

// ─── TOAST ───
function showToast(msg, type = 'info') {
  const existing = document.querySelector('.toast-notification');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.textContent = msg;
  const colors = { success: 'var(--accent-green)', error: 'var(--accent-red)', info: 'var(--gold)' };
  toast.style.background = colors[type] || colors.info;
  toast.style.color = type === 'error' ? '#fff' : '#000';
  toast.style.animation = 'toastIn 0.3s ease forwards';
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.animation = 'toastOut 0.3s ease forwards'; setTimeout(() => toast.remove(), 300); }, 2500);
}

// ─── NAVIGATION ───
function showView(id) {
  document.querySelectorAll('.view-section').forEach(v => { v.classList.remove('active'); v.classList.add('hidden'); });
  $(id).classList.remove('hidden');
  $(id).classList.add('active');
  if (id === 'view-profile') { updateProfileStats(); renderHistory(); }
  if (id === 'view-rewards') initRewards();
}

// ─── SAVE/LOAD ───
function saveState() {
  try {
    const save = { balance: state.balance, positions: state.positions, history: state.history, adsWatched: state.adsWatched, adsToday: state.adsToday, adsEarned: state.adsEarned, lastAdDate: state.lastAdDate, balanceHidden: state.balanceHidden };
    localStorage.setItem('tradesim_state', JSON.stringify(save));
  } catch(e) {}
}

function loadState() {
  try {
    const s = JSON.parse(localStorage.getItem('tradesim_state'));
    if (s) {
      state.balance = s.balance ?? 10000;
      state.positions = s.positions || [];
      state.history = s.history || [];
      state.adsWatched = s.adsWatched || 0;
      state.adsToday = s.adsToday || 0;
      state.adsEarned = s.adsEarned || 0;
      state.lastAdDate = s.lastAdDate || '';
      state.balanceHidden = s.balanceHidden || false;
    }
  } catch(e) {}
}

// ─── UI UPDATE ───
function updateUI() {
  renderPositions();
  updateProfileStats();
  renderHistory();
  // Update margin slider percentage
  const pct = Number(marginSlider.value);
  const val = (state.balance * pct / 100).toFixed(0);
  sizeInput.value = pct > 0 ? val : sizeInput.value;
  updateSliderGradient(marginSlider, pct);
}

function updateSliderGradient(slider, pct) {
  slider.style.background = `linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) ${pct}%, #2A2F36 ${pct}%, #2A2F36 100%)`;
}

// ─── EVENT LISTENERS ───
function initEvents() {
  // Leverage slider
  leverageSlider.addEventListener('input', () => {
    const v = leverageSlider.value;
    leverageValText.textContent = v + 'x';
    updateSliderGradient(leverageSlider, (v / 50) * 100);
    document.querySelectorAll('#leverageChips .chip').forEach(c => c.classList.toggle('active', c.dataset.v === v));
  });
  document.querySelectorAll('#leverageChips .chip').forEach(c => {
    c.addEventListener('click', () => { leverageSlider.value = c.dataset.v; leverageSlider.dispatchEvent(new Event('input')); });
  });

  // Margin slider
  marginSlider.addEventListener('input', () => {
    const pct = Number(marginSlider.value);
    marginPercentText.textContent = pct + '%';
    sizeInput.value = Math.floor(state.balance * pct / 100);
    updateSliderGradient(marginSlider, pct);
    document.querySelectorAll('.margin-mark').forEach(m => m.classList.toggle('active', Number(m.dataset.pct) === pct));
  });
  document.querySelectorAll('.margin-mark').forEach(m => {
    m.addEventListener('click', () => { marginSlider.value = m.dataset.pct; marginSlider.dispatchEvent(new Event('input')); });
  });

  // Size input -> margin slider sync
  sizeInput.addEventListener('input', () => {
    const pct = state.balance > 0 ? Math.round(Number(sizeInput.value) / state.balance * 100) : 0;
    marginSlider.value = Math.min(100, Math.max(0, pct));
    marginPercentText.textContent = marginSlider.value + '%';
    updateSliderGradient(marginSlider, marginSlider.value);
  });

  // Trade buttons
  $('openLong').addEventListener('click', () => openPosition('long'));
  $('openShort').addEventListener('click', () => openPosition('short'));

  // Pair selector
  $('pairTrigger').addEventListener('click', () => $('pairDropdown').classList.toggle('open'));
  document.querySelectorAll('.pair-item').forEach(item => {
    item.addEventListener('click', () => {
      state.pair = item.dataset.pair;
      $('triggerText').textContent = item.textContent;
      document.querySelectorAll('.pair-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      $('pairDropdown').classList.remove('open');
      if (ws) ws.close();
      fetchCandles();
      connectWS();
    });
  });
  document.addEventListener('click', (e) => { if (!$('pairDropdown').contains(e.target)) $('pairDropdown').classList.remove('open'); });

  // Timeframes
  document.querySelectorAll('.tf-opt').forEach(opt => {
    opt.addEventListener('click', () => {
      state.tf = Number(opt.dataset.tf);
      document.querySelectorAll('.tf-opt').forEach(o => o.classList.remove('active'));
      opt.classList.add('active');
      fetchCandles();
    });
  });

  // Indicators
  document.querySelectorAll('.indicator-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const ind = chip.dataset.indicator;
      state.indicators[ind] = !state.indicators[ind];
      chip.classList.toggle('active');
      updateIndicators();
    });
  });

  // Drawing tools
  $('drawingToolsToggle').addEventListener('click', () => { $('drawingToolsMenu').classList.toggle('open'); });
  document.querySelectorAll('.drawing-tool-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tool = btn.dataset.tool;
      if (tool === 'clear') {
        state.drawingLines.forEach(l => { try { candleSeries.removePriceLine?.(l); } catch(e) {} });
        state.drawingLines = [];
        document.querySelectorAll('.drawing-tool-btn').forEach(b => b.classList.remove('active'));
        state.drawingTool = null;
        return;
      }
      if (tool === 'cursor') { state.drawingTool = null; document.querySelectorAll('.drawing-tool-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); return; }
      state.drawingTool = tool;
      document.querySelectorAll('.drawing-tool-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // Chart click for drawing horizontal lines
  $('chart').addEventListener('click', (e) => {
    if (state.drawingTool !== 'horizline' || !chartReady) return;
    const rect = $('chart').getBoundingClientRect();
    const y = e.clientY - rect.top;
    const price = candleSeries.coordinateToPrice(y);
    if (!price || isNaN(price)) return;
    const line = candleSeries.createPriceLine({
      price: price, color: '#1E90FF', lineWidth: 1, lineStyle: 2,
      axisLabelVisible: true, title: formatPrice(price),
    });
    state.drawingLines.push(line);
  });

  // Navigation
  $('btnProfile').addEventListener('click', () => showView('view-profile'));
  $('btnCloseProfile').addEventListener('click', () => showView('view-trade'));
  $('btnGoRewards').addEventListener('click', () => showView('view-rewards'));
  $('btnBackFromRewards').addEventListener('click', () => showView('view-profile'));

  // Balance toggle
  $('btnToggleBalance').addEventListener('click', () => {
    state.balanceHidden = !state.balanceHidden;
    $('btnToggleBalance').src = state.balanceHidden ? 'https://img.icons8.com/ios-glyphs/60/ffffff/invisible.png' : 'https://img.icons8.com/ios-glyphs/60/ffffff/visible.png';
    updateProfileStats();
    saveState();
  });

  // Copy ref link
  $('btnCopyRefLink').addEventListener('click', () => {
    navigator.clipboard?.writeText($('refLinkInput').value).then(() => showToast('Link copied!', 'success')).catch(() => { $('refLinkInput').select(); document.execCommand('copy'); showToast('Link copied!', 'success'); });
  });

  // History filters
  document.querySelectorAll('.h-filter').forEach(f => {
    f.addEventListener('click', () => {
      state.histFilter = f.dataset.filter;
      document.querySelectorAll('.h-filter').forEach(x => x.classList.remove('active'));
      f.classList.add('active');
      renderHistory();
    });
  });

  // PnL modal
  $('netPnlCard').addEventListener('click', openPnLModal);
  $('pnlModalClose').addEventListener('click', closePnLModal);
  $('pnlModalOverlay').addEventListener('click', (e) => { if (e.target === $('pnlModalOverlay')) closePnLModal(); });

  // Equity period
  document.querySelectorAll('#equityPeriodSelector .period-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      state.equityPeriod = btn.dataset.period;
      document.querySelectorAll('#equityPeriodSelector .period-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderEquityChart();
    });
  });

  // Calendar nav
  $('calendarPrev').addEventListener('click', () => {
    state.calendarMonth--;
    if (state.calendarMonth < 0) { state.calendarMonth = 11; state.calendarYear--; }
    renderCalendar();
  });
  $('calendarNext').addEventListener('click', () => {
    state.calendarMonth++;
    if (state.calendarMonth > 11) { state.calendarMonth = 0; state.calendarYear++; }
    renderCalendar();
  });

  // Ads
  $('btnWatchAd').addEventListener('click', watchAd);

  // TPSL modal
  setupTPSLInputs();

  // Resize chart
  const ro = new ResizeObserver(() => {
    if (chart) chart.applyOptions({ width: $('chart').clientWidth, height: $('chart').clientHeight });
    if (volumeChart) volumeChart.applyOptions({ width: $('volumeChart').clientWidth, height: $('volumeChart').clientHeight });
  });
  ro.observe($('chart'));

  // Responsive timeframe selector wrap
  function checkTfWrap() {
    const sel = $('timeframeSelector');
    const header = $('marketHeader');
    if (!sel || !header) return;
    sel.classList.toggle('tf-wrapped', header.clientWidth < 420);
  }
  window.addEventListener('resize', checkTfWrap);
  checkTfWrap();

  // OHLC tooltip wrap
  function checkOhlcWrap() {
    const tooltip = $('ohlcTooltip');
    const chart = $('chartCard');
    if (!tooltip || !chart) return;
    tooltip.classList.toggle('ohlc-wrapped', chart.clientWidth < 350);
  }
  window.addEventListener('resize', checkOhlcWrap);
  checkOhlcWrap();
}

// ─── LOADER ───
function animateLoader() {
  const bar = $('loaderBar');
  const text = $('loaderText');
  const steps = [
    [20, 'CONNECTING'],
    [50, 'LOADING MARKETS'],
    [80, 'PREPARING CHART'],
    [100, 'READY']
  ];
  let i = 0;
  const interval = setInterval(() => {
    if (i >= steps.length) { clearInterval(interval); return; }
    bar.style.width = steps[i][0] + '%';
    text.textContent = steps[i][1];
    i++;
  }, 400);
  return new Promise(r => setTimeout(r, 1800));
}

// ─── INIT ───
async function init() {
  await animateLoader();
  $('app-loader').classList.add('hidden');
  setTimeout(() => $('app-loader').style.display = 'none', 500);

  loadState();
  initChart();
  initEvents();
  initRewards();
  loadReferrals();
  updateUI();

  // Initial slider gradient
  updateSliderGradient(leverageSlider, (leverageSlider.value / 50) * 100);
  updateSliderGradient(marginSlider, 0);

  fetchCandles();
  connectWS();

  // Update positions PnL every second
  setInterval(() => { if (state.positions.length) updatePositionsPnL(); }, 1000);

  // Auto-save every 30 seconds
  setInterval(saveState, 30000);
}

init();
</script>
</body>
</html>
