<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>TradeSim — Futures</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

<style>
/* ————— CORE STYLES ————— */
:root {
  --bg: #0B0E11;
  --panel: #1E2329;
  --muted: #848E9C;
  --accent-green: #0ECB81;
  --accent-red: #F6465D;
  --input-bg: #2B3139;
  --border: rgba(255, 255, 255, 0.05);
  --white: #EAECEF;
  --primary-btn: #FCD535; /* Binance-like yellow for primary actions looks good, keeping requested green/red for trade */
  --thumb-color: #EAECEF;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html, body {
  height: 100%;
  margin: 0;
  background: var(--bg);
  color: var(--white);
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  overflow: hidden; /* App feels native */
}

/* Скроллбары */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

/* ————— LAYOUT ————— */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.logo { font-weight: 700; font-size: 16px; letter-spacing: -0.5px; }

.profile-sm {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  background: rgba(255,255,255,0.05);
  padding: 4px 8px 4px 4px;
  border-radius: 20px;
}
.avatar-sm { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background: #333; }

/* Основной контейнер с адаптивной сеткой */
.container {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 300px; /* Десктоп: график + сайдбар */
  gap: 8px;
  padding: 8px;
  overflow-y: auto;
}

.main-col { display: flex; flex-direction: column; gap: 8px; min-width: 0; }
.side-col { display: flex; flex-direction: column; gap: 8px; min-width: 0; }

/* Карточки */
.card {
  background: var(--panel);
  border-radius: 8px;
  padding: 12px;
  border: 1px solid var(--border);
}

/* График */
.chart-container {
  position: relative;
  height: 450px; /* Фиксированная высота для удобства */
  border-radius: 8px;
  overflow: hidden;
  background: var(--bg);
}

/* Статистика цены над графиком */
.ticker-stats {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.price-big { font-family: 'Roboto Mono', monospace; font-size: 24px; font-weight: 700; }
.pair-title { font-size: 16px; font-weight: 700; color: var(--white); }

/* ————— CONTROLS & LEVERAGE ————— */
.control-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.input-group {
  display: flex;
  gap: 10px;
}
.input-field {
  flex: 1;
  background: var(--input-bg);
  border: 1px solid var(--border);
  padding: 12px;
  border-radius: 8px;
  color: var(--white);
  font-size: 16px;
  outline: none;
}
.input-field:focus { border-color: var(--accent-green); }

/* Slider & Leverage UI */
.leverage-wrap {
  background: rgba(0,0,0,0.2);
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
}
.leverage-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 13px;
  color: var(--muted);
}
.leverage-val { color: var(--accent-green); font-weight: 700; font-family: 'Roboto Mono'; }

/* Стили ползунка */
input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  background: transparent;
  margin: 8px 0;
}
input[type=range]::-webkit-slider-runnable-track {
  width: 100%;
  height: 4px;
  background: #444;
  border-radius: 2px;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  height: 20px;
  width: 20px;
  border-radius: 50%;
  background: var(--white);
  margin-top: -8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.5);
  cursor: pointer;
  border: 2px solid var(--accent-green);
}

.lev-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
  gap: 4px;
}
.lev-btn {
  flex: 1;
  background: var(--input-bg);
  border: 1px solid var(--border);
  color: var(--muted);
  font-size: 11px;
  padding: 6px 0;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}
.lev-btn.active {
  background: rgba(14, 203, 129, 0.15);
  color: var(--accent-green);
  border-color: var(--accent-green);
  font-weight: 700;
}

/* Trade Buttons */
.trade-actions { display: flex; gap: 8px; margin-top: 4px; }
.btn-trade {
  flex: 1;
  padding: 14px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  color: white;
}
.btn-long { background: var(--accent-green); }
.btn-short { background: var(--accent-red); }
.btn-long:active, .btn-short:active { opacity: 0.8; transform: scale(0.98); }

/* ————— LISTS (Positions, Orderbook) ————— */
.section-header {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
}

.list-scroll {
  max-height: 250px;
  overflow-y: auto;
}

.ob-row, .trade-row {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  padding: 4px 0;
  font-family: 'Roboto Mono', monospace;
}
.ob-row.sell .price { color: var(--accent-red); }
.ob-row.buy .price { color: var(--accent-green); }
.text-muted { color: var(--muted); }

/* Position Card */
.pos-card {
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 8px;
  border-left: 3px solid transparent;
}
.pos-card.long { border-left-color: var(--accent-green); }
.pos-card.short { border-left-color: var(--accent-red); }

/* ————— RESPONSIVE (MOBILE) ————— */
@media (max-width: 900px) {
  .container {
    grid-template-columns: 1fr; /* Одна колонка */
    padding-bottom: 80px; /* Место под навбар, если он плавающий */
  }
  .side-col {
    order: 2; /* Сайдбар вниз */
    display: grid;
    grid-template-columns: 1fr 1fr; /* Ордербук и история рядом */
    gap: 8px;
  }
  .chart-container {
    height: 350px; /* Меньше высота на мобильном */
  }
}

@media (max-width: 500px) {
  .side-col { grid-template-columns: 1fr; } /* На совсем узких - друг под другом */
}

/* ————— LOADER ————— */
#app-loader {
  position: fixed; inset: 0; background: var(--bg); z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.4s;
}
.loader-bar-bg { width: 160px; height: 3px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 20px;}
.loader-bar { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.2s; }
</style>
</head>

<body>

<div id="app-loader">
  <div class="logo" style="font-size: 24px;">⧉ TradeSim</div>
  <div class="loader-bar-bg"><div class="loader-bar" id="loaderBar"></div></div>
  <div style="margin-top: 10px; color: var(--muted); font-size: 12px;" id="loaderText">Initializing...</div>
</div>

<div class="app">
  <header class="header">
    <div style="display:flex; gap:12px; align-items:center;">
      <div class="logo">⧉ TradeSim</div>
    </div>
    <div class="profile-sm">
      <img id="avatarImg" src="" class="avatar-sm" style="display:none">
      <span id="balanceDisplay" style="font-family:'Roboto Mono'">0.00 VP</span>
    </div>
  </header>

  <main class="container">
    
    <section class="main-col">
      <div class="card">
        <div class="ticker-stats">
          <div>
            <span class="pair-title" id="pairLabel">BTC/USD</span>
            <span class="text-muted" style="font-size:12px; margin-left:6px;">Perp</span>
          </div>
          <div class="price-big" id="priceDisplay">...</div>
        </div>
        
        <div class="chart-container" id="chart"></div>
        
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button class="lev-btn active pair-btn" data-pair="BTC-USD" style="padding: 8px;">BTC</button>
          <button class="lev-btn pair-btn" data-pair="ETH-USD" style="padding: 8px;">ETH</button>
        </div>
      </div>

      <div class="card control-panel">
        <div class="input-group">
          <input type="number" id="sizeInput" class="input-field" placeholder="Маржа (VP)" value="100">
        </div>

        <div class="leverage-wrap">
          <div class="leverage-header">
            <span>Кредитное плечо</span>
            <span class="leverage-val" id="levDisplay">10x</span>
          </div>
          <input type="range" min="1" max="50" step="1" value="10" id="levSlider">
          
          <div class="lev-buttons">
            <div class="lev-btn" data-v="1">1x</div>
            <div class="lev-btn" data-v="5">5x</div>
            <div class="lev-btn active" data-v="10">10x</div>
            <div class="lev-btn" data-v="20">20x</div>
            <div class="lev-btn" data-v="50">50x</div>
          </div>
        </div>

        <div class="trade-actions">
          <button id="btnLong" class="btn-trade btn-long">Buy / Long</button>
          <button id="btnShort" class="btn-trade btn-short">Sell / Short</button>
        </div>
      </div>

      <div class="card">
        <div class="section-header">
          <span>Открытые позиции</span>
        </div>
        <div id="positionsList"></div>
      </div>
    </section>

    <aside class="side-col">
      <div class="card">
        <div class="section-header">Order Book</div>
        <div class="list-scroll" id="orderBook"></div>
      </div>
      <div class="card">
        <div class="section-header">History</div>
        <div class="list-scroll" id="tradeHistory"></div>
      </div>
    </aside>

  </main>
</div>

<script>
(async function(){
  // --- UI References ---
  const loaderEl = document.getElementById('app-loader');
  const loaderBar = document.getElementById('loaderBar');
  const loaderText = document.getElementById('loaderText');
  
  const slider = document.getElementById('levSlider');
  const levDisplay = document.getElementById('levDisplay');
  const levBtns = document.querySelectorAll('.lev-btn[data-v]');
  
  // --- Config ---
  const WSS_URL = "wss://tradingbot-backend-2yws.onrender.com";
  const API_URL = "https://tradingbot-p9n8.onrender.com";
  let currentUserId = null;
  let selectedPair = "BTC-USD";
  let currentPrice = 0;
  let currentLeverage = 10;
  
  // --- Telegram Init ---
  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready();
    tg.expand();
    // Цвет хедера под темную тему
    tg.setHeaderColor?.('#1E2329'); 
    tg.setBackgroundColor?.('#0B0E11');
  }

  // --- Leverage Logic (Sync Slider & Buttons) ---
  function updateLeverage(val) {
    currentLeverage = parseInt(val);
    slider.value = currentLeverage;
    levDisplay.textContent = currentLeverage + "x";
    
    // Подсветка кнопок
    levBtns.forEach(btn => {
      const btnVal = parseInt(btn.dataset.v);
      if (btnVal === currentLeverage) btn.classList.add('active');
      else btn.classList.remove('active');
    });
  }

  slider.addEventListener('input', (e) => updateLeverage(e.target.value));
  
  levBtns.forEach(btn => {
    btn.addEventListener('click', () => updateLeverage(btn.dataset.v));
  });

  // --- Chart Setup ---
  const chartEl = document.getElementById("chart");
  const chart = LightweightCharts.createChart(chartEl, {
    layout: { background: { type: 'solid', color: '#0B0E11' }, textColor: '#848E9C' },
    grid: { vertLines: { color: '#1E2329' }, horzLines: { color: '#1E2329' } },
    timeScale: { borderColor: '#1E2329' },
    rightPriceScale: { borderColor: '#1E2329' },
    crosshair: { vertLine: { color: '#333' }, horzLine: { color: '#333' } }
  });
  
  let candleSeries = chart.addCandlestickSeries({
    upColor: '#0ECB81', borderUpColor: '#0ECB81', wickUpColor: '#0ECB81',
    downColor: '#F6465D', borderDownColor: '#F6465D', wickDownColor: '#F6465D',
  });

  // Авто-ресайз графика
  new ResizeObserver(entries => {
    if(entries.length === 0 || !entries[0].contentRect) return;
    const { width, height } = entries[0].contentRect;
    chart.applyOptions({ width, height });
  }).observe(chartEl);

  // --- State & History ---
  let lastCandle = null;
  const pairHistory = { "BTC-USD": [], "ETH-USD": [] };

  // --- WebSocket ---
  let socket = null;
  
  function connectWS() {
    socket = new WebSocket(WSS_URL);
    socket.onopen = () => {
      socket.send(JSON.stringify({ type:"subscribe", pair: selectedPair }));
    };
    socket.onmessage = (evt) => {
      try { handleWS(JSON.parse(evt.data)); } catch(e){}
    };
    socket.onclose = () => setTimeout(connectWS, 2000);
  }

  function handleWS(msg) {
    if(msg.type === "history" && msg.pair === selectedPair) {
      const data = msg.data.map(c => ({ 
        time: c.time, open: c.open, high: c.high, low: c.low, close: c.close 
      }));
      pairHistory[msg.pair] = data;
      candleSeries.setData(data);
      
      if(data.length) {
        lastCandle = data[data.length - 1];
        currentPrice = lastCandle.close;
        updatePriceDisplay();
        chart.timeScale().fitContent();
      }
      return;
    }
    
    if(msg.type === "price" && msg.pair === selectedPair) {
      currentPrice = Number(msg.price);
      updatePriceDisplay();
      
      if(lastCandle) {
        const now = Math.floor(Date.now()/1000);
        const candleTime = now - (now % 60);
        
        if(candleTime === lastCandle.time) {
          lastCandle.high = Math.max(lastCandle.high, currentPrice);
          lastCandle.low = Math.min(lastCandle.low, currentPrice);
          lastCandle.close = currentPrice;
          candleSeries.update(lastCandle);
        } else {
          lastCandle = { time: candleTime, open: lastCandle.close, high: currentPrice, low: currentPrice, close: currentPrice };
          candleSeries.update(lastCandle);
        }
      }
    }
    
    if(msg.type === "orderBook" && msg.pair === selectedPair) renderOrderBook(msg.buy, msg.sell);
    if(msg.type === "trades" && msg.pair === selectedPair) renderTrades(msg.trades);
  }

  // --- Rendering ---
  function updatePriceDisplay() {
    document.getElementById("priceDisplay").textContent = currentPrice.toFixed(2);
    document.title = `${currentPrice.toFixed(0)} | TradeSim`;
    renderPositions(); // Обновляем PnL
  }

  function renderOrderBook(buys, sells) {
    const el = document.getElementById("orderBook");
    let html = "";
    sells.slice(0, 15).reverse().forEach(s => {
      html += `<div class="ob-row sell"><span class="price">${s.price.toFixed(2)}</span><span class="text-muted">${s.size.toFixed(4)}</span></div>`;
    });
    html += '<div style="height:4px; border-bottom:1px dashed #333; margin:4px 0;"></div>';
    buys.slice(0, 15).forEach(b => {
      html += `<div class="ob-row buy"><span class="price">${b.price.toFixed(2)}</span><span class="text-muted">${b.size.toFixed(4)}</span></div>`;
    });
    el.innerHTML = html;
  }

  function renderTrades(trades) {
    const el = document.getElementById("tradeHistory");
    const html = trades.slice().reverse().map(t => {
      const color = t.side === 'buy' ? 'var(--accent-green)' : 'var(--accent-red)';
      return `<div class="trade-row"><span style="color:${color}">${t.price.toFixed(2)}</span><span class="text-muted">${t.size.toFixed(4)}</span></div>`;
    }).join('');
    el.innerHTML = html;
  }

  window._positions = [];
  function renderPositions() {
    const el = document.getElementById("positionsList");
    if(!window._positions.length) {
      el.innerHTML = `<div class="text-muted" style="text-align:center; padding:20px; font-size:13px;">Нет активных позиций</div>`;
      return;
    }
    
    el.innerHTML = window._positions.map(pos => {
      const entry = Number(pos.entryPrice || pos.entry_price || 0);
      const size = Number(pos.size || 0);
      const lev = Number(pos.leverage || 1);
      const type = (pos.type || "LONG").toUpperCase();
      
      let pnl = 0;
      if(currentPrice > 0 && entry > 0) {
        const diff = (currentPrice - entry) / entry;
        pnl = type === "LONG" ? (diff * size) : (-diff * size);
      }
      
      const pnlClass = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
      const sideClass = type === "LONG" ? "long" : "short";
      
      return `
        <div class="pos-card ${sideClass}">
          <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
            <div style="font-weight:700; font-size:13px;">${type} ${selectedPair} <span style="color:var(--muted); font-weight:400;">x${lev}</span></div>
            <div style="font-weight:700; color:${pnlClass}">${pnl > 0 ? '+' : ''}${pnl.toFixed(2)} VP</div>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div class="text-muted" style="font-size:11px;">
              Вход: ${entry.toFixed(2)}<br>
              Объем: ${size.toFixed(0)}
            </div>
            <button onclick="closePosition('${pos.id || pos._id}')" 
              style="background:rgba(255,255,255,0.1); border:none; color:white; border-radius:4px; padding:4px 8px; font-size:11px; cursor:pointer;">
              Закрыть
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  // --- API Actions ---
  window.closePosition = async (id) => {
    if(!confirm("Закрыть позицию?")) return;
    try {
      const res = await fetch(API_URL + "/api/order/close", {
        method: "POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ userId: currentUserId, positionId: id, closePrice: currentPrice })
      });
      const data = await res.json();
      if(data.ok) {
        window._positions = window._positions.filter(p => p.id != id && p._id != id);
        if(data.newBalance) updateBalance(data.newBalance);
        renderPositions();
      } else { alert(data.error || "Ошибка"); }
    } catch(e) { alert("Network error"); }
  };

  async function openTrade(side) {
    const margin = parseFloat(document.getElementById("sizeInput").value);
    if(!margin || margin <= 0) return alert("Введите сумму маржи");
    
    const size = margin * currentLeverage;
    
    try {
      const res = await fetch(API_URL + "/api/order/open", {
        method: "POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          userId: currentUserId, pair: selectedPair, type: side,
          size: size, leverage: currentLeverage, entryPrice: currentPrice
        })
      });
      const data = await res.json();
      if(data.ok) {
        window._positions.push(data.position);
        if(data.newBalance !== undefined) updateBalance(data.newBalance);
        renderPositions();
        tg?.HapticFeedback?.notificationOccurred('success');
      } else { alert(data.error); }
    } catch(e) { console.error(e); alert("Network error"); }
  }

  document.getElementById("btnLong").onclick = () => openTrade("LONG");
  document.getElementById("btnShort").onclick = () => openTrade("SHORT");

  // --- Initialization ---
  function updateBalance(val) {
    document.getElementById("balanceDisplay").textContent = Number(val).toFixed(2) + " VP";
  }

  async function init() {
    loaderBar.style.width = "30%";
    
    // Auth
    try {
      const initData = tg?.initData || "";
      const res = await fetch(API_URL + "/api/init", {
        method: "POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ initData })
      });
      const data = await res.json();
      if(data.ok && data.user) {
        currentUserId = data.user.user_id;
        updateBalance(data.user.balance || 0);
        window._positions = data.positions || [];
        if(data.user.photo_url) {
          const img = document.getElementById("avatarImg");
          img.src = data.user.photo_url; img.style.display = "block";
        }
      }
    } catch(e) { console.error("Auth fail", e); }
    
    loaderBar.style.width = "70%";
    connectWS();
    
    // Wait for price (fake delay ensuring connection)
    await new Promise(r => setTimeout(r, 1500));
    
    loaderBar.style.width = "100%";
    setTimeout(() => {
      loaderEl.style.opacity = '0';
      setTimeout(()=> loaderEl.style.display = 'none', 400);
    }, 500);
  }

  // --- Pair Switching ---
  document.querySelectorAll('.pair-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const newPair = btn.dataset.pair;
      if(newPair === selectedPair) return;
      document.querySelectorAll('.pair-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedPair = newPair;
      document.getElementById('pairLabel').textContent = newPair.replace('-', '/');
      
      // Reset chart
      candleSeries.setData([]);
      lastCandle = null;
      if(socket) socket.send(JSON.stringify({type:"unsubscribe", pair: selectedPair})); // Unsub old
      if(socket) socket.send(JSON.stringify({type:"subscribe", pair: newPair})); // Sub new
    });
  });

  init();
})();
</script>
</body>
</html>
