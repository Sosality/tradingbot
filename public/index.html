<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>TradeSim</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0B0E11;
      --panel: #1E2329;
      --panel-light: #2A2F36;
      --muted: #848E9C;
      --accent-green: #0ECB81;
      --accent-green-transparent: rgba(14, 203, 129, 0.15);
      --accent-red: #F6465D;
      --accent-red-transparent: rgba(246, 70, 93, 0.15);
      --white: #EAECEF;
      --border: rgba(255, 255, 255, 0.08);
      --gold: #F0B90B;
      --gold-gradient: linear-gradient(135deg, #F0B90B 0%, #B88A00 100%);
      --accent-blue: #1E90FF;
      --accent-purple: #A855F7;
      --accent-orange: #F7931A;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--white); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; position: relative; }

    .view-section {
      flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease;
      position: absolute; width: 100%; top: 0; left: 0; background: var(--bg);
    }
    .view-section.hidden { display: none; opacity: 0; pointer-events: none; z-index: -1; }
    .view-section.active { display: flex; opacity: 1; z-index: 10; }

    .header {
      flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; background: var(--panel); border-bottom: 1px solid var(--border); height: 60px; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo-img { height: 28px; width: auto; display: block; }

    .pair-dropdown { position: relative; font-family: 'Roboto Mono', monospace; }
    .pair-trigger {
      display: flex; align-items: center; gap: 8px; background: transparent; padding: 6px 12px;
      border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 15px; color: var(--white);
      transition: background 0.2s; user-select: none;
    }
    .pair-trigger:hover { background: rgba(255,255,255,0.05); }
    .pair-trigger .arrow { font-size: 10px; color: var(--muted); transition: transform 0.2s; }
    .pair-dropdown.open .pair-trigger .arrow { transform: rotate(180deg); }
    .pair-menu {
      position: absolute; top: 100%; left: 0; margin-top: 8px;
      background: rgba(30, 35, 41, 0.95); backdrop-filter: blur(10px);
      border: 1px solid var(--border); border-radius: 8px; width: 160px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; pointer-events: none;
      transform: translateY(-10px); transition: all 0.2s ease; z-index: 200;
      display: flex; flex-direction: column; padding: 4px;
    }
    .pair-dropdown.open .pair-menu { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .pair-item {
      padding: 10px 12px; font-size: 14px; font-weight: 500; color: var(--muted);
      cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
    }
    .pair-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
    .pair-item.active { background: rgba(255,255,255,0.08); color: var(--white); font-weight: 700; }
    .pair-item.active::after { content: '✓'; color: var(--accent-green); font-size: 12px; }

    .user-area { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 8px; border-radius: 8px; transition: background 0.2s; }
    .user-area:active { background: rgba(255,255,255,0.05); }
    .balance-group { text-align: right; line-height: 1.2; }
    .balance-label { font-size: 10px; color: var(--muted); display: block; }
    .balance-val { font-size: 13px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono', monospace; }
    .avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; border: 1px solid var(--border); }
    .avatar-sm img { width: 100%; height: 100%; object-fit: cover; }

    .container {
      flex: 1; display: flex; flex-direction: column;
      overflow-y: auto; overflow-x: hidden; padding: 12px; gap: 12px;
    }
    @media (min-width: 900px) {
      .container { display: grid; grid-template-columns: 1fr 340px; height: calc(100vh - 60px); overflow: hidden; }
      .left-col { overflow-y: auto; padding-right: 4px; }
      .right-col { overflow: hidden; height: 100%; }
      .ob-container, .pos-list { max-height: 400px; overflow-y: auto; }
    }

    .left-col { display: flex; flex-direction: column; gap: 12px; }
    .right-col { display: flex; flex-direction: column; gap: 12px; }
    .card { background: var(--panel); border-radius: 12px; padding: 12px; border: 1px solid var(--border); }

    .market-header {
      display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
      gap: 12px; min-width: 0; position: relative;
    }

    .price-block { display: flex; flex-direction: column; min-width: 0; flex-shrink: 0; }
    .price-label { color: var(--muted); font-size: 11px; margin-bottom: 4px; }
    .price-display { font-family: 'Roboto Mono', monospace; font-size: 32px; font-weight: 700; line-height: 1; letter-spacing: -1px; white-space: nowrap; }

    .chart-wrapper { position: relative; display: flex; flex-direction: column; gap: 0; }

    .chart-container {
      height: 280px; width: 100%; border-radius: 8px; overflow: hidden;
      position: relative; background: #111;
    }
    .chart-container.has-volume { border-radius: 8px 8px 0 0; }
    @media (min-width: 900px) { .chart-container { height: 40vh; } }

    .volume-container {
      height: 60px; width: 100%; background: #111;
      border-radius: 0 0 8px 8px; overflow: hidden; position: relative;
      border-top: 1px solid rgba(255,255,255,0.12); display: none;
    }
    .volume-container.visible { display: block; }

    .chart-loading-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(11, 14, 17, 0.7); display: flex; align-items: center; justify-content: center;
      z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
    }
    .chart-loading-overlay.active { opacity: 1; pointer-events: auto; }
    .chart-loading-spinner {
      width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-green); border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .ohlc-tooltip {
      position: absolute; top: 8px; left: 46px; z-index: 30;
      display: flex; align-items: center; gap: 8px;
      font-family: 'Roboto Mono', monospace; font-size: 10px; color: var(--muted);
      background: rgba(11, 14, 17, 0.85); padding: 4px 8px; border-radius: 4px;
      pointer-events: none; opacity: 0; transition: opacity 0.15s ease;
      max-width: calc(100% - 54px);
    }
    .ohlc-tooltip.visible { opacity: 1; }
    .ohlc-tooltip.ohlc-wrapped { flex-wrap: wrap; }
    .ohlc-tooltip .ohlc-item { display: flex; gap: 2px; white-space: nowrap; }
    .ohlc-tooltip .ohlc-label { color: var(--muted); }
    .ohlc-tooltip .ohlc-value { color: var(--white); font-weight: 500; }
    .ohlc-tooltip .ohlc-value.up { color: var(--accent-green); }
    .ohlc-tooltip .ohlc-value.down { color: var(--accent-red); }

    .drawing-tools-menu {
      position: absolute; top: 8px; left: 8px; z-index: 40;
      display: flex; flex-direction: column; gap: 2px;
    }
    .drawing-tools-toggle {
      width: 28px; height: 28px; background: rgba(30, 35, 41, 0.9);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--muted); font-size: 14px;
    }
    .drawing-tools-toggle:hover { background: var(--panel-light); color: var(--white); }
    .drawing-tools-toggle.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); }
    .drawing-tools-panel {
      display: flex; flex-direction: column; gap: 2px;
      opacity: 0; pointer-events: none; transform: translateY(-4px); transition: all 0.2s ease;
    }
    .drawing-tools-menu.open .drawing-tools-panel { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .drawing-tool-btn {
      width: 28px; height: 28px; background: rgba(30, 35, 41, 0.9);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--muted); font-size: 12px;
    }
    .drawing-tool-btn:hover { background: var(--panel-light); color: var(--white); }
    .drawing-tool-btn.active { background: rgba(30, 144, 255, 0.2); color: var(--accent-blue); border-color: var(--accent-blue); }
    .drawing-tool-btn svg { width: 14px; height: 14px; }

    .indicators-panel { display: flex; align-items: center; gap: 6px; padding: 8px 0; flex-wrap: wrap; }
    .indicator-chip {
      display: flex; align-items: center; gap: 4px; padding: 4px 10px;
      font-size: 11px; font-weight: 600; color: var(--muted);
      background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
      border-radius: 4px; cursor: pointer; transition: all 0.2s; user-select: none;
    }
    .indicator-chip:hover { background: rgba(255, 255, 255, 0.06); color: var(--white); }
    .indicator-chip.active.ema { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(30, 144, 255, 0.15); }
    .indicator-chip.active.sma { border-color: var(--accent-purple); color: var(--accent-purple); background: rgba(168, 85, 247, 0.15); }
    .indicator-chip.active.vwap { border-color: var(--accent-orange); color: var(--accent-orange); background: rgba(247, 147, 26, 0.15); }
    .indicator-chip.active.volume { border-color: var(--accent-green); color: var(--accent-green); background: var(--accent-green-transparent); }
    .indicator-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: 0; transition: opacity 0.2s; }
    .indicator-chip.active .indicator-dot { opacity: 1; }

    .controls-area { display: flex; flex-direction: column; gap: 16px; margin-top: 12px; }
    .input-group { position: relative; }
    .input-label { position: absolute; top: 8px; left: 12px; font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .main-input {
      width: 100%; background: #111; border: 1px solid var(--border); color: var(--white);
      padding: 24px 12px 8px 12px; border-radius: 8px; font-size: 16px;
      font-family: 'Roboto Mono', monospace; outline: none; transition: border 0.2s;
    }
    .main-input:focus { border-color: var(--accent-green); }

    .slider-wrap { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
    .slider-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .slider-val { color: var(--accent-green); font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

    .range-slider {
      -webkit-appearance: none; width: 100%; height: 4px;
      background: linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) 0%, #2A2F36 0%, #2A2F36 100%);
      border-radius: 2px; outline: none; margin: 10px 0;
    }
    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid var(--accent-green); transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .range-slider::-webkit-slider-thumb:hover { transform: scale(1.1); box-shadow: 0 2px 12px rgba(14, 203, 129, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); }
    .range-slider::-webkit-slider-thumb:active { transform: scale(0.95); }
    .range-slider::-moz-range-thumb {
      width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(145deg, #3a4149 0%, #2A2F36 100%); cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid var(--accent-green);
    }

    .chips-row { display: flex; justify-content: space-between; gap: 4px; margin-top: 8px; }
    .chip { flex: 1; text-align: center; padding: 6px 0; font-size: 11px; background: #15181b; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); color: var(--muted); transition: 0.2s; }
    .chip.active { background: var(--accent-green-transparent); color: var(--accent-green); border-color: var(--accent-green); font-weight: 700; }

    .margin-slider-wrap { position: relative; padding: 0 10px; }
    .margin-slider-wrap .range-slider { width: 100%; }
    .margin-marks { display: flex; justify-content: space-between; margin-top: 4px; position: relative; }
    .margin-mark {
      font-size: 10px; color: var(--muted); cursor: pointer; padding: 2px 0; border-radius: 3px;
      transition: 0.2s; user-select: none; text-align: center; min-width: 28px;
    }
    .margin-mark:first-child { text-align: left; }
    .margin-mark:last-child { text-align: right; }
    .margin-mark:hover { color: var(--accent-green); }
    .margin-mark.active { color: var(--accent-green); font-weight: 600; }

    .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .btn-trade {
      padding: 14px; border-radius: 8px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; color: #fff;
      display: flex; flex-direction: column; align-items: center; line-height: 1.2; transition: filter 0.2s;
    }
    .btn-trade:active { filter: brightness(0.9); transform: scale(0.98); }
    .btn-trade span { font-size: 10px; font-weight: 400; opacity: 0.8; margin-top: 2px; }
    .btn-long { background: var(--accent-green); color: #052e1f; }
    .btn-short { background: var(--accent-red); color: #2d0a0f; }

    .ob-header { display: grid; grid-template-columns: 1fr 1fr; font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; padding: 0 6px; }
    .ob-container { font-size: 12px; font-family: 'Roboto Mono', monospace; display: flex; flex-direction: column; gap: 1px; overflow: hidden; }
    .ob-row { position: relative; display: grid; grid-template-columns: 1fr 1fr; align-items: center; height: 20px; padding: 0 6px; line-height: 1; white-space: nowrap; overflow: hidden; }
    .trade-time { text-align: right; opacity: 0.7; }
    .ob-bg { position: absolute; top: 0; bottom: 0; z-index: 0; opacity: 0.18; transition: width 0.2s ease; }
    .bg-red { left: 0; background: linear-gradient(to right, var(--accent-red), transparent); }
    .bg-green { right: 0; background: linear-gradient(to left, var(--accent-green), transparent); }
    .ob-row span { position: relative; z-index: 1; }
    .ob-row span:last-child { text-align: right; }
    .text-green { color: var(--accent-green); }
    .text-red { color: var(--accent-red); }

    .pos-list { display: flex; flex-direction: column; gap: 8px; }
    .pos-item { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; position: relative; overflow: hidden; }
    .pos-item.long { border-left: 4px solid var(--accent-green); }
    .pos-item.short { border-left: 4px solid var(--accent-red); }
    .pos-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; font-weight: 700; align-items: center; }
    .pos-pair { font-size: 15px; letter-spacing: 0.5px; }
    .pos-type-badge { font-size: 14px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

    .pos-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 8px 0; padding: 8px 0; border-top: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .stat-col { display: flex; flex-direction: column; gap: 4px; }
    .stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stat-val { font-size: 13px; font-weight: 700; font-family: 'Roboto Mono'; }

    .risk-wrap { margin-top: 4px; width: 100%; }
    .risk-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .risk-fill { height: 100%; width: 0%; background: var(--accent-green); transition: width 0.3s, background 0.3s; }

    .pos-details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
    .pd-col { display: flex; flex-direction: column; gap: 2px; }
    .pd-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .pd-val { font-size: 12px; color: var(--white); font-family: 'Roboto Mono'; font-weight: 700; }

    .close-btn {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--accent-red);
      padding: 8px 12px; border-radius: 8px; font-size: 12px; margin-top: 12px; width: 100%; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .close-btn:active { background: var(--accent-red); color: #fff; }

    .pos-tpsl-actions {
      display: flex; gap: 8px; margin-top: 12px; padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .btn-tpsl {
      flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 10px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    .btn-tpsl:hover { background: rgba(255,255,255,0.06); }
    .btn-tpsl:active { transform: scale(0.98); }
    .btn-tpsl.tp { color: var(--accent-green); }
    .btn-tpsl.tp:hover { border-color: var(--accent-green); background: var(--accent-green-transparent); }
    .btn-tpsl.sl { color: var(--accent-red); }
    .btn-tpsl.sl:hover { border-color: var(--accent-red); background: var(--accent-red-transparent); }
    .btn-tpsl-icon { font-size: 14px; }
    .btn-tpsl .tpsl-count { font-size: 10px; opacity: 0.7; font-weight: 400; }

    .pos-tpsl-orders {
      margin-top: 10px; padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .tpsl-orders-title {
      font-size: 11px; color: var(--muted); text-transform: uppercase;
      font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
    }
    .tpsl-orders-count {
      background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 10px;
      font-size: 10px; color: var(--white);
    }
    .tpsl-orders-list { display: flex; flex-direction: column; gap: 6px; }
    .tpsl-order-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border-radius: 8px; font-size: 12px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      font-family: 'Roboto Mono', monospace;
    }
    .tpsl-order-item.tp-order { border-left: 3px solid var(--accent-green); }
    .tpsl-order-item.sl-order { border-left: 3px solid var(--accent-red); }
    .tpsl-order-info { display: flex; flex-direction: column; gap: 2px; }
    .tpsl-order-type { font-weight: 700; font-size: 11px; text-transform: uppercase; }
    .tpsl-order-type.tp-type { color: var(--accent-green); }
    .tpsl-order-type.sl-type { color: var(--accent-red); }
    .tpsl-order-details {
      display: flex; gap: 12px; font-size: 11px; color: var(--muted);
    }
    .tpsl-order-details span { display: flex; align-items: center; gap: 4px; }
    .tpsl-order-actions { display: flex; align-items: center; gap: 8px; }
    .tpsl-order-pnl { font-size: 11px; font-weight: 600; }
    .tpsl-order-roe { font-size: 9px; font-weight: 600; }
    .btn-delete-tpsl {
      width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
      background: rgba(246, 70, 93, 0.1); border: 1px solid transparent;
      border-radius: 6px; color: var(--accent-red); cursor: pointer;
      transition: all 0.2s; font-size: 14px;
    }
    .btn-delete-tpsl:hover { background: var(--accent-red-transparent); border-color: var(--accent-red); }
    .btn-delete-tpsl:active { transform: scale(0.9); }

    .tpsl-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .tpsl-modal-overlay.active { opacity: 1; pointer-events: auto; }

    .tpsl-modal {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      max-height: 90vh; overflow-y: auto; z-index: 1001;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    .tpsl-modal-overlay.active .tpsl-modal { transform: translateY(0); }

    .tpsl-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--panel); z-index: 10;
    }
    .tpsl-modal-header-left { display: flex; flex-direction: column; gap: 2px; }
    .tpsl-modal-title { font-size: 16px; font-weight: 700; color: var(--white); }
    .tpsl-modal-subtitle { font-size: 12px; color: var(--muted); }
    .tpsl-modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 50%; cursor: pointer;
      color: var(--muted); font-size: 18px; transition: all 0.2s; border: none;
    }
    .tpsl-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }

    .tpsl-modal-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }

    .tpsl-position-info {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; background: rgba(255,255,255,0.03);
      border: 1px solid var(--border); border-radius: 10px;
    }
    .tpsl-position-left { display: flex; align-items: center; gap: 10px; }
    .tpsl-position-type {
      padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700;
    }
    .tpsl-position-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
    .tpsl-position-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
    .tpsl-position-pair { font-size: 14px; font-weight: 600; color: var(--white); }
    .tpsl-position-leverage { font-size: 12px; color: var(--muted); margin-left: 4px; }
    .tpsl-position-right { text-align: right; }
    .tpsl-position-entry-label { font-size: 11px; color: var(--muted); }
    .tpsl-position-entry-val { font-size: 14px; font-weight: 600; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .tpsl-position-mark-label { font-size: 10px; color: var(--muted); margin-top: 2px; }
    .tpsl-position-mark-val { font-size: 12px; font-weight: 600; font-family: 'Roboto Mono', monospace; color: var(--gold); }

    .tpsl-tabs {
      display: flex; gap: 4px; background: rgba(255,255,255,0.03);
      padding: 4px; border-radius: 10px; border: 1px solid var(--border);
    }
    .tpsl-tab {
      flex: 1; padding: 10px 16px; font-size: 13px; font-weight: 600;
      color: var(--muted); background: transparent; border: none;
      border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .tpsl-tab:hover { color: var(--white); }
    .tpsl-tab.active { background: var(--panel-light); color: var(--white); }

    .tpsl-tab-content { display: none; flex-direction: column; gap: 16px; }
    .tpsl-tab-content.active { display: flex; }

    .tpsl-input-group { display: flex; flex-direction: column; gap: 8px; }
    .tpsl-input-label {
      font-size: 12px; font-weight: 600; color: var(--muted);
      display: flex; align-items: center; justify-content: space-between;
    }
    .tpsl-input-hint { font-size: 11px; font-weight: 400; }
    .tpsl-input-wrapper { position: relative; display: flex; gap: 8px; }
    .tpsl-input {
      flex: 1; background: #111; border: 1px solid var(--border);
      color: var(--white); padding: 14px 16px; border-radius: 10px;
      font-size: 16px; font-family: 'Roboto Mono', monospace;
      outline: none; transition: border 0.2s;
    }
    .tpsl-input:focus { border-color: var(--gold); }
    .tpsl-input.error { border-color: var(--accent-red); }
    .tpsl-market-btn {
      padding: 14px 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--border);
      border-radius: 10px; color: var(--muted); font-size: 10px; font-weight: 600;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    .tpsl-market-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .tpsl-input-error {
      font-size: 11px; color: var(--accent-red); min-height: 16px;
    }

    .tpsl-size-section { display: flex; flex-direction: column; gap: 12px; }
    .tpsl-size-header {
      display: flex; justify-content: space-between; align-items: center;
    }
    .tpsl-size-label { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; }
    .tpsl-size-value {
      font-size: 14px; font-weight: 700; color: var(--accent-green);
      font-family: 'Roboto Mono', monospace;
    }
    .tpsl-size-slider-wrap { padding: 0 4px; }
    .tpsl-size-marks {
      display: flex; justify-content: space-between; margin-top: 6px;
    }
    .tpsl-size-mark {
      font-size: 10px; color: var(--muted); cursor: pointer;
      padding: 4px 8px; border-radius: 4px; transition: 0.2s;
    }
    .tpsl-size-mark:hover { color: var(--accent-green); background: rgba(255,255,255,0.05); }
    .tpsl-size-mark.active { color: var(--accent-green); font-weight: 600; }
    .tpsl-available-info {
      display: flex; justify-content: space-between; font-size: 11px;
      color: var(--muted); padding: 8px 12px; background: rgba(255,255,255,0.02);
      border-radius: 6px; border: 1px solid var(--border);
    }
    .tpsl-available-info span:last-child { color: var(--white); font-family: 'Roboto Mono', monospace; }

    .tpsl-pnl-preview {
      display: flex; flex-direction: column; gap: 8px; padding: 16px;
      background: rgba(255,255,255,0.02); border: 1px solid var(--border);
      border-radius: 10px;
    }
    .tpsl-pnl-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 13px;
    }
    .tpsl-pnl-label { color: var(--muted); }
    .tpsl-pnl-value { font-weight: 600; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .tpsl-pnl-value.positive { color: var(--accent-green); }
    .tpsl-pnl-value.negative { color: var(--accent-red); }
    .tpsl-pnl-divider { height: 1px; background: var(--border); margin: 4px 0; }

    .tpsl-existing-orders {
      padding: 12px 16px; background: rgba(240, 185, 11, 0.1);
      border: 1px solid rgba(240, 185, 11, 0.3); border-radius: 10px;
    }
    .tpsl-existing-title {
      font-size: 12px; font-weight: 600; color: var(--gold);
      display: flex; align-items: center; gap: 6px; margin-bottom: 8px;
    }
    .tpsl-existing-list { display: flex; flex-direction: column; gap: 6px; }
    .tpsl-existing-item {
      display: flex; justify-content: space-between; font-size: 12px;
      padding: 8px 10px; background: rgba(0,0,0,0.2); border-radius: 6px;
    }
    .tpsl-existing-item-type { font-weight: 600; }
    .tpsl-existing-item-type.tp { color: var(--accent-green); }
    .tpsl-existing-item-type.sl { color: var(--accent-red); }
    .tpsl-existing-item-info { color: var(--muted); font-family: 'Roboto Mono', monospace; font-size: 11px; }

    .tpsl-limit-notice {
      text-align: center; font-size: 11px; color: var(--accent-red);
      padding: 12px; background: var(--accent-red-transparent);
      border-radius: 8px; font-weight: 600;
    }

    .tpsl-submit-btn {
      width: 100%; padding: 16px; border-radius: 10px; border: none;
      font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .tpsl-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .tpsl-submit-btn:not(:disabled):active { transform: scale(0.98); }
    .tpsl-submit-btn.tp-confirm { background: var(--accent-green); color: #052e1f; }
    .tpsl-submit-btn.sl-confirm { background: var(--accent-red); color: #fff; }

    .toast-notification {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600;
      z-index: 9999; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }

    .profile-container { flex: 1; display: flex; flex-direction: column; padding: 16px; overflow-y: auto; gap: 20px; background: var(--bg); }
    .pro-header, .asset-card, .analysis-block, .rewards-banner, .hist-header-row { flex-shrink: 0; }
    .pro-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .pro-user { display: flex; align-items: center; gap: 12px; }
    .pro-avatar { width: 44px; height: 44px; border-radius: 50%; background: #333; overflow: hidden; border: 2px solid var(--panel); }
    .pro-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .pro-name { font-size: 16px; font-weight: 700; color: var(--white); line-height: 1.2; }
    .pro-id { font-size: 11px; color: var(--muted); font-family: monospace; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }

    .asset-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; position: relative; overflow: hidden; }
    .asset-label { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
    .eye-btn { width: 20px; height: 20px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; margin-left: 6px; display: block; }
    .eye-btn:active { opacity: 1; transform: scale(0.9); }
    .asset-val { font-size: 26px; font-weight: 700; color: var(--white); font-family: 'Roboto Mono'; margin: 8px 0; }
    .asset-approx { font-size: 13px; color: var(--muted); }
    .asset-pnl { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); display: inline-flex; align-items: center; gap: 4px; margin-left: 8px; }
    .asset-rate { font-size: 11px; color: var(--muted); margin-top: 8px; display: block; }
    .pro-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .pro-btn { background: var(--panel-light); border: none; color: var(--white); padding: 10px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .pro-btn.primary { background: var(--gold); color: #000; }

    .analysis-block { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .an-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 110px; }
    .an-card.clickable { cursor: pointer; transition: all 0.2s; }
    .an-card.clickable:hover { border-color: rgba(255,255,255,0.15); background: rgba(30, 35, 41, 0.8); }
    .an-card.clickable:active { transform: scale(0.98); }
    .an-title { font-size: 11px; color: var(--muted); margin-bottom: 0; text-transform: uppercase; width: 100%; text-align: left; }
    .an-content-center { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }

    .donut-chart { width: 70px; height: 70px; border-radius: 50%; background: conic-gradient(var(--accent-green) 0% 0%, var(--panel-light) 0% 100%); position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; }
    .donut-chart::after { content: ''; position: absolute; width: 56px; height: 56px; background: var(--panel); border-radius: 50%; }
    .donut-val { position: absolute; z-index: 2; font-size: 12px; font-weight: 700; color: var(--white); }
    .an-text { font-size: 12px; color: var(--white); font-weight: 600; margin-top: 4px; }

    .pnl-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .pnl-modal-overlay.active { opacity: 1; pointer-events: auto; }
    .pnl-modal {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--panel); border-radius: 20px 20px 0 0;
      max-height: 85vh; overflow-y: auto; z-index: 1001;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    .pnl-modal-overlay.active .pnl-modal { transform: translateY(0); }
    .pnl-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--panel); z-index: 10;
    }
    .pnl-modal-title { font-size: 16px; font-weight: 700; color: var(--white); }
    .pnl-modal-close {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 50%; cursor: pointer;
      color: var(--muted); font-size: 18px; transition: all 0.2s; border: none;
    }
    .pnl-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .pnl-modal-content { padding: 20px; display: flex; flex-direction: column; gap: 24px; }

    .stats-metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stats-metric-card {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 4px;
    }
    .stats-metric-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stats-metric-value { font-size: 18px; font-weight: 700; font-family: 'Roboto Mono', monospace; color: var(--white); }
    .stats-metric-value.positive { color: var(--accent-green); }
    .stats-metric-value.negative { color: var(--accent-red); }

    .period-selector {
      display: flex; gap: 4px; background: rgba(255,255,255,0.03);
      padding: 3px; border-radius: 8px; border: 1px solid var(--border);
    }
    .period-btn {
      padding: 6px 12px; font-size: 11px; font-weight: 600; color: var(--muted);
      background: transparent; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;
    }
    .period-btn:hover { color: var(--white); }
    .period-btn.active { background: var(--panel-light); color: var(--white); }

    .chart-section { display: flex; flex-direction: column; gap: 12px; }
    .chart-section-header { display: flex; justify-content: space-between; align-items: center; }
    .chart-section-title { font-size: 13px; font-weight: 600; color: var(--white); }
    .equity-chart-container {
      height: 160px; background: rgba(0,0,0,0.2); border-radius: 8px;
      overflow: hidden; position: relative;
    }

    .calendar-pnl-container { display: flex; flex-direction: column; gap: 8px; }
    .calendar-month-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 8px; }
    .calendar-nav-btn {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border: none; border-radius: 6px;
      color: var(--muted); cursor: pointer; transition: all 0.2s; font-size: 16px;
    }
    .calendar-nav-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .calendar-month-label { font-size: 14px; font-weight: 600; color: var(--white); min-width: 120px; text-align: center; }
    .calendar-header { display: flex; justify-content: space-between; padding: 0 2px; }
    .calendar-day-label { font-size: 9px; color: var(--muted); width: 36px; text-align: center; font-weight: 600; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-cell {
      aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 600; font-family: 'Roboto Mono', monospace;
      cursor: default; transition: transform 0.15s; position: relative;
      background: rgba(255,255,255,0.03); color: var(--muted);
    }
    .calendar-cell:hover { transform: scale(1.1); z-index: 2; }
    .calendar-cell.empty { background: transparent; }
    .calendar-cell.profit { background: var(--accent-green-transparent); color: var(--accent-green); }
    .calendar-cell.loss { background: var(--accent-red-transparent); color: var(--accent-red); }
    .calendar-cell.profit.high { background: rgba(14, 203, 129, 0.3); }
    .calendar-cell.loss.high { background: rgba(246, 70, 93, 0.3); }
    .calendar-cell.today { border: 1px solid var(--gold); }
    .calendar-legend {
      display: flex; justify-content: center; gap: 16px; margin-top: 8px;
      padding-top: 8px; border-top: 1px solid var(--border);
    }
    .calendar-legend-item { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--muted); }
    .calendar-legend-dot { width: 10px; height: 10px; border-radius: 3px; }
    .calendar-legend-dot.profit { background: var(--accent-green-transparent); }
    .calendar-legend-dot.loss { background: var(--accent-red-transparent); }
    .calendar-legend-dot.no-trade { background: rgba(255,255,255,0.03); }

    .ref-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .ref-top { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .ref-title { font-weight: 800; font-size: 14px; }
    .ref-badge { font-size: 11px; color: var(--muted); background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); }
    .ref-row { display: flex; gap: 8px; align-items: center; }
    .ref-input { flex: 1; background: #111; border: 1px solid var(--border); color: var(--white); padding: 12px; border-radius: 10px; font-family: 'Roboto Mono', monospace; font-size: 12px; outline: none; width: 100%; }
    .ref-btn { background: var(--panel-light); border: 1px solid var(--border); color: var(--white); padding: 12px 12px; border-radius: 10px; font-weight: 700; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .ref-btn.primary { background: var(--gold); color: #000; border-color: rgba(240,185,11,0.4); }
    .ref-help { font-size: 11px; color: var(--muted); line-height: 1.35; }
    .ref-list { display: flex; flex-direction: column; gap: 8px; max-height: 180px; overflow-y: auto; padding-right: 2px; }
    .ref-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 10px; }
    .ref-item-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .ref-avatar { width: 28px; height: 28px; border-radius: 50%; background: #333; overflow: hidden; border: 1px solid var(--border); flex-shrink: 0; }
    .ref-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .ref-name { font-size: 12px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
    .ref-date { font-size: 10px; color: var(--muted); font-family: monospace; flex-shrink: 0; }
    .ref-status { font-size: 10px; color: var(--muted); }

    .rewards-banner {
      background: linear-gradient(90deg, #1E2329 0%, #252a33 100%); border: 1px solid rgba(240, 185, 11, 0.3);
      border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; position: relative; overflow: hidden;
    }
    .rewards-banner::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gold); }
    .rb-content h3 { margin: 0; font-size: 15px; color: var(--white); }
    .rb-content p { margin: 4px 0 0; font-size: 11px; color: var(--muted); }
    .rb-icon { display: flex; align-items: center; }

    .hist-header-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; }
    .hist-title { margin: 0; font-size: 15px; font-weight: 700; }
    .hist-filters { display: flex; background: var(--panel); border-radius: 8px; padding: 2px; border: 1px solid var(--border); }
    .h-filter { padding: 4px 10px; font-size: 11px; color: var(--muted); border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: 500; }
    .h-filter.active { background: var(--panel-light); color: var(--white); font-weight: 700; }

    .history-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 60px; }
    .history-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 8px; }
    .hc-header { display: flex; justify-content: space-between; align-items: center; }
    .hc-pair { font-weight: 700; font-size: 14px; }
    .hc-type { font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
    .hc-type.long { background: var(--accent-green-transparent); color: var(--accent-green); }
    .hc-type.short { background: var(--accent-red-transparent); color: var(--accent-red); }
    .hc-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); }
    .hc-val { color: var(--white); font-family: 'Roboto Mono'; }
    .hc-pnl { font-weight: 700; font-family: 'Roboto Mono'; font-size: 14px; }

    .rewards-container { padding: 20px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; padding-bottom: 100px; }
    .rewards-header { text-align: center; padding: 20px 0; }
    .rh-title { font-size: 22px; font-weight: 700; color: var(--white); margin-bottom: 8px; }
    .rh-sub { font-size: 13px; color: var(--muted); }
    .stats-row { display: flex; justify-content: center; gap: 32px; margin-top: 16px; }
    .stat-item { text-align: center; }
    .stat-item .stat-number { font-size: 24px; font-weight: 700; color: var(--gold); font-family: 'Roboto Mono'; }
    .stat-item .stat-desc { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .progress-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
    .prog-info { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; color: var(--white); font-weight: 600; }
    .prog-track { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative; }
    .prog-fill { height: 100%; background: var(--gold-gradient); width: 0%; transition: width 0.5s ease; border-radius: 4px; }
    .milestones { display: flex; justify-content: space-between; margin-top: 12px; }
    .ms-item { text-align: center; width: 30px; position: relative; }
    .ms-dot { width: 10px; height: 10px; background: #333; border: 2px solid var(--muted); border-radius: 50%; margin: 0 auto 4px; z-index: 2; position: relative; }
    .ms-item.active .ms-dot { background: var(--gold); border-color: var(--gold); box-shadow: 0 0 10px rgba(240, 185, 11, 0.4); }
    .ms-val { font-size: 10px; color: var(--muted); }

    .task-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .task-item { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
    .task-left h4 { margin: 0 0 4px; font-size: 14px; }
    .task-left p { margin: 0; font-size: 11px; color: var(--muted); }
    .task-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .daily-counter { font-size: 11px; color: var(--muted); font-family: 'Roboto Mono'; }
    .daily-counter.limit-reached { color: var(--accent-red); }
    .btn-claim { background: var(--gold); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .btn-claim:hover { filter: brightness(1.1); }
    .btn-claim:active { transform: scale(0.96); }
    .btn-claim:disabled { background: var(--panel-light); color: var(--muted); cursor: not-allowed; }
    .btn-claim.loading { opacity: 0.7; pointer-events: none; }

    .btn-back-float {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--panel-light); border: 1px solid var(--border); color: var(--white);
      padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 900; cursor: pointer;
    }

    #app-loader {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s;
    }
    #app-loader.hidden { opacity: 0; pointer-events: none; }
    .loader-logo { width: 80px; height: auto; margin-bottom: 20px; animation: pulse 2s infinite ease-in-out; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    .loader-bar-bg { width: 140px; height: 2px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .loader-bar-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.2s; }

    .tf-selector {
      display: flex; gap: 2px; background: rgba(255,255,255,0.03);
      padding: 2px; border-radius: 6px; height: fit-content; flex-shrink: 0; align-self: flex-start;
    }
    .tf-selector.tf-wrapped {
      display: grid; grid-template-columns: repeat(3, auto); grid-template-rows: auto auto;
      gap: 2px; width: auto; justify-content: end;
    }
    .tf-opt {
      padding: 4px 8px; font-size: 10px; color: var(--muted); border-radius: 4px;
      cursor: pointer; font-weight: 600; transition: 0.2s; user-select: none; white-space: nowrap; text-align: center;
    }
    .tf-opt:hover { color: var(--white); background: rgba(255,255,255,0.05); }
    .tf-opt.active { background: var(--panel-light); color: var(--gold); }
  </style>
</head>
<body>

<div id="app-loader">
  <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="TradeSim" class="loader-logo">
  <div class="loader-bar-bg"><div class="loader-bar-fill" id="loaderBar"></div></div>
  <div style="margin-top: 12px; font-size: 10px; color: var(--muted); font-family: monospace; letter-spacing: 1px;" id="loaderText">CONNECTING</div>
</div>

<div class="app">

  <div id="view-trade" class="view-section active">
    <header class="header">
      <div class="header-left">
        <img src="https://i.postimg.cc/D0Zvnmdq/logobirzhi2.png" alt="Logo" class="logo-img">
        <div class="pair-dropdown" id="pairDropdown">
          <div class="pair-trigger" id="pairTrigger">
            <span id="triggerText">BTC/USD</span>
            <span class="arrow">▼</span>
          </div>
          <div class="pair-menu">
            <div class="pair-item active" data-pair="BTC-USD">BTC/USD</div>
            <div class="pair-item" data-pair="ETH-USD">ETH/USD</div>
          </div>
        </div>
      </div>
      <div class="user-area" id="btnProfile">
        <div class="balance-group">
          <span class="balance-label">Total Assets</span>
          <span class="balance-val" id="headerBalance">0.00 VP</span>
        </div>
        <div class="avatar-sm"><img id="avatarImg" src="" style="display:none"></div>
      </div>
    </header>

    <main class="container">
      <div class="left-col">
        <div class="card">
          <div class="market-header" id="marketHeader">
            <div class="price-block" id="priceBlock">
              <div class="price-label">Market Price</div>
              <div class="price-display text-green" id="priceDisplay">--.--</div>
            </div>
            <div class="tf-selector" id="timeframeSelector">
              <div class="tf-opt active" data-tf="60">1m</div>
              <div class="tf-opt" data-tf="300">5m</div>
              <div class="tf-opt" data-tf="900">15m</div>
              <div class="tf-opt" data-tf="3600">1h</div>
              <div class="tf-opt" data-tf="21600">6h</div>
              <div class="tf-opt" data-tf="86400">1d</div>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-container" id="chartCard">
              <div id="chart" style="width: 100%; height: 100%;"></div>
              <div class="chart-loading-overlay" id="chartLoadingOverlay">
                <div class="chart-loading-spinner"></div>
              </div>
              <div class="ohlc-tooltip" id="ohlcTooltip">
                <div class="ohlc-item"><span class="ohlc-label">O:</span><span class="ohlc-value" id="ohlcOpen">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">H:</span><span class="ohlc-value" id="ohlcHigh">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">L:</span><span class="ohlc-value" id="ohlcLow">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">C:</span><span class="ohlc-value" id="ohlcClose">-</span></div>
                <div class="ohlc-item"><span class="ohlc-label">V:</span><span class="ohlc-value" id="ohlcVol">-</span></div>
              </div>
              <div class="drawing-tools-menu" id="drawingToolsMenu">
                <div class="drawing-tools-toggle" id="drawingToolsToggle" title="Drawing Tools">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/>
                  </svg>
                </div>
                <div class="drawing-tools-panel" id="drawingToolsPanel">
                  <div class="drawing-tool-btn" id="toolCursor" data-tool="cursor" title="Cursor"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg></div>
                  <div class="drawing-tool-btn" id="toolTrendLine" data-tool="trendline" title="Trend Line"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="20" x2="20" y2="4"/></svg></div>
                  <div class="drawing-tool-btn" id="toolHorizLine" data-tool="horizline" title="Horizontal Line"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="12" x2="22" y2="12"/></svg></div>
                  <div class="drawing-tool-btn" id="toolClearAll" data-tool="clear" title="Clear All"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
                </div>
              </div>
            </div>
            <div class="volume-container" id="volumeContainer"><div id="volumeChart" style="width: 100%; height: 100%;"></div></div>
            <div class="indicators-panel" id="indicatorsPanel">
              <div class="indicator-chip ema" id="chipEMA" data-indicator="ema"><span class="indicator-dot"></span><span>EMA 20</span></div>
              <div class="indicator-chip sma" id="chipSMA" data-indicator="sma"><span class="indicator-dot"></span><span>SMA 50</span></div>
              <div class="indicator-chip vwap" id="chipVWAP" data-indicator="vwap"><span class="indicator-dot"></span><span>VWAP</span></div>
              <div class="indicator-chip volume" id="chipVolume" data-indicator="volume"><span class="indicator-dot"></span><span>Volume</span></div>
            </div>
          </div>

          <div class="controls-area">
            <div class="input-group">
              <span class="input-label">Margin (VP)</span>
              <input type="number" id="sizeInput" class="main-input" value="100" placeholder="10-10000" />
            </div>
            <div class="slider-wrap">
              <div class="slider-header"><span>Margin %</span><span class="slider-val" id="marginPercentText">0%</span></div>
              <div class="margin-slider-wrap">
                <input type="range" class="range-slider" id="marginSlider" min="0" max="100" step="1" value="0">
                <div class="margin-marks">
                  <span class="margin-mark" data-pct="0">0%</span>
                  <span class="margin-mark" data-pct="25">25%</span>
                  <span class="margin-mark" data-pct="50">50%</span>
                  <span class="margin-mark" data-pct="75">75%</span>
                  <span class="margin-mark" data-pct="100">100%</span>
                </div>
              </div>
            </div>
            <div class="slider-wrap">
              <div class="slider-header"><span>Leverage</span><span class="slider-val" id="leverageValText">10x</span></div>
              <input type="range" class="range-slider" id="leverageSlider" min="1" max="50" step="1" value="10">
              <div class="chips-row" id="leverageChips">
                <div class="chip" data-v="1">1x</div>
                <div class="chip" data-v="5">5x</div>
                <div class="chip active" data-v="10">10x</div>
                <div class="chip" data-v="20">20x</div>
                <div class="chip" data-v="50">50x</div>
              </div>
            </div>
            <div class="action-btns">
              <button id="openLong" class="btn-trade btn-long">Buy / Long <span>Up</span></button>
              <button id="openShort" class="btn-trade btn-short">Sell / Short <span>Down</span></button>
            </div>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px; padding-left: 4px;">Open Positions</div>
          <div id="positionsList" class="pos-list"><div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div></div>
        </div>
      </div>

      <div class="right-col">
        <div class="card" style="display:flex; flex-direction:column; min-height: 300px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between; align-items:center;">
            <span>Order Book</span>
            <div style="display:flex; gap:8px; align-items:center;">
              <span id="bookPairLabel" style="color:var(--muted); font-size:11px;">BTC-USD</span>
              <span id="bookUpdated" style="color:var(--muted); font-size:11px;">—</span>
            </div>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Amount</span></div>
          <div class="ob-container" id="orderBook" style="flex:1;"></div>
        </div>
        <div class="card" style="display:flex; flex-direction:column; min-height: 250px;">
          <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; display:flex; justify-content:space-between;">
            <span>Last Trades</span>
            <span style="color:var(--muted); font-size:11px;">Real-time</span>
          </div>
          <div class="ob-header"><span>Price</span><span style="text-align:right">Time</span></div>
          <div class="ob-container" id="tradeHistory" style="flex:1;"></div>
        </div>
      </div>
    </main>
  </div>

  <div id="view-profile" class="view-section hidden">
    <div class="profile-container">
      <div class="pro-header">
        <div class="pro-user">
          <div class="pro-avatar"><img id="profileAvatarBig" src=""></div>
          <div>
            <div class="pro-name" id="profileName">Trader</div>
            <div class="pro-id" id="profileId">ID: --</div>
          </div>
        </div>
        <div class="btn-close" id="btnCloseProfile" style="color:var(--muted); padding:8px; cursor:pointer;">✕</div>
      </div>
      <div class="asset-card">
        <div class="asset-label">Total Assets (VP)<img id="btnToggleBalance" class="eye-btn" src="https://img.icons8.com/ios-glyphs/60/ffffff/visible.png" alt="Show/Hide"></div>
        <div class="asset-val" id="profileBalance">0.00</div>
        <div style="display:flex; align-items:center;">
          <span class="asset-approx" id="profileBalanceApprox">≈ $0.00</span>
          <div class="asset-pnl text-green" id="profilePnlPill">+0.00%</div>
        </div>
        <span class="asset-rate">1 VP = $0.005</span>
        <div class="pro-actions">
          <button class="pro-btn primary">Deposit</button>
          <button class="pro-btn">Withdraw</button>
        </div>
      </div>
      <div class="analysis-block">
        <div class="an-card">
          <div class="an-title">Win Rate</div>
          <div class="an-content-center">
            <div class="donut-chart" id="winRateChart"><span class="donut-val" id="winRateVal">0%</span></div>
            <div class="an-text" id="totalTradesVal" style="margin-top: 6px;">0 Trades</div>
          </div>
        </div>
        <div class="an-card clickable" id="netPnlCard">
          <div class="an-title">Net PnL</div>
          <div class="an-content-center">
            <div style="font-size:20px; font-weight:700; font-family:'Roboto Mono';" id="statPnL">0.00</div>
          </div>
          <div style="font-size:10px; color:var(--muted); width:100%; text-align:center;">Tap for details →</div>
        </div>
      </div>
      <div class="ref-card" id="refCard">
        <div class="ref-top"><div class="ref-title">Referrals</div><div class="ref-badge" id="refCountBadge">Invited: 0</div></div>
        <div class="ref-row"><input class="ref-input" id="refLinkInput" readonly value="Loading..."><button class="ref-btn primary" id="btnCopyRefLink">Copy</button></div>
        <div class="ref-help" id="refHelpText">Share the link with friends. When they open the bot using your link, they will be automatically assigned as your referral.</div>
        <div class="ref-list" id="refList"><div class="ref-status" id="refStatus">Loading referrals...</div></div>
      </div>
      <div class="rewards-banner" id="btnGoRewards">
        <div class="rb-content"><h3>Rewards Center</h3><p>Complete tasks to unlock features</p></div>
        <div class="rb-icon"><img src="https://i.postimg.cc/pdkwtBbQ/gift-thunder.png" style="width: 40px; height: auto;"></div>
      </div>
      <div>
        <div class="hist-header-row">
          <div class="hist-title">History</div>
          <div class="hist-filters">
            <div class="h-filter active" data-filter="all">All</div>
            <div class="h-filter" data-filter="day">24h</div>
            <div class="h-filter" data-filter="week">7d</div>
          </div>
        </div>
        <div class="history-list" id="historyList"><div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history</div></div>
      </div>
    </div>
  </div>

  <div id="view-rewards" class="view-section hidden">
    <div class="rewards-container">
      <div class="rewards-header">
        <div class="rh-title">Achievement Progress</div>
        <div class="rh-sub">Watch ads & earn rewards</div>
        <div class="stats-row">
          <div class="stat-item"><div class="stat-number" id="totalAdsWatched">0</div><div class="stat-desc">Ads Watched</div></div>
          <div class="stat-item"><div class="stat-number" id="totalEarnedFromAds">0</div><div class="stat-desc">VP Earned</div></div>
        </div>
      </div>
      <div class="progress-card">
        <div class="prog-info"><span id="currentLevelText">Level 1</span><span id="adsProgressText">0 / 10 Ads</span></div>
        <div class="prog-track"><div class="prog-fill" id="adsProgressBar" style="width: 0%;"></div></div>
        <div class="milestones">
          <div class="ms-item active" id="ms-start"><div class="ms-dot"></div><span class="ms-val">Start</span></div>
          <div class="ms-item" id="ms-5"><div class="ms-dot"></div><span class="ms-val">5 Ads</span></div>
          <div class="ms-item" id="ms-10"><div class="ms-dot"></div><span class="ms-val">10 Ads</span></div>
        </div>
      </div>
      <div class="task-list">
        <div class="task-item">
          <div class="task-left"><h4>Watch Ad</h4><p>Earn +1 VP per view</p></div>
          <div class="task-right">
            <span class="daily-counter" id="dailyAdCounter">0/5 today</span>
            <button class="btn-claim" id="btnWatchAd">WATCH</button>
          </div>
        </div>
      </div>
      <button class="btn-back-float" id="btnBackFromRewards">Back to Profile</button>
    </div>
  </div>

</div>

<!-- PnL Modal -->
<div class="pnl-modal-overlay" id="pnlModalOverlay">
  <div class="pnl-modal" id="pnlModal">
    <div class="pnl-modal-header">
      <div class="pnl-modal-title">Trading Statistics</div>
      <button class="pnl-modal-close" id="pnlModalClose">×</button>
    </div>
    <div class="pnl-modal-content">
      <div class="stats-metrics-grid">
        <div class="stats-metric-card"><div class="stats-metric-label">Avg Risk:Reward</div><div class="stats-metric-value" id="modalAvgRR">--</div></div>
        <div class="stats-metric-card"><div class="stats-metric-label">Max Drawdown</div><div class="stats-metric-value negative" id="modalMaxDD">--</div></div>
        <div class="stats-metric-card"><div class="stats-metric-label">Profit Factor</div><div class="stats-metric-value" id="modalProfitFactor">--</div></div>
        <div class="stats-metric-card"><div class="stats-metric-label">Avg Trade</div><div class="stats-metric-value" id="modalAvgTrade">--</div></div>
      </div>
      <div class="chart-section">
        <div class="chart-section-header">
          <div class="chart-section-title">Equity Curve</div>
          <div class="period-selector" id="equityPeriodSelector">
            <button class="period-btn active" data-period="7d">7D</button>
            <button class="period-btn" data-period="30d">30D</button>
            <button class="period-btn" data-period="90d">90D</button>
            <button class="period-btn" data-period="all">All</button>
          </div>
        </div>
        <div class="equity-chart-container" id="equityChartContainer"></div>
      </div>
      <div class="chart-section">
        <div class="chart-section-title" style="margin-bottom: 12px;">Calendar PnL</div>
        <div class="calendar-pnl-container" id="calendarPnlContainer">
          <div class="calendar-month-nav">
            <button class="calendar-nav-btn" id="calendarPrev">‹</button>
            <span class="calendar-month-label" id="calendarMonthLabel">January 2025</span>
            <button class="calendar-nav-btn" id="calendarNext">›</button>
          </div>
          <div class="calendar-header">
            <span class="calendar-day-label">Mon</span><span class="calendar-day-label">Tue</span><span class="calendar-day-label">Wed</span><span class="calendar-day-label">Thu</span><span class="calendar-day-label">Fri</span><span class="calendar-day-label">Sat</span><span class="calendar-day-label">Sun</span>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
          <div class="calendar-legend">
            <div class="calendar-legend-item"><span class="calendar-legend-dot profit"></span><span>Profit</span></div>
            <div class="calendar-legend-item"><span class="calendar-legend-dot loss"></span><span>Loss</span></div>
            <div class="calendar-legend-item"><span class="calendar-legend-dot no-trade"></span><span>No Trade</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TP/SL Modal -->
<div class="tpsl-modal-overlay" id="tpslModalOverlay">
  <div class="tpsl-modal" id="tpslModal">
    <div class="tpsl-modal-header">
      <div class="tpsl-modal-header-left">
        <div class="tpsl-modal-title" id="tpslModalTitle">Take Profit</div>
        <div class="tpsl-modal-subtitle" id="tpslModalSubtitle">Lock in profits at target price</div>
      </div>
      <button class="tpsl-modal-close" id="tpslModalClose">×</button>
    </div>
    <div class="tpsl-modal-content">
      <div class="tpsl-position-info">
        <div class="tpsl-position-left">
          <div class="tpsl-position-type long" id="tpslPositionType">LONG</div>
          <div>
            <span class="tpsl-position-pair" id="tpslPositionPair">BTC-USD</span>
            <span class="tpsl-position-leverage" id="tpslPositionLeverage">x10</span>
          </div>
        </div>
        <div class="tpsl-position-right">
          <div class="tpsl-position-entry-label">Entry Price</div>
          <div class="tpsl-position-entry-val" id="tpslEntryPrice">0.00</div>
          <div class="tpsl-position-mark-label">Mark Price</div>
          <div class="tpsl-position-mark-val" id="tpslMarkPrice">0.00</div>
        </div>
      </div>

      <div class="tpsl-tabs">
        <button class="tpsl-tab active" id="tpslTabFull" data-tab="full">Position TP/SL</button>
        <button class="tpsl-tab" id="tpslTabPartial" data-tab="partial">Partial TP/SL</button>
      </div>

      <div class="tpsl-tab-content active" id="tabFull">
        <div class="tpsl-input-group">
          <div class="tpsl-input-label">
            <span>Trigger Price</span>
            <span class="tpsl-input-hint" id="tpslPriceHint">Must be above current price</span>
          </div>
          <div class="tpsl-input-wrapper">
            <input type="number" class="tpsl-input" id="tpslPriceInput" placeholder="0.00" step="any">
            <button class="tpsl-market-btn" id="tpslMarketBtn">Market</button>
          </div>
          <div class="tpsl-input-error" id="tpslErrorText"></div>
        </div>

        <div class="tpsl-pnl-preview">
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Expected PnL</span>
            <span class="tpsl-pnl-value" id="tpslExpectedPnl">-- VP</span>
          </div>
          <div class="tpsl-pnl-divider"></div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">ROE</span>
            <span class="tpsl-pnl-value" id="tpslExpectedRoe">--%</span>
          </div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Close Size</span>
            <span class="tpsl-pnl-value" id="tpslCloseSize">100%</span>
          </div>
        </div>

        <div class="tpsl-existing-orders" id="tpslExistingOrders" style="display: none;">
          <div class="tpsl-existing-title">
            <span>⚠️</span>
            <span>Existing Orders</span>
          </div>
          <div class="tpsl-existing-list" id="tpslExistingList"></div>
        </div>

        <div id="tpslLimitNotice" class="tpsl-limit-notice" style="display:none;">
          Maximum 3 orders reached for this type
        </div>

        <button class="tpsl-submit-btn tp-confirm" id="tpslSubmitFull" disabled>
          <span>Confirm Take Profit</span>
        </button>
      </div>

      <div class="tpsl-tab-content" id="tabPartial">
        <div class="tpsl-input-group">
          <div class="tpsl-input-label">
            <span>Trigger Price</span>
            <span class="tpsl-input-hint" id="tpslPriceHintPartial">Must be above current price</span>
          </div>
          <div class="tpsl-input-wrapper">
            <input type="number" class="tpsl-input" id="tpslPriceInputPartial" placeholder="0.00" step="any">
            <button class="tpsl-market-btn" id="tpslMarketBtnPartial">Market</button>
          </div>
          <div class="tpsl-input-error" id="tpslErrorTextPartial"></div>
        </div>

        <div class="tpsl-size-section">
          <div class="tpsl-size-header">
            <span class="tpsl-size-label">Close Size</span>
            <span class="tpsl-size-value" id="tpslSizeValue">50%</span>
          </div>
          <div class="tpsl-size-slider-wrap">
            <input type="range" class="range-slider" id="tpslSizeSlider" min="10" max="100" step="5" value="50">
          </div>
          <div class="tpsl-size-marks">
            <span class="tpsl-size-mark" data-size="25">25%</span>
            <span class="tpsl-size-mark active" data-size="50">50%</span>
            <span class="tpsl-size-mark" data-size="75">75%</span>
            <span class="tpsl-size-mark" data-size="100">100%</span>
          </div>
          <div class="tpsl-available-info">
            <span>Available to close</span>
            <span id="tpslAvailableSize">100%</span>
          </div>
        </div>

        <div class="tpsl-pnl-preview">
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Expected PnL</span>
            <span class="tpsl-pnl-value" id="tpslExpectedPnlPartial">-- VP</span>
          </div>
          <div class="tpsl-pnl-divider"></div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">ROE</span>
            <span class="tpsl-pnl-value" id="tpslExpectedRoePartial">--%</span>
          </div>
          <div class="tpsl-pnl-row">
            <span class="tpsl-pnl-label">Close Amount</span>
            <span class="tpsl-pnl-value" id="tpslCloseSizePartial">-- VP</span>
          </div>
        </div>

        <div class="tpsl-existing-orders" id="tpslExistingOrdersPartial" style="display: none;">
          <div class="tpsl-existing-title">
            <span>⚠️</span>
            <span>Existing Orders (<span id="tpslUsedPercent">0</span>% used)</span>
          </div>
          <div class="tpsl-existing-list" id="tpslExistingListPartial"></div>
        </div>

        <div id="tpslLimitNoticePartial" class="tpsl-limit-notice" style="display:none;">
          Maximum 3 orders reached for this type
        </div>

        <button class="tpsl-submit-btn tp-confirm" id="tpslSubmitPartial" disabled>
          <span>Confirm Take Profit</span>
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  (async function(){
    const $ = (id) => document.getElementById(id);

    const WSS_PRICE_URL = "wss://tradingbot-backend-2yws.onrender.com";
    const API_BASE = "https://tradingbot-p9n8.onrender.com";
    const ALL_PAIRS = ["BTC-USD", "ETH-USD"];
    
    const ADSGRAM_BLOCK_ID = "22326";
    const VP_TO_USD_RATE = 0.005;
    const DAILY_AD_LIMIT = 5;
    const MAX_TP_PER_POSITION = 3;
    const MAX_SL_PER_POSITION = 3;

    let currentUserId = null;
    let selectedPair = "BTC-USD";
    let marketPrices = {};
    let currentTimeframe = 60;
    let localCandles = [];
    let localVolumes = [];
    let isLoadingHistory = false;
    let allHistoryLoaded = false;

    let profile = { 
      balance: 0, name: "Trader", id: 0, photo: "", 
      adViewsCount: 0, dailyAdViews: 0, dailyAdLimit: DAILY_AD_LIMIT
    };
    let currentLeverage = 10;
    let localTrades = [];
    let remoteHistory = [];

    let isBalanceHidden = false;
    let historyFilterMode = 'all';
    const ICON_EYE_OPEN = "https://img.icons8.com/ios-glyphs/60/ffffff/visible.png";
    const ICON_EYE_CLOSED = "https://img.icons8.com/ios-glyphs/60/ffffff/hide.png";

    let AdController = null;

    let indicatorState = { ema: false, sma: false, vwap: false, volume: false };
    let emaSeries = null;
    let smaSeries = null;
    let vwapSeries = null;
    let volumeChartInstance = null;
    let volumeHistogramSeries = null;

    let currentDrawingTool = 'cursor';
    let isDrawingToolsOpen = false;
    let drawnLines = [];
    let isDrawing = false;
    let drawStartPoint = null;

    let lastTapTime = 0;
    const DOUBLE_TAP_DELAY = 300;

    let calendarCurrentMonth = new Date();

    let equityChartInstance = null;
    let equityLineSeries = null;

    // ==================== TP/SL STATE ====================
    window._tpSlOrders = [];
    let tpslModalState = {
      positionId: null,
      orderType: null,
      tab: 'full',
      position: null
    };

    const tg = window.Telegram?.WebApp;
    if(tg) {
      tg.ready();
      try { tg.expand(); } catch(e){}
      tg.setHeaderColor('#1E2329');
      tg.setBackgroundColor('#0B0E11');
      tg.enableClosingConfirmation();
    }

    // ==================== RESPONSIVE OVERFLOW CHECK ====================
    const TF_OVERLAP_GAP = 12;

    function checkResponsiveOverflows() {
      checkOhlcOverflow();
      checkTfSelectorOverflow();
    }

    function checkOhlcOverflow() {
      const tooltip = $('ohlcTooltip');
      const container = $('chartCard');
      if (!tooltip || !container) return;
      tooltip.classList.remove('ohlc-wrapped');
      const containerWidth = container.clientWidth;
      const tooltipLeft = 46;
      const tooltipPaddingH = 16;
      const availableWidth = containerWidth - tooltipLeft - tooltipPaddingH;
      let totalItemsWidth = 0;
      const items = tooltip.querySelectorAll('.ohlc-item');
      const gap = 8;
      items.forEach((item, i) => {
        totalItemsWidth += item.offsetWidth;
        if (i < items.length - 1) totalItemsWidth += gap;
      });
      if (totalItemsWidth > availableWidth) tooltip.classList.add('ohlc-wrapped');
    }

    function checkTfSelectorOverflow() {
      const tfSelector = $('timeframeSelector');
      const priceBlock = $('priceBlock');
      const marketHeader = $('marketHeader');
      if (!tfSelector || !priceBlock || !marketHeader) return;
      tfSelector.classList.remove('tf-wrapped');
      requestAnimationFrame(() => {
        const priceRect = priceBlock.getBoundingClientRect();
        const tfRect = tfSelector.getBoundingClientRect();
        const headerRect = marketHeader.getBoundingClientRect();
        const gap = tfRect.left - priceRect.right;
        const isOverlapping = gap < TF_OVERLAP_GAP;
        const needsWrapByWidth = priceRect.width + tfRect.width + TF_OVERLAP_GAP > headerRect.width;
        if (isOverlapping || needsWrapByWidth) tfSelector.classList.add('tf-wrapped');
      });
    }

    // ==================== ADSGRAM ====================
    function initAdsgram() {
      if (window.Adsgram && ADSGRAM_BLOCK_ID !== "YOUR_BLOCK_ID_HERE") {
        try { AdController = window.Adsgram.init({ blockId: ADSGRAM_BLOCK_ID }); } catch(e) { console.error("Adsgram init error:", e); }
      }
    }

    function canWatchAd() { return profile.dailyAdViews < profile.dailyAdLimit; }

    function updateWatchAdButton() {
      const btn = $('btnWatchAd');
      const counter = $('dailyAdCounter');
      if (counter) {
        counter.textContent = `${profile.dailyAdViews}/${profile.dailyAdLimit} today`;
        counter.classList.toggle('limit-reached', !canWatchAd());
      }
      if (btn) { btn.disabled = !canWatchAd(); btn.textContent = canWatchAd() ? 'WATCH' : 'LIMIT'; }
    }

    async function showRewardedAd() {
      const btn = $('btnWatchAd');
      if (!AdController) { notify("Ad system not available"); return; }
      if (!canWatchAd()) { notify(`Daily limit reached (${profile.dailyAdLimit} ads). Come back tomorrow!`); return; }
      btn.classList.add('loading'); btn.textContent = 'Loading...';
      try {
        await AdController.show();
        await new Promise(r => setTimeout(r, 1500));
        await loadAdStats();
        if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        const remaining = profile.dailyAdLimit - profile.dailyAdViews;
        notify(remaining > 0 ? `Reward received: +1 VP! (${remaining} ads left today)` : "Reward received: +1 VP! Daily limit reached.");
      } catch(e) {
        console.error("Ad error:", e);
        if (e.error) notify("Ad unavailable. Try again later.");
      } finally { btn.classList.remove('loading'); updateWatchAdButton(); }
    }

    async function loadAdStats() {
      if (!currentUserId) return;
      try {
        const res = await fetch(API_BASE + "/api/user/ad-stats?userId=" + currentUserId);
        const data = await res.json();
        if (data.ok) {
          profile.adViewsCount = data.adViewsCount || 0;
          profile.dailyAdViews = data.dailyAdViews || 0;
          profile.dailyAdLimit = data.dailyAdLimit || DAILY_AD_LIMIT;
          profile.balance = data.balance || profile.balance;
          updateRewardsUI(); updateBalanceUI(); updateWatchAdButton();
        }
      } catch(e) { console.error("Error loading ad stats:", e); }
    }

    function updateRewardsUI() {
      const views = profile.adViewsCount || 0;
      const level = Math.floor(views / 10) + 1;
      const viewsInLevel = views % 10;
      const progressPercent = (viewsInLevel / 10) * 100;
      $('totalAdsWatched').textContent = views;
      $('totalEarnedFromAds').textContent = views;
      $('currentLevelText').textContent = `Level ${level}`;
      $('adsProgressText').textContent = `${viewsInLevel} / 10 Ads`;
      $('adsProgressBar').style.width = progressPercent + '%';
      $('ms-start').classList.add('active');
      $('ms-5').classList.toggle('active', viewsInLevel >= 5);
      $('ms-10').classList.toggle('active', viewsInLevel >= 10);
      updateWatchAdButton();
    }

    // ==================== FORMATTERS ====================
    function formatPrice(val) {
      const num = Number(val);
      if(isNaN(num)) return "--.--";
      if(num < 1) return num.toFixed(5);
      if(num < 10) return num.toFixed(4);
      return num.toFixed(2);
    }

    function formatUSD(vpAmount) { return (Number(vpAmount) * VP_TO_USD_RATE).toFixed(2); }

    function normalizePair(p) {
      if (!p) return "";
      return String(p).trim().replace("/", "-").toUpperCase();
    }

    function formatVolume(vol) {
      if (vol >= 1000000) return (vol / 1000000).toFixed(2) + 'M';
      if (vol >= 1000) return (vol / 1000).toFixed(2) + 'K';
      return vol.toFixed(2);
    }

    // ==================== INDICATOR CALCULATIONS ====================
    function calculateEMA(data, period = 20) {
      if (!data || data.length < period) return [];
      const k = 2 / (period + 1); const emaData = [];
      let ema = data.slice(0, period).reduce((sum, c) => sum + c.close, 0) / period;
      for (let i = period - 1; i < data.length; i++) {
        if (i === period - 1) emaData.push({ time: data[i].time, value: ema });
        else { ema = data[i].close * k + ema * (1 - k); emaData.push({ time: data[i].time, value: ema }); }
      }
      return emaData;
    }

    function calculateSMA(data, period = 50) {
      if (!data || data.length < period) return [];
      const smaData = [];
      for (let i = period - 1; i < data.length; i++) {
        const sum = data.slice(i - period + 1, i + 1).reduce((s, c) => s + c.close, 0);
        smaData.push({ time: data[i].time, value: sum / period });
      }
      return smaData;
    }

    function calculateVWAP(data) {
      if (!data || data.length === 0) return [];
      const vwapData = []; let cumulativeTPV = 0; let cumulativeVolume = 0; let currentDay = null;
      for (let i = 0; i < data.length; i++) {
        const candle = data[i];
        const candleDate = new Date(candle.time * 1000).toDateString();
        if (candleDate !== currentDay) { cumulativeTPV = 0; cumulativeVolume = 0; currentDay = candleDate; }
        const typicalPrice = (candle.high + candle.low + candle.close) / 3;
        const volume = (localVolumes[i] && localVolumes[i].value) || 1;
        cumulativeTPV += typicalPrice * volume; cumulativeVolume += volume;
        vwapData.push({ time: candle.time, value: cumulativeVolume > 0 ? cumulativeTPV / cumulativeVolume : typicalPrice });
      }
      return vwapData;
    }

    function buildVolumeData(candles) {
      return candles.map(c => ({
        time: c.time,
        value: c.volume || (Math.abs(c.close - c.open) * 1000 + Math.random() * 500 + 100),
        color: c.close >= c.open ? 'rgba(14, 203, 129, 0.5)' : 'rgba(246, 70, 93, 0.5)'
      }));
    }

    // ==================== INDICATOR TOGGLE ====================
    function toggleIndicator(indicator) {
      indicatorState[indicator] = !indicatorState[indicator];
      const chipId = indicator === 'ema' ? 'chipEMA' : indicator === 'sma' ? 'chipSMA' : indicator === 'vwap' ? 'chipVWAP' : 'chipVolume';
      const chip = $(chipId);
      if (chip) chip.classList.toggle('active', indicatorState[indicator]);
      updateIndicators();
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function updateIndicators() {
      if (indicatorState.ema) {
        if (!emaSeries) emaSeries = chart.addLineSeries({ color: '#1E90FF', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
        emaSeries.setData(calculateEMA(localCandles, 20));
      } else if (emaSeries) { chart.removeSeries(emaSeries); emaSeries = null; }
      if (indicatorState.sma) {
        if (!smaSeries) smaSeries = chart.addLineSeries({ color: '#A855F7', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
        smaSeries.setData(calculateSMA(localCandles, 50));
      } else if (smaSeries) { chart.removeSeries(smaSeries); smaSeries = null; }
      if (indicatorState.vwap) {
        if (!vwapSeries) vwapSeries = chart.addLineSeries({ color: '#F7931A', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
        vwapSeries.setData(calculateVWAP(localCandles));
      } else if (vwapSeries) { chart.removeSeries(vwapSeries); vwapSeries = null; }
      const volContainer = $('volumeContainer');
      const chartCard = $('chartCard');
      if (indicatorState.volume) {
        volContainer.classList.add('visible'); chartCard.classList.add('has-volume');
        if (volumeHistogramSeries && localVolumes.length > 0) volumeHistogramSeries.setData(localVolumes);
      } else {
        volContainer.classList.remove('visible'); chartCard.classList.remove('has-volume');
        if (volumeHistogramSeries) volumeHistogramSeries.setData([]);
      }
    }

    // ==================== DRAWING TOOLS ====================
    function initDrawingTools() {
      const toggle = $('drawingToolsToggle'); const menu = $('drawingToolsMenu'); const panel = $('drawingToolsPanel');
      const toolBtns = panel.querySelectorAll('.drawing-tool-btn');
      toggle.addEventListener('click', (e) => { e.stopPropagation(); isDrawingToolsOpen = !isDrawingToolsOpen; menu.classList.toggle('open', isDrawingToolsOpen); toggle.classList.toggle('active', isDrawingToolsOpen); });
      toolBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation(); const tool = btn.dataset.tool;
          if (tool === 'clear') { clearAllDrawings(); return; }
          toolBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active');
          currentDrawingTool = tool;
          if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        });
      });
      document.addEventListener('click', (e) => { if (!menu.contains(e.target)) { isDrawingToolsOpen = false; menu.classList.remove('open'); toggle.classList.remove('active'); } });
    }

    function clearAllDrawings() {
      drawnLines.forEach(line => { try { chart.removeSeries(line); } catch(e) {} }); drawnLines = [];
      if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    }

    function handleChartClick(param) {
      if (currentDrawingTool === 'cursor' || !param.point || !param.time) return;
      const price = candleSeries.coordinateToPrice(param.point.y);
      if (currentDrawingTool === 'horizline') { drawHorizontalLine(price); }
      else if (currentDrawingTool === 'trendline') {
        if (!isDrawing) { isDrawing = true; drawStartPoint = { time: param.time, price: price }; }
        else { drawTrendLine(drawStartPoint, { time: param.time, price: price }); isDrawing = false; drawStartPoint = null; }
      }
    }

    function drawHorizontalLine(price) {
      const line = chart.addLineSeries({ color: '#F0B90B', lineWidth: 1, lineStyle: 2, priceLineVisible: false, lastValueVisible: true, crosshairMarkerVisible: false });
      const now = Math.floor(Date.now() / 1000);
      line.setData([{ time: now - 365*86400, value: price }, { time: now + 365*86400, value: price }]);
      drawnLines.push(line);
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }

    function drawTrendLine(start, end) {
      const line = chart.addLineSeries({ color: '#1E90FF', lineWidth: 1, priceLineVisible: false, lastValueVisible: false, crosshairMarkerVisible: false });
      line.setData([{ time: start.time, value: start.price }, { time: end.time, value: end.price }]);
      drawnLines.push(line);
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }

    // ==================== OHLC TOOLTIP ====================
    function updateOHLCTooltip(param) {
      const tooltip = $('ohlcTooltip');
      if (!param || !param.time || !param.seriesData) { tooltip.classList.remove('visible'); return; }
      const candleData = param.seriesData.get(candleSeries);
      if (!candleData) { tooltip.classList.remove('visible'); return; }
      const { open, high, low, close } = candleData;
      const isUp = close >= open; const cls = isUp ? 'up' : 'down';
      $('ohlcOpen').textContent = formatPrice(open); $('ohlcOpen').className = `ohlc-value ${cls}`;
      $('ohlcHigh').textContent = formatPrice(high); $('ohlcHigh').className = `ohlc-value ${cls}`;
      $('ohlcLow').textContent = formatPrice(low); $('ohlcLow').className = `ohlc-value ${cls}`;
      $('ohlcClose').textContent = formatPrice(close); $('ohlcClose').className = `ohlc-value ${cls}`;
      const volData = localVolumes.find(v => v.time === param.time);
      $('ohlcVol').textContent = volData ? formatVolume(volData.value) : '--';
      $('ohlcVol').className = `ohlc-value ${cls}`;
      tooltip.classList.add('visible');
      requestAnimationFrame(() => { checkOhlcOverflow(); });
    }

    // ==================== DOUBLE TAP RESET ====================
    function setupDoubleTapHandler() {
      const chartEl = $('chart');
      chartEl.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTapTime < DOUBLE_TAP_DELAY && now - lastTapTime > 0) { e.preventDefault(); chart.timeScale().fitContent(); chart.priceScale('right').applyOptions({ autoScale: true }); if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium'); }
        lastTapTime = now;
      });
      chartEl.addEventListener('dblclick', (e) => { e.preventDefault(); chart.timeScale().fitContent(); chart.priceScale('right').applyOptions({ autoScale: true }); });
    }

    // ==================== PNL MODAL ====================
    let currentEquityPeriod = '7d';

    function openPnlModal() {
      $('pnlModalOverlay').classList.add('active'); document.body.style.overflow = 'hidden';
      renderModalStats(); renderEquityChart(currentEquityPeriod); renderCalendarPnL();
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }

    function closePnlModal() { $('pnlModalOverlay').classList.remove('active'); document.body.style.overflow = ''; }

    function renderModalStats() {
      if (!remoteHistory || remoteHistory.length === 0) { $('modalAvgRR').textContent = '--'; $('modalMaxDD').textContent = '--'; $('modalProfitFactor').textContent = '--'; $('modalAvgTrade').textContent = '--'; return; }
      let totalWins = 0, totalLosses = 0, winCount = 0, lossCount = 0, maxDrawdown = 0, peak = 0, runningPnL = 0;
      remoteHistory.forEach(trade => {
        const pnl = Number(trade.pnl); runningPnL += pnl;
        if (pnl > 0) { totalWins += pnl; winCount++; } else { totalLosses += Math.abs(pnl); lossCount++; }
        if (runningPnL > peak) peak = runningPnL;
        const dd = peak - runningPnL; if (dd > maxDrawdown) maxDrawdown = dd;
      });
      const avgWin = winCount > 0 ? totalWins / winCount : 0;
      const avgLoss = lossCount > 0 ? totalLosses / lossCount : 1;
      const avgRR = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : '--';
      const profitFactor = totalLosses > 0 ? (totalWins / totalLosses).toFixed(2) : (totalWins > 0 ? '∞' : '--');
      const avgTrade = remoteHistory.length > 0 ? (runningPnL / remoteHistory.length).toFixed(2) : '--';
      const rrEl = $('modalAvgRR'); rrEl.textContent = avgRR !== '--' ? `1:${avgRR}` : '--'; rrEl.className = `stats-metric-value ${Number(avgRR) >= 1 ? 'positive' : ''}`;
      $('modalMaxDD').textContent = maxDrawdown > 0 ? `-${maxDrawdown.toFixed(2)} VP` : '--';
      const pfEl = $('modalProfitFactor'); pfEl.textContent = profitFactor; pfEl.className = `stats-metric-value ${Number(profitFactor) >= 1 ? 'positive' : 'negative'}`;
      const atEl = $('modalAvgTrade'); atEl.textContent = avgTrade !== '--' ? `${Number(avgTrade) >= 0 ? '+' : ''}${avgTrade} VP` : '--'; atEl.className = `stats-metric-value ${Number(avgTrade) >= 0 ? 'positive' : 'negative'}`;
    }

    function renderEquityChart(period) {
      const container = $('equityChartContainer');
      if (equityChartInstance) { equityChartInstance.remove(); equityChartInstance = null; }
      equityChartInstance = LightweightCharts.createChart(container, {
        width: container.clientWidth, height: container.clientHeight,
        layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#848E9C' },
        grid: { horzLines: { color: 'rgba(255,255,255,0.03)' }, vertLines: { color: 'rgba(255,255,255,0.03)' } },
        rightPriceScale: { borderVisible: false }, timeScale: { borderVisible: false, timeVisible: true }, crosshair: { mode: 0 }
      });
      equityLineSeries = equityChartInstance.addAreaSeries({ topColor: 'rgba(14, 203, 129, 0.4)', bottomColor: 'rgba(14, 203, 129, 0.0)', lineColor: '#0ECB81', lineWidth: 2 });
      if (!remoteHistory || remoteHistory.length === 0) { equityLineSeries.setData([]); return; }
      const now = Date.now(); const periods = { '7d': 7*86400000, '30d': 30*86400000, '90d': 90*86400000, 'all': Infinity };
      const cutoff = periods[period] === Infinity ? 0 : now - periods[period];
      const filtered = remoteHistory.filter(h => new Date(h.closed_at).getTime() >= cutoff).sort((a, b) => new Date(a.closed_at) - new Date(b.closed_at));
      if (filtered.length === 0) { equityLineSeries.setData([]); return; }
      let equity = 1000;
      const equityData = [{ time: Math.floor(new Date(filtered[0].closed_at).getTime() / 1000) - 86400, value: equity }];
      filtered.forEach(trade => { equity += Number(trade.pnl); equityData.push({ time: Math.floor(new Date(trade.closed_at).getTime() / 1000), value: equity }); });
      const unique = equityData.filter((v, i, a) => a.findIndex(t => t.time === v.time) === i).sort((a, b) => a.time - b.time);
      equityLineSeries.setData(unique); equityChartInstance.timeScale().fitContent();
      const lastEq = unique[unique.length - 1]?.value || 1000; const isPos = lastEq >= 1000;
      equityLineSeries.applyOptions({ topColor: isPos ? 'rgba(14, 203, 129, 0.4)' : 'rgba(246, 70, 93, 0.4)', bottomColor: isPos ? 'rgba(14, 203, 129, 0.0)' : 'rgba(246, 70, 93, 0.0)', lineColor: isPos ? '#0ECB81' : '#F6465D' });
    }

    function renderCalendarPnL() {
      const grid = $('calendarGrid'); const monthLabel = $('calendarMonthLabel');
      const year = calendarCurrentMonth.getFullYear(); const month = calendarCurrentMonth.getMonth();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      monthLabel.textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1); const daysInMonth = new Date(year, month + 1, 0).getDate();
      let startDay = firstDay.getDay() - 1; if (startDay < 0) startDay = 6;
      const dailyPnL = {};
      if (remoteHistory && remoteHistory.length > 0) {
        remoteHistory.forEach(trade => { const d = new Date(trade.closed_at); if (d.getFullYear() === year && d.getMonth() === month) { const day = d.getDate(); dailyPnL[day] = (dailyPnL[day] || 0) + Number(trade.pnl); } });
      }
      const maxPnL = Math.max(...Object.values(dailyPnL).map(Math.abs), 1);
      const today = new Date(); const isCurrentMonth = month === today.getMonth() && year === today.getFullYear();
      let html = '';
      for (let i = 0; i < startDay; i++) html += '<div class="calendar-cell empty"></div>';
      for (let day = 1; day <= daysInMonth; day++) {
        const pnl = dailyPnL[day]; let cls = 'calendar-cell';
        if (pnl !== undefined) { cls += pnl >= 0 ? ' profit' : ' loss'; if (Math.abs(pnl) / maxPnL > 0.5) cls += ' high'; }
        if (isCurrentMonth && day === today.getDate()) cls += ' today';
        const title = pnl !== undefined ? `${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP` : 'No trades';
        html += `<div class="${cls}" title="${title}">${day}</div>`;
      }
      grid.innerHTML = html;
    }

    function changeCalendarMonth(delta) { calendarCurrentMonth.setMonth(calendarCurrentMonth.getMonth() + delta); renderCalendarPnL(); if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }

    function initPnlModal() {
      $('netPnlCard').addEventListener('click', openPnlModal);
      $('pnlModalClose').addEventListener('click', closePnlModal);
      $('pnlModalOverlay').addEventListener('click', (e) => { if (e.target === $('pnlModalOverlay')) closePnlModal(); });
      $('calendarPrev').addEventListener('click', () => changeCalendarMonth(-1));
      $('calendarNext').addEventListener('click', () => changeCalendarMonth(1));
      document.querySelectorAll('#equityPeriodSelector .period-btn').forEach(btn => {
        btn.addEventListener('click', () => { document.querySelectorAll('#equityPeriodSelector .period-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentEquityPeriod = btn.dataset.period; renderEquityChart(currentEquityPeriod); });
      });
    }

    function initIndicatorChips() { document.querySelectorAll('.indicator-chip').forEach(chip => { chip.addEventListener('click', () => toggleIndicator(chip.dataset.indicator)); }); }

    // ==================== VIEW MANAGEMENT ====================
    function showView(viewId) {
      document.querySelectorAll('.view-section').forEach(el => { el.classList.remove('active'); el.classList.add('hidden'); });
      const target = $(viewId); target.classList.remove('hidden'); target.classList.add('active');
      if (viewId === 'view-profile') { if(tg) tg.BackButton.show(); }
      else if (viewId === 'view-trade') { if(tg) tg.BackButton.hide(); }
      else if (viewId === 'view-rewards') { loadAdStats(); }
    }

    $('btnProfile').onclick = () => { renderProfile(); showView('view-profile'); };
    $('btnCloseProfile').onclick = () => showView('view-trade');
    $('btnGoRewards').onclick = () => showView('view-rewards');
    $('btnBackFromRewards').onclick = () => showView('view-profile');
    $('btnWatchAd').onclick = () => showRewardedAd();

    if(tg) { tg.BackButton.onClick(() => { const vr = $('view-rewards'), vp = $('view-profile'); if(vr.classList.contains('active')) showView('view-profile'); else if(vp.classList.contains('active')) showView('view-trade'); }); }

    const btnEye = $('btnToggleBalance');
    if(btnEye) { btnEye.onclick = (e) => { e.stopPropagation(); isBalanceHidden = !isBalanceHidden; btnEye.src = isBalanceHidden ? ICON_EYE_CLOSED : ICON_EYE_OPEN; updateBalanceUI(); }; }

    document.querySelectorAll('.h-filter').forEach(btn => {
      btn.addEventListener('click', () => { document.querySelectorAll('.h-filter').forEach(b => b.classList.remove('active')); btn.classList.add('active'); historyFilterMode = btn.dataset.filter; renderHistoryList(); });
    });

    // ==================== UTILS ====================
    function notify(msg) {
      try { if(tg && typeof tg.showPopup === 'function') { tg.showPopup({ title: 'Info', message: msg, buttons: [{type:'ok'}] }); return; } } catch(e) {}
      alert(msg);
    }

    async function copyTextToClipboard(text) {
      const t = String(text || ""); if(!t) return false;
      try { if(tg?.Clipboard?.writeText) { await tg.Clipboard.writeText(t); return true; } } catch(e) {}
      try { if(navigator.clipboard?.writeText) { await navigator.clipboard.writeText(t); return true; } } catch(e) {}
      try { const tmp = document.createElement('textarea'); tmp.value = t; tmp.style.position = 'fixed'; tmp.style.left = '-9999px'; document.body.appendChild(tmp); tmp.focus(); tmp.select(); const ok = document.execCommand('copy'); document.body.removeChild(tmp); return ok; } catch(e) { return false; }
    }

    const btnCopyRefLink = $('btnCopyRefLink');
    if(btnCopyRefLink) { btnCopyRefLink.onclick = async () => { const ok = await copyTextToClipboard($('refLinkInput')?.value); notify(ok ? 'Referral link copied' : 'Copy failed'); }; }

    function escapeHtml(str) { return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }

    // ==================== PROFILE ====================
    async function renderProfile() {
      $('profileName').textContent = profile.name || "Trader";
      $('profileId').textContent = "ID: " + profile.id;
      updateBalanceUI();
      if(profile.photo) $('profileAvatarBig').src = profile.photo;
      try { const res = await fetch(API_BASE + "/api/user/history?userId=" + currentUserId); const data = await res.json(); if(data.ok) remoteHistory = data.history; } catch(e) { console.error("History fetch error", e); }
      let totalPnL = 0, wins = 0, count = remoteHistory.length;
      remoteHistory.forEach(h => { const p = Number(h.pnl); totalPnL += p; if(p > 0) wins++; });
      const pnlEl = $('statPnL'); pnlEl.textContent = (totalPnL > 0 ? "+" : "") + totalPnL.toFixed(2) + " VP"; pnlEl.className = (totalPnL >= 0 ? "text-green" : "text-red");
      let winRate = count > 0 ? Math.round((wins / count) * 100) : 0;
      $('winRateVal').textContent = winRate + "%"; $('totalTradesVal').textContent = count + " Trades";
      const chartColor = winRate >= 50 ? '#0ECB81' : '#F6465D';
      $('winRateChart').style.background = `conic-gradient(${chartColor} 0% ${winRate}%, var(--panel-light) ${winRate}% 100%)`;
      renderHistoryList(); await renderReferrals();
    }

    async function renderReferrals() {
      const listEl = $('refList'), linkInput = $('refLinkInput'), badge = $('refCountBadge');
      if(!listEl || !linkInput || !badge) return;
      listEl.innerHTML = "<div class='ref-status'>Loading referrals...</div>";
      linkInput.value = "Loading..."; badge.textContent = "Invited: ...";
      try {
        const res = await fetch(API_BASE + "/api/user/referrals?userId=" + encodeURIComponent(currentUserId));
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || 'REFERRALS_ERROR');
        linkInput.value = data.referralLink || ""; badge.textContent = "Invited: " + Number(data.invitedCount || 0);
        const invited = Array.isArray(data.invited) ? data.invited : [];
        listEl.innerHTML = "";
        if(invited.length === 0) { listEl.innerHTML = "<div class='ref-status'>No referrals yet</div>"; return; }
        invited.slice(0, 50).forEach(u => {
          const div = document.createElement('div'); div.className = 'ref-item';
          const name = u.first_name || 'User';
          const when = u.invited_at ? new Date(u.invited_at) : (u.created_at ? new Date(u.created_at) : null);
          const dateStr = when ? when.toLocaleDateString([], {month:'2-digit', day:'2-digit', year:'2-digit'}) : '--';
          const photo = u.photo_url || '';
          div.innerHTML = `<div class="ref-item-left"><div class="ref-avatar">${photo ? `<img src="${photo}" alt="">` : ''}</div><div class="ref-name">${escapeHtml(name)}</div></div><div class="ref-date">${dateStr}</div>`;
          listEl.appendChild(div);
        });
      } catch(e) { listEl.innerHTML = "<div class='ref-status'>Failed to load referrals</div>"; console.error('Referrals fetch error', e); }
    }

    function renderHistoryList() {
      const list = $('historyList'); list.innerHTML = "";
      if(remoteHistory.length === 0) { list.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trading history yet</div>'; return; }
      const now = Date.now();
      const filtered = remoteHistory.filter(h => { if(historyFilterMode === 'all') return true; const t = new Date(h.closed_at).getTime(); if(historyFilterMode === 'day') return (now - t) < 86400000; if(historyFilterMode === 'week') return (now - t) < 604800000; return true; });
      if(filtered.length === 0) { list.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px; font-size:13px;">No trades in this period</div>'; return; }
      filtered.slice(0, 50).forEach(h => {
        const pnlVal = Number(h.pnl), sizeVal = Number(h.size), commVal = Number(h.commission || 0);
        const entryVal = Number(h.entry_price), exitVal = Number(h.exit_price);
        const pnlClass = pnlVal >= 0 ? "text-green" : "text-red";
        const dateStr = new Date(h.closed_at).toLocaleString([], {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
        const div = document.createElement('div'); div.className = "history-card";
        div.innerHTML = `<div class="hc-header"><div class="hc-pair">${h.pair||"UNK"}</div><div class="hc-type ${h.type==='LONG'?'long':'short'}">${h.type} x${h.leverage}</div></div><div class="hc-row"><span>Size: <span class="hc-val">${sizeVal.toFixed(0)}</span></span><span>${dateStr}</span></div><div class="hc-row"><span>Entry: <span class="hc-val">${formatPrice(entryVal)}</span></span><span>Exit: <span class="hc-val">${formatPrice(exitVal)}</span></span></div><div class="hc-row" style="margin-top:4px; border-top:1px solid var(--border); padding-top:4px;"><span>Fee: <span style="color:var(--muted)">-${commVal.toFixed(2)}</span></span><span class="hc-pnl ${pnlClass}">${pnlVal > 0 ? '+' : ''}${pnlVal.toFixed(2)} VP</span></div>`;
        list.appendChild(div);
      });
    }

    // ==================== PAIR / TIMEFRAME ====================
    const pairDropdown = $('pairDropdown'), pairTrigger = $('pairTrigger'), triggerText = $('triggerText');
    const pairItems = document.querySelectorAll('.pair-item');

    pairTrigger.addEventListener('click', (e) => { e.stopPropagation(); pairDropdown.classList.toggle('open'); });
    document.addEventListener('click', () => pairDropdown.classList.remove('open'));

    pairItems.forEach(item => {
      item.addEventListener('click', () => {
        const newPair = item.dataset.pair; if(newPair === selectedPair) return;
        pairItems.forEach(i => i.classList.remove('active')); item.classList.add('active');
        triggerText.textContent = item.textContent; switchPair(newPair);
      });
    });

    function switchPair(newPair) {
      selectedPair = newPair; $('bookPairLabel').textContent = selectedPair;
      $('priceDisplay').textContent = marketPrices[selectedPair] ? formatPrice(marketPrices[selectedPair]) : "--.--";
      $('orderBook').innerHTML = ''; $('tradeHistory').innerHTML = ""; localTrades = [];
      candleSeries.setData([]); lastCandle = null; localCandles = []; localVolumes = [];
      isLoadingMoreHistory = false; allOlderHistoryLoaded = false; lastLoadMoreUntil = null; lockedLeftBoundary = null;
      hideChartLoadingOverlay(); chart.timeScale().fitContent(); chart.priceScale('right').applyOptions({ autoScale: true });
      Object.keys(indicatorState).forEach(key => { if (key !== 'volume') { indicatorState[key] = false; } const chipId = key === 'ema' ? 'chipEMA' : key === 'sma' ? 'chipSMA' : key === 'vwap' ? 'chipVWAP' : 'chipVolume'; if (key !== 'volume') $(chipId)?.classList.remove('active'); });
      if (emaSeries) { chart.removeSeries(emaSeries); emaSeries = null; }
      if (smaSeries) { chart.removeSeries(smaSeries); smaSeries = null; }
      if (vwapSeries) { chart.removeSeries(vwapSeries); vwapSeries = null; }
      clearAllDrawings();
      if (volumeHistogramSeries) volumeHistogramSeries.setData([]);
      if (socket && socket.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ type: "subscribe", pair: newPair, timeframe: currentTimeframe })); }
    }

    function changeTimeframe(newTimeframe) {
      newTimeframe = parseInt(newTimeframe); if (currentTimeframe === newTimeframe) return;
      currentTimeframe = newTimeframe;
      document.querySelectorAll('.tf-opt').forEach(opt => { opt.classList.toggle('active', parseInt(opt.dataset.tf) === currentTimeframe); });
      candleSeries.setData([]); lastCandle = null; localCandles = []; localVolumes = [];
      isLoadingHistory = false; allHistoryLoaded = false; isLoadingMoreHistory = false; allOlderHistoryLoaded = false;
      lastLoadMoreUntil = null; lockedLeftBoundary = null; hideChartLoadingOverlay();
      chart.timeScale().fitContent(); chart.priceScale('right').applyOptions({ autoScale: true });
      if (volumeHistogramSeries) volumeHistogramSeries.setData([]);
      updateIndicators();
      if (socket && socket.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ type: "subscribe", pair: selectedPair, timeframe: currentTimeframe })); }
    }

    document.querySelectorAll('.tf-opt').forEach(opt => { opt.addEventListener('click', () => changeTimeframe(opt.dataset.tf)); });

    // ==================== CHART SETUP ====================
    const chartEl = $('chart');
    const chartLoadingOverlay = $('chartLoadingOverlay');
    const volumeChartEl = $('volumeChart');

    const chart = LightweightCharts.createChart(chartEl, {
      width: chartEl.clientWidth, height: chartEl.clientHeight,
      layout: { background: { type: 'solid', color: '#0B0E11' }, textColor: '#5E6673' },
      grid: { horzLines: { color: 'rgba(255,255,255,0.03)' }, vertLines: { color: 'rgba(255,255,255,0.03)' } },
      rightPriceScale: { borderVisible: false, autoScale: true, scaleMargins: { top: 0.1, bottom: 0.1 } },
      timeScale: { borderVisible: false, timeVisible: true, rightOffset: 5 },
      crosshair: { vertLine: { color: 'rgba(255,255,255,0.1)', style: 3 }, horzLine: { color: 'rgba(255,255,255,0.1)', style: 3 } }
    });

    let candleSeries = chart.addCandlestickSeries({
      upColor: '#0ECB81', borderUpColor: '#0ECB81', wickUpColor: '#0ECB81',
      downColor: '#F6465D', borderDownColor: '#F6465D', wickDownColor: '#F6465D'
    });

    volumeChartInstance = LightweightCharts.createChart(volumeChartEl, {
      width: volumeChartEl.clientWidth, height: volumeChartEl.clientHeight,
      layout: { background: { type: 'solid', color: '#0B0E11' }, textColor: '#5E6673' },
      grid: { horzLines: { visible: false }, vertLines: { visible: false } },
      rightPriceScale: { borderVisible: false, scaleMargins: { top: 0.1, bottom: 0 } },
      timeScale: { visible: false }, crosshair: { mode: 0 }
    });
    volumeHistogramSeries = volumeChartInstance.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: '' });

    chart.timeScale().subscribeVisibleLogicalRangeChange(range => { if (range) volumeChartInstance.timeScale().setVisibleLogicalRange(range); });
    chart.subscribeCrosshairMove(updateOHLCTooltip);
    chart.subscribeClick(handleChartClick);

    new ResizeObserver(entries => { if (entries.length === 0 || entries[0].target !== chartEl) return; const r = entries[0].contentRect; chart.applyOptions({ width: r.width, height: r.height }); checkResponsiveOverflows(); }).observe(chartEl);
    new ResizeObserver(entries => { if (entries.length === 0) return; const r = entries[0].contentRect; volumeChartInstance.applyOptions({ width: r.width, height: r.height }); }).observe(volumeChartEl);
    const marketHeaderEl = $('marketHeader');
    if (marketHeaderEl) { new ResizeObserver(() => { checkTfSelectorOverflow(); }).observe(marketHeaderEl); }

    // ==================== HISTORY LOADING ====================
    let isLoadingMoreHistory = false;
    let allOlderHistoryLoaded = false;
    let lastLoadMoreUntil = null;
    let lockedLeftBoundary = null;

    function showChartLoadingOverlay() { if (chartLoadingOverlay) chartLoadingOverlay.classList.add('active'); }
    function hideChartLoadingOverlay() { if (chartLoadingOverlay) chartLoadingOverlay.classList.remove('active'); }

    chart.timeScale().subscribeVisibleTimeRangeChange(timeRange => {
      if (!timeRange) return;
      if (isLoadingMoreHistory && lockedLeftBoundary !== null) { if (timeRange.from < lockedLeftBoundary) { const cr = chart.timeScale().getVisibleRange(); if (cr) { const dur = cr.to - cr.from; chart.timeScale().setVisibleRange({ from: lockedLeftBoundary, to: lockedLeftBoundary + dur }); } return; } }
      if (allOlderHistoryLoaded || isLoadingMoreHistory) return;
      if (!localCandles || localCandles.length === 0) return;
      const oldest = localCandles[0].time; const visRange = timeRange.to - timeRange.from;
      if (timeRange.from <= oldest + (visRange * 0.05)) requestMoreHistory();
    });

    async function requestMoreHistory() {
      if (isLoadingMoreHistory || allOlderHistoryLoaded) return;
      if (!localCandles || localCandles.length === 0) return;
      const oldest = localCandles[0].time; if (lastLoadMoreUntil === oldest) return;
      lastLoadMoreUntil = oldest; isLoadingMoreHistory = true; lockedLeftBoundary = oldest; showChartLoadingOverlay();
      if (socket && socket.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ type: "loadMore", pair: selectedPair, timeframe: currentTimeframe, until: oldest })); }
      else { isLoadingMoreHistory = false; lockedLeftBoundary = null; hideChartLoadingOverlay(); }
    }

    // ==================== SLIDERS ====================
    const leverageSlider = $('leverageSlider'); const levDisplay = $('leverageValText'); const levChips = document.querySelectorAll('.chip');

    function updateSliderTrack(slider, pct) { slider.style.background = `linear-gradient(to right, var(--accent-green) 0%, var(--accent-green) ${pct}%, #2A2F36 ${pct}%, #2A2F36 100%)`; }

    function updateLeverageUI(val) {
      currentLeverage = parseInt(val); leverageSlider.value = currentLeverage; levDisplay.textContent = currentLeverage + 'x';
      levChips.forEach(chip => chip.classList.toggle('active', parseInt(chip.dataset.v) === currentLeverage));
      updateSliderTrack(leverageSlider, ((currentLeverage - 1) / 49) * 100);
    }
    leverageSlider.addEventListener('input', (e) => updateLeverageUI(e.target.value));
    levChips.forEach(chip => chip.addEventListener('click', () => updateLeverageUI(chip.dataset.v)));
    updateLeverageUI(10);

    const marginSlider = $('marginSlider'); const marginPercentText = $('marginPercentText'); const sizeInput = $('sizeInput');
    const marginMarks = document.querySelectorAll('.margin-mark');
    const SNAP_POINTS = [0, 25, 50, 75, 100]; const SNAP_THRESHOLD = 4;

    function snapToMagneticPoint(value) { for (const point of SNAP_POINTS) { if (Math.abs(value - point) <= SNAP_THRESHOLD) return point; } return value; }

    function updateMarginSliderUI(pct, fromInput = false, skipSnap = false) {
      pct = Math.max(0, Math.min(100, parseInt(pct) || 0));
      if (!skipSnap && !fromInput) pct = snapToMagneticPoint(pct);
      marginSlider.value = pct; marginPercentText.textContent = pct + '%';
      updateSliderTrack(marginSlider, pct);
      marginMarks.forEach(mark => mark.classList.toggle('active', parseInt(mark.dataset.pct) === pct));
      if (!fromInput && profile.balance > 0) { const marginVal = Math.floor((profile.balance * pct) / 100); sizeInput.value = marginVal > 0 ? marginVal : ''; }
    }

    let lastSnappedValue = null;
    marginSlider.addEventListener('input', (e) => {
      const raw = parseInt(e.target.value); const snapped = snapToMagneticPoint(raw);
      if (snapped !== raw && snapped !== lastSnappedValue) { if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); lastSnappedValue = snapped; } else if (snapped === raw) { lastSnappedValue = null; }
      updateMarginSliderUI(snapped, false, true);
    });
    marginMarks.forEach(mark => { mark.addEventListener('click', () => { updateMarginSliderUI(mark.dataset.pct, false, true); if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }); });
    sizeInput.addEventListener('input', () => { if (profile.balance > 0) { const pct = Math.min(100, Math.round((Number(sizeInput.value) || 0) / profile.balance * 100)); updateMarginSliderUI(pct, true); } });
    updateMarginSliderUI(0);

    // ==================== BALANCE ====================
    let historyResolve = null;
    const historyPromise = new Promise(r => historyResolve = r);

    function updateBalanceUI() {
      const val = profile.balance.toFixed(2); const usdVal = formatUSD(profile.balance);
      $('headerBalance').textContent = isBalanceHidden ? "******" : (val + " VP");
      const elProBal = $('profileBalance'); if(elProBal) elProBal.textContent = isBalanceHidden ? "****" : val;
      const elApprox = $('profileBalanceApprox'); if(elApprox) elApprox.textContent = isBalanceHidden ? "≈ $****" : `≈ $${usdVal}`;
      const currentMarginPct = parseInt(marginSlider.value) || 0;
      if (currentMarginPct > 0) updateMarginSliderUI(currentMarginPct, false, true);
    }

    // ==================== TP/SL MODULE ====================

    function getTpSlOrdersForPosition(positionId) {
      return (window._tpSlOrders || []).filter(o => String(o.position_id) === String(positionId) && o.status === 'ACTIVE');
    }

    function getTpSlCounts(positionId) {
      const orders = getTpSlOrdersForPosition(positionId);
      return {
        tp: orders.filter(o => o.order_type === 'TP').length,
        sl: orders.filter(o => o.order_type === 'SL').length,
        tpUsed: orders.filter(o => o.order_type === 'TP').reduce((s, o) => s + Number(o.size_percent), 0),
        slUsed: orders.filter(o => o.order_type === 'SL').reduce((s, o) => s + Number(o.size_percent), 0)
      };
    }

    function calculateTpSlPnl(position, triggerPrice, sizePercent) {
      const entry = Number(position.entry_price || position.entryPrice);
      const size = Number(position.size);
      const margin = Number(position.margin);
      const type = (position.type || 'LONG').toUpperCase();
      const trig = Number(triggerPrice);
      const pct = Number(sizePercent) || 100;

      const closeSize = (size * pct) / 100;
      const closeMargin = (margin * pct) / 100;

      const priceChange = (trig - entry) / entry;
      let pnl = priceChange * closeSize;
      if (type === 'SHORT') pnl = -pnl;

      const commission = closeSize * 0.0003;
      pnl -= commission;

      const roe = closeMargin > 0 ? (pnl / closeMargin) * 100 : 0;

      return { pnl, roe, closeSize, closeMargin };
    }

    function getHintText(posType, orderType) {
      const isTP = orderType === 'TP';
      if (posType === 'LONG') {
        return isTP ? 'Must be above current price' : 'Must be below current price';
      } else {
        return isTP ? 'Must be below current price' : 'Must be above current price';
      }
    }

    function openTpSlModal(positionId, orderType) {
      const pos = (window._positions || []).find(p => String(p.id || p._id) === String(positionId));
      if (!pos) return;

      tpslModalState = { positionId, orderType, tab: 'full', position: pos };

      const isTP = orderType === 'TP';
      const posType = (pos.type || 'LONG').toUpperCase();
      const pair = normalizePair(pos.pair || 'BTC-USD');
      const currentPrice = marketPrices[pair];

      $('tpslModalTitle').textContent = isTP ? 'Take Profit' : 'Stop Loss';
      $('tpslModalTitle').style.color = isTP ? 'var(--accent-green)' : 'var(--accent-red)';
      $('tpslModalSubtitle').textContent = isTP ? 'Lock in profits at target price' : 'Limit losses at trigger price';

      const typeEl = $('tpslPositionType');
      typeEl.textContent = posType;
      typeEl.className = `tpsl-position-type ${posType.toLowerCase()}`;
      $('tpslPositionPair').textContent = pair;
      $('tpslPositionLeverage').textContent = `x${pos.leverage}`;
      $('tpslEntryPrice').textContent = formatPrice(pos.entry_price);
      $('tpslMarkPrice').textContent = currentPrice ? formatPrice(currentPrice) : '--.--';

      const hint = getHintText(posType, orderType);
      $('tpslPriceHint').textContent = hint;
      $('tpslPriceHintPartial').textContent = hint;

      $('tpslPriceInput').value = '';
      $('tpslPriceInput').classList.remove('error');
      $('tpslErrorText').textContent = '';
      $('tpslExpectedPnl').textContent = '-- VP';
      $('tpslExpectedPnl').className = 'tpsl-pnl-value';
      $('tpslExpectedRoe').textContent = '--%';
      $('tpslExpectedRoe').className = 'tpsl-pnl-value';
      $('tpslCloseSize').textContent = '100%';

      $('tpslPriceInputPartial').value = '';
      $('tpslPriceInputPartial').classList.remove('error');
      $('tpslErrorTextPartial').textContent = '';
      $('tpslExpectedPnlPartial').textContent = '-- VP';
      $('tpslExpectedPnlPartial').className = 'tpsl-pnl-value';
      $('tpslExpectedRoePartial').textContent = '--%';
      $('tpslExpectedRoePartial').className = 'tpsl-pnl-value';
      $('tpslCloseSizePartial').textContent = '-- VP';

      $('tpslTabFull').classList.add('active');
      $('tpslTabPartial').classList.remove('active');
      $('tabFull').classList.add('active');
      $('tabPartial').classList.remove('active');
      tpslModalState.tab = 'full';

      const counts = getTpSlCounts(positionId);
      const usedPct = isTP ? counts.tpUsed : counts.slUsed;
      const availablePct = Math.max(0, 100 - usedPct);
      const slider = $('tpslSizeSlider');
      slider.max = Math.max(10, availablePct);
      slider.value = Math.min(50, availablePct);
      $('tpslSizeValue').textContent = slider.value + '%';
      $('tpslAvailableSize').textContent = Math.floor(availablePct) + '%';
      $('tpslUsedPercent').textContent = Math.floor(usedPct);
      updateSliderTrack(slider, ((Number(slider.value) - 10) / (Number(slider.max) - 10)) * 100);

      document.querySelectorAll('.tpsl-size-mark').forEach(m => {
        m.classList.toggle('active', Number(m.dataset.size) === Number(slider.value));
      });

      const fullBtn = $('tpslSubmitFull');
      const partialBtn = $('tpslSubmitPartial');
      fullBtn.className = `tpsl-submit-btn ${isTP ? 'tp-confirm' : 'sl-confirm'}`;
      fullBtn.innerHTML = `<span>Confirm ${isTP ? 'Take Profit' : 'Stop Loss'}</span>`;
      fullBtn.disabled = true;
      partialBtn.className = `tpsl-submit-btn ${isTP ? 'tp-confirm' : 'sl-confirm'}`;
      partialBtn.innerHTML = `<span>Confirm Partial ${isTP ? 'TP' : 'SL'}</span>`;
      partialBtn.disabled = true;

      const maxReached = isTP ? counts.tp >= MAX_TP_PER_POSITION : counts.sl >= MAX_SL_PER_POSITION;
      $('tpslLimitNotice').style.display = maxReached ? 'block' : 'none';
      $('tpslLimitNoticePartial').style.display = maxReached ? 'block' : 'none';
      if (maxReached) {
        const limitText = `Maximum ${isTP ? MAX_TP_PER_POSITION : MAX_SL_PER_POSITION} ${isTP ? 'TP' : 'SL'} orders reached`;
        $('tpslLimitNotice').textContent = limitText;
        $('tpslLimitNoticePartial').textContent = limitText;
      }

      renderExistingOrdersInModal(positionId, isTP);

      $('tpslModalOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }

    function renderExistingOrdersInModal(positionId, isTP) {
      const orders = getTpSlOrdersForPosition(positionId).filter(o => o.order_type === (isTP ? 'TP' : 'SL'));
      const pos = tpslModalState.position;

      const fullContainer = $('tpslExistingOrders');
      const fullList = $('tpslExistingList');
      const partialContainer = $('tpslExistingOrdersPartial');
      const partialList = $('tpslExistingListPartial');

      if (orders.length === 0) {
        fullContainer.style.display = 'none';
        partialContainer.style.display = 'none';
        return;
      }

      fullContainer.style.display = 'block';
      partialContainer.style.display = 'block';

      let html = '';
      orders.forEach(order => {
        const { pnl } = calculateTpSlPnl(pos, order.trigger_price, order.size_percent);
        html += `<div class="tpsl-existing-item">
          <span class="tpsl-existing-item-type ${isTP ? 'tp' : 'sl'}">${order.order_type} @ ${formatPrice(order.trigger_price)}</span>
          <span class="tpsl-existing-item-info">${Number(order.size_percent).toFixed(0)}% · ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP</span>
        </div>`;
      });

      fullList.innerHTML = html;
      partialList.innerHTML = html;
    }

    function closeTpSlModal() {
      $('tpslModalOverlay').classList.remove('active');
      document.body.style.overflow = '';
      tpslModalState = { positionId: null, orderType: null, tab: 'full', position: null };
    }

    function validateTpSlPriceForTab(tab) {
      const pos = tpslModalState.position;
      if (!pos) return false;

      const isPartial = tab === 'partial';
      const inputEl = $(isPartial ? 'tpslPriceInputPartial' : 'tpslPriceInput');
      const errorEl = $(isPartial ? 'tpslErrorTextPartial' : 'tpslErrorText');
      const submitBtn = $(isPartial ? 'tpslSubmitPartial' : 'tpslSubmitFull');
      const pnlEl = $(isPartial ? 'tpslExpectedPnlPartial' : 'tpslExpectedPnl');
      const roeEl = $(isPartial ? 'tpslExpectedRoePartial' : 'tpslExpectedRoe');
      const closeSizeEl = $(isPartial ? 'tpslCloseSizePartial' : 'tpslCloseSize');

      inputEl.classList.remove('error');
      errorEl.textContent = '';
      submitBtn.disabled = true;

      const triggerPrice = Number(inputEl.value);

      if (!triggerPrice || triggerPrice <= 0) {
        pnlEl.textContent = '-- VP'; pnlEl.className = 'tpsl-pnl-value';
        roeEl.textContent = '--%'; roeEl.className = 'tpsl-pnl-value';
        if (closeSizeEl) closeSizeEl.textContent = isPartial ? '-- VP' : '100%';
        return false;
      }

      const posType = (pos.type || 'LONG').toUpperCase();
      const pair = normalizePair(pos.pair || 'BTC-USD');
      const currentPrice = marketPrices[pair];
      const isTP = tpslModalState.orderType === 'TP';

      if (currentPrice) {
        if (isTP) {
          if (posType === 'LONG' && triggerPrice <= currentPrice) {
            inputEl.classList.add('error');
            errorEl.textContent = `TP must be above current price (${formatPrice(currentPrice)})`;
            return false;
          }
          if (posType === 'SHORT' && triggerPrice >= currentPrice) {
            inputEl.classList.add('error');
            errorEl.textContent = `TP must be below current price (${formatPrice(currentPrice)})`;
            return false;
          }
        } else {
          if (posType === 'LONG' && triggerPrice >= currentPrice) {
            inputEl.classList.add('error');
            errorEl.textContent = `SL must be below current price (${formatPrice(currentPrice)})`;
            return false;
          }
          if (posType === 'SHORT' && triggerPrice <= currentPrice) {
            inputEl.classList.add('error');
            errorEl.textContent = `SL must be above current price (${formatPrice(currentPrice)})`;
            return false;
          }
        }
      }

      const counts = getTpSlCounts(tpslModalState.positionId);
      const maxCount = isTP ? MAX_TP_PER_POSITION : MAX_SL_PER_POSITION;
      const currentCount = isTP ? counts.tp : counts.sl;
      if (currentCount >= maxCount) {
        const noticeId = isPartial ? 'tpslLimitNoticePartial' : 'tpslLimitNotice';
        $(noticeId).style.display = 'block';
        return false;
      }

      const sizePercent = isPartial ? Number($('tpslSizeSlider').value) : 100;
      const { pnl, roe, closeSize } = calculateTpSlPnl(pos, triggerPrice, sizePercent);

      pnlEl.textContent = `${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} VP`;
      pnlEl.className = `tpsl-pnl-value ${pnl >= 0 ? 'positive' : 'negative'}`;

      roeEl.textContent = `${roe >= 0 ? '+' : ''}${roe.toFixed(2)}%`;
      roeEl.className = `tpsl-pnl-value ${roe >= 0 ? 'positive' : 'negative'}`;

      if (closeSizeEl) {
        closeSizeEl.textContent = isPartial ? `${closeSize.toFixed(2)} VP` : '100%';
      }

      submitBtn.disabled = false;
      return true;
    }

    async function confirmTpSlOrder(tab) {
      if (!tpslModalState.positionId || !tpslModalState.orderType) return;

      const isPartial = tab === 'partial';
      const inputEl = $(isPartial ? 'tpslPriceInputPartial' : 'tpslPriceInput');
      const submitBtn = $(isPartial ? 'tpslSubmitPartial' : 'tpslSubmitFull');
      const errorEl = $(isPartial ? 'tpslErrorTextPartial' : 'tpslErrorText');

      const triggerPrice = Number(inputEl.value);
      if (!triggerPrice || triggerPrice <= 0) return;

      const sizePercent = isPartial ? Number($('tpslSizeSlider').value) : 100;
      const isTP = tpslModalState.orderType === 'TP';

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>Processing...</span>';

      try {
        const res = await fetch(API_BASE + "/api/tp-sl/create", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: currentUserId,
            positionId: tpslModalState.positionId,
            orderType: tpslModalState.orderType,
            triggerPrice: triggerPrice,
            sizePercent: sizePercent
          })
        });
        const data = await res.json();
        if (data.ok) {
          if (data.allOrders) {
            window._tpSlOrders = window._tpSlOrders.filter(o => String(o.position_id) !== String(tpslModalState.positionId));
            window._tpSlOrders.push(...data.allOrders);
          }
          closeTpSlModal();
          renderPositions(true);
          if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
          notify(`${isTP ? 'Take Profit' : 'Stop Loss'} set at ${formatPrice(triggerPrice)}`);
        } else {
          submitBtn.disabled = false;
          submitBtn.innerHTML = `<span>Confirm ${isTP ? (isPartial ? 'Partial TP' : 'Take Profit') : (isPartial ? 'Partial SL' : 'Stop Loss')}</span>`;
          let errorMsg = data.error || 'Failed to create order';
          if (data.error === 'EXCEEDS_AVAILABLE_VOLUME') {
            errorMsg = `Exceeds available volume. Available: ${data.availablePercent}%`;
          }
          errorEl.textContent = errorMsg;
        }
      } catch (e) {
        console.error("TP/SL create error:", e);
        submitBtn.disabled = false;
        submitBtn.innerHTML = `<span>Confirm ${isTP ? (isPartial ? 'Partial TP' : 'Take Profit') : (isPartial ? 'Partial SL' : 'Stop Loss')}</span>`;
        errorEl.textContent = 'Network error. Try again.';
      }
    }

    async function deleteTpSlOrder(orderId) {
      try {
        const res = await fetch(API_BASE + "/api/tp-sl/delete", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: currentUserId, orderId: orderId })
        });
        const data = await res.json();
        if (data.ok) {
          window._tpSlOrders = window._tpSlOrders.filter(o => String(o.id) !== String(orderId));
          if (data.allOrders) {
            const posId = data.allOrders.length > 0 ? data.allOrders[0].position_id : null;
            if (posId) {
              window._tpSlOrders = window._tpSlOrders.filter(o => String(o.position_id) !== String(posId));
              window._tpSlOrders.push(...data.allOrders);
            }
          }
          renderPositions(true);
          if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        } else { notify(data.error || 'Failed to delete order'); }
      } catch (e) { console.error("TP/SL delete error:", e); notify('Network error'); }
    }

    function initTpSlModal() {
      $('tpslModalClose').addEventListener('click', closeTpSlModal);
      $('tpslModalOverlay').addEventListener('click', (e) => { if (e.target === $('tpslModalOverlay')) closeTpSlModal(); });

      $('tpslTabFull').addEventListener('click', () => {
        tpslModalState.tab = 'full';
        $('tpslTabFull').classList.add('active');
        $('tpslTabPartial').classList.remove('active');
        $('tabFull').classList.add('active');
        $('tabPartial').classList.remove('active');
      });

      $('tpslTabPartial').addEventListener('click', () => {
        tpslModalState.tab = 'partial';
        $('tpslTabPartial').classList.add('active');
        $('tpslTabFull').classList.remove('active');
        $('tabPartial').classList.add('active');
        $('tabFull').classList.remove('active');
      });

      $('tpslPriceInput').addEventListener('input', () => validateTpSlPriceForTab('full'));
      $('tpslMarketBtn').addEventListener('click', () => {
        if (!tpslModalState.position) return;
        const pair = normalizePair(tpslModalState.position.pair || 'BTC-USD');
        const cp = marketPrices[pair];
        if (cp) { $('tpslPriceInput').value = formatPrice(cp); validateTpSlPriceForTab('full'); }
      });
      $('tpslSubmitFull').addEventListener('click', () => confirmTpSlOrder('full'));

      $('tpslPriceInputPartial').addEventListener('input', () => validateTpSlPriceForTab('partial'));
      $('tpslMarketBtnPartial').addEventListener('click', () => {
        if (!tpslModalState.position) return;
        const pair = normalizePair(tpslModalState.position.pair || 'BTC-USD');
        const cp = marketPrices[pair];
        if (cp) { $('tpslPriceInputPartial').value = formatPrice(cp); validateTpSlPriceForTab('partial'); }
      });
      $('tpslSubmitPartial').addEventListener('click', () => confirmTpSlOrder('partial'));

      const sizeSlider = $('tpslSizeSlider');
      sizeSlider.addEventListener('input', () => {
        $('tpslSizeValue').textContent = sizeSlider.value + '%';
        updateSliderTrack(sizeSlider, ((Number(sizeSlider.value) - 10) / (Number(sizeSlider.max) - 10)) * 100);
        document.querySelectorAll('.tpsl-size-mark').forEach(m => {
          m.classList.toggle('active', Number(m.dataset.size) === Number(sizeSlider.value));
        });
        validateTpSlPriceForTab('partial');
      });

      document.querySelectorAll('.tpsl-size-mark').forEach(mark => {
        mark.addEventListener('click', () => {
          const val = Number(mark.dataset.size);
          const max = Number(sizeSlider.max);
          if (val <= max) {
            sizeSlider.value = val;
            $('tpslSizeValue').textContent = val + '%';
            updateSliderTrack(sizeSlider, ((val - 10) / (max - 10)) * 100);
            document.querySelectorAll('.tpsl-size-mark').forEach(m => m.classList.remove('active'));
            mark.classList.add('active');
            validateTpSlPriceForTab('partial');
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
          }
        });
      });
    }

    // ==================== LOAD TP/SL ORDERS ====================
    async function loadTpSlOrders() {
      if (!currentUserId) return;
      try {
        const res = await fetch(API_BASE + "/api/tp-sl/list?userId=" + currentUserId);
        const data = await res.json();
        if (data.ok && data.orders) {
          window._tpSlOrders = data.orders;
          renderPositions(true);
        }
      } catch (e) {
        console.error("Failed to load TP/SL orders:", e);
      }
    }

    // ==================== SESSION ====================
    async function initSession() {
      try {
        let initData = tg?.initData || "";
        let res = await fetch(API_BASE + "/api/init", {
          method: "POST", headers: {"Content-Type":"application/json"},
          body: JSON.stringify(initData ? {initData} : {})
        });
        let data = await res.json();
        if(data.ok && data.user) {
          currentUserId = data.user.user_id;
          profile.balance = Number(data.user.balance || 0);
          profile.name = data.user.first_name || "User";
          profile.id = data.user.user_id;
          profile.adViewsCount = Number(data.user.ad_views_count || 0);
          profile.dailyAdViews = Number(data.user.daily_ad_views || 0);
          profile.dailyAdLimit = Number(data.user.daily_ad_limit || DAILY_AD_LIMIT);
          window._positions = data.positions || [];
          
          // Load TP/SL orders from init response or fetch separately
          if (data.tpSlOrders && Array.isArray(data.tpSlOrders)) {
            window._tpSlOrders = data.tpSlOrders;
          } else {
            // Fetch separately if not included in init
            await loadTpSlOrders();
          }
          
          if(data.user.photo_url) {
            profile.photo = data.user.photo_url;
            $('avatarImg').src = data.user.photo_url;
            $('avatarImg').style.display = 'block';
          }
          updateBalanceUI(); updateRewardsUI(); renderPositions(true);
        }
      } catch(e) { console.error(e); }
    }

    // ==================== WEBSOCKET ====================
    let socket = null;
    let lastCandle = null;

    function connectWS() {
      socket = new WebSocket(WSS_PRICE_URL);
      socket.onopen = () => { ALL_PAIRS.forEach(pair => { socket.send(JSON.stringify({ type: "subscribe", pair: pair, timeframe: currentTimeframe })); }); };
      socket.onmessage = (evt) => {
        let msg; try { msg = JSON.parse(evt.data); } catch(e) { return; }
        if (!msg || !msg.type) return;
        const msgPairNorm = normalizePair(msg.pair); const selPairNorm = normalizePair(selectedPair);

        if (msg.type === "price" && msg.pair && msg.price) {
          marketPrices[msgPairNorm] = Number(msg.price);
          if (msgPairNorm === selPairNorm) {
            const currentPrice = Number(msg.price);
            $('priceDisplay').textContent = formatPrice(currentPrice);
            updatePositionsDynamic();
            if (lastCandle) {
              const now = Math.floor(Date.now() / 1000); const candleTime = now - (now % currentTimeframe);
              if (candleTime === lastCandle.time) {
                lastCandle.high = Math.max(lastCandle.high, currentPrice); lastCandle.low = Math.min(lastCandle.low, currentPrice); lastCandle.close = currentPrice;
                candleSeries.update(lastCandle);
                if (localVolumes.length > 0) { const lastVol = localVolumes[localVolumes.length - 1]; if (lastVol.time === candleTime) { lastVol.color = currentPrice >= lastCandle.open ? 'rgba(14, 203, 129, 0.5)' : 'rgba(246, 70, 93, 0.5)'; if (indicatorState.volume && volumeHistogramSeries) volumeHistogramSeries.update(lastVol); } }
              } else {
                lastCandle = { time: candleTime, open: lastCandle.close, high: currentPrice, low: currentPrice, close: currentPrice, volume: 0 };
                localCandles.push(lastCandle); candleSeries.update(lastCandle);
                const newVol = { time: candleTime, value: Math.random() * 100 + 50, color: 'rgba(14, 203, 129, 0.5)' };
                localVolumes.push(newVol);
                if (indicatorState.volume && volumeHistogramSeries) volumeHistogramSeries.update(newVol);
                updateIndicators();
              }
            }
          }
          return;
        }

        if (msgPairNorm !== selPairNorm) return;
        if (msg.type === "orderBook") { renderOrderBook(msg.buy || msg.bids, msg.sell || msg.asks); return; }
        if (msg.type === "moreHistory") {
          if (msg.timeframe && Number(msg.timeframe) !== Number(currentTimeframe)) { isLoadingMoreHistory = false; lockedLeftBoundary = null; hideChartLoadingOverlay(); return; }
          if (!msg.data || msg.data.length === 0) { allOlderHistoryLoaded = true; isLoadingMoreHistory = false; lockedLeftBoundary = null; hideChartLoadingOverlay(); return; }
          const newCandles = msg.data.map(c => ({ time:c.time, open:c.open, high:c.high, low:c.low, close:c.close, volume: c.volume || 0 }));
          const newVolumes = buildVolumeData(newCandles);
          const currentRange = chart.timeScale().getVisibleRange();
          localCandles = [...newCandles, ...localCandles].filter((v,i,a) => a.findIndex(t => t.time === v.time) === i).sort((a,b) => a.time - b.time);
          localVolumes = [...newVolumes, ...localVolumes].filter((v,i,a) => a.findIndex(t => t.time === v.time) === i).sort((a,b) => a.time - b.time);
          candleSeries.setData(localCandles);
          if (indicatorState.volume && volumeHistogramSeries) volumeHistogramSeries.setData(localVolumes);
          if (currentRange) chart.timeScale().setVisibleRange(currentRange);
          updateIndicators(); isLoadingMoreHistory = false; lockedLeftBoundary = null; hideChartLoadingOverlay(); return;
        }
        if (msg.type === "history") {
          if (msg.timeframe && Number(msg.timeframe) !== Number(currentTimeframe)) return;
          const data = msg.data.map(c => ({ time:c.time, open:c.open, high:c.high, low:c.low, close:c.close, volume: c.volume || 0 }));
          localCandles = data; localVolumes = buildVolumeData(data);
          candleSeries.setData(data);
          if (indicatorState.volume && volumeHistogramSeries) volumeHistogramSeries.setData(localVolumes);
          chart.timeScale().fitContent(); chart.priceScale('right').applyOptions({ autoScale: true });
          if (data.length) {
            const last = data[data.length - 1]; const now = Math.floor(Date.now() / 1000); const currentCandleTime = now - (now % currentTimeframe);
            if (last.time >= currentCandleTime) { lastCandle = last; }
            else { lastCandle = { time: currentCandleTime, open: last.close, high: last.close, low: last.close, close: last.close, volume: 0 }; candleSeries.update(lastCandle); localCandles.push(lastCandle); }
            marketPrices[selPairNorm] = lastCandle.close; $('priceDisplay').textContent = formatPrice(lastCandle.close);
          }
          updateIndicators();
          if (historyResolve) { historyResolve(); historyResolve = null; }
          isLoadingHistory = false; return;
        }
        if (msg.type === "trades") {
          const newTrades = msg.trades || []; localTrades = [...newTrades, ...localTrades];
          if (localTrades.length > 20) localTrades = localTrades.slice(0, 20);
          renderTrades(localTrades); return;
        }
      };
      socket.onclose = () => setTimeout(connectWS, 2000);
    }

    // ==================== POSITIONS ====================
    function renderPositions(forceRebuild = false) {
      const list = $('positionsList');
      if (!window._positions) window._positions = [];
      const positions = window._positions;
      if (positions.length === 0) {
        if (list.innerHTML.includes("pos-item") || forceRebuild) list.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>';
        return;
      }
      if (positions.length > 0 && list.innerText.includes("No open positions")) list.innerHTML = "";

      const existingIds = Array.from(list.querySelectorAll('.pos-item')).map(el => el.dataset.id);
      const currentIds = positions.map(p => String(p.id || p._id));
      existingIds.forEach(domId => { if (!currentIds.includes(domId)) { const el = document.getElementById('pos-item-' + domId); if(el) el.remove(); } });
      if(list.children.length === 0 && positions.length === 0) { list.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">No open positions</div>'; return; }

      [...positions].reverse().forEach(pos => {
        const id = String(pos.id || pos._id);
        const pair = normalizePair(pos.pair || "BTC-USD");
        const entry = Number(pos.entry_price || pos.entryPrice);
        const size = Number(pos.size);
        const type = (pos.type || "LONG").toUpperCase();
        const lev = Number(pos.leverage || 1);

        let div = document.getElementById('pos-item-' + id);
        if (div && forceRebuild) { div.remove(); div = null; }

        if (!div) {
          div = document.createElement('div');
          div.className = `pos-item ${type === 'LONG' ? 'long' : 'short'}`;
          div.id = 'pos-item-' + id; div.dataset.id = id;

          const counts = getTpSlCounts(id);
          const orders = getTpSlOrdersForPosition(id);

          let ordersHtml = '';
          if (orders.length > 0) {
            ordersHtml = `<div class="pos-tpsl-orders" id="tpsl-section-${id}">
              <div class="tpsl-orders-title">Active Orders <span class="tpsl-orders-count">${orders.length}</span></div>
              <div class="tpsl-orders-list" id="tpsl-list-${id}">`;
            orders.forEach(order => {
              const isTP = order.order_type === 'TP';
              const { pnl, roe } = calculateTpSlPnl(pos, order.trigger_price, order.size_percent);
              ordersHtml += `<div class="tpsl-order-item ${isTP ? 'tp-order' : 'sl-order'}">
                <div class="tpsl-order-info">
                  <span class="tpsl-order-type ${isTP ? 'tp-type' : 'sl-type'}">${order.order_type}</span>
                  <div class="tpsl-order-details">
                    <span>@ ${formatPrice(order.trigger_price)}</span>
                    <span>${Number(order.size_percent).toFixed(0)}%</span>
                  </div>
                </div>
                <div class="tpsl-order-actions">
                  <div style="text-align:right;">
                    <div class="tpsl-order-pnl ${pnl >= 0 ? 'text-green' : 'text-red'}" id="tpsl-pnl-${order.id}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</div>
                    <div class="tpsl-order-roe ${roe >= 0 ? 'text-green' : 'text-red'}" id="tpsl-roe-${order.id}">${roe >= 0 ? '+' : ''}${roe.toFixed(1)}%</div>
                  </div>
                  <button class="btn-delete-tpsl" data-order-id="${order.id}" title="Cancel">×</button>
                </div>
              </div>`;
            });
            ordersHtml += '</div></div>';
          } else {
            ordersHtml = `<div class="pos-tpsl-orders" id="tpsl-section-${id}" style="display:none;"></div>`;
          }

          div.innerHTML =
            `<div class="pos-header"><div style="display:flex; align-items:center; gap:6px;"><span class="${type==='LONG'?'text-green':'text-red'}">${type}</span><span class="pos-pair">${pair}</span><span class="pos-type-badge ${type==='LONG'?'text-green':'text-red'}">x${lev}</span></div><div class="pos-pnl" id="pnl-${id}">0.00 VP</div></div>` +
            `<div class="pos-stats-grid"><div class="stat-col"><span class="stat-label">ROE %</span><span class="stat-val" id="roe-${id}">0.00%</span></div><div class="stat-col" style="align-items: center;"><span class="stat-label">Margin Ratio</span><span class="stat-val" id="ratio-${id}">0.00%</span></div><div class="stat-col" style="align-items: flex-end;"><span class="stat-label">Risk</span><span class="stat-val" id="risk-val-${id}">0.0%</span><div class="risk-wrap" style="width: 100%;"><div class="risk-track"><div class="risk-fill" id="risk-bar-${id}"></div></div></div></div></div>` +
            `<div class="pos-details"><div class="pd-col"><span class="pd-label">Entry Price</span><span class="pd-val">${formatPrice(entry)}</span></div><div class="pd-col" style="align-items: center;"><span class="pd-label">Size / Mark</span><span class="pd-val">${size.toFixed(0)} / <span id="mark-${id}">--.--</span></span></div><div class="pd-col" style="align-items: flex-end;"><span class="pd-label">Liquidation Price</span><span class="pd-val text-red" id="liq-${id}">--.--</span></div></div>` +
            `<div class="pos-tpsl-actions">` +
              `<button class="btn-tpsl tp" data-pos-id="${id}" data-type="TP"><span class="btn-tpsl-icon">🎯</span> Take Profit <span class="tpsl-count">${counts.tp}/${MAX_TP_PER_POSITION}</span></button>` +
              `<button class="btn-tpsl sl" data-pos-id="${id}" data-type="SL"><span class="btn-tpsl-icon">🛡️</span> Stop Loss <span class="tpsl-count">${counts.sl}/${MAX_SL_PER_POSITION}</span></button>` +
            `</div>` +
            ordersHtml +
            `<button class="close-btn" data-id="${id}">Close Position</button>`;

          list.appendChild(div);

          div.querySelector('.close-btn').onclick = () => closePosition(id, pair);

          div.querySelectorAll('.btn-tpsl').forEach(btn => {
            btn.addEventListener('click', () => openTpSlModal(btn.dataset.posId, btn.dataset.type));
          });

          div.querySelectorAll('.btn-delete-tpsl').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              deleteTpSlOrder(btn.dataset.orderId);
            });
          });
        }
      });
      updatePositionsDynamic();
    }

    function updatePositionsDynamic() {
      if (!window._positions || window._positions.length === 0) return;
      window._positions.forEach(pos => {
        const id = String(pos.id || pos._id);
        const pair = normalizePair(pos.pair || "BTC-USD");
        const currentPrice = marketPrices[pair];
        if (!currentPrice) return;
        const entry = Number(pos.entry_price || pos.entryPrice);
        const size = Number(pos.size), margin = Number(pos.margin);
        const type = (pos.type || "LONG").toUpperCase();
        let diff = (currentPrice - entry) / entry;
        if (type === "SHORT") diff = -diff;
        const pnl = diff * size;
        const roe = (pnl / margin) * 100;
        let riskPercent = 1.0;
        if (pnl < 0) riskPercent = (Math.abs(pnl) / (margin * 0.9)) * 100;
        riskPercent = Math.max(1, Math.min(100, riskPercent));

        const pnlEl = document.getElementById(`pnl-${id}`);
        const roeEl = document.getElementById(`roe-${id}`);
        const ratioEl = document.getElementById(`ratio-${id}`);
        const riskValEl = document.getElementById(`risk-val-${id}`);
        const riskBarEl = document.getElementById(`risk-bar-${id}`);
        const markEl = document.getElementById(`mark-${id}`);
        const liqEl = document.getElementById(`liq-${id}`);

        if (pnlEl) { pnlEl.textContent = `${pnl > 0 ? '+' : ''}${pnl.toFixed(2)} VP`; pnlEl.className = `pos-pnl ${pnl >= 0 ? 'text-green' : 'text-red'}`; }
        if (roeEl) { roeEl.textContent = `${roe > 0 ? '+' : ''}${roe.toFixed(2)}%`; roeEl.className = `stat-val ${roe >= 0 ? 'text-green' : 'text-red'}`; }
        if (riskValEl && riskBarEl) {
          riskValEl.textContent = riskPercent.toFixed(1) + "%"; riskBarEl.style.width = riskPercent + "%";
          const c = riskPercent < 50 ? "#0ECB81" : riskPercent < 80 ? "#F0B90B" : "#F6465D";
          riskValEl.style.color = c; riskBarEl.style.background = c;
        }
        if (ratioEl) ratioEl.textContent = (riskPercent / 2).toFixed(2) + "%";
        if (markEl) markEl.textContent = formatPrice(currentPrice);
        if (liqEl) {
          const liqDist = (margin * 0.90) / size * entry;
          liqEl.textContent = formatPrice(type === "LONG" ? entry - liqDist : entry + liqDist);
        }

        const orders = getTpSlOrdersForPosition(id);
        orders.forEach(order => {
          const { pnl: oPnl, roe: oRoe } = calculateTpSlPnl(pos, order.trigger_price, order.size_percent);
          const oPnlEl = document.getElementById(`tpsl-pnl-${order.id}`);
          const oRoeEl = document.getElementById(`tpsl-roe-${order.id}`);
          if (oPnlEl) { oPnlEl.textContent = `${oPnl >= 0 ? '+' : ''}${oPnl.toFixed(2)}`; oPnlEl.className = `tpsl-order-pnl ${oPnl >= 0 ? 'text-green' : 'text-red'}`; }
          if (oRoeEl) { oRoeEl.textContent = `${oRoe >= 0 ? '+' : ''}${oRoe.toFixed(1)}%`; oRoeEl.className = `tpsl-order-roe ${oRoe >= 0 ? 'text-green' : 'text-red'}`; }
        });
      });
    }

    // ==================== ORDER BOOK & TRADES ====================
    function renderOrderBook(buys, sells) {
      const b = Array.isArray(buys) ? buys : (buys?.bids || []);
      const s = Array.isArray(sells) ? sells : (sells?.asks || []);
      const container = $('orderBook'); const maxLevels = 10;
      const bidMap = new Map(), askMap = new Map();
      b.forEach(l => { const sz = Number(l.size) || 0; if (sz > 0) bidMap.set(Number(l.price).toFixed(2), sz); });
      s.forEach(l => { const sz = Number(l.size) || 0; if (sz > 0) askMap.set(Number(l.price).toFixed(2), sz); });
      let sortedAsks = Array.from(askMap.entries()).map(([p, sz]) => ({ price: Number(p), size: sz, type: 'ask' })).sort((a, b) => a.price - b.price).slice(0, maxLevels).reverse();
      let sortedBids = Array.from(bidMap.entries()).map(([p, sz]) => ({ price: Number(p), size: sz, type: 'bid' })).sort((a, b) => b.price - a.price).slice(0, maxLevels);
      const renderList = [...sortedAsks, ...sortedBids]; const maxVol = Math.max(...renderList.map(x => x.size), 0.0000001);
      container.innerHTML = "";
      renderList.forEach(level => {
        const isAsk = level.type === 'ask'; const row = document.createElement('div'); row.className = 'ob-row';
        row.innerHTML = `<div class="ob-bg ${isAsk ? 'bg-red' : 'bg-green'}" style="width:${(level.size / maxVol) * 100}%"></div><span class="${isAsk ? 'text-red' : 'text-green'}">${formatPrice(level.price)}</span><span style="text-align:right;">${level.size.toFixed(5)}</span>`;
        container.appendChild(row);
      });
      const updEl = $('bookUpdated'); if (updEl) updEl.textContent = new Date().toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }

    function renderTrades(trades) {
      const el = $('tradeHistory'); if(!Array.isArray(trades)) return; let html = "";
      trades.forEach(t => { const color = t.side === 'buy' ? 'text-green' : 'text-red'; const timeStr = new Date(t.time).toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'}); html += `<div class="ob-row"><span class="${color}">${formatPrice(t.price)}</span><span class="trade-time">${timeStr}</span></div>`; });
      el.innerHTML = html;
    }

    // ==================== OPEN / CLOSE POSITION ====================
    async function openPosition(type) {
      const margin = Number($('sizeInput').value); const currentPrice = marketPrices[selectedPair];
      if(!margin || margin <= 0) return alert("Enter margin");
      if(!currentPrice) return alert("Waiting for price...");
      const size = margin * currentLeverage;
      if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
      try {
        const res = await fetch(API_BASE + "/api/order/open", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ userId: currentUserId, pair: selectedPair, type, size, leverage: currentLeverage, entryPrice: currentPrice }) });
        const data = await res.json();
        if(data.ok) {
          window._positions.push(data.position);
          if(data.newBalance) { profile.balance = data.newBalance; updateBalanceUI(); }
          renderPositions(true);
          if(tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        } else { alert(data.error || "Error"); }
      } catch(e) { console.error(e); }
    }

    async function closePosition(id, pair) {
      const pos = window._positions.find(p => (p.id == id || p._id == id));
      if(!pos) return;
      const closePrice = marketPrices[pair || pos.pair];
      if(!closePrice) return alert("Price not available for " + pair);
      if(!confirm("Close position?")) return;
      try {
        const res = await fetch(API_BASE + "/api/order/close", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ userId: currentUserId, positionId: id, closePrice: closePrice }) });
        const data = await res.json();
        if(data.ok) {
          window._positions = window._positions.filter(p => (p.id!=id && p._id!=id));
          window._tpSlOrders = window._tpSlOrders.filter(o => String(o.position_id) !== String(id));
          if(data.newBalance) { profile.balance = data.newBalance; updateBalanceUI(); }
          const el = document.getElementById('pos-item-' + id); if(el) el.remove();
          renderPositions(false);
          if(tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }
      } catch(e) { console.error(e); }
    }

    $('openLong').onclick = () => openPosition("LONG");
    $('openShort').onclick = () => openPosition("SHORT");

    // ==================== BOOT ====================
    const loaderEl = $('app-loader'); const loaderBar = $('loaderBar');
    function setProgress(pct, txt) { loaderBar.style.width = pct + '%'; $('loaderText').textContent = txt; }

    setProgress(20, "AUTH...");
    await initSession();

    setProgress(40, "ADSGRAM...");
    initAdsgram();

    setProgress(50, "TOOLS...");
    initDrawingTools();
    initIndicatorChips();
    initPnlModal();
    initTpSlModal();
    setupDoubleTapHandler();

    setProgress(60, "STREAM...");
    connectWS();

    await Promise.race([historyPromise, new Promise(r => setTimeout(r, 4000))]);
    setProgress(100, "READY");

    setTimeout(() => { checkResponsiveOverflows(); }, 100);

    setTimeout(() => { loaderEl.classList.add('hidden'); setTimeout(() => loaderEl.style.display = 'none', 400); }, 500);

  })();
</script>
</body>
</html>
