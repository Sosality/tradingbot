<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Futures Sim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>

    <!-- Моноширинный для финансовых данных -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet"/>

    <style>
        /* ========== GLOBAL ========== */
        body {
            background-color: #0A0A0A;
            color: #EAEAEA;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        /* Верхняя панель */
        .market-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0D0D0D;
            border-bottom: 1px solid #1e1e1e;
        }
        .pair {
            color: #999;
            font-size: 14px;
            font-weight: 600;
        }
        #price {
            font-family: "Roboto Mono", monospace;
            font-size: 32px;
            font-weight: 700;
        }

        /* График */
        #chart {
            width: 100%;
            height: 45vh;
        }

        /* Панель трейдинга */
        .ui-panel {
            background: #111;
            height: 55vh;
            padding: 16px;
            overflow-y: auto;
            border-top: 1px solid #1e1e1e;
        }

        /* Баланс */
        .balance {
            font-size: 15px;
            margin-bottom: 12px;
            font-family: "Roboto Mono", monospace;
        }

        /* Инпуты */
        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            background: #1e1e1e;
            color: #fff;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            font-size: 15px;
        }
        input:focus, select:focus {
            border-color: #aaa;
            outline: none;
        }

        /* Кнопки */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 18px;
        }
        button {
            padding: 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
            transition: opacity .2s;
        }
        button:hover { opacity: .85; }

        .btn-long { background: #0EBE83; color: #000; }
        .btn-short { background: #FF4E4E; color: #fff; }

        /* ========== ПОЗИЦИИ ========== */
        .positions { margin-top: 10px; }

        .pos-card {
            background: #161616;
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #242424;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pos-info {
            font-size: 13px;
            opacity: .8;
        }
        .pos-entry {
            font-family: "Roboto Mono", monospace;
            font-size: 13px;
            color: #bbb;
        }

        .pnl {
            font-family: "Roboto Mono", monospace;
            font-size: 20px;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .close-btn {
            background: #2d2d2d;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 14px;
            color: #bbb;
        }
    </style>
</head>
<body>

<div class="market-header">
    <span class="pair">BTC / USDT</span>
    <span id="price">...</span>
</div>

<div id="chart"></div>

<div class="ui-panel">
    <div class="balance">Balance: <span id="balance">0</span> VP</div>

    <input type="number" id="amount" placeholder="Order Size (VP)" value="100">
    <select id="leverage">
        <option value="1">x1</option>
        <option value="5">x5</option>
        <option value="10" selected>x10</option>
        <option value="20">x20</option>
    </select>

    <div class="controls">
        <button class="btn-long" onclick="openOrder('LONG')">LONG</button>
        <button class="btn-short" onclick="openOrder('SHORT')">SHORT</button>
    </div>

    <div class="positions" id="positionsList"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    if (!window.Telegram?.WebApp) {
        window.Telegram = { WebApp: {
            initDataUnsafe: { user: { id: 'test_user_1' }},
            expand: ()=>{}, enableClosingConfirmation: ()=>{},
            showAlert: alert, HapticFeedback:{impactOccurred:()=>{},notificationOccurred:()=>{}}
        }};
    }

    const tg = Telegram.WebApp;
    tg.expand();

    const userId = tg.initDataUnsafe?.user?.id || "test_user_1";
    let currentPrice = 0;
    let positions = [];
    let lastCandle = null;

    const chartContainer = document.getElementById('chart');
    const { createChart } = LightweightCharts;
    const chart = createChart(chartContainer, {
        layout: { background: { color: '#111' }, textColor: '#DDD' },
        grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } },
        timeScale: { timeVisible: true, secondsVisible: false }
    });
    const candleSeries = chart.addCandlestickSeries();

    new ResizeObserver(() => {
        chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
    }).observe(chartContainer);

    fetch('/api/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
    })
    .then(r=>r.json())
    .then(user => {
        document.getElementById('balance').innerText = user.balance.toFixed(2);
        positions = user.positions;
        renderPositions();
    });

    function loadHistory() {
        fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=200')
            .then(r => r.json())
            .then(data => {
                const candles = data.map(c => ({
                    time: c[0]/1000,
                    open: +c[1],
                    high: +c[2],
                    low: +c[3],
                    close: +c[4]
                }));
                candleSeries.setData(candles);
                lastCandle = candles[candles.length-1];
                chart.timeScale().fitContent();
            });
    }
    loadHistory();

    function updatePriceAndChart() {
        fetch('/api/price')
            .then(r => r.json())
            .then(data => {
                if (!data.price) return;
                currentPrice = data.price;
                document.getElementById('price').innerText = currentPrice.toFixed(2);

                const now = Math.floor(Date.now() / 1000);
                const minute = Math.floor(now / 60) * 60;

                if (!lastCandle || lastCandle.time !== minute) {
                    lastCandle = { time: minute, open: currentPrice, high: currentPrice, low: currentPrice, close: currentPrice };
                    candleSeries.update(lastCandle);
                } else {
                    lastCandle.high = Math.max(lastCandle.high, currentPrice);
                    lastCandle.low = Math.min(lastCandle.low, currentPrice);
                    lastCandle.close = currentPrice;
                    candleSeries.update(lastCandle);
                }
                updatePositionsPnL();
            });
    }
    setInterval(updatePriceAndChart, 1000);

    window.openOrder = function(type){
        const margin = +document.getElementById('amount').value;
        const leverage = +document.getElementById('leverage').value;

        fetch('/api/order/open', {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, type, margin, leverage })
        })
        .then(r=>r.json())
        .then(res=>{
            if(res.error) return tg.showAlert(res.error);
            positions.push(res.position);
            document.getElementById('balance').innerText = res.balance.toFixed(2);
            renderPositions();
        });
    }

    window.closeOrder = function(id){
        fetch('/api/order/close', {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, positionId:id })
        })
        .then(r=>r.json())
        .then(res=>{
            positions = positions.filter(p=>p.id!==id);
            document.getElementById('balance').innerText=res.balance.toFixed(2);
            renderPositions();
        });
    }

    function renderPositions(){
        const list = document.getElementById("positionsList");
        list.innerHTML = "";
        positions.forEach(p=>{
            const el = document.createElement("div");
            el.className="pos-card";
            el.id="pos-"+p.id;
            el.innerHTML = `
                <div><b>${p.type} x${p.leverage}</b><br>${p.entryPrice.toFixed(2)}</div>
                <div style="text-align:right;">
                    <span class="pnl">0.00</span> VP<br>
                    <button onclick="closeOrder(${p.id})" style="background:#444;padding:5px;border-radius:5px;">✖</button>
                </div>`;
            list.appendChild(el);
        });
    }

    function updatePositionsPnL(){
        positions.forEach(p => {
            let pnl = (p.type==='LONG')
                ? ((currentPrice - p.entryPrice) / p.entryPrice) * p.size
                : ((p.entryPrice - currentPrice) / p.entryPrice) * p.size;

            const el = document.querySelector(`#pos-${p.id} .pnl`);
            if(el){
                el.innerText=pnl.toFixed(2);
                el.style.color=pnl>=0?'#26a69a':'#ef5350';
            }
        });
    }
});
</script>

</body>
</html>
