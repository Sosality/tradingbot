<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TradeSim ‚Äî BTC/ETH Futures (Telegram auth)</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ‚Äî‚Äî‚Äî‚Äî‚Äî –û–ë–©–ò–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ‚Äî‚Äî‚Äî‚Äî‚Äî */
:root{
  --bg:#0B0E11;
  --panel:#1E2329;
  --muted:#98A0A6;
  --accent-green:#0ECB81;
  --accent-red:#F6465D;
  --glass: rgba(255,255,255,0.02);
  --white:#E6EEF3;
}

*{ box-sizing:border-box; outline: none; -webkit-tap-highlight-color: transparent; }
html,body{ height:100%; margin:0; background:var(--bg); color:var(--white); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; overflow: hidden; }

/* –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
.app{ display:flex; flex-direction:column; height:100vh; height: 100dvh; /* dvh –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö */ }

/* ‚Äî‚Äî‚Äî‚Äî‚Äî –®–ê–ü–ö–ê ‚Äî‚Äî‚Äî‚Äî‚Äî */
.header{ display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-bottom:1px solid rgba(255,255,255,0.03); flex-shrink: 0; }
.brand{ display:flex; flex-direction: column; justify-content: center; }
.logo{ font-weight:700; font-size:16px; margin-bottom: 2px; }
.brand-subtitle { color:var(--muted); font-size:11px; }

/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —à–∞–ø–∫–∏ */
.header-right { display:flex; align-items:center; gap:10px; }

.profile{ display:flex; align-items:center; gap:10px; cursor: pointer; }
.avatar{ width:36px; height:36px; border-radius:50%; background:#222; overflow:hidden; flex-shrink:0; border: 1px solid rgba(255,255,255,0.1); }
.avatar img{ width:100%; height:100%; object-fit:cover; }
.profile-info{ display:flex; flex-direction:column; font-size:12px; text-align: right; }
.profile-name{ font-weight:600; max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.profile-balance{ font-family:"Roboto Mono",monospace; color:#cfd8dc; font-weight:700; margin-top:2px; font-size:11px; }

/* ‚Äî‚Äî‚Äî‚Äî‚Äî –ö–û–ù–¢–ï–ô–ù–ï–† (–ì–õ–ê–í–ù–ê–Ø –°–ï–¢–ö–ê) ‚Äî‚Äî‚Äî‚Äî‚Äî */
.container{
  display: grid;
  grid-template-columns: 1fr 320px; /* –ü–ö: –ì—Ä–∞—Ñ–∏–∫ —Å–ª–µ–≤–∞, —Å—Ç–∞–∫–∞–Ω —Å–ø—Ä–∞–≤–∞ */
  gap: 12px;
  padding: 12px;
  flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –º–µ–∂–¥—É —à–∞–ø–∫–æ–π –∏ –ø–æ–¥–≤–∞–ª–æ–º */
  overflow: hidden; /* –ß—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª–∏–ª–∏—Å—å –∫–æ–ª–æ–Ω–∫–∏ –≤–Ω—É—Ç—Ä–∏, –∞ –Ω–µ –≤—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */
}

.left-col { display: flex; flex-direction: column; gap: 12px; overflow-y: auto; height: 100%; min-height: 0; padding-right: 4px; }
.right-col { display: flex; flex-direction: column; gap: 12px; overflow-y: auto; height: 100%; padding-right: 4px; }

/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
.card{ background:var(--panel); border-radius:12px; padding:12px; box-shadow:0 4px 18px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02); position: relative; }

/* –ì—Ä–∞—Ñ–∏–∫ */
.chart-wrap{ height: 50vh; border-radius:10px; overflow:hidden; border: 1px solid rgba(255,255,255,0.05); }

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–µ–Ω—ã */
.top-stats{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap: wrap; }
.price{ font-family:"Roboto Mono",monospace; font-size:24px; font-weight:700; }
.price-change{ font-weight:700; padding:4px 8px; border-radius:6px; font-size:12px; }
.price-change.up{ background:rgba(14,190,131,0.12); color:var(--accent-green); }
.price-change.down{ background:rgba(246,70,93,0.10); color:var(--accent-red); }

/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã) */
.controls-wrapper { display: flex; flex-direction: column; gap: 12px; margin-top: 12px; }
.controls-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }

.controls-inputs { display: flex; gap: 8px; flex: 1; min-width: 200px; }
.controls input { background:#111; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); color:var(--white); font-size:14px; width: 100%; }

.segment{ display:flex; gap:6px; background: #111; padding: 4px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.03); }
.chip{ padding:6px 10px; border-radius:6px; background:transparent; cursor:pointer; font-size: 12px; font-weight: 600; color: var(--muted); transition: all 0.2s; }
.chip.active{ background: var(--panel); color: var(--white); box-shadow: 0 2px 8px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }

.trade-buttons { display: flex; gap: 8px; flex: 1; }
.trade-buttons button { flex: 1; white-space: nowrap; }

/* –ë–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏ (Orderbook) */
.side-section{ display:flex; flex-direction:column; gap:8px; overflow:hidden; max-height: 50%; }
.orderbook-list{ display:flex; flex-direction:column; gap:4px; font-size:12px; color:var(--muted); overflow-y:auto; padding-right: 2px; }
.orderbook-row{ display:flex; justify-content:space-between; padding:4px 6px; border-radius:4px; }
.orderbook-row:hover { background: rgba(255,255,255,0.03); }
.orderbook-row .price{ width:80px; font-weight: 600; font-size: 12px; }
.orderbook-row.buy .price{ color:var(--accent-green); }
.orderbook-row.sell .price{ color:var(--accent-red); }

.trade-history{ overflow-y:auto; padding-right: 2px; max-height: 200px; }
.trade-row{ display:flex; justify-content:space-between; padding:4px 6px; border-radius:4px; font-size:12px; margin-bottom: 2px; }

/* –ü–æ–∑–∏—Ü–∏–∏ */
.pos-card{ display:flex; flex-direction: column; padding:12px; border-radius:8px; margin-bottom:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); gap: 8px; }
.pos-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
.pos-details { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; font-size: 12px; color: var(--muted); }

/* –ü–æ–¥–≤–∞–ª */
.bottom-nav{ display:flex; gap:8px; padding:12px; background:var(--panel); border-top:1px solid rgba(255,255,255,0.05); flex-shrink: 0; align-items: center; }

/* –ö–Ω–æ–ø–∫–∏ */
.btn{ padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:700; font-size: 13px; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; }
.btn:active { opacity: 0.7; }
.btn-primary{ background:var(--accent-green); color:#0B0E11; }
.btn-danger{ background:var(--accent-red); color:#0B0E11; }
.btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.05); color:var(--muted); }

/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–∞—Ä */
.pair-switch { display:flex; gap:6px; background: #15181b; padding: 4px; border-radius: 8px; }
.pair-btn { padding:6px 12px; border-radius:6px; cursor:pointer; color:var(--muted); font-size: 12px; font-weight: 600; transition: all 0.2s; }
.pair-btn.active { color:var(--white); background: rgba(255,255,255,0.05); }

/* ‚Äî‚Äî‚Äî‚Äî‚Äî –ê–î–ê–ü–¢–ò–í (–ú–û–ë–ò–õ–¨–ù–´–ï) ‚Äî‚Äî‚Äî‚Äî‚Äî */
@media (max-width: 900px) {
  /* –ú–µ–Ω—è–µ–º Grid –Ω–∞ Flex –∫–æ–ª–æ–Ω–∫—É */
  .container {
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* –í–∫–ª—é—á–∞–µ–º –æ–±—â–∏–π —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    padding-bottom: 20px;
  }
  
  /* –†–∞–∑—Ä–µ—à–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
  .left-col, .right-col {
    overflow: visible;
    height: auto;
  }

  /* –ì—Ä–∞—Ñ–∏–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç—ã */
  .chart-wrap {
    height: 400px;
    min-height: 400px;
  }

  /* –£–ª—É—á—à–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º */
  .trade-buttons button {
    padding: 14px;
    font-size: 14px;
  }

  /* –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–µ–µ –≤ —à–∞–ø–∫–µ –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º —É–∑–∫–æ */
  .profile-username { display: none; }
  .brand-subtitle { display: none; }
  
  /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–∞—Ä –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
  .pair-btn { padding: 6px 8px; }

  /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ —á–∞—Å—Ç—å –ø–æ—Ç–æ–∫–∞ –Ω–∞ iOS) */
  /* –ù–æ –º—ã –æ—Å—Ç–∞–≤–∏–º –µ–µ –≤ flex-layout .app, –æ–Ω–∞ –±—É–¥–µ—Ç –ø—Ä–∏–∂–∞—Ç–∞ –∫ –Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ –≤—Å–µ–≥–¥–∞ */
}

/* ‚Äî‚Äî‚Äî‚Äî‚Äî –ó–ê–ì–†–£–ó–ß–ò–ö ‚Äî‚Äî‚Äî‚Äî‚Äî */
#app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s; }
#app-loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
.loader-logo { font-weight: 700; font-size: 24px; margin-bottom: 24px; color: var(--white); letter-spacing: -0.5px; }
.loader-track { width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative; }
.loader-bar { position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: var(--accent-green); transition: width 0.3s ease-out; box-shadow: 0 0 10px rgba(14, 203, 129, 0.5); }
.loader-text { margin-top: 12px; font-size: 12px; color: var(--muted); font-family: 'Roboto Mono', monospace; }
</style>
</head>

<body>

<div id="app-loader">
  <div class="loader-logo">‚ßâ TradeSim</div>
  <div class="loader-track">
    <div class="loader-bar" id="loaderBar"></div>
  </div>
  <div class="loader-text" id="loaderText">Loading assets...</div>
</div>

<div class="app">

<header class="header">
  <div class="brand">
    <div class="logo">‚ßâ TradeSim</div>
    <div style="color:var(--muted);font-size:13px">BTC/ETH Futures demo</div>
  </div>

  <div style="display:flex;align-items:center;gap:12px">
    <div class="pair-switch" id="pairSwitch">
      <div class="pair-btn active" data-pair="BTC-USD">BTC</div>
      <div class="pair-btn" data-pair="ETH-USD">ETH</div>
    </div>

    <div class="profile" id="profileArea">
      <div class="avatar" id="avatarWrap"><img id="avatarImg" src=""></div>
      <div class="profile-info">
        <div class="profile-name" id="profileName">‚Äî</div>
        <div class="profile-username" id="profileUsername">@‚Äî</div>
        <div class="profile-balance" id="profileBalance">–ë–∞–ª–∞–Ω—Å: 0 VP</div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section class="left-col">
    <div class="card">
      <div class="top-stats">
        <div>
          <div style="color:var(--muted);font-size:12px">–ü–∞—Ä–∞</div>
          <div style="display:flex;align-items:center;gap:12px;margin-top:6px">
            <div style="font-weight:700" id="pairLabel">BTC / USD</div>
            <div id="marketTag" style="background:var(--glass);padding:4px 8px;border-radius:8px;color:var(--muted);font-size:12px">Perpetual (sim)</div>
          </div>
        </div>

        <div style="text-align:right">
          <div class="price" id="priceDisplay">‚Äî</div>
          <div id="priceChange" class="price-change">‚Äî</div>
        </div>
      </div>

      <div class="chart-wrap card" id="chartCard">
        <div id="chart" style="width:100%;height:100%;"></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
        <div class="controls" style="flex:1">
          <input id="sizeInput" type="number" placeholder="–°—É–º–º–∞ (VP)" value="100" />
          <div class="segment" id="leverageSegment" style="align-items:center">
            <div class="chip" data-value="1">x1</div>
            <div class="chip" data-value="5">x5</div>
            <div class="chip active" data-value="10">x10</div>
            <div class="chip" data-value="20">x20</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-left:12px">
          <button id="openLong" class="btn btn-primary">BUY / LONG</button>
          <button id="openShort" class="btn btn-danger">SELL / SHORT</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Positions</div>
        <div style="color:var(--muted);font-size:13px">live</div>
      </div>
      <div id="positionsList" style="margin-top:10px"></div>
    </div>
  </section>

  <aside class="right-col">
    <div class="card side-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Order Book</div>
        <div style="color:var(--muted);font-size:13px" id="bookPairLabel">BTC-USD</div>
      </div>
      <div class="orderbook-list" id="orderBook"></div>
    </div>

    <div class="card side-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Trade History</div>
        <div style="color:var(--muted);font-size:13px" id="tradesPairLabel">BTC-USD</div>
      </div>
      <div class="trade-history" id="tradeHistory"></div>
    </div>
  </aside>
</main>

<div class="bottom-nav">
  <button id="btnProfile" class="btn btn-ghost">–ü—Ä–æ—Ñ–∏–ª—å</button>
  <button id="btnFutures" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ –§—å—é—á–µ—Ä—Å—ã</button>
  <div style="flex:1"></div>
  <div style="color:var(--muted);font-size:13px;padding:6px 8px">WS: <span id="wsStatus">‚Äî</span></div>
</div>

</div> <script>
(async function(){
  // ==============================
  // [NEW] LOADER LOGIC
  // ==============================
  const loaderEl = document.getElementById('app-loader');
  const loaderBar = document.getElementById('loaderBar');
  const loaderText = document.getElementById('loaderText');

  function setProgress(percent, text) {
    loaderBar.style.width = percent + '%';
    if(text) loaderText.textContent = text;
  }

  // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  setProgress(10, "Connecting Telegram...");

  // –û–±–µ—â–∞–Ω–∏–µ (Promise), –∫–æ—Ç–æ—Ä–æ–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –ø—Ä–∏–¥–µ—Ç –∏—Å—Ç–æ—Ä–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
  let historyResolve = null;
  const historyPromise = new Promise(resolve => {
    historyResolve = resolve;
  });

  // ==============================
  // CONFIG
  // ==============================
  const WSS_PRICE_URL = "wss://tradingbot-backend-2yws.onrender.com";
  const API_BASE = "https://tradingbot-p9n8.onrender.com";
  let currentUserId = null;

  // ==============================
  // TELEGRAM INIT
  // ==============================
  const tg = window.Telegram?.WebApp;
  tg?.ready();
  tg?.expand();

  let profile = { first_name:"Guest", username:"", photo_url:"", balance:0 };

  function updateProfileUI(userObj){
    const avatarImg = document.getElementById("avatarImg");
    if (userObj.photo_url) {
      avatarImg.src = userObj.photo_url;
      avatarImg.style.display = "block";
    } else {
      avatarImg.src = "";
      avatarImg.style.display = "none";
    }
    document.getElementById("profileName").textContent = userObj.first_name || "Guest";
    document.getElementById("profileUsername").textContent = userObj.username ? "@" + userObj.username : "";
    document.getElementById("profileBalance").textContent = "–ë–∞–ª–∞–Ω—Å: " + (Number(userObj.balance || 0)).toFixed(2) + " VP";
  }

  async function initSession(){
    try {
      let initData = tg?.initData || "";
      let response;
      if (initData) {
        response = await fetch(API_BASE + "/api/init", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData })
        });
      } else {
        response = await fetch(API_BASE + "/api/init", { method: "POST", body: JSON.stringify({}) });
      }
      const data = await response.json();

      if (data.ok && data.user) {
        profile = {
          first_name: data.user.first_name || "Guest",
          username: data.user.username || "",
          photo_url: data.user.photo_url || "",
          balance: Number(data.user.balance || 0)
        };
        currentUserId = data.user.user_id; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è –æ—Ä–¥–µ—Ä–æ–≤
        window._positions = data.positions || [];
        renderPositions();
        updateProfileUI(profile);
      } else {
        if (tg?.initDataUnsafe?.user) {
          const u = tg.initDataUnsafe.user;
          profile = {
            first_name: u.first_name || "Guest",
            username: u.username || "",
            photo_url: u.photo_url || "",
            balance: 0
          };
          updateProfileUI(profile);
        }
      }
    } catch (err) {
      console.error("initSession error:", err);
      if (tg?.initDataUnsafe?.user) {
        const u = tg.initDataUnsafe.user;
        profile = {
          first_name: u.first_name || "Guest",
          username: u.username || "",
          photo_url: u.photo_url || "",
          balance: 0
        };
        updateProfileUI(profile);
      }
    }
  }

  // ==============================
  // CHART SETUP
  // ==============================
  const chartDiv = document.getElementById("chart");
  const chart = LightweightCharts.createChart(chartDiv,{
    width: chartDiv.clientWidth,
    height: chartDiv.clientHeight,
    layout:{ background:{color:getComputedStyle(document.body).getPropertyValue('--bg')}, textColor:'#D1D8DE' },
    grid:{ horzLines:{color:'rgba(255,255,255,0.03)'}, vertLines:{color:'rgba(255,255,255,0.03)'} },
    priceScale:{ borderVisible:false },
    timeScale:{ borderVisible:false }
  });

  let candleSeries = chart.addCandlestickSeries({
    upColor:'rgba(14,190,131,1)',
    borderUpColor:'rgba(14,190,131,1)',
    wickUpColor:'rgba(14,190,131,1)',
    downColor:'rgba(246,70,93,1)',
    borderDownColor:'rgba(246,70,93,1)',
    wickDownColor:'rgba(246,70,93,1)'
  });

  window.addEventListener("resize",()=>{
    chart.applyOptions({ width:chartDiv.clientWidth, height:chartDiv.clientHeight });
  });

  // ==============================
  // STATE
  // ==============================
  let selectedPair = "BTC-USD";
  let currentPrice = 0;
  let lastCandle = null; 

  const pairHistory = {
    "BTC-USD": [],
    "ETH-USD": []
  };

  document.getElementById("pairLabel").textContent = "BTC / USD";
  document.getElementById("bookPairLabel").textContent = selectedPair;
  document.getElementById("tradesPairLabel").textContent = selectedPair;

  // ==============================
  // WS CLIENT
  // ==============================
  let socket = null;
  const wsStatus = document.getElementById("wsStatus");

  function connectWS(){
    socket = new WebSocket(WSS_PRICE_URL);
    socket.onopen = () => {
      wsStatus.textContent = "connected";
      subscribePair(selectedPair);
    };
    socket.onclose = () => {
      wsStatus.textContent = "closed";
      setTimeout(connectWS, 1500);
    };
    socket.onerror = () => {
      wsStatus.textContent = "error";
    };
    socket.onmessage = evt => {
      try {
        const msg = JSON.parse(evt.data);
        handleWS(msg);
      } catch(e){ console.error("WS parse error", e); }
    };
  }

  function subscribePair(pair){
    if (socket && socket.readyState === WebSocket.OPEN){
      socket.send(JSON.stringify({ type:"subscribe", pair }));
    }
  }

  function unsubscribePair(pair){
    if (socket && socket.readyState === WebSocket.OPEN){
      socket.send(JSON.stringify({ type:"unsubscribe", pair }));
    }
  }

  // ==============================
  // WS HANDLER
  // ==============================
  function handleWS(msg){
    if (!msg.type) return;

    // –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–≤–µ—á–µ–π
    if (msg.type === "history") {
      if (!msg.pair) return;
      pairHistory[msg.pair] = msg.data.map(c => ({
        time: c.time,
        open: c.open,
        high: c.high,
        low: c.low,
        close: c.close
      }));

      if (msg.pair === selectedPair) {
        const candles = pairHistory[msg.pair];
        if (candles.length > 0) {
          candleSeries.setData(candles);

          const firstTime = candles[0].time;
          const lastTime = candles[candles.length - 1].time;

          try {
            chart.timeScale().setVisibleRange({ from: firstTime, to: lastTime + 60 });
          } catch(e) {
            chart.timeScale().fitContent();
          }

          lastCandle = { ...candles[candles.length - 1] };
          currentPrice = lastCandle.close;
          updatePriceUI();
        } else {
          candleSeries.setData([]);
          chart.timeScale().fitContent();
          lastCandle = null;
          currentPrice = 0;
          updatePriceUI();
        }

        // [NEW] –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–º–∏—Å –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
        if (historyResolve) {
            historyResolve(); 
            historyResolve = null; // –ß—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
        }
      }
      return;
    }

    if (msg.type === "price" && msg.pair === selectedPair){
      currentPrice = Number(msg.price);
      if (!lastCandle) {
        updatePriceUI();
        return;
      }
      const now = Math.floor(Date.now() / 1000);
      const currentMinute = now - (now % 60);

      if (currentMinute === lastCandle.time) {
        lastCandle.high = Math.max(lastCandle.high, currentPrice);
        lastCandle.low = Math.min(lastCandle.low, currentPrice);
        lastCandle.close = currentPrice;
        candleSeries.update(lastCandle);
      } else {
        lastCandle = {
          time: currentMinute,
          open: lastCandle.close,
          high: currentPrice,
          low: currentPrice,
          close: currentPrice
        };
        candleSeries.update(lastCandle);
      }
      updatePriceUI();
    }

    if (msg.type === "orderBook" && msg.pair === selectedPair){
      renderOrderBook(msg.buy, msg.sell);
    }
    if (msg.type === "trades" && msg.pair === selectedPair){
      renderTrades(msg.trades);
    }
  }

  // ==============================
  // UI RENDER & FUNCTIONS
  // ==============================
  window._positions = [];

  function renderPositions() {
    const el = document.getElementById("positionsList");
    el.innerHTML = "";

    if (!window._positions || window._positions.length === 0) {
      el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:32px 0;font-size:14px">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</div>';
      return;
    }

    window._positions.forEach(pos => {
      const entryPrice = Number(pos.entry_price || pos.entryPrice || 0);
      const size = Number(pos.size || 0);
      const leverage = Number(pos.leverage || 1);
      const margin = Number(pos.margin || 0);
      const type = (pos.type || "LONG").toUpperCase();
      
      let pnl = 0;
      if (currentPrice > 0 && entryPrice > 0) {
        const priceChangePct = (currentPrice - entryPrice) / entryPrice;
        pnl = priceChangePct * size;
        if (type === "SHORT") {
          pnl = -pnl;
        }
      }

      let roePercent = "0.00";
      if (margin > 0) {
        roePercent = ((pnl / margin) * 100).toFixed(2);
      }

      const pnlColor = pnl >= 0 ? "var(--accent-green)" : "var(--accent-red)";
      const sign = pnl >= 0 ? "+" : "";

      const card = document.createElement("div");
      card.className = "pos-card";
      card.style.cssText = "display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;margin-bottom:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);";

      card.innerHTML = `
        <div>
          <div style="font-weight:700;font-size:15px;color:${pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
            ${type === "LONG" ? "üü¢ LONG" : "üî¥ SHORT"} ${selectedPair}
          </div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px">
            –û–±—ä–µ–º: ${size.toFixed(2)} VP | –ü–ª–µ—á–æ: x${leverage}
          </div>
          <div style="font-size:12px;color:var(--muted)">
            –í—Ö–æ–¥: $${entryPrice.toFixed(2)}
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700;font-size:15px;color:${pnlColor}">
            ${sign}${pnl.toFixed(2)} VP
          </div>
          <div style="font-size:12px;color:${pnlColor};margin-top:2px">
            ROE: ${sign}${roePercent}%
          </div>
          <button class="btn btn-ghost" 
                  style="margin-top:6px;padding:4px 10px;font-size:12px;border:1px solid rgba(255,255,255,0.1)"
                  data-id="${pos.id || pos._id}">
            –ó–∞–∫—Ä—ã—Ç—å
          </button>
        </div>
      `;
      el.appendChild(card);
    });

    el.querySelectorAll("button[data-id]").forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        closePos(btn.dataset.id);
      };
    });
  }

  async function closePos(id) {
    if (!confirm("–ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é?")) return;
    try {
      const response = await fetch(API_BASE + "/api/order/close", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: currentUserId,
          positionId: id,
          closePrice: currentPrice
        })
      });

      const data = await response.json();
      if (data.ok) {
        window._positions = window._positions.filter(p => (p.id != id && p._id != id));
        renderPositions();
        if (data.newBalance) {
          profile.balance = data.newBalance;
          updateProfileUI(profile);
        }
      } else {
        alert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å"));
      }
    } catch (e) {
      console.error(e);
      alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
    }
  }

  function updatePriceUI(){
    document.getElementById("priceDisplay").textContent = currentPrice ? currentPrice.toFixed(2) : "‚Äî";
    renderPositions();
  }

  document.getElementById("openLong").addEventListener("click", openPosition("LONG"));
  document.getElementById("openShort").addEventListener("click", openPosition("SHORT"));

  function openPosition(side) {
    return async () => {
      const marginInput = Number(document.getElementById("sizeInput").value);
      const leverageEl = document.querySelector("#leverageSegment .chip.active");
      const leverage = Number(leverageEl?.dataset.value || 10);

      if (!marginInput || marginInput <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –º–∞—Ä–∂–∏");

      const positionSize = marginInput * leverage;

      try {
        const response = await fetch(API_BASE + "/api/order/open", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: currentUserId,
            pair: selectedPair,
            type: side,
            size: positionSize,
            leverage: leverage,
            entryPrice: currentPrice
          })
        });

        const data = await response.json();
        
        if (data.ok) {
          window._positions.push(data.position);
          renderPositions();
          
          if (data.newBalance !== undefined) {
             profile.balance = data.newBalance;
             updateProfileUI(profile);
          }
          alert(`–ü–æ–∑–∏—Ü–∏—è ${side} –æ—Ç–∫—Ä—ã—Ç–∞!\n–ú–∞—Ä–∂–∞: ${marginInput} VP\n–û–±—ä–µ–º –ø–æ–∑–∏—Ü–∏–∏: ${positionSize} VP (x${leverage})`);
        } else {
          alert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ—Ä–¥–µ—Ä"));
        }
      } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
      }
    };
  }

  document.querySelectorAll("#leverageSegment .chip").forEach(chip => {
    chip.addEventListener("click", () => {
      document.querySelectorAll("#leverageSegment .chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
    });
  });

  function renderOrderBook(buys, sells){
    const el = document.getElementById("orderBook");
    el.innerHTML = "";
    sells.slice(0,20).forEach(s=>{
      const r=document.createElement("div");
      r.className="orderbook-row sell";
      r.innerHTML=`<div class="price">${s.price.toFixed(2)}</div><div>${s.size.toFixed(4)}</div>`;
      el.appendChild(r);
    });
    el.appendChild(Object.assign(document.createElement("div"),{style:"height:6px"}));
    buys.slice(0,20).forEach(b=>{
      const r=document.createElement("div");
      r.className="orderbook-row buy";
      r.innerHTML=`<div class="price">${b.price.toFixed(2)}</div><div>${b.size.toFixed(4)}</div>`;
      el.appendChild(r);
    });
  }

  function renderTrades(list){
    const el=document.getElementById("tradeHistory");
    el.innerHTML="";
    (list||[]).slice().reverse().forEach(t=>{
      const row=document.createElement("div");
      row.className="trade-row";
      const color = t.side==="buy" ? "var(--accent-green)" : "var(--accent-red)";
      row.innerHTML = `
        <div style="color:${color};font-family:Roboto Mono">${t.price.toFixed(2)}</div>
        <div>${t.size.toFixed(3)}</div>
        <div style="color:var(--muted);font-size:12px">${new Date(t.time).toLocaleTimeString()}</div>
      `;
      el.appendChild(row);
    });
  }

  document.querySelectorAll(".pair-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".pair-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      const newPair = btn.dataset.pair;
      if (newPair === selectedPair) return;

      unsubscribePair(selectedPair);

      chart.removeSeries(candleSeries);
      const newSeries = chart.addCandlestickSeries({
        upColor:'rgba(14,190,131,1)',
        borderUpColor:'rgba(14,190,131,1)',
        wickUpColor:'rgba(14,190,131,1)',
        downColor:'rgba(246,70,93,1)',
        borderDownColor:'rgba(246,70,93,1)',
        wickDownColor:'rgba(246,70,93,1)'
      });
      candleSeries = newSeries;

      lastCandle = null;
      currentPrice = 0;
      updatePriceUI();
      document.getElementById("orderBook").innerHTML="";
      document.getElementById("tradeHistory").innerHTML="";

      selectedPair = newPair;
      document.getElementById("pairLabel").textContent = newPair.replace("-"," / ");
      document.getElementById("bookPairLabel").textContent = newPair;
      document.getElementById("tradesPairLabel").textContent = newPair;

      if (pairHistory[selectedPair]?.length) {
        candleSeries.setData(pairHistory[selectedPair]);
        chart.timeScale().fitContent();

        const lastHist = pairHistory[selectedPair].slice(-1)[0];
        if (lastHist) {
          lastCandle = { ...lastHist };
          currentPrice = lastCandle.close;
          updatePriceUI();
        }
      }

      subscribePair(selectedPair);
    });
  });

  // ==============================
  // [NEW] START SEQUENCE
  // ==============================
  
  // 1. –ì—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–∞
  setProgress(30, "Loading User Data...");
  await initSession();
  
  // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–æ–∫–µ—Ç—É
  setProgress(60, "Connecting to Market...");
  connectWS();

  // 3. –ñ–¥–µ–º, –ø–æ–∫–∞ —Å–æ–∫–µ—Ç –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∏ –ø—Ä–∏—à–ª–µ—Ç "history" (—Å–≤–µ—á–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞)
  // –°—Ç–∞–≤–∏–º —Ç–∞–π–º–∞—É—Ç 5 —Å–µ–∫, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª–æ –≤–µ—á–Ω–æ, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Ç—É–ø–∏—Ç
  const timeoutPromise = new Promise(resolve => setTimeout(resolve, 5000));
  await Promise.race([historyPromise, timeoutPromise]);
  
  // 4. –§–∏–Ω–∞–ª
  setProgress(100, "Ready!");
  
  // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ–º –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
  setTimeout(() => {
    loaderEl.classList.add('hidden');
    // –£–¥–∞–ª—è–µ–º –∏–∑ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => {
      loaderEl.style.display = 'none';
    }, 500);
  }, 500);

})();
</script>
</body>
</html>
